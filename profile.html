<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Prince Alex Travel Services</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut, 
            updateEmail, 
            updatePassword 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc,
            setDoc,
            updateDoc, 
            collection, 
            query, 
            where, 
            getDocs 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGErPBeQ1Fdx9EHPXOHepoEoOx7P2f57o",
            authDomain: "princealextravel.firebaseapp.com",
            projectId: "princealextravel",
            storageBucket: "princealextravel.firebasestorage.app",
            messagingSenderId: "947577729462",
            appId: "1:947577729462:web:dd4b4c7cb4a984c5e3d117"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase instances and functions globally accessible
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOutFirebase = signOut; // Renamed to avoid conflict
        window.updateEmailFirebase = updateEmail; // Renamed to avoid conflict
        window.updatePasswordFirebase = updatePassword; // Renamed to avoid conflict
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;

        // Global variable for current user, populated by onAuthStateChanged
        window.currentUser = null;

        // Listen for authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                window.currentUser = user;
                document.getElementById('profileContent').style.display = 'block';
                document.getElementById('loggedOutMessage').style.display = 'none';
                
                // Only load profile if no welcome message is already displayed
                const currentMessage = document.getElementById('profileMessage');
                if (!currentMessage.textContent.includes('Welcome')) {
                    await loadUserProfile(user);
                }
                await loadPastBookings(user.uid);
            } else {
                // User is signed out
                window.currentUser = null;
                document.getElementById('profileContent').style.display = 'none';
                document.getElementById('loggedOutMessage').style.display = 'block';
            }
            updateAuthLinks(); // Update navigation links based on auth state
        });
    </script>
    <style>
        /* Modern CSS Variables for Enhanced Design */
        :root {
            --primary-color: #1e3a8a; /* Modern deep blue */
            --primary-light: #3b82f6; /* Lighter blue for accents */
            --accent-color: #f59e0b; /* Modern amber/gold */
            --accent-light: #fbbf24; /* Light amber */
            --light-bg: #f8fafc; /* Clean light background */
            --white: #ffffff;
            --text-dark: #1e293b;
            --text-light: #ffffff;
            --text-muted: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            --gradient-accent: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-light) 100%);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --border-radius: 12px;
            --border-radius-lg: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
            line-height: 1.6;
        }
        .navbar {
            background: var(--gradient-primary);
            padding: 1rem 0;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        .navbar-container {
            max-width: 1200px;
            margin: auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            background: var(--white);
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }
        .logo:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .logo img {
            height: 50px;
            display: block;
        }
        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        .nav-links a {
            color: var(--text-light);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95rem;
            position: relative;
            padding: 0.5rem 0;
            transition: var(--transition);
        }
        .nav-links a::after {
            content: '';
            display: block;
            width: 0;
            height: 2px;
            background: var(--accent-color);
            transition: var(--transition);
            position: absolute;
            bottom: 0;
            left: 0;
            border-radius: 1px;
        }
        .nav-links a:hover::after {
            width: 100%;
        }
        .nav-links a:hover {
            color: var(--accent-light);
            transform: translateY(-1px);
        }

        /* Hamburger Menu Icon */
        .menu-toggle {
            display: none;
            flex-direction: column;
            justify-content: space-around;
            width: 30px;
            height: 25px;
            cursor: pointer;
            z-index: 10001;
            background: none;
            border: none;
            padding: 0;
        }

        .menu-toggle .bar {
            width: 100%;
            height: 3px;
            background-color: white;
            border-radius: 5px;
            transition: all 0.3s ease;
            transform-origin: center;
        }

        /* Animation for hamburger to close icon */
        .menu-toggle.open .bar:nth-child(1) {
            transform: translateY(11px) rotate(45deg);
        }
        .menu-toggle.open .bar:nth-child(2) {
            opacity: 0;
        }
        .menu-toggle.open .bar:nth-child(3) {
            transform: translateY(-11px) rotate(-45deg);
        }
        .footer {
            background: var(--gradient-primary);
            color: var(--white);
            padding: 3rem 2rem 1rem;
            text-align: center;
            font-size: 0.95rem;
            margin-top: 3rem;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }
        .footer-content {
            max-width: 1200px;
            margin: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            text-align: left;
        }
        .footer-section {
            flex: 1;
            min-width: 200px;
        }
        .footer-section h4 {
            color: var(--accent-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .footer-section a,
        .footer-section p {
            display: block;
            color: var(--white);
            margin: 0.5rem 0;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .footer-section a:hover {
            color: var(--accent-color);
            transform: translateX(4px);
        }
        .footer-bottom {
            margin-top: 2rem;
            padding-top: 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.8;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .contact-info p {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .contact-info i {
            color: var(--accent-color);
            width: 16px;
        }

        .quick-contact {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .contact-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .contact-btn.whatsapp {
            background: #25D366;
            color: white;
        }

        .contact-btn.whatsapp:hover {
            background: #1ea952;
            transform: translateY(-2px);
        }

        .contact-btn.call {
            background: var(--primary-color);
            color: white;
        }

        .contact-btn.call:hover {
            background: #001c44;
            transform: translateY(-2px);
        }

        .social-links {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .social-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            color: var(--text-light);
        }

        .social-link:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .social-link.facebook:hover {
            color: #1877F2;
        }

        .social-link.instagram:hover {
            color: #E4405F;
        }

        .social-link.twitter:hover {
            color: #1DA1F2;
        }

        .newsletter-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .newsletter-form input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            font-size: 0.9rem;
        }

        .newsletter-form input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .newsletter-form button {
            padding: 0.75rem 1rem;
            background: var(--accent-color);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .newsletter-form button:hover {
            background: #d4b800;
            transform: translateY(-2px);
        }

        /* Modern Profile Page Styles */
        .profile-container {
            max-width: 900px; /* Wider container */
            margin: 3rem auto;
            padding: 0; /* Remove padding to allow cards to have their own */
            background: transparent; /* Remove container background */
            box-shadow: none; /* Remove container shadow */
            text-align: left;
            border: none;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding: 2rem;
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .user-info h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0;
        }

        .user-info p {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin: 0;
        }

        .profile-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab-link {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            position: relative;
            top: 2px;
        }

        .tab-link:hover {
            color: var(--primary-color);
        }

        .tab-link.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        /* Custom Popup Modal */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .popup-modal {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-xl);
            transform: scale(0.8) translateY(20px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .popup-overlay.show .popup-modal {
            transform: scale(1) translateY(0);
        }

        .popup-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .popup-icon.success {
            color: #10b981;
        }

        .popup-icon.error {
            color: #ef4444;
        }

        .popup-icon.warning {
            color: #f59e0b;
        }

        .popup-icon.info {
            color: #3b82f6;
        }

        .popup-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .popup-message {
            font-size: 1rem;
            color: var(--text-light);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .popup-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .popup-button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .popup-button.primary {
            background: var(--primary-color);
            color: var(--white);
        }

        .popup-button.primary:hover {
            background: #001c44;
            transform: translateY(-2px);
        }

        .popup-button.secondary {
            background: #f1f5f9;
            color: var(--text-dark);
            border: 1px solid #e2e8f0;
        }

        .popup-button.secondary:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .popup-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .popup-close:hover {
            color: var(--text-dark);
        }

        .profile-form .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        .profile-form .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9rem;
        }
        .profile-form .form-group input[type="text"],
        .profile-form .form-group input[type="password"],
        .profile-form .form-group input[type="email"],
        .profile-form .form-group input[type="tel"] {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--white);
            box-sizing: border-box;
        }
        .profile-form .form-group input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        .profile-form .form-group input:hover {
            border-color: #cbd5e1;
        }
        .profile-form .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        .profile-actions {
            display: flex;
            justify-content: flex-end; /* Align button to the right */
            gap: 1rem;
            margin-top: 2rem;
        }
        .profile-actions button {
            background: var(--gradient-accent);
            color: var(--white);
            border: none;
            padding: 0.75rem 2rem;
            font-size: 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }
        .profile-actions button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .message {
            margin-bottom: 1.5rem; /* Display message at the top */
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            font-weight: 600;
            text-align: center;
            display: none;
            border: 1px solid transparent;
        }
        .message.error {
            background: #fee2e2;
            color: var(--error);
            border-color: #fca5a5;
        }
        .message.success {
            background: #d1fae5;
            color: var(--success);
            border-color: #a7f3d0;
        }
        .message.warning {
            background: #fef3c7;
            color: var(--warning);
            border-color: #fcd34d;
        }
        /* Modern logged-out message */
        .logged-out-message {
            text-align: center;
            padding: 3rem;
            font-size: 1.25rem;
            color: var(--text-muted);
            margin-top: 3rem;
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .logged-out-message a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }
        .logged-out-message a:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }

        /* Modern Past Bookings Section */
        .past-bookings-section {
            margin-top: 0; /* No margin needed as it's in a tab */
        }
        .past-bookings-section h2 {
            display: none; /* Hide h2 as it's part of the tab now */
        }
        .booking-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            align-items: center;
            border: 1px solid #e2e8f0;
            transition: var(--transition);
        }
        .booking-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .booking-card div {
            font-size: 0.95rem;
        }
        .booking-card div label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }
        .booking-card div span {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dark);
        }
        .booking-card .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--white);
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            justify-self: flex-start;
        }
        .booking-card .status-badge.paid { background: var(--success); }
        .booking-card .status-badge.pending { background: var(--warning); }
        .booking-card .status-badge.cancelled { background: var(--error); }
        
        .no-bookings-message {
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
            padding: 2rem;
            font-size: 1.1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .navbar-container {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                position: relative;
            }
            .menu-toggle {
                display: flex;
            }
            .nav-links {
                position: absolute;
                top: 100%;
                left: 0;
                width: 100%;
                background: var(--gradient-primary);
                box-shadow: var(--shadow-lg);
                flex-direction: column;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease-in-out;
                z-index: 9999;
                border-radius: 0 0 1rem 1rem;
            }
            .nav-links.open {
                max-height: 500px;
            }
            .nav-links a {
                padding: 0.75rem 1rem;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                text-align: left;
                width: 100%;
                font-size: 1.1em;
                display: block;
            }
            .nav-links a:last-child {
                border-bottom: none;
            }
            .profile-container {
                margin: 2rem auto;
                padding: 0 1rem;
            }
            .profile-header {
                flex-direction: column;
                text-align: center;
                padding: 1.5rem;
            }
            .user-info h1 {
                font-size: 1.75rem;
            }
            .profile-form .grid-2 {
                grid-template-columns: 1fr;
            }
            .booking-card {
                grid-template-columns: 1fr 1fr;
            }
            .footer {
                padding: 2rem 1rem 1rem;
            }
            .footer-content {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                text-align: center;
            }
            .footer-section h4 {
                text-align: center;
            }
            .quick-contact {
                justify-content: center;
            }
            .newsletter-form {
                flex-direction: column;
                gap: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .profile-container {
                padding: 0 0.5rem;
            }
            .card {
                padding: 1.5rem;
            }
            .profile-form .form-group input[type="text"],
            .profile-form .form-group input[type="password"],
            .profile-form .form-group input[type="email"],
            .profile-form .form-group input[type="tel"] {
                padding: 0.6rem 0.8rem;
            }
            .profile-actions button {
                width: 100%;
            }
            .booking-card {
                grid-template-columns: 1fr;
                text-align: center;
            }
            .booking-card div {
                width: 100%;
            }
            .booking-card .status-badge {
                justify-self: center;
            }
        }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="navbar-container">
            <div class="logo">
                <img src="mylogo.png" alt="Prince Alex Logo" />
            </div>
            <!-- Hamburger Menu Icon -->
            <button class="menu-toggle" id="mobile-menu" aria-label="Toggle mobile menu">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </button>
            <nav class="nav-links" id="main-nav">
                <a href="index.html">Home</a>
                <a href="about-us.html">About Us</a>
                <a href="#contact-us">Contact</a>
                <a href="ticket-lookup.html">Print Ticket</a>
                <a href="admin.html">Admin Login</a>
                <a href="profile.html" id="myProfileLink" style="display:none;">My Profile</a>
                <a href="login-register.html" id="loginRegisterLink">Login / Register</a>
                <a href="#" id="logoutLink" style="display:none;">Logout</a>
            </nav>
        </div>
    </header>

    <div class="profile-container" id="profileContent">
        <div class="profile-header">
            <div class="avatar"><span id="userInitials"></span></div>
            <div class="user-info">
                <h1 id="profileGreeting">Hello!</h1>
                <p id="profileEmailHeader">Loading your details...</p>
            </div>
        </div>

        <div class="profile-tabs">
            <button class="tab-link active" data-tab="profile-settings">Profile Settings</button>
            <button class="tab-link" data-tab="my-bookings">My Bookings</button>
        </div>

        <div id="profile-settings" class="tab-content active">
            <div class="card">
                <div id="profileMessage" class="message"></div>
                <h2>Update Information</h2>
                <p style="color: var(--text-muted); margin-top: -0.5rem; margin-bottom: 1.5rem;">Keep your personal and contact details up to date.</p>
                <form id="profileForm" class="profile-form">
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="newFullName">Full Name</label>
                            <input type="text" id="newFullName" placeholder="Enter your full name">
                        </div>
                        <div class="form-group">
                            <label for="newIdNumber">National ID</label>
                            <input type="text" id="newIdNumber" placeholder="Enter your ID number">
                        </div>
                        <div class="form-group">
                            <label for="newPhoneNumber">Phone Number</label>
                            <input type="tel" id="newPhoneNumber" placeholder="Enter your phone number">
                        </div>
                        <div class="form-group">
                            <label for="newEmail">Email Address</label>
                            <input type="email" id="newEmail" placeholder="Enter your email address">
                        </div>
                    </div>
                    <div class="profile-actions">
                        <button type="submit">Update Profile</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="my-bookings" class="tab-content">
            <div id="pastBookingsList">
                <p class="no-bookings-message">Loading past bookings...</p>
            </div>
        </div>
    </div>

    <div class="logged-out-message" id="loggedOutMessage" style="display:none;">
        <p>You need to be logged in to view your profile.</p>
        <p><a href="login-register.html">Login or Register here</a></p>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section" id="contact-us">
                <h4>Contact Us</h4>
                <div class="contact-info">
                    <p><i class="fas fa-envelope"></i> senerwaalex@gmail.com</p>
                    <p><i class="fas fa-phone"></i> +254 717 384 875</p>
                    <p><i class="fas fa-map-marker-alt"></i> Nairobi, Kenya</p>
                </div>
                <div class="quick-contact">
                    <a href="tel:+254717384875" class="contact-btn whatsapp">
                        <i class="fab fa-whatsapp"></i>
                        Call Now
                    </a>
                    <a href="https://wa.me/254717384875" class="contact-btn call" target="_blank">
                        <i class="fas fa-phone"></i>
                        WhatsApp
                    </a>
                </div>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <a href="index.html">Home</a>
                <a href="about-us.html">About Us</a>
                <a href="ticket-lookup.html">Print Ticket</a>
                <a href="admin.html">Admin Login</a>
            </div>
            <div class="footer-section">
                <h4>Follow Us</h4>
                <div class="social-links">
                    <a href="#" class="social-link facebook">
                        <i class="fab fa-facebook-f"></i>
                        Facebook
                    </a>
                    <a href="#" class="social-link instagram">
                        <i class="fab fa-instagram"></i>
                        Instagram
                    </a>
                    <a href="#" class="social-link twitter">
                        <i class="fab fa-twitter"></i>
                        Twitter
                    </a>
                </div>
            </div>
            <div class="footer-section">
                <h4>Newsletter</h4>
                <p>Stay updated with our latest offers and travel news!</p>
                <form class="newsletter-form" onsubmit="event.preventDefault(); subscribeNewsletter();">
                    <input type="email" placeholder="Enter your email" required>
                    <button type="submit">
                        <i class="fas fa-paper-plane"></i>
                        Subscribe
                    </button>
                </form>
            </div>
        </div>
        <div class="footer-bottom">
            &copy; 2025 Prince Alex Digital. All rights reserved.
        </div>
    </footer>

    <script>
        // Navbar link references (declare once globally)
        const myProfileLink = document.getElementById('myProfileLink');
        const loginRegisterLink = document.getElementById('loginRegisterLink');
        const logoutLink = document.getElementById('logoutLink');


        document.addEventListener('DOMContentLoaded', () => {
            // Attach logout handler
            logoutLink.addEventListener('click', async (e) => {
                e.preventDefault();
                await logout();
            });

            // Handle profile update
            const profileForm = document.getElementById('profileForm');
            profileForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await updateProfile();
            });

            // Hamburger menu functionality
            const mobileMenuToggle = document.getElementById('mobile-menu');
            const mainNav = document.getElementById('main-nav');

            if (mobileMenuToggle && mainNav) {
                mobileMenuToggle.addEventListener('click', function () {
                    this.classList.toggle('open');
                    mainNav.classList.toggle('open');
                });

                mainNav.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        mobileMenuToggle.classList.remove('open');
                        mainNav.classList.remove('open');
                    });
                });

                // Close mobile menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!mobileMenuToggle.contains(event.target) && !mainNav.contains(event.target)) {
                        mobileMenuToggle.classList.remove('open');
                        mainNav.classList.remove('open');
                    }
                });
            }

            // Tab functionality
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabContents = document.querySelectorAll('.tab-content');

            tabLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const tabId = link.dataset.tab;

                    tabLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');

                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId) {
                            content.classList.add('active');
                        }
                    });
                });
            });

            // âœ… Check for new user welcome message
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('newUser') === '1') {
                displayMessage('profileMessage', 'ðŸ‘‹ Welcome! Please complete your profile details.', 'warning');
            }
            
            // Ensure navbar is correct on load
            updateAuthLinks();
        });

        // --- Load User Profile Data ---
        async function loadUserProfile(user) {
            const userDocRef = doc(firebaseDb, "users", user.uid);
            const docSnap = await getDoc(userDocRef);

            if (!docSnap.exists()) {
                // Check if we already have a welcome message displayed
                const currentMessage = document.getElementById('profileMessage');
                if (!currentMessage.textContent.includes('Welcome')) {
                    displayMessage('profileMessage', 'Please update your profile details.', 'warning');
                }
                // Populate header with fallback data
                document.getElementById('profileGreeting').textContent = `Hello, ${user.email.split('@')[0]}!`;
                document.getElementById('profileEmailHeader').textContent = user.email;
                const initials = (user.email[0] || '').toUpperCase();
                document.getElementById('userInitials').textContent = initials;
                return;
            }

            const profileData = docSnap.data();
            const fullName = profileData.passenger_name || user.email.split('@')[0];
            const email = profileData.passenger_email || user.email;

            // Display profile values
            document.getElementById('profileGreeting').textContent = `Hello, ${fullName}!`;
            document.getElementById('profileEmailHeader').textContent = email;
            const initials = fullName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            document.getElementById('userInitials').textContent = initials || (email[0] || '').toUpperCase();

            // Pre-fill form values
            document.getElementById('newFullName').value = profileData.passenger_name || '';
            document.getElementById('newPhoneNumber').value = profileData.passenger_phone || '';
            document.getElementById('newIdNumber').value = profileData.passenger_id || '';
            document.getElementById('newEmail').value = email;
        }

        // --- Load Past Bookings for the User ---
        async function loadPastBookings(userId) {
            const pastBookingsList = document.getElementById('pastBookingsList');
            pastBookingsList.innerHTML = '<p class="no-bookings-message">Loading past bookings...</p>';

            try {
                const bookingsCol = collection(firebaseDb, "bookings");
                
                // Try user_id first
                const q = query(bookingsCol, where("user_id", "==", userId));
                const querySnapshot = await getDocs(q);

                let bookings = [];
                querySnapshot.forEach((doc) => bookings.push({ id: doc.id, ...doc.data() }));

                // If no bookings found with user_id, try passenger_email as fallback
                if (bookings.length === 0) {
                    const user = firebaseAuth.currentUser;
                    if (user && user.email) {
                        const emailQuery = query(bookingsCol, where("passenger_email", "==", user.email));
                        const emailSnapshot = await getDocs(emailQuery);
                        
                        emailSnapshot.forEach((doc) => {
                            // Avoid adding duplicates if a booking somehow has both matching email and different user_id
                            if (!bookings.some(b => b.id === doc.id)) {
                                bookings.push({ id: doc.id, ...doc.data() });
                            }
                        });
                    }
                }

                if (bookings.length === 0) {
                    pastBookingsList.innerHTML = '<p class="no-bookings-message">No past bookings found.</p>';
                    return;
                }

                bookings.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                pastBookingsList.innerHTML = '';
                bookings.forEach(booking => {
                    const bookingCard = document.createElement('div');
                    bookingCard.classList.add('booking-card');
                    const statusClass = (booking.status || 'pending').toLowerCase();
                    bookingCard.innerHTML = `
                        <div><label>Booking Ref</label><span>${booking.booking_ref || 'N/A'}</span></div>
                        <div><label>Route</label><span>${booking.bus_route || 'N/A'}</span></div>
                        <div><label>Travel Date</label><span>${booking.travel_date || 'N/A'}</span></div>
                        <div><label>Seat</label><span>${booking.seat_number || 'N/A'}</span></div>
                        <div><label>Price</label><span>Ksh ${Number(booking.price || 0).toLocaleString()}</span></div>
                        <div><label>Status</label><span class="status-badge ${statusClass}">${booking.status || 'PENDING'}</span></div>
                    `;
                    pastBookingsList.appendChild(bookingCard);
                });

            } catch (error) {
                console.error("Error loading bookings:", error);
                pastBookingsList.innerHTML = '<p class="no-bookings-message error">Error loading bookings: ' + error.message + '</p>';
            }
        }

        // --- Update User Profile Data ---
        async function updateProfile() {
            const newFullName = document.getElementById('newFullName').value.trim();
            const newPhoneNumber = document.getElementById('newPhoneNumber').value.trim();
            const newIdNumber = document.getElementById('newIdNumber').value.trim();
            const newEmail = document.getElementById('newEmail').value.trim();

            const user = firebaseAuth.currentUser;
            if (!user) {
                displayMessage('profileMessage', 'You must be logged in to update.', 'error');
                return;
            }

            try {
                const userDocRef = doc(firebaseDb, "users", user.uid);
                const updates = {};

                if (newFullName) updates.passenger_name = newFullName;
                if (newPhoneNumber) updates.passenger_phone = newPhoneNumber;
                if (newIdNumber) updates.passenger_id = newIdNumber;
                if (newEmail && newEmail !== user.email) {
                    updates.passenger_email = newEmail;
                    try {
                        await updateEmailFirebase(user, newEmail); // keep Auth email in sync
                    } catch (emailError) {
                        if (emailError.code === 'auth/requires-recent-login') {
                            displayMessage('profileMessage', 'Please log out and log in again before updating your email.', 'error');
                            return;
                        }
                        throw emailError; // Re-throw other errors
                    }
                }

                // Use setDoc with merge: true to create document if it doesn't exist
                await setDoc(userDocRef, updates, { merge: true });

                displayMessage('profileMessage', 'âœ… Profile updated successfully!', 'success');
                await loadUserProfile(user);

            } catch (error) {
                console.error("Error updating profile:", error);
                displayMessage('profileMessage', 'Update failed: ' + error.message, 'error');
            }
        }

        // --- Logout Function ---
        async function logout() {
            try {
                await signOutFirebase(firebaseAuth);
                // onAuthStateChanged listener will handle UI updates
                showCustomAlert('Logged out successfully!');
                window.location.href = 'index.html'; // Redirect to home page after logout
            } catch (error) {
                console.error("An unexpected error occurred during logout:", error);
                showCustomAlert('An unexpected error occurred during logout.');
            }
        }

        // --- Update Authentication Links ---
        function updateAuthLinks() {
            if (window.currentUser) {
                // User is logged in
                loginRegisterLink.style.display = 'none';
                myProfileLink.style.display = 'block';
                logoutLink.style.display = 'block';

                // Highlight My Profile link if on this page
                if (window.location.pathname.includes('profile.html')) {
                    myProfileLink.style.color = 'var(--accent-color)';
                    myProfileLink.style.borderBottom = '2px solid var(--accent-color)';
                } else {
                    myProfileLink.style.color = 'white';
                    myProfileLink.style.borderBottom = 'none';
                }
            } else {
                // User is not logged in
                loginRegisterLink.style.display = 'block';
                myProfileLink.style.display = 'none';
                logoutLink.style.display = 'none';
            }
        }

        // --- General Email Validation ---
        function validateEmail(email) {
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        // --- Custom Alert Modals (replaces browser's alert) ---
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.7); display: flex; justify-content: center;
                align-items: center; z-index: 1001;
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 25px; border-radius: 8px; text-align: center; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                    <p style="margin-bottom: 20px; font-size: 1.1em;">${message}</p>
                    <button style="background-color: var(--primary-color); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;" onclick="this.parentNode.parentNode.remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function displayMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            
            // For warning messages, add a close button
            if (type === 'warning') {
                element.innerHTML = `
                    <span>${message}</span>
                    <button onclick="this.parentElement.style.display='none'" 
                            style="background: none; border: none; color: inherit; font-size: 1.2em; cursor: pointer; margin-left: 10px; float: right;">Ã—</button>
                `;
            } else {
                element.textContent = message;
            }
            
            element.className = `message ${type}`; // Add type class (error or success)
            element.style.display = 'block';
            
            // Don't auto-hide warnings
            if (type === 'warning') return;
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // --- PDF Generation Function (reused from ticket-lookup.html, adjusted for direct booking object) ---
        // This function needs to be global or accessible from loadPastBookings
        async function downloadTicketFromBooking(bookingId) {
            // Fetch the booking data directly for this specific ticket download
            const bookingDocRef = doc(firebaseDb, "bookings", bookingId);
            const docSnap = await getDoc(bookingDocRef);

            if (!docSnap.exists()) {
                console.error("Error fetching booking for PDF generation: No such document!");
                showCustomAlert("Failed to retrieve booking details for PDF. Please try again.");
                return;
            }
            const booking = { id: docSnap.id, ...docSnap.data() };

            if (booking.status !== 'paid') {
                showCustomAlert('Ticket can only be downloaded after payment is confirmed.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let y = 20;
            const lineHeight = 7;
            const leftMargin = 20;

            // Define colors (matching CSS variables, directly from the CSS in the HTML)
            const primaryColor = '#002d6b';
            const accentColor = '#c69214';
            const darkTextColor = '#1a1a1a';
            const secondaryTextColor = '#555';


            // --- 1. Header with Logo and QR Code ---
            // Add Logo
            const img = new Image();
            img.src = 'mylogo.png'; // Ensure this path is correct
            await new Promise((resolve, reject) => {
                img.onload = () => resolve();
                img.onerror = () => {
                    console.error("Error loading logo image: Mylogo.png. Please ensure the file exists and the path is correct.");
                    // Optionally, you can add a fallback or skip adding the image
                    resolve(); // Resolve even on error to allow PDF generation to continue
                };
            });
            if (img.complete && img.naturalWidth !== 0) { // Check if image loaded successfully
                doc.addImage(img, 'PNG', 15, y, 40, 40); // x, y, width, height
            } else {
                console.warn("Logo image not loaded, skipping addition to PDF.");
            }


            // Title
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(primaryColor);
            doc.text("Prince Alex Travel Services", 60, y + 15);
            doc.setFontSize(14);
            doc.setFont("helvetica", "normal");
            doc.text("E-Ticket & Booking Confirmation", 60, y + 25);

            // Generate QR Code
            const qrCodeData = booking.booking_ref; // Data to encode in QR code
            const qrCodeSize = 50; // Size of the QR code image

            // Create a temporary div to render the QR code
            const qrCodeDiv = document.createElement('div');
            qrCodeDiv.style.display = 'none'; // Keep it hidden
            document.body.appendChild(qrCodeDiv);

            let qrCodeImgData = '';
            try {
                new QRCode(qrCodeDiv, {
                    text: qrCodeData,
                    width: qrCodeSize,
                    height: qrCodeSize,
                    colorDark : primaryColor, // Use company color for QR code
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });

                // Wait a tiny bit for QR code to render to canvas/img
                await new Promise(resolve => setTimeout(resolve, 50));
                qrCodeImgData = qrCodeDiv.querySelector('canvas').toDataURL("image/png");

            } catch (qrError) {
                console.error("Error generating QR code:", qrError);
            } finally {
                // Clean up the temporary div
                document.body.removeChild(qrCodeDiv);
            }

            if (qrCodeImgData) {
                 doc.addImage(qrCodeImgData, 'PNG', 160, y, 40, 40); // x, y, width, height
            } else {
                console.warn("QR Code image data not generated, skipping addition to PDF.");
            }


            y += 55; // Move Y position down after header content

            // --- Drawing the main ticket body container ---
            doc.setDrawColor(primaryColor);
            doc.setLineWidth(1.5);
            doc.line(10, y, 200, y); // Horizontal line below header

            y += 10; // Space after line

            // --- 2. Booking Reference (Prominent) ---
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(accentColor);
            doc.text(`Booking Reference: ${booking.booking_ref}`, 20, y);
            y += 15;

            // --- 3. Passenger Details Section ---
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(primaryColor);
            doc.text("Passenger Details:", 20, y);
            y += 8;
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(darkTextColor);
            doc.text(`Name: ${booking.passenger_name}`, 20, y); y += lineHeight;
            doc.text(`Phone: ${booking.passenger_phone}`, 20, y); y += lineHeight;
            doc.text(`Email: ${booking.passenger_email || 'N/A'}`, 20, y); y += 12;

            // --- 4. Journey Details Section ---
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(primaryColor);
            doc.text("Journey Details:", 20, y);
            y += 8;
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(darkTextColor);
            doc.text(`Bus Name: ${booking.bus_name || 'N/A'}`, 20, y); y += lineHeight;
            doc.text(`Route: ${booking.bus_route}`, 20, y); y += lineHeight;
            doc.text(`Travel Date: ${booking.travel_date}`, 20, y); y += lineHeight;
            doc.text(`Departure Time: ${booking.bus_time}`, 20, y); y += lineHeight;
            doc.text(`Bus ID: ${booking.bus_id || 'N/A'}`, 20, y); y += lineHeight;
            doc.text(`Seat Number: ${booking.seat_number}`, 20, y); y += 12;

            // --- 5. Payment Summary Section ---
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(primaryColor);
            doc.text("Payment Summary:", 20, y);
            y += 8;
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(darkTextColor);
            doc.text(`Amount: Ksh ${booking.price.toFixed(2)}`, 20, y); y += lineHeight;
            doc.text(`Payment Status: ${booking.status.toUpperCase()}`, 20, y); y += 12;
            doc.text(`Booking Date: ${new Date(booking.booking_date).toLocaleDateString()}`, 20, y); y += 12;

            // --- 6. Special Note for PENDING Status ---
            if (booking.status.toUpperCase() === 'PENDING') {
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(200, 0, 0); // Red color for warning
                doc.text("NOTE: This ticket is PENDING PAYMENT. Please complete payment to validate.", 20, y);
                y += 5;
                doc.text("Contact support for assistance: +254 717 384 875", 20, y);
                doc.setTextColor(darkTextColor); // Reset color
                y += 15;
            }

            // --- 7. Footer ---
            y = doc.internal.pageSize.height - 25; // Position footer from bottom
            doc.setDrawColor(primaryColor);
            doc.setLineWidth(0.5);
            doc.line(10, y, 200, y); // Horizontal line above footer
            y += 5;

            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(darkTextColor);
            doc.text("Prince Alex Travel Services | Email: senerwaalex@gmail.com | Phone: +254 717 384 875", doc.internal.pageSize.width / 2, y, { align: "center" });
            y += 5;
            doc.text("Â© 2025 Prince Alex Digital. All rights reserved.", doc.internal.pageSize.width / 2, y, { align: "center" });


            doc.save(`ticket-${booking.booking_ref}.pdf`);
        }

        // Newsletter subscription function
        function subscribeNewsletter() {
            const emailInput = document.querySelector('.newsletter-form input');
            const email = emailInput.value.trim();
            
            if (!email) {
                showPopup('Email Required', 'Please enter your email address to subscribe to our newsletter.', 'warning');
                return;
            }
            
            // Simulate newsletter subscription
            showPopup(
                'ðŸŽ‰ Welcome to Our Newsletter!',
                'Thank you for subscribing! You\'ll now receive updates about our latest offers, travel news, and special promotions directly to your inbox.',
                'success'
            );
            emailInput.value = '';
        }

        // Custom Popup Functions
        function showPopup(title, message, type = 'info', buttons = null) {
            const overlay = document.getElementById('popupOverlay');
            const icon = document.getElementById('popupIcon');
            const titleEl = document.getElementById('popupTitle');
            const messageEl = document.getElementById('popupMessage');
            const buttonsEl = document.getElementById('popupButtons');

            // Set icon based on type
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };
            icon.textContent = icons[type] || icons.info;
            icon.className = `popup-icon ${type}`;

            // Set content
            titleEl.textContent = title;
            messageEl.textContent = message;

            // Set buttons
            if (buttons) {
                buttonsEl.innerHTML = buttons;
            } else {
                buttonsEl.innerHTML = '<button class="popup-button primary" onclick="closePopup()">Got it!</button>';
            }

            // Show popup
            overlay.classList.add('show');
        }

        function closePopup() {
            const overlay = document.getElementById('popupOverlay');
            overlay.classList.remove('show');
        }

        // Close popup when clicking outside
        document.getElementById('popupOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closePopup();
            }
        });
    </script>

    <!-- Custom Popup Modal -->
    <div id="popupOverlay" class="popup-overlay">
        <div class="popup-modal">
            <button class="popup-close" onclick="closePopup()">&times;</button>
            <div class="popup-icon" id="popupIcon"></div>
            <h3 class="popup-title" id="popupTitle"></h3>
            <p class="popup-message" id="popupMessage"></p>
            <div class="popup-buttons" id="popupButtons">
                <button class="popup-button primary" onclick="closePopup()">Got it!</button>
            </div>
        </div>
    </div>
</body>
</html>
