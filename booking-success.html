<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Successful! - Prince Alex Travel Services</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #002d6b;
            --accent-color: #c69214;
            --light-bg: #f5f7fa;
            --text-dark: #1a1a1a;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .navbar {
            background-color: var(--primary-color);
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .navbar-container {
            max-width: 1200px;
            margin: auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            background-color: white;
            padding: 10px 15px;
            border-radius: 12px;
            box-shadow: 0 0 8px rgba(0,0,0,0.2);
        }
        .logo img {
            height: 80px;
            display: block;
        }
        .nav-links {
            display: flex;
            gap: 25px;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
            position: relative;
        }
        .nav-links a::after {
            content: '';
            display: block;
            width: 0;
            height: 2px;
            background: var(--accent-color);
            transition: width 0.3s;
            position: absolute;
            bottom: -5px;
            left: 0;
        }
        .nav-links a:hover::after {
            width: 100%;
        }
        .nav-links a:hover {
            color: var(--accent-color);
        }
        main {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
        }
        .success-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 700px;
            width: 100%;
            text-align: center;
        }
        .success-container h1 {
            color: var(--primary-color);
            font-size: 32px;
            margin-bottom: 20px;
        }
        .success-icon {
            color: #28a745; /* Green for success */
            font-size: 80px;
            margin-bottom: 30px;
        }
        .booking-details {
            text-align: left;
            margin-bottom: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .booking-details p {
            font-size: 1.1em;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .booking-details p strong {
            color: var(--primary-color);
        }
        .booking-details span.status-pending {
            color: #ffc107; /* Orange for pending */
            font-weight: bold;
        }
        .booking-details span.status-paid {
            color: #28a745; /* Green for paid */
            font-weight: bold;
        }
        .booking-actions button {
            background-color: var(--accent-color);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s ease;
            margin: 10px;
        }
        .booking-actions button:hover {
            background-color: #b27e0f;
        }
        .booking-actions a {
            display: inline-block;
            background-color: #6c757d; /* Grey for back button */
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s ease;
            margin: 10px;
        }
        .booking-actions a:hover {
            background-color: #5a6268;
        }
        .qr-code-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #ddd;
        }
        .qr-code-container img {
            width: 150px;
            height: 150px;
            border: 1px solid #eee;
            padding: 5px;
            background-color: white;
        }
        .footer {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 14px;
            margin-top: auto; /* Pushes footer to the bottom */
        }
        .footer-content {
            max-width: 1000px;
            margin: auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 20px;
            text-align: left;
        }
        .footer-section {
            flex: 1;
            min-width: 200px;
        }
        .footer-section h4 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }
        .footer-section a,
        .footer-section p {
            display: block;
            color: white;
            margin: 4px 0;
            text-decoration: none;
        }
        .footer-section a:hover {
            text-decoration: underline;
        }
        .footer-bottom {
            margin-top: 20px;
            text-align: center;
            font-size: 13px;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .navbar-container {
                flex-direction: column;
                gap: 15px;
            }
            .success-container {
                padding: 25px;
                margin: 20px;
            }
            .success-container h1 {
                font-size: 24px;
            }
            .success-icon {
                font-size: 60px;
            }
            .booking-details p {
                font-size: 1em;
            }
            .booking-actions button,
            .booking-actions a {
                padding: 12px 20px;
                font-size: 1em;
                margin: 5px;
            }
            .footer-content {
                flex-direction: column;
                text-align: center;
            }
            .footer-section {
                min-width: unset;
            }
            .footer-section h4 {
                text-align: center;
            }
            .footer-section a,
            .footer-section p {
                display: inline-block;
                margin: 0 5px;
            }
        }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="navbar-container">
            <div class="logo">
                <img src="Mylogo.png" alt="Prince Alex Logo" />
            </div>
            <nav class="nav-links">
                <a href="dashboard.html">Home</a>
                <a href="#">About Us</a>
                <a href="#">Contact</a>
                <a href="ticket-lookup.html">Print Ticket</a>
                <a href="admin.html">Admin Login</a>
                <a href="#">Login / Register</a>
            </nav>
        </div>
    </header>

    <main>
        <div class="success-container">
            <i class="fas fa-check-circle success-icon"></i>
            <h1>Booking Confirmed!</h1>
            <p>Your trip has been successfully booked. Find your details below.</p>

            <div class="booking-details" id="bookingDetails">
                </div>

            <div class="qr-code-container">
                <h3>Your Booking QR Code</h3>
                <img id="qrCodeImage" src="" alt="QR Code">
                <p style="font-size: 0.9em; color: #555; margin-top: 10px;">Scan this code for quick access to your booking details.</p>
            </div>

            <div class="booking-actions">
                <button onclick="generatePDF()">Download Ticket</button>
                <button onclick="initiateSTKPush()">Pay Now (M-Pesa STK)</button>
                <a href="dashboard.html">Book Another Trip</a>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>Contact Us</h4>
                <p>Email: senerwaalex@gmail.com</p>
                <p>Phone: +254 717 384 875</p>
                <p>Location: Nairobi, Kenya</p>
            </div>
            <div class="footer-section">
                <h4>Follow Us</h4>
                <a href="#">Facebook</a>
                <a href="#">Instagram</a>
                <a href="#">Twitter</a>
            </div>
        </div>
        <div class="footer-bottom">
            &copy; 2025 Prince Alex Digital. All rights reserved.
        </div>
    </footer>

    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const lastBookingId = localStorage.getItem('lastBookingId');
            const bookings = JSON.parse(localStorage.getItem('bookings')) || [];
            const booking = bookings.find(b => b.id === lastBookingId);
            const bookingDetailsDiv = document.getElementById('bookingDetails');
            const qrCodeImage = document.getElementById('qrCodeImage');

            if (booking) {
                const seatDisplay = booking.seatNumber ? `S${booking.seatNumber}` : 'Not Selected';

                bookingDetailsDiv.innerHTML = `
                    <p><strong>Booking ID:</strong> ${booking.id}</p>
                    <p><strong>Passenger Name:</strong> ${booking.passengerName}</p>
                    <p><strong>ID Number:</strong> ${booking.passengerID || 'N/A'}</p>
                    <p><strong>Gender:</strong> ${booking.passengerGender || 'N/A'}</p>
                    <p><strong>Phone:</strong> ${booking.passengerPhone || 'N/A'}</p>
                    <p><strong>Email:</strong> ${booking.passengerEmail || 'N/A'}</p>
                    <p><strong>Route:</strong> ${booking.busRoute}</p>
                    <p><strong>Travel Date:</strong> ${booking.travelDate}</p>
                    <p><strong>Departure Time:</strong> ${booking.busTime}</p>
                    <p><strong>Bus ID:</strong> ${booking.busId}</p>
                    <p><strong>Seat Number:</strong> ${seatDisplay}</p>
                    <p><strong>Price:</strong> Ksh ${booking.price}</p>
                    <p><strong>Status:</strong> <span class="status-${booking.status}">${booking.status.toUpperCase()}</span></p>
                    <p><strong>Booking Date:</strong> ${booking.bookingDate}</p>
                `;

                // Generate QR Code
                const qrData = JSON.stringify({
                    id: booking.id,
                    name: booking.passengerName,
                    route: booking.busRoute,
                    date: booking.travelDate,
                    time: booking.busTime,
                    seat: seatDisplay
                });

                // Using qrcode.js library
                // Create a temporary div to render the QR code into
                const qrCodeDiv = document.createElement('div');
                new QRCode(qrCodeDiv, {
                    text: qrData,
                    width: 150,
                    height: 150,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });

                // The QR code is drawn asynchronously. We need to wait for it.
                setTimeout(() => {
                    const canvas = qrCodeDiv.querySelector('canvas');
                    if (canvas) {
                        qrCodeImage.src = canvas.toDataURL();
                    } else {
                        console.error("QR Code canvas not found after generation.");
                    }
                }, 50); // Small delay to allow QR code to render to canvas

            } else {
                bookingDetailsDiv.innerHTML = '<p>No booking details found. Please go back to the <a href="dashboard.html">home page</a> to make a booking.</p>';
            }
        });

        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const lastBookingId = localStorage.getItem('lastBookingId');
            const bookings = JSON.parse(localStorage.getItem('bookings')) || [];
            const booking = bookings.find(b => b.id === lastBookingId);

            if (!booking) {
                alert('Booking details not found for PDF generation. Please ensure you just completed a booking.');
                return;
            }

            // --- Check for Pending status - Prevents download until paid ---
            if (booking.status === 'pending') {
                alert('Ticket cannot be downloaded with PENDING status. Please complete your payment first.');
                return; // Stop the function if status is pending
            }
            // --- End of check ---

            const seatDisplay = booking.seatNumber ? `S${booking.seatNumber}` : 'Not Selected';

            // Set font for consistency
            doc.setFont('helvetica');

            // Header
            doc.setFontSize(22);
            doc.setTextColor(0, 45, 107); // Primary color
            doc.text("Prince Alex Travel Services", 105, 20, null, null, "center");

            doc.setFontSize(10);
            doc.text("Your journey, our priority.", 105, 27, null, null, "center");
            doc.line(20, 35, 190, 35); // Horizontal line

            // Booking Confirmation
            doc.setFontSize(18);
            doc.setTextColor(40, 167, 69); // Green success color
            doc.text("Booking Confirmation", 105, 45, null, null, "center");

            doc.setFontSize(12);
            doc.setTextColor(50, 50, 50); // Dark grey for details
            let y = 60;
            doc.text(`Booking ID: ${booking.id}`, 20, y); y += 10;

            // Passenger Details
            doc.setFontSize(14);
            doc.setTextColor(0, 45, 107);
            doc.text("Passenger Details:", 20, y);
            y += 7;
            doc.setFontSize(12);
            doc.setTextColor(50, 50, 50);
            doc.text(`Name: ${booking.passengerName}`, 20, y); y += 7;
            doc.text(`ID Number: ${booking.passengerID || 'N/A'}`, 20, y); y += 7;
            doc.text(`Gender: ${booking.passengerGender || 'N/A'}`, 20, y); y += 7;
            doc.text(`Phone: ${booking.passengerPhone || 'N/A'}`, 20, y); y += 7;
            doc.text(`Email: ${booking.passengerEmail || 'N/A'}`, 20, y); y += 15;

            // Trip Details
            doc.setFontSize(14);
            doc.setTextColor(0, 45, 107);
            doc.text("Trip Details:", 20, y);
            y += 7;
            doc.setFontSize(12);
            doc.setTextColor(50, 50, 50);
            doc.text(`Route: ${booking.busRoute}`, 20, y); y += 7;
            doc.text(`Travel Date: ${booking.travelDate}`, 20, y); y += 7;
            doc.text(`Departure Time: ${booking.busTime}`, 20, y); y += 7;
            doc.text(`Bus ID: ${booking.busId}`, 20, y); y += 7;
            doc.text(`Seat Number: ${seatDisplay}`, 20, y); y += 15;


            // Payment Summary
            doc.setFontSize(14);
            doc.setTextColor(0, 45, 107);
            doc.text("Payment Summary:", 20, y);
            y += 10;
            doc.setFontSize(12);
            doc.setTextColor(50, 50, 50);
            doc.text(`Amount: Ksh ${booking.price}`, 20, y); y += 7;
            doc.text(`Status: ${booking.status.toUpperCase()}`, 20, y);
            if (booking.status === 'pending') {
                doc.setTextColor(255, 193, 7); // Orange for pending
                doc.text(`(PENDING PAYMENT)`, 50, y);
            } else if (booking.status === 'paid') {
                doc.setTextColor(40, 167, 69); // Green for paid
                doc.text(`(PAID)`, 50, y);
            }
            doc.setTextColor(50, 50, 50); // Reset color

            if (booking.status === 'pending') { // This block for PDF content, even if download is blocked by JS
                y += 15;
                doc.setFontSize(10);
                doc.setTextColor(200, 0, 0); // Red
                doc.text("NOTE: This ticket is PENDING PAYMENT. Please proceed to make the payment before your travel date.", 20, y);
                doc.text("Show this ticket at the counter for payment verification.", 20, y + 5);
                doc.setTextColor(50, 50, 50); // Reset color
            }

            // QR Code (if available)
            const qrCodeDataUrl = document.getElementById('qrCodeImage').src;
            if (qrCodeDataUrl && qrCodeDataUrl !== window.location.href) { // Check if QR code is actually loaded
                y += 15;
                doc.setFontSize(14);
                doc.setTextColor(0, 45, 107);
                doc.text("Scan QR Code:", 20, y);
                y += 5;
                doc.addImage(qrCodeDataUrl, 'PNG', 20, y, 50, 50); // x, y, width, height
            }

            // Footer
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Booking Date: ${booking.bookingDate}`, 20, doc.internal.pageSize.height - 20);
            doc.text("Thank you for choosing Prince Alex Travel Services!", 105, doc.internal.pageSize.height - 10, null, null, "center");

            doc.save(`ticket-${booking.id}.pdf`);
        }

        function initiateSTKPush() {
            const lastBookingId = localStorage.getItem('lastBookingId');
            let bookings = JSON.parse(localStorage.getItem('bookings')) || []; // Use `let` to modify
            const bookingIndex = bookings.findIndex(b => b.id === lastBookingId);

            if (bookingIndex === -1) {
                alert('Booking details not found for payment.');
                return;
            }

            let booking = bookings[bookingIndex]; // Get the mutable booking object

            if (booking.status === 'paid') {
                alert('This booking has already been paid for.');
                return;
            }

            if (!booking.passengerPhone || !booking.price) {
                alert('Phone number or price missing for STK push. Cannot proceed. Please ensure your phone number and price are correctly saved with the booking.');
                return;
            }

            // Simulate STK Push
            const confirmPayment = confirm(`Initiating M-Pesa STK Push to ${booking.passengerPhone} for Ksh ${booking.price}. Please check your phone for the prompt. (Click OK to simulate successful payment)`);

            if (confirmPayment) {
                // Simulate successful payment: Update status to 'paid'
                booking.status = 'paid';
                bookings[bookingIndex] = booking; // Update the booking in the array
                localStorage.setItem('bookings', JSON.stringify(bookings));

                alert('Payment successful! Your booking status has been updated to PAID. You can now download your ticket.');
                // Refresh the page to reflect the updated status and enable download button
                window.location.reload();
            } else {
                alert('STK Push cancelled or failed. Please try again or contact support.');
            }
        }
    </script>
</body>
</html>