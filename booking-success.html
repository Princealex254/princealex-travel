<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Successful! - Prince Alex Travel Services</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script>
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Global variable to hold the current booking data fetched from Supabase
        let currentBookingData = null;
    </script>
    <style>
        :root {
            --primary-color: #002d6b;
            --accent-color: #c69214;
            --light-bg: #f5f7fa;
            --text-dark: #1a1a1a;
            --success-color: #28a745;
            --pending-color: #ffc107;
            --error-color: #dc3545;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Changed from 1vh to 100vh to ensure footer is at bottom */
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-brand img {
            height: 40px;
            border-radius: 5px;
        }

        .header-brand h1 {
            font-size: 24px;
            margin: 0;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            margin-left: 20px;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: var(--accent-color);
        }

        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .booking-summary-container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .booking-summary-container h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 2em;
        }

        .booking-summary-container .icon {
            color: var(--success-color);
            font-size: 4em;
            margin-bottom: 20px;
        }

        .booking-details p {
            margin: 10px 0;
            font-size: 1.1em;
            color: var(--text-dark);
        }

        .booking-details span {
            font-weight: bold;
            color: var(--primary-color);
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            color: white;
            margin-left: 10px;
        }

        .status-badge.paid {
            background-color: var(--success-color);
        }

        .status-badge.pending {
            background-color: var(--pending-color);
        }

        .actions {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .actions button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .actions button.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .actions button.primary:hover {
            background-color: #001f4e;
            transform: translateY(-2px);
        }

        .actions button.secondary {
            background-color: var(--accent-color);
            color: white;
        }

        .actions button.secondary:hover {
            background-color: #a3720f;
            transform: translateY(-2px);
        }

        .actions button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: var(--error-color);
            font-weight: bold;
            margin-top: 20px;
        }

        .footer {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            font-size: 0.9em;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .footer-content {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            padding: 0 20px;
        }

        .footer-section {
            margin: 10px 20px;
            min-width: 150px;
        }

        .footer-section h4 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .footer-section p, .footer-section a {
            color: white;
            text-decoration: none;
            display: block;
            margin-bottom: 5px;
        }

        .footer-section a:hover {
            text-decoration: underline;
        }

        .footer-bottom {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-brand">
            <img src="mylogo.png" alt="Prince Alex Digital Logo">
            <h1>Prince Alex Travel Services</h1>
        </div>
        <nav class="nav-links">
            <a href="Index.html">Home</a>
            <a href="about-us.html">About Us</a>
            <a href="ticket-lookup.html">Retrieve Ticket</a>
            <a href="login-register.html">Login/Register</a>
        </nav>
    </header>

    <main class="main-content">
        <div class="booking-summary-container">
            <h2 id="bookingTitle">Booking Successful!</h2>
            <i class="fas fa-check-circle icon"></i>
            <p>Your booking has been successfully recorded. Please find your details below:</p>

            <div id="bookingDetails" class="booking-details">
                <p>Booking Reference: <span id="bookingReference"></span></p>
                <p>Route: <span id="displayRoute"></span></p>
                <p>Time: <span id="displayTime"></span></p>
                <p>Travel Date: <span id="displayDate"></span></p>
                <p>Seat Number: <span id="displaySeat"></span></p>
                <p>Price: <span id="displayPrice"></span></p>
                <p>Passenger Name: <span id="displayName"></span></p>
                <p>Phone: <span id="displayPhone"></span></p>
                <p>Email: <span id="displayEmail"></span></p>
                <p>Status: <span id="statusBadge" class="status-badge"></span></p>
            </div>

            <div id="paymentInfo" class="payment-info">
                <p>A payment prompt will be sent to your phone. Please complete the payment to confirm your booking.</p>
            </div>

            <div class="actions">
                <button id="payNowBtn" class="primary" onclick="simulateSTKPush()">Pay Now</button>
                <button id="downloadTicketBtn" class="secondary" onclick="generatePDF()">Download Ticket</button>
                <a href="Index.html" class="primary" style="display: block; text-decoration: none; padding: 12px 25px; border-radius: 8px; font-size: 1.1em; background-color: var(--primary-color); color: white; margin-top: 10px;">Book Another Ticket</a>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <div class="footer-section" id="contact-us">
                    <p>Email: senerwaalex@gmail.com</p>
                    <p>Phone: +254 717 384 875</p>
                    <p>Location: Nairobi, Kenya</p>
                </div>
            </div>
            <div class="footer-section">
                <h4>Follow Us</h4>
                <a href="#">Facebook</a>
                <a href="#">Instagram</a>
                <a href="#">Twitter</a>
            </div>
        </div>
        <div class="footer-bottom">
            &copy; 2025 Prince Alex Digital. All rights reserved.
        </div>
    </footer>

    <script>
        // Supabase Initialization
        const SUPABASE_URL = 'https://numnzxrnrlxvkjwlusbe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51bW56eHJucmx4dmtqd2x1c2JlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMTgxNzgsImV4cCI6MjA2Njc5NDEzOH0.03mPw9Y7tuWne5SNpsag7lYhQSZ6HqA8YmDSxVMVMFg';
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentBookingData = null; // Global variable to hold the current booking data

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('bookingId');

            const bookingDetailsDiv = document.getElementById('bookingDetails');
            const paymentInfoDiv = document.getElementById('paymentInfo');
            const bookingReferenceSpan = document.getElementById('bookingReference');
            const statusBadgeSpan = document.getElementById('statusBadge');
            const downloadTicketBtn = document.getElementById('downloadTicketBtn');
            const payNowBtn = document.getElementById('payNowBtn');
            const bookingTitle = document.getElementById('bookingTitle');

            if (!bookingId) {
                bookingDetailsDiv.innerHTML = '<p class="error-message">Booking ID not found in URL. Please go back to the home page and try again.</p>';
                paymentInfoDiv.style.display = 'none';
                downloadTicketBtn.style.display = 'none';
                payNowBtn.style.display = 'none';
                bookingTitle.textContent = 'Booking Not Found';
                return;
            }

            try {
                // Fetch booking data from Supabase
                const { data, error } = await supabase
                    .from('bookings')
                    .select('*')
                    .eq('id', bookingId)
                    .single();

                if (error || !data) {
                    console.error("Error fetching booking details:", error ? error.message : "No data found.");
                    bookingDetailsDiv.innerHTML = '<p class="error-message">Booking not found or an error occurred. Please check your Booking ID or try again.</p>';
                    paymentInfoDiv.style.display = 'none';
                    downloadTicketBtn.style.display = 'none';
                    payNowBtn.style.display = 'none';
                    bookingTitle.textContent = 'Booking Not Found';
                    return;
                }

                currentBookingData = data; // Store the fetched booking for other functions

                // Update booking details display
                bookingReferenceSpan.textContent = currentBookingData.id;
                document.getElementById('displayRoute').textContent = `${currentBookingData.bus_route}`;
                document.getElementById('displayTime').textContent = `${currentBookingData.bus_time}`;
                document.getElementById('displayDate').textContent = `${currentBookingData.travel_date}`;
                document.getElementById('displaySeat').textContent = `${currentBookingData.seat_number}`;
                document.getElementById('displayPrice').textContent = `Ksh ${currentBookingData.price.toFixed(2)}`;
                document.getElementById('displayName').textContent = `${currentBookingData.passenger_name}`;
                document.getElementById('displayPhone').textContent = `${currentBookingData.passenger_phone}`;
                document.getElementById('displayEmail').textContent = `${currentBookingData.passenger_email || 'N/A'}`;

                // Update status badge and button visibility
                statusBadgeSpan.textContent = currentBookingData.status.toUpperCase();
                statusBadgeSpan.className = 'status-badge'; // Reset classes
                if (currentBookingData.status === 'paid') {
                    statusBadgeSpan.classList.add('paid');
                    payNowBtn.style.display = 'none';
                    downloadTicketBtn.style.display = 'block';
                    paymentInfoDiv.style.display = 'none'; // Hide payment info if already paid
                    bookingTitle.textContent = 'Booking Confirmed!';
                    document.querySelector('.booking-summary-container .icon').style.color = 'var(--success-color)';
                } else if (currentBookingData.status === 'pending') {
                    statusBadgeSpan.classList.add('pending');
                    payNowBtn.style.display = 'block';
                    downloadTicketBtn.style.display = 'none';
                    paymentInfoDiv.style.display = 'block'; // Show payment info if pending
                    bookingTitle.textContent = 'Payment Pending';
                    document.querySelector('.booking-summary-container .icon').style.color = 'var(--pending-color)'; // Change icon color for pending
                } else { // e.g., 'cancelled'
                    statusBadgeSpan.classList.add('error'); // Use error style for cancelled
                    payNowBtn.style.display = 'none';
                    downloadTicketBtn.style.display = 'none';
                    paymentInfoDiv.style.display = 'none';
                    bookingTitle.textContent = 'Booking Status: ' + currentBookingData.status.toUpperCase();
                    document.querySelector('.booking-summary-container .icon').style.color = 'var(--error-color)'; // Change icon color for error
                }

            } catch (error) {
                console.error("An unexpected error occurred during booking data fetch:", error);
                bookingDetailsDiv.innerHTML = '<p class="error-message">An unexpected error occurred. Please try again later.</p>';
                paymentInfoDiv.style.display = 'none';
                downloadTicketBtn.style.display = 'none';
                payNowBtn.style.display = 'none';
                bookingTitle.textContent = 'Error';
            }
        });

        async function simulateSTKPush() {
            if (!currentBookingData) {
                showCustomAlert('Booking data not loaded. Please refresh the page.');
                return;
            }

            if (currentBookingData.status === 'paid') {
                showCustomAlert('This booking has already been paid for.');
                return;
            }

            if (!currentBookingData.passenger_phone || !currentBookingData.price) {
                showCustomAlert('Phone number or price missing for STK push. Cannot proceed. Please ensure your phone number and price are correctly saved with the booking.');
                return;
            }

            const confirmPayment = await showCustomConfirm(`Initiating M-Pesa STK Push to ${currentBookingData.passenger_phone} for Ksh ${currentBookingData.price.toFixed(2)}. Please check your phone for the prompt. (Click OK to simulate successful payment)`);

            if (confirmPayment) {
                try {
                    // Update booking status to 'paid' in Supabase
                    const { error } = await supabase
                        .from('bookings')
                        .update({
                            status: 'paid',
                            last_updated: new Date().toISOString()
                        })
                        .eq('id', currentBookingData.id);

                    if (error) {
                        console.error("Error updating booking status:", error.message);
                        showCustomAlert('Payment simulation failed: Could not update booking status. Please contact support.');
                        return;
                    }

                    showCustomAlert('Payment successful! Your booking status has been updated to PAID. You can now download your ticket.');
                    window.location.reload(); // Refresh to reflect updated status and enable download
                } catch (error) {
                    console.error("An unexpected error occurred during payment update:", error);
                    showCustomAlert('An unexpected error occurred during payment. Please try again or contact support.');
                }
            } else {
                showCustomAlert('STK Push cancelled or failed. Please try again or contact support.');
            }
        }

        async function generatePDF() {
            if (!currentBookingData) {
                showCustomAlert('Booking data not loaded. Please refresh the page.');
                return;
            }

            if (currentBookingData.status !== 'paid') {
                showCustomAlert('Ticket can only be downloaded after payment is confirmed.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let y = 20;
            const lineHeight = 7;
            const leftMargin = 20;

            // Define colors (matching CSS variables, directly from the CSS in the HTML)
            const primaryColor = '#002d6b';
            const accentColor = '#c69214';
            const darkTextColor = '#1a1a1a';
            const secondaryTextColor = '#555';


            // --- 1. Header with Logo and QR Code ---
            // Add Logo
            const img = new Image();
            img.src = 'mylogo.png'; // Ensure this path is correct
            await new Promise((resolve, reject) => {
                img.onload = () => resolve();
                img.onerror = () => {
                    console.error("Error loading logo image: mylogo.png. Please ensure the file exists and the path is correct.");
                    // Optionally, you can add a fallback or skip adding the image
                    resolve(); // Resolve even on error to allow PDF generation to continue
                };
            });
            if (img.complete && img.naturalWidth !== 0) { // Check if image loaded successfully
                doc.addImage(img, 'PNG', 15, y, 40, 40); // x, y, width, height
            } else {
                console.warn("Logo image not loaded, skipping addition to PDF.");
            }


            // Title
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(primaryColor);
            doc.text("Prince Alex Travel Services", 60, y + 15);
            doc.setFontSize(14);
            doc.setFont("helvetica", "normal");
            doc.text("E-Ticket & Booking Confirmation", 60, y + 25);

            // Generate QR Code
            const qrCodeData = currentBookingData.id; // Data to encode in QR code
            const qrCodeSize = 50; // Size of the QR code image

            // Create a temporary div to render the QR code
            const qrCodeDiv = document.createElement('div');
            qrCodeDiv.style.display = 'none'; // Keep it hidden
            document.body.appendChild(qrCodeDiv);

            let qrCodeImgData = '';
            try {
                new QRCode(qrCodeDiv, {
                    text: qrCodeData,
                    width: qrCodeSize,
                    height: qrCodeSize,
                    colorDark : primaryColor, // Use company color for QR code
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });

                // Wait a tiny bit for QR code to render to canvas/img
                await new Promise(resolve => setTimeout(resolve, 50));
                qrCodeImgData = qrCodeDiv.querySelector('canvas').toDataURL("image/png");

            } catch (qrError) {
                console.error("Error generating QR code:", qrError);
            } finally {
                // Clean up the temporary div
                document.body.removeChild(qrCodeDiv);
            }

            if (qrCodeImgData) {
                 doc.addImage(qrCodeImgData, 'PNG', 160, y, 40, 40); // x, y, width, height
            } else {
                console.warn("QR Code image data not generated, skipping addition to PDF.");
            }


            y += 55; // Move Y position down after header content

            // --- Drawing the main ticket body container ---
            doc.setDrawColor(primaryColor);
            doc.setLineWidth(1.5);
            doc.line(10, y, 200, y); // Horizontal line below header

            y += 10; // Space after line

            // --- 2. Booking Reference (Prominent) ---
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(accentColor);
            doc.text(`Booking Reference: ${currentBookingData.id}`, 20, y);
            y += 15;

            // --- 3. Passenger Details Section ---
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(primaryColor);
            doc.text("Passenger Details:", 20, y);
            y += 8;
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(darkTextColor);
            doc.text(`Name: ${currentBookingData.passenger_name}`, 20, y); y += lineHeight;
            doc.text(`Phone: ${currentBookingData.passenger_phone}`, 20, y); y += lineHeight;
            doc.text(`Email: ${currentBookingData.passenger_email || 'N/A'}`, 20, y); y += 12;

            // --- 4. Journey Details Section ---
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(primaryColor);
            doc.text("Journey Details:", 20, y);
            y += 8;
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(darkTextColor);
            doc.text(`Route: ${currentBookingData.bus_route}`, 20, y); y += lineHeight;
            doc.text(`Travel Date: ${currentBookingData.travel_date}`, 20, y); y += lineHeight;
            doc.text(`Departure Time: ${currentBookingData.bus_time}`, 20, y); y += lineHeight;
            doc.text(`Bus ID: ${currentBookingData.bus_id || 'N/A'}`, 20, y); y += lineHeight;
            doc.text(`Seat Number: ${currentBookingData.seat_number}`, 20, y); y += 12;

            // --- 5. Payment Summary Section ---
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(primaryColor);
            doc.text("Payment Summary:", 20, y);
            y += 8;
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(darkTextColor);
            doc.text(`Amount: Ksh ${currentBookingData.price.toFixed(2)}`, 20, y); y += lineHeight;
            doc.text(`Payment Status: ${currentBookingData.status.toUpperCase()}`, 20, y); y += 12;
            doc.text(`Booking Date: ${new Date(currentBookingData.booking_date).toLocaleDateString()}`, 20, y); y += 12;

            // --- 6. Special Note for PENDING Status ---
            if (currentBookingData.status.toUpperCase() === 'PENDING') {
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(200, 0, 0); // Red color for warning
                doc.text("NOTE: This ticket is PENDING PAYMENT. Please complete payment to validate.", 20, y);
                y += 5;
                doc.text("Contact support for assistance: +254 717 384 875", 20, y);
                doc.setTextColor(darkTextColor); // Reset color
                y += 15;
            }

            // --- 7. Footer ---
            y = doc.internal.pageSize.height - 25; // Position footer from bottom
            doc.setDrawColor(primaryColor);
            doc.setLineWidth(0.5);
            doc.line(10, y, 200, y); // Horizontal line above footer
            y += 5;

            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(darkTextColor);
            doc.text("Prince Alex Travel Services | Email: senerwaalex@gmail.com | Phone: +254 717 384 875", doc.internal.pageSize.width / 2, y, { align: "center" });
            y += 5;
            doc.text("© 2025 Prince Alex Digital. All rights reserved.", doc.internal.pageSize.width / 2, y, { align: "center" });


            doc.save(`ticket-${currentBookingData.id}.pdf`);
        }

        // Custom Alert/Confirm Modals (replaces browser's alert/confirm)
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.7); display: flex; justify-content: center;
                align-items: center; z-index: 1001;
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 25px; border-radius: 8px; text-align: center; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                    <p style="margin-bottom: 20px; font-size: 1.1em;">${message}</p>
                    <button style="background-color: var(--primary-color); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;" onclick="this.parentNode.parentNode.remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showCustomConfirm(message) {
            return new Promise(resolve => {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background-color: rgba(0,0,0,0.7); display: flex; justify-content: center;
                    align-items: center; z-index: 1001;
                `;
                modal.innerHTML = `
                    <div style="background: white; padding: 25px; border-radius: 8px; text-align: center; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                        <p style="margin-bottom: 20px; font-size: 1.1em;">${message}</p>
                        <button id="confirmYes" style="background-color: var(--success-color); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">Yes</button>
                        <button id="confirmNo" style="background-color: var(--error-color); color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">No</button>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('confirmYes').onclick = () => {
                    modal.remove();
                    resolve(true);
                };
                document.getElementById('confirmNo').onclick = () => {
                    modal.remove();
                    resolve(false);
                };
            });
        }
    </script>
</body>
</html>
