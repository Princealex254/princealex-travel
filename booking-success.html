<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Successful! - Prince Alex Travel Services</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://numnzxrnrlxvkjwlusbe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51bW56eHJucmx4dmtqd2x1c2JlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMTgxNzgsImV4cCI6MjA2Njc5NDQ1OH0.03mPw9Y7tuWne5SNpsag7lYhQSZ6HqA8YmDSxVMVMFg';

        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variable to hold the current booking data fetched from Supabase
        let currentBookingData = null;
    </script>
    <style>
        :root {
            --primary-color: #002d6b;
            --accent-color: #c69214;
            --light-bg: #f5f7fa;
            --text-dark: #1a1a1a;
            --success-color: #28a745;
            --pending-color: #ffc107;
            --error-color: #dc3545;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-brand img {
            height: 40px;
            border-radius: 5px;
        }

        .header-brand h1 {
            font-size: 24px;
            margin: 0;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            margin-left: 20px;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: var(--accent-color);
        }

        .main-content {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .booking-summary-container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 600px;
            width: 100%;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .booking-summary-container h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 2em;
        }

        .booking-summary-container .icon {
            color: var(--success-color);
            font-size: 4em;
            margin-bottom: 20px;
        }

        .booking-details p {
            margin: 10px 0;
            font-size: 1.1em;
            color: var(--text-dark);
        }

        .booking-details span {
            font-weight: bold;
            color: var(--primary-color);
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            color: white;
            margin-left: 10px;
        }

        .status-badge.paid {
            background-color: var(--success-color);
        }

        .status-badge.pending {
            background-color: var(--pending-color);
        }

        .actions {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .actions button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .actions button.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .actions button.primary:hover {
            background-color: #001f4e;
            transform: translateY(-2px);
        }

        .actions button.secondary {
            background-color: var(--accent-color);
            color: white;
        }

        .actions button.secondary:hover {
            background-color: #a3720f;
            transform: translateY(-2px);
        }

        .actions button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .error-message {
            color: var(--error-color);
            font-weight: bold;
            margin-top: 20px;
        }

        .footer {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            font-size: 0.9em;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        .footer-content {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            padding: 0 20px;
        }

        .footer-section {
            margin: 10px 20px;
            min-width: 150px;
        }

        .footer-section h4 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .footer-section p, .footer-section a {
            color: white;
            text-decoration: none;
            display: block;
            margin-bottom: 5px;
        }

        .footer-section a:hover {
            text-decoration: underline;
        }

        .footer-bottom {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-brand">
            <img src="images/logo.png" alt="Prince Alex Digital Logo">
            <h1>Prince Alex Travel Services</h1>
        </div>
        <nav class="nav-links">
            <a href="Index.html">Home</a>
            <a href="about-us.html">About Us</a>
            <a href="ticket-lookup.html">Retrieve Ticket</a>
            <a href="login-register.html">Login/Register</a>
        </nav>
    </header>

    <main class="main-content">
        <div class="booking-summary-container">
            <h2 id="bookingTitle">Booking Successful!</h2>
            <i class="fas fa-check-circle icon"></i>
            <p>Your booking has been successfully recorded. Please find your details below:</p>

            <div id="bookingDetails" class="booking-details">
                <p>Booking Reference: <span id="bookingReference"></span></p>
                <p>Route: <span id="displayRoute"></span></p>
                <p>Time: <span id="displayTime"></span></p>
                <p>Travel Date: <span id="displayDate"></span></p>
                <p>Seat Number: <span id="displaySeat"></span></p>
                <p>Price: <span id="displayPrice"></span></p>
                <p>Passenger Name: <span id="displayName"></span></p>
                <p>Phone: <span id="displayPhone"></span></p>
                <p>Email: <span id="displayEmail"></span></p>
                <p>Status: <span id="statusBadge" class="status-badge"></span></p>
            </div>

            <div id="paymentInfo" class="payment-info">
                <p>A payment prompt will be sent to your phone. Please complete the payment to confirm your booking.</p>
            </div>

            <div class="actions">
                <button id="payNowBtn" class="primary" onclick="simulateSTKPush()">Pay Now</button>
                <button id="downloadTicketBtn" class="secondary" onclick="generatePDF()">Download Ticket</button>
                <a href="Index.html" class="primary" style="display: block; text-decoration: none; padding: 12px 25px; border-radius: 8px; font-size: 1.1em; background-color: var(--primary-color); color: white; margin-top: 10px;">Book Another Ticket</a>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <div class="footer-section" id="contact-us">
                    <p>Email: senerwaalex@gmail.com</p>
                    <p>Phone: +254 717 384 875</p>
                    <p>Location: Nairobi, Kenya</p>
                </div>
            </div>
            <div class="footer-section">
                <h4>Follow Us</h4>
                <a href="#">Facebook</a>
                <a href="#">Instagram</a>
                <a href="#">Twitter</a>
            </div>
        </div>
        <div class="footer-bottom">
            &copy; 2025 Prince Alex Digital. All rights reserved.
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const bookingId = urlParams.get('bookingId');

            const bookingDetailsDiv = document.getElementById('bookingDetails');
            const paymentInfoDiv = document.getElementById('paymentInfo');
            const bookingReferenceSpan = document.getElementById('bookingReference');
            const statusBadgeSpan = document.getElementById('statusBadge');
            const downloadTicketBtn = document.getElementById('downloadTicketBtn');
            const payNowBtn = document.getElementById('payNowBtn');
            const bookingTitle = document.getElementById('bookingTitle');

            if (!bookingId) {
                bookingDetailsDiv.innerHTML = '<p class="error-message">Booking ID not found in URL. Please go back to the home page and try again.</p>';
                paymentInfoDiv.style.display = 'none';
                downloadTicketBtn.style.display = 'none';
                payNowBtn.style.display = 'none';
                bookingTitle.textContent = 'Booking Not Found';
                return;
            }

            try {
                const { data: booking, error } = await supabase
                    .from('bookings')
                    .select('*')
                    .eq('id', bookingId)
                    .single();

                if (error || !booking) {
                    console.error('Error fetching booking:', error ? error.message : 'Booking not found.');
                    bookingDetailsDiv.innerHTML = '<p class="error-message">Failed to retrieve booking details. Please check your reference or contact support.</p>';
                    paymentInfoDiv.style.display = 'none';
                    downloadTicketBtn.style.display = 'none';
                    payNowBtn.style.display = 'none';
                    bookingTitle.textContent = 'Booking Not Found';
                    return;
                }

                currentBookingData = booking; // Store the fetched booking for other functions

                // Update booking details display
                bookingReferenceSpan.textContent = currentBookingData.id;
                document.getElementById('displayRoute').textContent = `${currentBookingData.busRoute}`;
                document.getElementById('displayTime').textContent = `${currentBookingData.busTime}`;
                document.getElementById('displayDate').textContent = `${currentBookingData.travelDate}`;
                document.getElementById('displaySeat').textContent = `${currentBookingData.seatNumber}`;
                document.getElementById('displayPrice').textContent = `Ksh ${currentBookingData.price}`;
                document.getElementById('displayName').textContent = `${currentBookingData.passengerName}`;
                document.getElementById('displayPhone').textContent = `${currentBookingData.passengerPhone}`;
                document.getElementById('displayEmail').textContent = `${currentBookingData.passengerEmail}`;

                // Update status badge
                statusBadgeSpan.textContent = currentBookingData.status.toUpperCase();
                statusBadgeSpan.className = 'status-badge';
                if (currentBookingData.status === 'paid') {
                    statusBadgeSpan.classList.add('paid');
                    payNowBtn.style.display = 'none';
                    downloadTicketBtn.style.display = 'block';
                    paymentInfoDiv.style.display = 'none'; // Hide payment info if already paid
                } else {
                    statusBadgeSpan.classList.add('pending');
                    payNowBtn.style.display = 'block';
                    downloadTicketBtn.style.display = 'none';
                    paymentInfoDiv.style.display = 'block'; // Show payment info if pending
                }

            } catch (err) {
                console.error('An unexpected error occurred:', err.message);
                bookingDetailsDiv.innerHTML = '<p class="error-message">An unexpected error occurred while loading booking details.</p>';
                paymentInfoDiv.style.display = 'none';
                downloadTicketBtn.style.display = 'none';
                payNowBtn.style.display = 'none';
                bookingTitle.textContent = 'Error';
            }
        });

        async function simulateSTKPush() {
            if (!currentBookingData) {
                alert('Booking data not loaded. Please refresh the page.');
                return;
            }

            if (currentBookingData.status === 'paid') {
                alert('This booking has already been paid for.');
                return;
            }

            if (!currentBookingData.passengerPhone || !currentBookingData.price) {
                alert('Phone number or price missing for STK push. Cannot proceed. Please ensure your phone number and price are correctly saved with the booking.');
                return;
            }

            const confirmPayment = confirm(`Initiating M-Pesa STK Push to ${currentBookingData.passengerPhone} for Ksh ${currentBookingData.price}. Please check your phone for the prompt. (Click OK to simulate successful payment)`);

            if (confirmPayment) {
                try {
                    // Simulate successful payment: Update status to 'paid' in Supabase
                    const { data, error } = await supabase
                        .from('bookings')
                        .update({ status: 'paid' })
                        .eq('id', currentBookingData.id)
                        .select();

                    if (error) {
                        console.error('Error updating booking status:', error.message);
                        alert('Failed to update booking status: ' + error.message);
                        return;
                    }

                    console.log('Booking status updated successfully:', data);
                    alert('Payment successful! Your booking status has been updated to PAID. You can now download your ticket.');
                    window.location.reload(); // Refresh to reflect updated status and enable download
                } catch (err) {
                    console.error('An unexpected error occurred during payment update:', err.message);
                    alert('An unexpected error occurred during payment simulation.');
                }
            } else {
                alert('STK Push cancelled or failed. Please try again or contact support.');
            }
        }

        function generatePDF() {
            if (!currentBookingData) {
                alert('Booking data not loaded. Please refresh the page.');
                return;
            }

            if (currentBookingData.status !== 'paid') {
                alert('Ticket can only be downloaded after payment is confirmed.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let y = 20;
            const lineHeight = 7;

            doc.setFontSize(22);
            doc.text("Prince Alex Travel Services - E-Ticket", 20, y);
            y += 15;

            doc.setFontSize(16);
            doc.text("Booking Confirmation", 20, y);
            y += 10;

            doc.setFontSize(12);
            doc.text(`Booking Reference: ${currentBookingData.id}`, 20, y); y += lineHeight;
            doc.text(`Status: ${currentBookingData.status.toUpperCase()}`, 20, y); y += lineHeight;
            doc.text(`Booking Date: ${currentBookingData.bookingDate}`, 20, y); y += 15;

            doc.setFontSize(14);
            doc.text("Passenger Details:", 20, y);
            y += 10;
            doc.setFontSize(12);
            doc.text(`Name: ${currentBookingData.passengerName}`, 20, y); y += lineHeight;
            doc.text(`ID/Passport: ${currentBookingData.passengerID}`, 20, y); y += lineHeight;
            doc.text(`Gender: ${currentBookingData.passengerGender}`, 20, y); y += lineHeight;
            doc.text(`Phone: ${currentBookingData.passengerPhone}`, 20, y); y += lineHeight;
            doc.text(`Email: ${currentBookingData.passengerEmail}`, 20, y); y += 15;

            doc.setFontSize(14);
            doc.text("Journey Details:", 20, y);
            y += 10;
            doc.setFontSize(12);
            doc.text(`Route: ${currentBookingData.busRoute}`, 20, y); y += lineHeight;
            doc.text(`Travel Date: ${currentBookingData.travelDate}`, 20, y); y += lineHeight;
            doc.text(`Departure Time: ${currentBookingData.busTime}`, 20, y); y += lineHeight;
            doc.text(`Bus ID: ${currentBookingData.busId}`, 20, y); y += lineHeight;
            doc.text(`Seat Number: ${currentBookingData.seatNumber}`, 20, y); y += 15;

            doc.setFontSize(14);
            doc.text("Payment Summary:", 20, y);
            y += 10;
            doc.setFontSize(12);
            doc.text(`Amount: Ksh ${currentBookingData.price}`, 20, y); y += lineHeight;
            doc.text(`Payment Status: ${currentBookingData.status.toUpperCase()}`, 20, y); y += 15;

            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text("Thank you for choosing Prince Alex Travel Services!", 20, y);
            doc.text("For support, contact senerwaalex@gmail.com or +254 717 384 875", 20, y + 5);

            doc.save(`ticket-${currentBookingData.id}.pdf`);
        }
    </script>
</body>
</html>
