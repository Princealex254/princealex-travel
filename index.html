<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Prince Alex Travel Services</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, increment, onSnapshot, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGErPBeQ1Fdx9EHPXOHepoEoOx7P2f57o",
            authDomain: "princealextravel.firebaseapp.com",
            projectId: "princealextravel",
            storageBucket: "princealextravel.firebasestorage.app",
            messagingSenderId: "947577729462",
            appId: "1:947577729462:web:dd4b4c7cb4a984c5e3d117"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase instances and functions globally accessible
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOutFirebase = signOut; // Renamed to avoid conflict with window.signOut
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.addDoc = addDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.increment = increment;
        window.onSnapshot = onSnapshot;
        window.getDoc = getDoc;
        window.serverTimestamp = serverTimestamp; // Expose serverTimestamp as well

        // Global variable for current user, populated by onAuthStateChanged
        window.currentUser = null;
        window.currentUserProfile = null; // To store additional profile data

        // Listen for authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                window.currentUser = user;
                // Fetch user profile from Firestore
                const userProfileRef = doc(db, "users", user.uid);
                const userProfileSnap = await getDoc(userProfileRef);
                if (userProfileSnap.exists()) {
                    window.currentUserProfile = userProfileSnap.data();
                } else {
                    console.log("No user profile found in Firestore for:", user.uid);
                    window.currentUserProfile = {
                        fullName: user.email, // Fallback if no profile
                        email: user.email
                    };
                }
            } else {
                // User is signed out
                window.currentUser = null;
                window.currentUserProfile = null;
            }
            updateAuthLinks(); // Update navigation links based on auth state
        });
    </script>
    <style>
        /* Modern CSS Variables for Enhanced Design */
        :root {
            --primary-color: #1e3a8a; /* Modern deep blue */
            --primary-light: #3b82f6; /* Lighter blue for accents */
            --accent-color: #f59e0b; /* Modern amber/gold */
            --accent-light: #fbbf24; /* Light amber */
            --light-bg: #f8fafc; /* Clean light background */
            --white: #ffffff;
            --text-dark: #1e293b; /* Modern dark text */
            --text-light: #64748b; /* Light text */
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            --gradient-accent: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-light) 100%);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Use: Resets default browser margins/ paddings and sets box model for consistent sizing. */
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
            scroll-behavior: smooth;
            /* Use: Sets global font, background, and text color. */
        }
        .navbar {
            background: var(--gradient-primary);
            padding: 1rem 0;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            /* Modern sticky navbar with gradient background */
        }
        .navbar-container {
            max-width: 1200px;
            margin: auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Use: Centers and arranges navigation elements horizontally within the navbar. */
        }
        .logo {
            background: var(--white);
            padding: 0.75rem 1rem;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            /* Modern logo container with enhanced styling */
        }
        .logo:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .logo img {
            height: 60px;
            display: block;
            /* Optimized logo size */
        }
        .nav-links {
            display: flex;
            gap: 25px;
            /* Use: Arranges navigation links horizontally with spacing. */
        }
        .nav-links a {
            color: var(--white);
            text-decoration: none;
            font-weight: 500;
            font-size: 1rem;
            position: relative;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            /* Modern navigation links with enhanced styling */
        }
        .nav-links a::after {
            content: '';
            display: block;
            width: 0;
            height: 2px;
            background: var(--accent-color);
            transition: width 0.3s ease;
            position: absolute;
            bottom: 0.25rem;
            left: 50%;
            transform: translateX(-50%);
            /* Centered animated underline */
        }
        .nav-links a:hover::after {
            width: 80%;
            /* Expands the underline width on hover */
        }
        .nav-links a:hover {
            color: var(--accent-color);
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
            /* Enhanced hover effect with background and lift */
        }

        /* Hamburger Menu Icon */
        .menu-toggle {
            display: none;
            flex-direction: column;
            justify-content: space-around;
            width: 30px;
            height: 25px;
            cursor: pointer;
            z-index: 10001;
            background: none;
            border: none;
            padding: 0;
        }

        .menu-toggle .bar {
            width: 100%;
            height: 3px;
            background-color: white;
            border-radius: 5px;
            transition: all 0.3s ease;
            transform-origin: center;
        }

        /* Animation for hamburger to close icon */
        .menu-toggle.open .bar:nth-child(1) {
            transform: translateY(11px) rotate(45deg);
        }
        .menu-toggle.open .bar:nth-child(2) {
            opacity: 0;
        }
        .menu-toggle.open .bar:nth-child(3) {
            transform: translateY(-11px) rotate(-45deg);
        }

        /* Background Dim Overlay */
        body.menu-open::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 9998;
            transition: opacity 0.3s ease;
            opacity: 1;
            pointer-events: auto;
        }

        /* Mobile Navigation Overlay */
        /* This class will be applied to the .nav-links element on mobile */
        @media (max-width: 768px) {
            .nav-links { /* Target the .nav-links directly for mobile styles */
                flex-direction: column;
                position: fixed;
                top: 0;
                right: 0;
                width: 70%; /* Adjust as needed */
                height: 100%;
                background: var(--gradient-primary); /* Same gradient as about-us.html */
                padding-top: 100px; /* Space for logo/header */
                box-shadow: -2px 0 20px rgba(0,0,0,0.3); /* Stronger shadow for better visibility */
                transition: transform 0.4s ease, opacity 0.4s ease;
                z-index: 10000;
                opacity: 0; /* Initially hidden */
                pointer-events: none; /* Disable interaction when hidden */
                display: flex; /* Keep it as flex for transitions, but visually hidden */
                backdrop-filter: blur(8px); /* Reduced blur for clarity */
                transform: translateX(100%); /* Start off-screen */
            }

            .nav-links.open { /* This class will be toggled by JS */
                transform: translateX(0); /* Slide in smoothly */
                opacity: 1; /* Make visible */
                pointer-events: auto; /* Enable interaction */
            }

            .nav-links a {
                padding: 15px 20px;
                border-bottom: 1px solid rgba(255,255,255,0.2); /* More visible border */
                text-align: left;
                width: 100%;
                font-size: 1.1em;
                color: var(--white); /* Ensure white text */
                font-weight: 600; /* Make text bolder */
            }
            .nav-links a:last-child {
                border-bottom: none;
            }
            .nav-links a:hover {
                background-color: rgba(255,255,255,0.1); /* Add hover background */
                color: var(--accent-light);
            }
        }


        .hero {
            background: var(--gradient-primary);
            color: var(--white);
            padding: 6rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            /* Modern hero section with enhanced styling */
        }
        .hero::after {
            content: '';
            position: absolute;
            bottom: 5%; /* Lift the image slightly from the bottom */
            left: 0;
            width: 100%;
            height: 100%;
            /* Use multiple backgrounds to display both buses */
            background-image: url('Bus2.png'), url('Bus1.png');
            background-size: 65%, 80%; /* Size for Bus2, then Bus1 */
            background-repeat: no-repeat, no-repeat;
            /* Position Bus2 to the bottom-left and Bus1 to the bottom-right */
            background-position: bottom -5% left -10%, bottom 5% right -5%;
            opacity: 0.2; /* Slightly increase opacity for better visibility */
            z-index: 0; /* Behind the content, above the background */
            pointer-events: none; /* Make it non-interactive */
            /* The transform is no longer needed as we position each bus individually */
            /* transform: translateX(5%); */
            /* Add a mask to blend the image edges seamlessly with the background */
            -webkit-mask-image: linear-gradient(to top, black 75%, transparent 100%);
            mask-image: linear-gradient(to top, black 75%, transparent 100%);
        }
        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
            animation: float 6s ease-in-out infinite;
        }

        .hero-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .hero-waves {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 120' preserveAspectRatio='none'%3E%3Cpath d='M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z' fill='rgba(255,255,255,0.1)' fill-opacity='0.3'/%3E%3C/svg%3E") repeat-x;
            animation: wave 20s linear infinite;
        }

        @keyframes wave {
            0% { transform: translateX(0); }
            100% { transform: translateX(-1200px); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 800px;
            margin: 0 auto;
        }

        .hero-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .cta-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .cta-button.primary {
            background: var(--accent-color);
            color: var(--white);
            box-shadow: 0 4px 15px rgba(245, 209, 4, 0.3);
        }

        .cta-button.primary:hover {
            background: #d4b800;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 209, 4, 0.4);
        }

        .cta-button.secondary {
            background: transparent;
            color: var(--white);
            border: 2px solid var(--white);
        }

        .cta-button.secondary:hover {
            background: var(--white);
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        .cta-button i {
            font-size: 1.2rem;
        }
        .hero h1 {
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            font-weight: 700;
            margin-bottom: 1.5rem;
            line-height: 1.2;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            /* Enhanced main heading */
        }
        .hero h2 {
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            font-weight: 400;
            margin-bottom: 1rem;
            color: var(--accent-light);
            /* Subtitle styling */
        }
        .hero p {
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            opacity: 0.95;
            line-height: 1.6;
            margin-bottom: 2rem;
            /* Enhanced paragraph text */
        }
        .booking {
            background: var(--white);
            padding: 4rem 2rem;
            text-align: center;
            position: relative;
            /* Modern booking section */
        }
        .booking-container {
            max-width: 1000px;
            margin: auto;
            /* Centers the content within the booking section */
        }
        .booking h2 {
            margin-bottom: 2rem;
            color: var(--primary-color);
            font-size: 2.5rem;
            font-weight: 700;
            /* Enhanced booking heading */
        }
        .booking-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--light-bg);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            /* Modern grid-based form layout */
        }
        .payment-methods {
            text-align: center;
            padding-top: 2rem; /* Add space above */
            padding-bottom: 2rem; /* Add space below */
        }
        .payment-methods p {
            color: var(--text-light);
            margin-bottom: 1rem;
            font-weight: 500;
        }
        .payment-logos {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .payment-logo {
            background: var(--white);
            padding: 0.5rem 1.2rem;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            height: 45px;
            font-weight: bold;
            transition: all 0.3s ease;
            font-family: 'Segoe UI', sans-serif;
        }
        .payment-logo:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        .payment-logo i {
            font-size: 2.5rem;
            color: var(--primary-color);
        }
        .payment-logo.mpesa { color: #4CAF50; }
        .payment-logo.airtel { color: #e40000; }
        .payment-logo.visa { color: #1A1F71; }
        .payment-logo.mastercard { color: #EB001B; }
        .form-group {
            display: flex;
            flex-direction: column;
            text-align: left;
        }
        .form-group label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .booking-form select,
        .booking-form input[type="date"] {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--white);
            transition: all 0.3s ease;
            /* Modern form inputs */
        }
        .booking-form select:focus,
        .booking-form input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            /* Focus states for form inputs */
        }
        .booking-form button[type="submit"] {
            background: var(--gradient-accent);
            color: var(--white);
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            grid-column: 1 / -1;
            margin-top: 1rem;
            /* Modern submit button */
        }
        .booking-form button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            /* Enhanced hover effect */
        }
        .booking-form button:active {
            transform: translateY(0);
        }
        .results-section {
            max-width: 1200px;
            margin: 3rem auto;
            padding: 2rem;
            display: none; /* Initially hidden, controlled by JS */
            /* Modern results section */
        }
        .results-section.active {
            display: block;
            animation: fadeInUp 0.6s ease-out;
            /* Smooth animation when results appear */
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .results-section h2 {
            margin-bottom: 2rem;
            color: var(--primary-color);
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            /* Enhanced results heading */
        }
        .result-card {
            background: var(--white);
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            /* Modern result cards with enhanced styling */
        }
        .result-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            /* Enhanced hover effect */
        }
        .result-card img {
            width: 120px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
            /* Enhanced bus image styling */
        }
        .result-details {
            flex: 1;
            min-width: 250px;
            /* Enhanced details container */
        }
        .result-details h4 {
            margin: 0 0 0.75rem;
            color: var(--primary-color);
            font-size: 1.25rem;
            font-weight: 600;
            /* Enhanced route heading */
        }
        .result-details p {
            margin: 0.5rem 0;
            font-size: 0.95rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            /* Enhanced detail text */
        }
        .result-details p i {
            color: var(--accent-color);
            width: 16px;
        }
        .book-btn {
            background: var(--gradient-accent);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-left: auto;
            flex-shrink: 0;
            font-size: 1rem;
            /* Modern book button */
        }
        .book-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            /* Enhanced hover effect */
        }
        .book-btn:active {
            transform: translateY(0);
        }
        .gallery {
            padding: 4rem 2rem;
            background: var(--light-bg);
            text-align: center;
            /* Modern gallery section */
        }
        .gallery h2 {
            color: var(--primary-color);
            margin-bottom: 2rem;
            font-size: 2.5rem;
            font-weight: 700;
            /* Enhanced gallery heading */
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            /* Enhanced responsive grid layout */
        }
        .image-grid img {
            width: 100%;
            height: 250px;
            border-radius: 16px;
            object-fit: cover;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            /* Enhanced image styling */
        }
        .image-grid img:hover {
            transform: scale(1.05) translateY(-8px);
            box-shadow: var(--shadow-xl);
            /* Enhanced hover effect with lift */
        }
        .footer {
            background: var(--gradient-primary);
            color: var(--white);
            padding: 3rem 2rem 1rem;
            text-align: center;
            font-size: 0.95rem;
            /* Modern footer styling */
        }
        .footer-content {
            max-width: 1200px;
            margin: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            text-align: left;
            /* Enhanced footer layout */
        }
        .footer-section {
            flex: 1;
            min-width: 200px;
        }

        #contact-us, #hero {
            scroll-margin-top: 80px; /* Account for sticky navbar */
        }

        .contact-info p {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .contact-info i {
            color: var(--accent-color);
            width: 16px;
        }

        .quick-contact {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .contact-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .contact-btn.whatsapp {
            background: #25D366;
            color: white;
        }

        .contact-btn.whatsapp:hover {
            background: #1ea952;
            transform: translateY(-2px);
        }

        .contact-btn.call {
            background: var(--primary-color);
            color: white;
        }

        .contact-btn.call:hover {
            background: #001c44;
            transform: translateY(-2px);
        }

        .social-links {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .social-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            color: var(--text-light);
        }

        .social-link:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .social-link.facebook:hover {
            color: #1877F2;
        }

        .social-link.instagram:hover {
            color: #E4405F;
        }

        .social-link.twitter:hover {
            color: #1DA1F2;
        }

        .newsletter-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .newsletter-form input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            font-size: 0.9rem;
        }

        .newsletter-form input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .newsletter-form button {
            padding: 0.75rem 1rem;
            background: var(--accent-color);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .newsletter-form button:hover {
            background: #d4b800;
            transform: translateY(-2px);
        }

        /* Loading Spinner */
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            text-align: center;
            margin: 2rem auto;
            max-width: 1200px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 45, 107, 0.1);
            border-left: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner p {
            color: var(--text-dark);
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0;
        }

        .hidden {
            display: none !important;
        }

        /* Custom Popup Modal */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .popup-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .popup-modal {
            background: var(--white);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: var(--shadow-xl);
            transform: scale(0.8) translateY(20px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .popup-overlay.show .popup-modal {
            transform: scale(1) translateY(0);
        }

        .popup-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .popup-icon.success {
            color: #10b981;
        }

        .popup-icon.error {
            color: #ef4444;
        }

        .popup-icon.warning {
            color: #f59e0b;
        }

        .popup-icon.info {
            color: #3b82f6;
        }

        .popup-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .popup-message {
            font-size: 1rem;
            color: var(--text-light);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .popup-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .popup-button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .popup-button.primary {
            background: var(--primary-color);
            color: var(--white);
        }

        .popup-button.primary:hover {
            background: #001c44;
            transform: translateY(-2px);
        }

        .popup-button.secondary {
            background: #f1f5f9;
            color: var(--text-dark);
            border: 1px solid #e2e8f0;
        }

        .popup-button.secondary:hover {
            background: #e2e8f0;
            transform: translateY(-2px);
        }

        .popup-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .popup-close:hover {
            color: var(--text-dark);
        }
        .footer-section h4 {
            color: var(--accent-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            /* Enhanced footer headings */
        }
        .footer-section a,
        .footer-section p {
            display: block;
            color: var(--white);
            margin: 0.5rem 0;
            text-decoration: none;
            transition: color 0.3s ease;
            /* Enhanced footer links */
        }
        .footer-section a:hover {
            color: var(--accent-color);
            transform: translateX(4px);
            /* Enhanced hover effect */
        }
        .footer-bottom {
            margin-top: 2rem;
            padding-top: 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.8;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            /* Enhanced footer bottom */
        }

        /* --- Seat Selection Modal Styling --- */
        #seatModal, #loginChoiceModal { /* Apply same base styles to both modals */
            display: none; /* Initially hidden, controlled by JS */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7); /* Darker overlay */
            z-index: 9999;
            justify-content: center; /* Use flexbox for centering when visible */
            align-items: center;
            padding: 20px; /* Add some padding for smaller screens */
            box-sizing: border-box; /* Include padding in element's total width and height */
            /* Use: Styles the modal overlay for seat selection, making it full screen and centered. */
        }

        #seatModal > div, #loginChoiceModal > div { /* Apply same inner modal styles */
            background: var(--light-bg);
            max-width: 500px; /* Adjusted for login choice, seat modal is wider */
            width: 100%; /* Ensure it takes available width */
            border-radius:12px;
            position:relative;
            box-shadow: 0 8px 16px rgba(0,0,0,0.25);
            max-height: 95vh; /* Limit height for scrollability */
            overflow: hidden; /* Hide overflow, manage scrolling internally */
            text-align: center; /* Center text in choice modal */
            display: flex; /* Use flexbox for robust layout */
            flex-direction: column; /* Stack header, body, footer vertically */
            /* Use: Styles the modal content box (white background, rounded corners, shadow, scrollable). */
        }

        #seatModal > div {
            max-width: 700px; /* Override for the wider seat modal */
        }

        #seatModal h3, #loginChoiceModal h3 {
            margin-bottom:20px;
            color: var(--primary-color); /* Using your primary color */
            text-align: center;
            font-size: 1.8em;
            /* Use: Styles the heading inside the seat selection modal. */
        }

        .modal-header {
            padding: 20px 25px;
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }
        .modal-header-card {
            background: var(--light-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            text-align: left;
        }
        .modal-header-card h4 { margin: 0 0 8px 0; color: var(--primary-color); font-size: 1.2rem; }
        .modal-header-card p { margin: 0; color: var(--text-light); font-size: 0.9rem; }
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--text-light);
            cursor: pointer;
            transition: color 0.2s;
        }
        .modal-close-btn:hover { color: var(--text-dark); }

        .modal-body {
            padding: 25px;
            overflow-y: auto;
            flex-grow: 1; /* Allow the body to take up all available space */
        }

        #seatGrid {
            display:grid;
            /* grid-template-columns will be set by JS dynamically */
            gap:12px; /* Default gap */
            margin-bottom:25px;
            justify-items: center; /* Center seat icons within their grid cells */
            /* Use: Creates a grid layout for displaying bus seats. */
        }

        .seat-container {
            position: relative;
            width: 60px; /* Adjust size of seat container */
            height: 60px; /* Adjust size of seat container */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer; 
            border-radius: 12px 12px 4px 4px; /* Rounded top, sharp bottom */
            transition: all 0.2s ease-in-out;
            background-color: #cbd5e1; /* Available color */
            border: 1px solid #a8b8c8;
            /* Use: Styles individual seat containers, making them clickable and setting initial appearance. */
        }

        .seat-container:not(.booked):hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .seat-container .seat-icon {
            font-size: 2.5em; /* Large seat icon */
            color: var(--white);
            transition: color 0.2s ease;
            /* Use: Styles the Font Awesome chair icon within a seat. */
        }

        .seat-container .seat-number {
            font-size: 0.75em;
            font-weight: 600;
            color: rgba(0,0,0,0.5);
            /* Use: Styles the seat number label. */
        }

        /* Styles for Selected Seat */
        .seat-container.selected .seat-icon {
            color: var(--accent-color); /* Using your accent color for selected */
            /* Use: Changes seat icon color to accent color when selected. */
        }
        .seat-container.selected {
            background-color: var(--accent-color);
            border-color: #c48a09;
            /* Use: Adds a light background and slight scale effect to selected seats. */
        }

        /* Styles for Booked Seat */
        .seat-container.booked {
            cursor: not-allowed;
            /* Use: Changes cursor for booked seats to indicate they are not clickable. */
        }
        .seat-container.booked .seat-icon {
            color: #dc2626; /* Red for booked */
            /* Use: Changes seat icon color to red for booked seats. */
        }
        .seat-container.booked::after {
            content: 'X'; /* Add an 'X' for booked seats */
            position: absolute;
            font-size: 2.5em;
            color: rgba(255, 255, 255, 0.7);
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            background-color: rgba(0,0,0,0.3); /* Dark overlay */
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            top: 0; /* Position correctly over the seat */
            left: 0; /* Position correctly over the seat */
            /* Use: Adds a semi-transparent 'X' overlay to visually mark booked seats. */
        }
        .driver-area {
            grid-column: 1 / -1; /* Span all columns */
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        /* Input Fields in Modal */
        #seatModal input[type="text"],
        #seatModal input[type="tel"],
        #seatModal input[type="email"],
        #seatModal select { /* Added select for gender */
            padding:12px 15px;
            width:100%;
            margin-bottom:15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box; /* Crucial for width to include padding and border */
            font-size: 1em;
            /* Use: Styles input fields and dropdowns within the seat selection modal. */
        }

        .modal-footer {
            padding: 15px 25px;
            background: var(--white);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
        }
        .footer-summary { text-align: left; }
        .footer-summary p { margin: 0; font-size: 0.9rem; color: var(--text-light); }
        .footer-summary strong { font-size: 1.1rem; color: var(--primary-color); }
        .footer-actions button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        .footer-actions button:active { transform: translateY(1px); }
        .footer-actions .btn-proceed { background: var(--accent-color); color: white; }
        .footer-actions .btn-proceed:hover { background-color: #b27e0f; }
        .footer-actions .btn-cancel { background: #e2e8f0; color: var(--text-dark); }
        .footer-actions .btn-cancel:hover { background-color: #cbd5e1; }

        #loginChoiceModal button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 0 10px;
        }
        #loginChoiceModal button:active { transform: translateY(1px); }

        #loginChoiceModal button:first-child {
            background: #e2e8f0;
            color: var(--text-dark);
        }
        #loginChoiceModal button:first-child:hover { background-color: #cbd5e1; }

        #loginChoiceModal button:last-child {
            background: var(--accent-color);
            color: white;
        }
        #loginChoiceModal button:last-child:hover {
            background-color: #b27e0f; /* Darker accent */
        }

        /* New styles for the redesigned login choice modal */
        .choice-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 25px;
            text-align: left;
        }
        .choice-card {
            padding: 25px 20px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .choice-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-color);
        }
        .choice-card.primary-choice {
            background: var(--primary-light);
            border-color: var(--primary-color);
            color: var(--white);
        }
        .choice-card.primary-choice:hover { border-color: var(--accent-color); }
        .choice-card.primary-choice p { color: rgba(255,255,255,0.8); }
        .choice-card i { font-size: 2rem; margin-bottom: 15px; color: var(--accent-color); }
        .choice-card h4 { font-size: 1.2rem; margin-bottom: 8px; }
        .choice-card p { font-size: 0.9rem; line-height: 1.5; margin: 0; }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 768px) {
            .navbar-container {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            /* Mobile nav styles are handled in the earlier media query */
            .menu-toggle {
                display: flex;
            }
            
            /* Hero Section Mobile */
            .hero {
                padding: 3rem 1rem;
            }
            .hero h1 {
                font-size: 2.5rem;
            }
            .hero h2 {
                font-size: 1.25rem;
            }
            .hero p {
                font-size: 1rem;
            }
            .hero::after {
                /* On mobile, make buses smaller and position them in the corners to prevent overlap */
            background-size: 90%, 90%; /* Make images slightly larger */
            /* Position both images in the center, slightly offset from each other */
            background-position: 45% center, 55% center;
            opacity: 0.08; /* Further reduce opacity to ensure text is readable */
            bottom: auto; /* Remove bottom positioning */
            height: 100%; /* Ensure it covers the full hero height */
            }

            
            /* Booking Form Mobile */
            .booking {
                padding: 2rem 1rem;
            }
            .booking h2 {
                font-size: 2rem;
            }
            .booking-form {
                grid-template-columns: 1fr;
                padding: 1.5rem;
                gap: 1rem;
                margin: 0 auto; /* Center the form on mobile */
            }
            
            /* Results Section Mobile */
            .results-section {
                padding: 1rem;
            }
            .results-section h2 {
                font-size: 1.75rem;
            }
            .result-card {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
                gap: 1rem;
            }
            .result-card img {
                width: 100%;
                height: 200px;
            }
            .result-details {
                min-width: unset;
                width: 100%;
            }
            .book-btn {
                margin-left: unset;
                margin-top: 1rem;
                width: 100%;
            }
            
            /* Gallery Mobile */
            .gallery {
                padding: 2rem 1rem;
            }
            .gallery h2 {
                font-size: 2rem;
            }
            .image-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            /* Modal Mobile */
            .seat-container {
                width: 45px;
                height: 45px;
            }
            .seat-container .seat-icon {
                font-size: 2em;
            }
            #seatModal > div, #loginChoiceModal > div {
                margin: 1rem;
                padding: 1.5rem;
            }
            #seatModal input, #seatModal select {
                padding: 0.75rem;
            }
            #seatModal button, #loginChoiceModal button {
                padding: 0.75rem 1.5rem;
                font-size: 0.95em;
            }
            
            /* Footer Mobile */
            .footer {
                padding: 2rem 1rem 1rem;
            }
            .footer-content {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                text-align: center;
            }
            .footer-section h4 {
                text-align: center;
            }
            .choice-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        @media (max-width: 480px) {
            /* Removed specific seatGrid columns for 480px, let JS handle it dynamically */
            .seat-container {
                width: 45px;
                height: 45px;
            }
            .seat-container .seat-icon {
                font-size: 2em;
            }
            /* Use: Further reduces seat and icon size for very small screens. */
            .book-now-btn, #seatModal button, #loginChoiceModal button {
                font-size: 0.9em;
                padding: 10px 15px;
            }
            /* Use: Adjusts button font size and padding for very small screens. */
        }

        /* AI Assistant Button */
        #aiAssistantButton {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: var(--primary-color);
            color: rgb(245, 209, 4);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            z-index: 10000; /* Ensure it's above everything */
            transition: background-color 0.3s ease, transform 0.3s ease;
            /* Use: Darkens and slightly scales the AI button on hover. */
        }

        #aiAssistantButton:hover {
            background-color: #001c44; /* Darker primary */
            transform: scale(1.05);
            /* Use: Darkens and slightly scales the AI button on hover. */
        }

        /* AI Assistant Chat Interface */
        #aiAssistantChat {
            position: fixed;
            bottom: 100px; /* Position above the button */
            right: 30px;
            width: 320px;
            height: 400px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
            transform: translateY(20px) scale(0.9);
            opacity: 0;
            pointer-events: none; /* Disable interaction when hidden */
            /* Use: Styles the chat window (position, size, appearance, initial hidden state). */
        }

        #aiAssistantChat.chat-visible {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: auto; /* Enable interaction when visible */
            /* Use: Applies transformation and opacity to make chat window visible with animation. */
        }

        .chat-hidden {
            display: none; /* For initial state and complete hiding */
            /* Use: Hides the chat window completely when not in use. */
        }

        .chat-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Use: Styles the header of the chat window (background, text, layout). */
        }

        .chat-header h3 {
            margin: 0;
            font-size: 1.2em;
            /* Use: Styles the title in the chat header. */
        }

        .chat-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            /* Use: Styles the close button in the chat header. */
        }

        .chat-close-btn:hover {
            color: var(--accent-color);
            /* Use: Changes close button color on hover. */
        }

        .chat-body {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
            /* Use: Styles the main message display area of the chat window (scrollable). */
        }

        /* --- Chat Message Styling --- */
        .chat-body p {
            max-width: 80%; /* Limit message bubble width */
            padding: 8px 12px;
            border-radius: 15px; /* Rounded corners for bubbles */
            margin-bottom: 10px; /* Space between messages */
            line-height: 1.4;
            word-wrap: break-word; /* Ensure long words break */
        }

        .user-message {
            background-color: var(--primary-color); /* User messages blue */
            color: white;
            align-self: flex-end; /* Align to the right */
            margin-left: auto; /* Push to the right */
            border-bottom-right-radius: 2px; /* Sharpen bottom-right corner */
        }

        .bot-message {
            background-color: #e0e0e0; /* Bot messages light grey */
            color: var(--text-dark);
            align-self: flex-start; /* Align to the left */
            margin-right: auto; /* Push to the left */
            border-bottom-left-radius: 2px; /* Sharpen bottom-left corner */
        }
        /* --- End Chat Message Styling --- */

        /* Quick Action Buttons */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .quick-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .quick-btn:hover {
            background-color: var(--accent-color);
            transform: translateY(-1px);
        }


        .chat-footer {
            padding: 15px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #eee;
            background-color: #f0f0f0;
            /* Use: Styles the input area at the bottom of the chat window. */
        }

        .chat-footer input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95em;
            /* Use: Styles the text input field in the chat footer. */
        }

        .chat-footer button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
            /* Use: Darkens the "Send" button on hover. */
        }

        .chat-footer button:hover {
            background-color: #b27e0f;
            /* Use: Darkens the "Send" button on hover. */
        }

        /* Responsive adjustments for chat */
        @media (max-width: 600px) {
            #aiAssistantButton {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
                bottom: 20px;
                right: 20px;
            }
            /* Use: Adjusts AI button size and position for smaller screens. */
            #aiAssistantChat {
                width: calc(100% - 40px); /* Full width minus margin */
                height: calc(80vh - 100px); /* Adjust height */
                bottom: 80px;
                right: 20px;
            }
            /* Use: Adjusts chat window size and position for smaller screens. */
        }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="navbar-container">
            <div class="logo">
                <img src="mylogo.png" alt="Prince Alex Logo" />
            </div>
            <!-- Hamburger Menu Icon -->
            <button class="menu-toggle" id="mobile-menu" aria-label="Toggle mobile menu">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </button>
            <nav class="nav-links" id="main-nav">
                <a href="#hero">Home</a>
                <a href="about-us.html">About Us</a>
                <a href="#contact-us">Contact</a>
                <a href="ticket-lookup.html">Print Ticket</a>
                <a href="admin.html">Admin Login</a>
                <a href="profile.html" id="myProfileLink" style="display:none;">My Profile</a>
                <a href="login-register.html" id="loginRegisterLink">Login / Register</a>
                <a href="#" id="logoutLink" style="display:none;">Logout</a>
            </nav>
        </div>
    </header>

    <section class="hero" id="hero">
        <div class="hero-background">
            <div class="hero-waves"></div>
        </div>
        <div class="hero-content">
        <h1>Welcome to Prince Alex Digital Travel Services</h1>
        <h2>Travel with Comfort and Safety</h2>
        <p>Your journey, our priority. Book your bus tickets online with Prince Alex Travel Services for a seamless experience.</p>
            <div class="hero-actions">
                <button class="cta-button primary" onclick="scrollToBooking()">
                    <i class="fas fa-ticket-alt"></i>
                    Book Now
                </button>
                <button class="cta-button secondary" onclick="scrollToContact()">
                    <i class="fas fa-phone"></i>
                    Contact Us
                </button>
            </div>
        </div>
    </section>

    <section class="booking">
        <div class="booking-container">
            <h2>Book Your Ticket</h2>
            <form class="booking-form" onsubmit="event.preventDefault(); searchResults();">
                <div class="form-group">
                    <label for="from">From</label>
                <select id="from" required>
                        <option value="">Select Origin</option>
                    <option>Nairobi</option>
                    <option>Kisumu</option>
                    <option>Eldoret</option>
                    <option>Mombasa</option>
                    <option>Nakuru</option>
                    <option>Kericho</option>
                    <option>Kakamega</option>
                    <option>Kitale</option>
                    <option>Nyeri</option>
                    <option>Busia</option>
                </select>
                </div>
                <div class="form-group">
                    <label for="to">To</label>
                <select id="to" required>
                        <option value="">Select Destination</option>
                    <option>Nairobi</option>
                    <option>Kisumu</option>
                    <option>Eldoret</option>
                    <option>Mombasa</option>
                    <option>Nakuru</option>
                    <option>Kericho</option>
                    <option>Kakamega</option>
                    <option>Kitale</option>
                    <option>Nyeri</option>
                    <option>Busia</option>
                </select>
                </div>
                <div class="form-group">
                    <label for="travelDate">Travel Date</label>
                <input type="date" id="travelDate" required />
                </div>
                <button type="submit">
                    <i class="fas fa-search"></i> Search Buses
                </button>
            </form>
        </div>
    </section>

    <div id="loadingSpinner" class="loading-spinner hidden">
        <div class="spinner"></div>
        <p>Searching for buses...</p>
    </div>
    
    <section class="results-section" id="results">
    </section>
    <div class="payment-methods">
        <p>We accept secure payments via:</p>
        <div class="payment-logos">
            <div class="payment-logo mpesa">M-PESA</div>
            <div class="payment-logo airtel">Airtel Money</div>
            <div class="payment-logo visa"><i class="fab fa-cc-visa"></i></div>
            <div class="payment-logo mastercard"><i class="fab fa-cc-mastercard"></i></div>
        </div>
    </div>

    <section class="gallery">
        <div class="gallery-container">
            <h2>Our Travel Experience</h2>
            <div class="image-grid">
                <img src="Bus1.png" alt="Luxury Bus">
                <img src="Bus2.png" alt="VIP Interior">
                <img src="Bus3.png" alt="Clean and Air Conditioned">
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section" id="contact-us">
                <h4>Contact Us</h4>
                <div class="contact-info">
                    <p><i class="fas fa-envelope"></i> senerwaalex@gmail.com</p>
                    <p><i class="fas fa-phone"></i> +254 717 384 875</p>
                    <p><i class="fas fa-map-marker-alt"></i> Nairobi, Kenya</p>
                </div>
                <div class="quick-contact">
                    <a href="tel:+254717384875" class="contact-btn whatsapp">
                        <i class="fab fa-whatsapp"></i>
                        Call Now
                    </a>
                    <a href="https://wa.me/254717384875" class="contact-btn call" target="_blank">
                        <i class="fas fa-phone"></i>
                        WhatsApp
                    </a>
                </div>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <a href="index.html">Home</a>
                <a href="about-us.html">About Us</a>
                <a href="ticket-lookup.html">Print Ticket</a>
                <a href="admin.html">Admin Login</a>
            </div>
            <div class="footer-section">
                <h4>Follow Us</h4>
                <div class="social-links">
                    <a href="#" class="social-link facebook">
                        <i class="fab fa-facebook-f"></i>
                        Facebook
                    </a>
                    <a href="#" class="social-link instagram">
                        <i class="fab fa-instagram"></i>
                        Instagram
                    </a>
                    <a href="#" class="social-link twitter">
                        <i class="fab fa-twitter"></i>
                        Twitter
                    </a>
                </div>
            </div>
            <div class="footer-section">
                <h4>Newsletter</h4>
                <p>Stay updated with our latest offers and travel news!</p>
                <form class="newsletter-form" onsubmit="event.preventDefault(); subscribeNewsletter();">
                    <input type="email" placeholder="Enter your email" required>
                    <button type="submit">
                        <i class="fas fa-paper-plane"></i>
                        Subscribe
                    </button>
                </form>
            </div>
        </div>
        <div class="footer-bottom">
            &copy; 2025 Prince Alex Digital. All rights reserved.
        </div>
    </footer>

    <div id="loginChoiceModal">
        <div>
            <h3>How would you like to book?</h3>
            <p style="color: var(--text-light);">Choose an option to continue to seat selection.</p>
            <div class="choice-container">
                <div class="choice-card" onclick="redirectToLogin()">
                    <i class="fas fa-user-circle"></i>
                    <h4>Login or Sign Up</h4>
                    <p>Access your profile, view booking history, and enjoy a faster checkout.</p>
                </div>
                <div class="choice-card primary-choice" onclick="proceedAsGuest()">
                    <i class="fas fa-ticket-alt"></i>
                    <h4>Continue as Guest</h4>
                    <p>Quickly book your ticket without creating an account. We'll email your ticket.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="seatModal">
        <div>
            <div class="modal-header">
                <div id="modalHeaderInfo" class="modal-header-card">
                    <!-- Bus info will be populated by JS -->
                </div>
                <button class="modal-close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="seatGrid"></div>
                <div style="margin-top: 25px; text-align: left;">
                    <h4 style="text-align: center; margin-bottom: 15px; color: var(--primary-color);">Passenger Details</h4>
                    <input type="text" id="passengerName" placeholder="Your Full Name" required />
                    <input type="text" id="passengerID" placeholder="ID Number" required />
                    <select id="passengerGender" required>
                        <option value="">Select Gender</option>
                        <option value="Male"> Male</option>
                        <option value="Female"> Female</option>
                        <option value="Other"> Other</option>
                    </select>
                    <input type="tel" id="passengerPhone" placeholder="Phone Number" required />
                    <input type="email" id="passengerEmail" placeholder="Email Address" required />
                </div>
            </div>
            <div class="modal-footer">
                <div id="footerSummary" class="footer-summary"></div>
                <div class="footer-actions">
                    <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button class="btn-proceed" onclick="confirmBooking()">Proceed </button>
                </div>
            </div>
        </div>
    </div>

    <div id="aiAssistantButton">
        <i class="fas fa-comments"></i>
    </div>

    <div id="aiAssistantChat" class="chat-hidden">
        <div class="chat-header">
            <h3>AI Assistant</h3>
            <button class="chat-close-btn" onclick="toggleChat()">&times;</button>
        </div>
        <div class="chat-body" id="chatBody">
            <p class="bot-message">Hello! I am your Prince Alex Travel AI Assistant. I can answer general questions about travel or provide information about bus routes if you tell me the origin and destination. How can I assist you today?</p>
            <div class="quick-actions">
                <button class="quick-btn" onclick="sendQuickMessage('Show me buses from Nairobi to Kisumu')">Nairobi  Kisumu</button>
                <button class="quick-btn" onclick="sendQuickMessage('What are your contact details?')">Contact Info</button>
                <button class="quick-btn" onclick="sendQuickMessage('How much does a ticket cost?')">Pricing</button>
                <button class="quick-btn" onclick="sendQuickMessage('Tell me about your services')">Our Services</button>
            </div>
        </div>
        <div class="chat-footer">
            <input type="text" placeholder="Type your message..." id="chatInput" />
            <button id="sendChatBtn">Send</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script>

    <script>
        // Set min date for travelDate input to today
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("travelDate").setAttribute("min", today);

        let currentBusId = null;
        let currentBusRoute = null;
        let currentBusTime = null;
        let currentTravelDate = null;
        let currentBusPrice = null;
        let currentBusName = null; // Added to store bus name
        let currentTotalSeats = null; // Added to store total seats for the current bus
        let selectedSeats = []; // New array to hold multiple selected seats

        // Global variables for navbar links (already declared in the module script, but re-declared for clarity in this script block)
        const myProfileLink = document.getElementById('myProfileLink');
        const loginRegisterLink = document.getElementById('loginRegisterLink');
        const logoutLink = document.getElementById('logoutLink');
        const mobileMenuToggle = document.getElementById('mobile-menu');
        const mainNav = document.getElementById('main-nav');

        // Fallback mobile menu toggle function
        function toggleMobileMenu(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            if (mainNav && mobileMenuToggle) {
                console.log('Fallback toggle function called');
                mainNav.classList.toggle('open');
                mobileMenuToggle.classList.toggle('open');
                document.body.classList.toggle('menu-open');
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            // Ensure modals are hidden on load
            document.getElementById("seatModal").style.display = "none";
            document.getElementById("loginChoiceModal").style.display = "none";
            
            // Add smooth scrolling for all anchor links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href').substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            }); 
            
            document.getElementById('aiAssistantButton').addEventListener('click', toggleChat);
            const aiAssistantChat = document.getElementById('aiAssistantChat');
            aiAssistantChat.classList.add('chat-hidden'); // Ensure it starts hidden

            // Get references to chat elements
            const chatInput = document.getElementById('chatInput');
            const sendChatBtn = document.getElementById('sendChatBtn');

            // Attach event listeners for chat input
            sendChatBtn.addEventListener('click', handleChatInput);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleChatInput();
                }
            });

            // Attach logout handler to the logout link in navbar
            logoutLink.addEventListener('click', async (e) => {
                e.preventDefault(); // Prevent default link behavior
                await logout(); // Use await for async logout
            });

            // Mobile Menu Toggle Functionality
            if (mobileMenuToggle && mainNav) {
                mobileMenuToggle.addEventListener('click', function () {
                    this.classList.toggle('open');
                    mainNav.classList.toggle('open');
                });

                mainNav.querySelectorAll('a').forEach(link => {
                    link.addEventListener('click', () => {
                        mobileMenuToggle.classList.remove('open');
                        mainNav.classList.remove('open');
                    });
                });

                // Close mobile menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!mobileMenuToggle.contains(event.target) && !mainNav.contains(event.target)) {
                        mobileMenuToggle.classList.remove('open');
                        mainNav.classList.remove('open');
                    }
                });
            }
        });

        // Global function to update navbar links based on auth state
        function updateAuthLinks() {
            if (window.currentUser) {
                loginRegisterLink.style.display = 'none';
                myProfileLink.style.display = 'block'; // Show My Profile
                logoutLink.style.display = 'block';
            } else {
                loginRegisterLink.style.display = 'block';
                myProfileLink.style.display = 'none'; // Hide My Profile
                logoutLink.style.display = 'none';
            }
        }

        // Global logout function (now uses Firebase signOut)
        async function logout() {
            try {
                await signOutFirebase(firebaseAuth); // Use the globally exposed signOutFirebase
                displayCustomMessage('Logged out successfully!');
                // onAuthStateChanged will handle updating links and currentUser to null
                window.location.href = 'index.html'; // Redirect to home page after logout
            } catch (error) {
                console.error('Error logging out:', error.message);
                displayCustomMessage('Error logging out: ' + error.message);
            }
        }

        // Function to clear any existing custom messages
        function clearCustomMessages() {
            // Only remove elements that are actually custom message modals
            const existingModals = document.querySelectorAll('div[style*="position: fixed"][style*="z-index: 10002"]');
            existingModals.forEach(modal => {
                // Double check it's a custom message modal by looking for specific content
                if (modal.querySelector('div[style*="background: white"]') || 
                    modal.querySelector('div[style*="background-color: white"]')) {
                    modal.remove();
                }
            });
        }

        // Custom message display function (replaces alert and confirm)
        function displayCustomMessage(message, type = 'alert') {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.7); display: flex; justify-content: center;
                align-items: center; z-index: 10002; /* Higher than other modals */
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 25px; border-radius: 8px; text-align: center; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                    <p style="margin-bottom: 20px; font-size: 1.1em;">${message}</p>
                    <button style="background-color: #002d6b; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;" onclick="this.parentNode.parentNode.remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }


        // --- Front-end Booking System Functions ---

        async function searchResults() {
            console.log('Search function called');
            
            // Small delay to ensure DOM is ready
            await new Promise(resolve => setTimeout(resolve, 10));
            
            const from = document.getElementById('from').value;
            const to = document.getElementById('to').value;
            const date = document.getElementById('travelDate').value;
            const resultsContainer = document.getElementById('results');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            console.log('Search values:', { from, to, date });
            console.log('Elements found:', { resultsContainer, loadingSpinner });
            
            // Check if required elements exist
            if (!resultsContainer) {
                console.error('Results container not found!');
                return;
            }
            if (!loadingSpinner) {
                console.error('Loading spinner not found!');
                return;
            }
            
            // Reset everything for fresh search
            resultsContainer.innerHTML = '';
            
            // Close any existing popups
            closePopup();
            
            // Show loading spinner and results section
            loadingSpinner.classList.remove('hidden');
            resultsContainer.classList.add('active');

            if (from === to) {
                loadingSpinner.classList.add('hidden');
                displayCustomMessage('Please choose different origin and destination.');
                return;
            }

            // Fetch matching buses from Firestore
            const busesRef = collection(firebaseDb, "buses");
            const q = query(busesRef, 
                            where("origin", "==", from), 
                            where("destination", "==", to), 
                            where("travelDate", "==", date));
            
            try {
                console.log('Starting Firebase query...');
                const querySnapshot = await getDocs(q);
                console.log('Query completed, processing results...');
                const buses = [];
                querySnapshot.forEach((doc) => {
                    buses.push({ id: doc.id, ...doc.data() });
                });
                console.log('Found buses:', buses.length);

                if (buses.length === 0) {
                    loadingSpinner.classList.add('hidden');
                    // Use the popup system to display the message
                    showPopup(
                        ' No Buses Found',
                        `Sorry, there are no buses available from ${from} to ${to} on ${date}. Please try a different date or route.`,
                        'warning'
                    );
                    return;
                }

                // Add a success header before the results
                const successHeader = document.createElement('div');
                successHeader.className = 'results-header success';
                successHeader.innerHTML = `<h3> Great! We found ${buses.length} bus${buses.length === 1 ? '' : 'es'} available.</h3><p>Please choose your preferred option below to proceed with your booking.</p>`;
                resultsContainer.appendChild(successHeader);

                buses.forEach(item => {
                    const busImage = item.image || 'https://placehold.co/150x100/002d6b/ffffff?text=Bus'; // Use a placeholder image if not available

                    // Create result card elements programmatically
                    const resultCard = document.createElement('div');
                    resultCard.classList.add('result-card');

                    const imgElement = document.createElement('img');
                    imgElement.src = busImage;
                    imgElement.alt = `${item.origin} to ${item.destination}`;
                    resultCard.appendChild(imgElement);

                    const detailsDiv = document.createElement('div');
                    detailsDiv.classList.add('result-details');
                    detailsDiv.innerHTML = `
                        <h4>${item.busName || item.company || 'Bus'} - ${item.origin} to ${item.destination}</h4>
                        <p><i class="fas fa-clock"></i> Departure: ${item.departureTime}</p>
                        <p><i class="fas fa-money-bill-wave"></i> Price: <strong>Ksh ${item.price}</strong></p>
                        <p><i class="fas fa-chair"></i> Total Seats: ${item.totalSeats}</p>
                        <p><i class="fas fa-check-circle"></i> Available Seats: ${item.available_seats}</p>
                        <p><i class="fas fa-calendar"></i> Travel Date: ${item.travelDate}</p>
                    `;
                    resultCard.appendChild(detailsDiv);

                    const bookBtn = document.createElement('button');
                    bookBtn.classList.add('book-btn');
                    bookBtn.textContent = 'Book Now'; // Only "Book Now" as text content

                    // Set data attributes using dataset for programmatic access
                    bookBtn.dataset.busId = item.id;
                    bookBtn.dataset.busRoute = `${item.origin} to ${item.destination}`;
                    bookBtn.dataset.busTime = item.departureTime;
                    bookBtn.dataset.travelDate = item.travelDate;
                    bookBtn.dataset.busPrice = item.price;
                    bookBtn.dataset.busName = item.busName || item.company || 'Bus';
                    bookBtn.dataset.totalSeats = item.totalSeats;
                    bookBtn.dataset.availableSeats = item.available_seats;

                    resultCard.appendChild(bookBtn);
                    resultsContainer.appendChild(resultCard);
                });

                attachBookNowListeners();
                loadingSpinner.classList.add('hidden');

                // Scroll to the results section
                setTimeout(() => {
                    resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100); // Small delay to ensure content is rendered before scrolling

            } catch (error) {
                console.error('Error fetching buses:', error);
                console.error('Error details:', error.message, error.code);
                loadingSpinner.classList.add('hidden');
                resultsContainer.innerHTML = `
                    <div class="results-header error">
                        <h3> Search Error</h3>
                        <p>Sorry, there was an error searching for buses. Please try again or contact support if the problem persists.</p>
                        <p style="font-size: 0.8rem; margin-top: 1rem; opacity: 0.7;">Error: ${error.message}</p>
                    </div>
                `;
            }
        }


        function attachBookNowListeners() {
            document.querySelectorAll('.book-btn').forEach(button => {
                button.removeEventListener('click', handleBookNowClick); // Prevent multiple listeners
                button.addEventListener('click', handleBookNowClick);
            });
        }

        // MODIFIED: handleBookNowClick function
        async function handleBookNowClick(event) {
            console.log("handleBookNowClick called. Current user:", window.currentUser);
            // Store selected bus details temporarily
            currentBusId = event.target.dataset.busId;
            currentBusRoute = event.target.dataset.busRoute;
            currentBusTime = event.target.dataset.busTime;
            currentTravelDate = event.target.dataset.travelDate;
            currentBusPrice = parseFloat(event.target.dataset.busPrice);
            currentBusName = event.target.dataset.busName;
            currentTotalSeats = parseInt(event.target.dataset.totalSeats);
            const currentAvailableSeats = parseInt(event.target.dataset.availableSeats);

            if (currentAvailableSeats <= 0) {
                displayCustomMessage("Sorry, this bus is fully booked. Please choose another one.");
                return;
            }

            // Check if user is logged in using Firebase currentUser
            if (window.currentUser) {
                console.log("User is logged in. Proceeding to seat selection directly with empty form.");

                // Populate new header
                const headerInfo = document.getElementById('modalHeaderInfo');
                headerInfo.innerHTML = `
                    <h4> ${currentBusName}  ${currentTotalSeats} Seater</h4>
                    <p><strong>Route:</strong> ${currentBusRoute}</p>
                    <p><strong>Date:</strong> ${currentTravelDate}  <strong>Time:</strong> ${currentBusTime}  <strong>Fare:</strong> KSh ${currentBusPrice.toLocaleString()}</p>
                `;

                await generateSeats(currentTotalSeats); // Pass total seats to generateSeats
                
                // Clear passenger details to allow manual entry
                document.getElementById("passengerName").value = '';
                document.getElementById("passengerID").value = '';
                document.getElementById("passengerGender").value = '';
                document.getElementById("passengerPhone").value = '';
                document.getElementById("passengerEmail").value = '';

                document.getElementById("seatModal").style.display = "flex";

            } else {
                console.log("User is NOT logged in. Showing login choice modal.");
                // If not logged in, show the login choice modal
                showLoginChoiceModal();
            }
        }

        // New function: Show the login/guest choice modal
        function showLoginChoiceModal() {
            console.log("showLoginChoiceModal called. Displaying login choice modal.");
            document.getElementById("loginChoiceModal").style.display = "flex";
        }

        // New function: Close the login/guest choice modal
        function closeLoginChoiceModal() {
            console.log("closeLoginChoiceModal called. Hiding login choice modal.");
            document.getElementById("loginChoiceModal").style.display = "none";
        }

        // New function: Handle "Proceed as Guest"
        async function proceedAsGuest() {
            console.log("proceedAsGuest called.");
            closeLoginChoiceModal(); // Close the choice modal
            // Now, open the seat selection modal as before
            const headerInfo = document.getElementById('modalHeaderInfo');
            headerInfo.innerHTML = `
                <h4> ${currentBusName}  ${currentTotalSeats} Seater</h4>
                <p><strong>Route:</strong> ${currentBusRoute}</p>
                <p><strong>Date:</strong> ${currentTravelDate}  <strong>Time:</strong> ${currentBusTime}  <strong>Fare:</strong> KSh ${currentBusPrice.toLocaleString()}</p>
            `;

            await generateSeats(currentTotalSeats); // Pass total seats to generateSeats
            // Clear passenger details for guest
            document.getElementById("passengerName").value = '';
            document.getElementById("passengerID").value = '';
            document.getElementById("passengerGender").value = '';
            document.getElementById("passengerPhone").value = '';
            document.getElementById("passengerEmail").value = '';
            document.getElementById("seatModal").style.display = "flex";
        }

        // New function: Handle "Login / Sign Up"
        function redirectToLogin() {
            console.log("redirectToLogin called.");
            closeLoginChoiceModal(); // Close the choice modal
            displayCustomMessage("Please log in or sign up. You will need to search for your bus again after logging in.");
            window.location.href = 'login-register.html'; // Redirect to login page
        }

        function closeModal() {
            document.getElementById("seatModal").style.display = "none";
            // Clear passenger details for next time (important for logged-in user who might cancel)
            document.getElementById("passengerName").value = '';
            document.getElementById("passengerID").value = '';
            document.getElementById("passengerGender").value = '';
            document.getElementById("passengerPhone").value = '';
            document.getElementById("passengerEmail").value = '';

            selectedSeats = []; // Clear selected seats
            updateSelectedSeatsDisplay(); // Update display
            const selected = document.querySelectorAll(".seat-container.selected");
            selected.forEach(s => s.classList.remove("selected"));
        }

        let unsubscribeSnapshot = null; // To store the unsubscribe function for real-time listener

        // Helper function to create a seat element (Updated to match admin.html)
        function createSeatElement(parent, seatNumber, bookedSeats) {
            const seatContainer = document.createElement("div");
            seatContainer.classList.add("seat-container");
            seatContainer.setAttribute("data-seat", `S${seatNumber}`); // Store as "S<number>"
            
            const seatIcon = document.createElement("i");
            seatIcon.classList.add("fas", "fa-chair", "seat-icon");

            const seatNumSpan = document.createElement("span");
            seatNumSpan.classList.add("seat-number");
            seatNumSpan.textContent = `S${seatNumber}`;

            seatContainer.appendChild(seatIcon);
            seatContainer.appendChild(seatNumSpan);

            if (bookedSeats.includes(`S${seatNumber}`)) { // Check against "S<number>" format
                seatContainer.classList.add("booked");
                seatContainer.onclick = null; // Make booked seats non-clickable
            } else {
                // Check if this seat was previously selected by the user
                if (selectedSeats.includes(seatNumber)) {
                    seatContainer.classList.add("selected");
                }
                seatContainer.onclick = function () {
                    const seatNum = parseInt(this.dataset.seat.replace('S', '')); // Convert back to number
                    if (this.classList.contains("selected")) {
                        this.classList.remove("selected");
                        selectedSeats = selectedSeats.filter(s => s !== seatNum);
                    } else {
                        this.classList.add("selected");
                        selectedSeats.push(seatNum);
                    }
                    updateSelectedSeatsDisplay();
                };
            }
            parent.appendChild(seatContainer);
        }

        async function generateSeats(totalSeats) {
            const seatGrid = document.getElementById("seatGrid");
            seatGrid.innerHTML = "";
            selectedSeats = [];
            updateSelectedSeatsDisplay();

            // Unsubscribe from previous listener if exists
            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
                unsubscribeSnapshot = null;
            }

            // Determine layout based on total seats (copied from admin.html)
            let seatsInLeftRow = 2;
            let seatsInRightRow = 2;
            let gridColumns = "repeat(2, 1fr) 0.5fr repeat(2, 1fr)"; // Default 2-2 layout (5 columns)

            if (totalSeats <= 14) { // Assuming 14-seater or smaller might be 2-1 layout
                seatsInLeftRow = 2;
                seatsInRightRow = 1;
                gridColumns = "repeat(2, 1fr) 0.5fr 1fr"; // 2-1 layout (4 columns)
            }

            seatGrid.style.gridTemplateColumns = gridColumns;

            // Add a "Front (Driver)" indicator
            const driverArea = document.createElement('div');
            driverArea.className = 'driver-area';
            driverArea.innerHTML = `<i class="fas fa-steering-wheel"></i> Front`;
            seatGrid.appendChild(driverArea);

            // Setup real-time listener for bookings for this specific bus and date
            const bookingsRef = collection(firebaseDb, "bookings");
            const q = query(bookingsRef, 
                            where("bus_id", "==", currentBusId), 
                            where("travel_date", "==", currentTravelDate),
                            where("status", "in", ['pending', 'paid'])); // Filter by active bookings

            unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                const bookedSeatsForThisTrip = [];
                snapshot.forEach((doc) => {
                    const booking = doc.data();
                    // Only add seats that are 'pending' or 'paid'
                    if (booking.status === 'pending' || booking.status === 'paid') {
                        bookedSeatsForThisTrip.push(booking.seat_number);
                    }
                });

                // Re-render seats based on the latest bookedSeatsForThisTrip
                // Clear all seats except the driver area (if already present)
                const existingDriverArea = seatGrid.querySelector('.driver-area');
                seatGrid.innerHTML = '';
                if (existingDriverArea) {
                    seatGrid.appendChild(existingDriverArea); // Re-add the driver area
                } else {
                    // This case should ideally not happen if driverArea is added once
                    const newDriverArea = document.createElement('div');
                    newDriverArea.className = 'driver-area';
                    newDriverArea.innerHTML = `<i class="fas fa-steering-wheel"></i> Front`;
                    seatGrid.appendChild(newDriverArea);
                }

                let currentSeatNum = 1;
                while (currentSeatNum <= totalSeats) {
                    // Left side seats
                    for (let j = 0; j < seatsInLeftRow; j++) {
                        if (currentSeatNum <= totalSeats) {
                            createSeatElement(seatGrid, currentSeatNum, bookedSeatsForThisTrip);
                            currentSeatNum++;
                        }
                    }

                    // Aisle
                    const aisleDiv = document.createElement('div');
                    aisleDiv.classList.add('aisle-space');
                    seatGrid.appendChild(aisleDiv);

                    // Right side seats
                    for (let j = 0; j < seatsInRightRow; j++) {
                        if (currentSeatNum <= totalSeats) {
                            createSeatElement(seatGrid, currentSeatNum, bookedSeatsForThisTrip); 
                            currentSeatNum++;
                        }
                    }
                }
            }, (error) => {
                console.error('Error fetching booked seats in real-time:', error.message);
                displayCustomMessage('Error fetching seat availability. Please try again.');
            });
        }


        function updateSelectedSeatsDisplay() {
            const summaryElement = document.getElementById('footerSummary');
            const totalCost = selectedSeats.length * currentBusPrice;
            const formattedSeats = selectedSeats.length > 0 
                ? selectedSeats.sort((a, b) => a - b).map(s => `S${s}`).join(', ')
                : 'None';

            if (selectedSeats.length > 0) {
                summaryElement.innerHTML = `<p>Seats: ${formattedSeats}</p><strong>Total: KSh ${totalCost.toLocaleString()}</strong>`;
            } else {
                summaryElement.innerHTML = `<p>Select your seat(s)</p>`;
            }
        }

        // Helper function for email validation
        function isValidEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        // Helper function for phone number validation
        function isValidPhoneNumber(phone) {
            // This regex allows for numbers, spaces, hyphens, and can start with a '+'
            const re = /^\+?[0-9\s-]{7,20}$/; 
            return re.test(String(phone));
        }

        // PDF Generation Function (from admin.html)
        async function generatePdfContent(booking) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a5' });

            // Define modern color scheme
            const primaryColor = '#1e3a8a'; // Modern deep blue
            const accentColor = '#f59e0b'; // Modern amber/gold
            const darkTextColor = '#1f2937'; // Dark gray
            const lightTextColor = '#6b7280'; // Light gray
            const whiteColor = '#ffffff';
            const lightBgColor = '#f8fafc';

            const status = (booking.status ?? "pending").toUpperCase();
            const statusColor = status === 'PAID' ? '#10b981' : '#f59e0b';

            // --- 1. MAIN TICKET BODY (as a rounded rectangle) ---
            doc.setFillColor(whiteColor);
            doc.setDrawColor(primaryColor);
            doc.setLineWidth(0.5);
            doc.roundedRect(5, 5, 200, 138, 5, 5, 'FD'); // Main ticket container

            // --- 2. HEADER SECTION ---
            doc.setFillColor(primaryColor);
            doc.roundedRect(5, 5, 200, 30, 5, 5, 'F');

            // Company logo placeholder
            doc.setFillColor(whiteColor);
            doc.circle(20, 20, 8, 'F');
            doc.setTextColor(primaryColor);
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text("PA", 18, 22);

            // Company name & "Boarding Pass"
            doc.setTextColor(whiteColor);
            doc.setFontSize(22);
            doc.setFont("helvetica", "bold");
            doc.text("Prince Alex Travel", 35, 18);
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text("BOARDING PASS", 35, 26);

            // Status Badge in Header
            const statusBadgeWidth = 35;
            const statusBadgeX = 205 - statusBadgeWidth - 10; // Positioned on the right
            doc.setFillColor(statusColor);
            doc.roundedRect(statusBadgeX, 15, statusBadgeWidth, 10, 3, 3, 'F');
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(whiteColor);
            doc.text(status, statusBadgeX + (statusBadgeWidth / 2), 21.5, { align: 'center' });

            // --- 3. MAIN CONTENT AREA (Boarding Pass Layout) ---
            const mainContentY = 40;
            const stubX = 145; // X position for the right-side "stub"

            // Dashed line for "tear-off" effect
            doc.setLineDashPattern([2, 2], 0);
            doc.setDrawColor(lightTextColor);
            doc.line(stubX, mainContentY - 2, stubX, 130);
            doc.setLineDashPattern([], 0);

            // --- LEFT SIDE (MAIN DETAILS) ---
            let yPos = mainContentY + 8;
            const leftMargin = 15;
            const leftColumnWidth = stubX - leftMargin - 5;

            // Passenger Name
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(lightTextColor);
            doc.text("PASSENGER NAME", leftMargin, yPos);
            yPos += 8;
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(darkTextColor);
            doc.text(booking.passenger_name ?? "-", leftMargin, yPos, { maxWidth: leftColumnWidth });
            yPos += 12;

            // Route (From -> To)
            const [origin, destination] = (booking.bus_route ?? '- to -').split(' to ');
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(lightTextColor);
            doc.text("FROM", leftMargin, yPos);
            doc.text("TO", leftMargin + 60, yPos);
            yPos += 10;
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(primaryColor);
            doc.text(origin.trim(), leftMargin, yPos, { maxWidth: 40 });
            doc.text("", leftMargin + 45, yPos);
            doc.text(destination.trim(), leftMargin + 60, yPos, { maxWidth: 65 });
            yPos += 12;

            // Date, Time, Seat in a row
            const detailY = yPos;
            const detailItems = [
                { label: "TRAVEL DATE", value: booking.travel_date ?? "-" },
                { label: "DEPARTURE", value: booking.bus_time ?? "-" },
                { label: "SEAT", value: booking.seat_number ?? "-" }
            ];
            detailItems.forEach((item, index) => {
                const xPos = leftMargin + (index * 45);
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(lightTextColor);
                doc.text(item.label, xPos, detailY);
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(darkTextColor);
                doc.text(item.value, xPos, detailY + 8, { maxWidth: 40 });
            });
            yPos += 20;

            // Important Notice
            doc.setFillColor(lightBgColor);
            doc.roundedRect(leftMargin - 5, yPos, leftColumnWidth + 5, 20, 3, 3, 'F');
            doc.setFontSize(8);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(primaryColor);
            doc.text("IMPORTANT REMINDERS:", leftMargin, yPos + 6);
            doc.setFontSize(8);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(darkTextColor);
            doc.text(" Arrive at the terminal 15 minutes before departure.", leftMargin, yPos + 11);
            doc.text(" Present this ticket (digital or printed) to the driver.", leftMargin, yPos + 16);

            // --- RIGHT SIDE (STUB) ---
            yPos = mainContentY + 8;
            const rightMargin = stubX + 8;
            const rightColumnWidth = 205 - rightMargin - 5;

            // Booking Reference
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(lightTextColor);
            doc.text("BOOKING REFERENCE", rightMargin, yPos);
            yPos += 8;
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(accentColor);
            doc.text(booking.booking_ref ?? booking.id, rightMargin, yPos, { maxWidth: rightColumnWidth });
            yPos += 12;

            // QR Code
            const qrCodeData = booking.booking_ref ?? booking.id;
            const qrCodeContainer = document.createElement('div');
            qrCodeContainer.style.display = 'none';
            document.body.appendChild(qrCodeContainer);

            let qrCodeImgData = '';
            try {
                new QRCode(qrCodeContainer, {
                    text: qrCodeData, width: 128, height: 128, colorDark: darkTextColor,
                    colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H
                });
                await new Promise(resolve => setTimeout(resolve, 50));
                const canvas = qrCodeContainer.querySelector('canvas');
                if (canvas) qrCodeImgData = canvas.toDataURL('image/png');
            } catch (e) {
                console.error("QR Code generation failed", e);
            } finally {
                document.body.removeChild(qrCodeContainer);
            }

            if (qrCodeImgData) {
                doc.addImage(qrCodeImgData, 'PNG', rightMargin + 3, yPos, 40, 40);
            }
            yPos += 45;

            // Bus Name
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(lightTextColor);
            doc.text("BUS NAME", rightMargin, yPos);
            yPos += 5;
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(darkTextColor);
            doc.text(booking.bus_name ?? "-", rightMargin, yPos, { maxWidth: rightColumnWidth });
            yPos += 8;

            // Price
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(lightTextColor);
            doc.text("PRICE PAID", rightMargin, yPos);
            yPos += 5;
            doc.setFontSize(11);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(darkTextColor);
            doc.text(`KES ${Number(booking.price ?? 0).toLocaleString()}`, rightMargin, yPos);
            yPos += 8;

            // --- 4. FOOTER ---
            const footerY = 132;
            doc.setDrawColor(primaryColor);
            doc.setLineWidth(0.2);
            doc.line(10, footerY, 200, footerY);
            
            const footerTextY = footerY + 5;
            doc.setFontSize(7);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(lightTextColor);

            doc.text(" 2025 Prince Alex Travel Services", 10, footerTextY);
            doc.text("This is an official e-ticket. Terms and conditions apply.", 10, footerTextY + 4);

            const rightAlignX = 205 - 10;
            doc.text("senerwaalex@gmail.com", rightAlignX, footerTextY, { align: 'right' });
            doc.text("+254 717 384 875", rightAlignX, footerTextY + 4, { align: 'right' });

            return doc;
        }

        async function confirmBooking() {
            const name = document.getElementById("passengerName").value.trim();
            const idNumber = document.getElementById("passengerID").value.trim();
            const gender = document.getElementById("passengerGender").value;
            const phone = document.getElementById("passengerPhone").value.trim();
            const email = document.getElementById("passengerEmail").value.trim();
            
            if (selectedSeats.length === 0) {
                displayCustomMessage("Please select at least one seat.");
                return;
            }
            if (!name) {
                displayCustomMessage("Please enter your Full Name.");
                return;
            }
            if (!idNumber) {
                displayCustomMessage("Please enter your ID Number.");
                return;
            }
            if (gender === "") {
                displayCustomMessage("Please select your Gender.");
                return;
            }
            if (!phone) {
                displayCustomMessage("Please enter your Phone Number.");
                return;
            }
            if (!isValidPhoneNumber(phone)) {
                displayCustomMessage("Please enter a valid Phone Number (e.g., +254712345678 or 0712345678).");
                return;
            }
            if (!email) {
                displayCustomMessage("Please enter your Email Address.");
                return;
            }
            if (!isValidEmail(email)) {
                displayCustomMessage("Please enter a valid Email Address.");
                return;
            }


            const bookingsToInsert = [];
            const emailsToInsert = []; // New array for email documents
            let lastBookingRef = null;

            // Fetch the current bus document to get the latest available_seats
            // Maximum allowed size for Base64 PDF content in bytes (approx 800KB for safety, Firestore limit is 1MB)
            const MAX_PDF_BASE64_SIZE_BYTES = 800 * 1024; // 800KB


            const busDocRef = doc(firebaseDb, "buses", currentBusId);
            const busDocSnap = await getDoc(busDocRef);

            if (!busDocSnap.exists()) {
                displayCustomMessage("Error: Bus details not found. Please try searching again.");
                return;
            }
            const busData = busDocSnap.data();
            let currentAvailableSeats = busData.available_seats;

            // Check if selected seats are still available
            const bookingsRef = collection(firebaseDb, "bookings");
            const qBookedSeats = query(bookingsRef, 
                                        where("bus_id", "==", currentBusId), 
                                        where("travel_date", "==", currentTravelDate),
                                        where("status", "in", ['pending', 'paid']));
            const bookedSeatsSnapshot = await getDocs(qBookedSeats);
            const currentlyBookedSeats = new Set(bookedSeatsSnapshot.docs.map(doc => doc.data().seat_number));

            for (const seatNumber of selectedSeats) {
                const formattedSeatNumber = `S${seatNumber}`; // Ensure "S<number>" format
                if (currentlyBookedSeats.has(formattedSeatNumber)) {
                    displayCustomMessage(`Seat ${formattedSeatNumber} has just been booked by someone else. Please select another seat.`);
                    generateSeats(currentTotalSeats); // Re-render seat grid with updated status
                    return;
                }
                if (currentAvailableSeats <= 0) {
                    displayCustomMessage("Not enough available seats on this bus for your selection. Please adjust your seats.");
                    generateSeats(currentTotalSeats); // Re-render seat grid with updated status
                    return;
                }
                currentAvailableSeats--; // Tentatively decrement for each selected seat

                const bookingRef = 'PA-' + Date.now().toString().slice(-6) + '-' + String(seatNumber).padStart(2, '0'); // Unique Booking Reference
                
                // Create booking document for 'bookings' collection
                const newBookingDoc = { 
                    booking_ref: bookingRef,
                    passenger_name: name,
                    passenger_id: idNumber,
                    passenger_gender: gender,
                    passenger_phone: phone,
                    passenger_email: email,
                    bus_id: currentBusId,
                    bus_name: currentBusName, // Add bus name to booking data
                    bus_route: currentBusRoute,
                    bus_time: currentBusTime,
                    travel_date: currentTravelDate,
                    seat_number: formattedSeatNumber, // Store in "S<number>" format
                    price: currentBusPrice, // Price per seat
                    status: 'pending', // Set to pending, payment gateway would confirm to 'paid'
                    booking_date: new Date().toISOString(), // ISO string for consistent date format
                    user_id: window.currentUser ? window.currentUser.uid : null, // Store Firebase user ID if logged in
                    createdAt: serverTimestamp(), // Add server timestamp
                };

                bookingsToInsert.push(newBookingDoc);
                lastBookingRef = bookingRef; // Keep track of the last one for redirect

                // Generate PDF for this booking
                const pdfDoc = await generatePdfContent(newBookingDoc);
                const pdfBase64 = pdfDoc.output("datauristring").split(",")[1];
                const pdfBase64SizeBytes = new TextEncoder().encode(pdfBase64).length;
                
                // Define the HTML content for the PENDING booking email body
                const emailHtml = `<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Your Booking is Pending - Prince Alex Travel</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; background-color: #f4f4f7; }
        .container { max-width: 600px; margin: 20px auto; padding: 0; background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .header { background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; padding: 40px 20px; text-align: center; }
        .header h1 { margin: 0; font-size: 28px; } .header p { margin: 5px 0 0; font-size: 16px; opacity: 0.9; }
        .content { padding: 30px; } .content h2 { color: #1e3a8a; margin-top: 0; font-size: 22px; }
        .ticket-info { background: #ffffff; padding: 25px; border-radius: 12px; margin: 25px 0; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .ticket-info h3 { margin-top: 0; margin-bottom: 25px; color: #1e3a8a; text-align: center; font-size: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .info-item { padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .info-item.full-width { grid-column: 1 / -1; }
        .info-item:last-child { border-bottom: none; }
        .info-label { display: block; font-size: 13px; color: #64748b; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-value { display: block; font-size: 16px; font-weight: 600; color: #1f2937; }
        .info-value.highlight { color: #f59e0b; font-size: 18px; }
        .footer { text-align: center; padding: 20px; color: #64748b; font-size: 13px; background-color: #f8fafc; border-top: 1px solid #e2e8f0; }
        .payment-notice { background: #fef3c7; padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b; margin: 25px 0; color: #78350f; }
        .payment-notice a { color: #92400e; font-weight: bold; text-decoration: none; }
        .status-pending { background: #f59e0b; color: white; padding: 5px 12px; border-radius: 99px; font-size: 12px; font-weight: bold; }
        .status-paid { background: #10b981; color: white; padding: 5px 12px; border-radius: 99px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1> Your Booking is Pending</h1><p>Prince Alex Travel - Booking Confirmation</p></div>
        <div class="content">
            <h2>Hello ${name}!</h2>
            <p>Thank you for choosing <strong>Prince Alex Travel Services</strong>. Your booking has been successfully created and is now pending payment. Your seat is reserved for a limited time.</p>
            <div class="payment-notice">
                <h4 style="margin-top: 0;"> Please Complete Your Payment</h4>
                <p style="margin-bottom: 0;">To confirm your ticket, please complete the payment on the booking success page. You can access it by clicking the button below.</p>
                <p style="text-align:center; margin-top:15px;"><a href="https://travel.princealex.pro/booking-success.html?bookingRef=${bookingRef}" style="background-color: #f59e0b; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none;">Complete Payment Now</a></p>
            </div>
            <div class="ticket-info">
                <h3>Your Ticket Details</h3>
                <div class="info-grid">
                    <div class="info-item full-width">
                        <span class="info-label">Booking Reference</span>
                        <span class="info-value highlight">${bookingRef}</span>
                    </div>
                    <div class="info-item full-width">
                        <span class="info-label">Route</span>
                        <span class="info-value">${currentBusRoute}</span>
                    </div>
                    <div class="info-item"><span class="info-label">Travel Date</span><span class="info-value">${currentTravelDate}</span></div>
                    <div class="info-item"><span class="info-label">Departure Time</span><span class="info-value">${currentBusTime}</span></div>
                    <div class="info-item"><span class="info-label">Seat Number</span><span class="info-value">${formattedSeatNumber}</span></div>
                    <div class="info-item"><span class="info-label">Price</span><span class="info-value">Ksh ${currentBusPrice.toLocaleString()}</span></div>
                    <div class="info-item full-width"><span class="info-label">Status</span><span class="info-value"><span class="status-pending">PENDING</span></span></div>
                </div>
            </div>
            <p>Your provisional e-ticket is attached to this email. Please note that this ticket is not valid for travel until payment is completed.</p>
            <p><strong>Need Help?</strong> If you have any questions, please don't hesitate to contact us:</p><p><strong> Email:</strong> senerwaalex@gmail.com<br><strong> Phone:</strong> +254 717 384 875</p>
        </div>
        <div class="footer"><p>&copy; ${new Date().getFullYear()} Prince Alex Digital. All rights reserved.<br>Nairobi, Kenya | Prince Alex Travel Services</p></div>
    </div>
</body></html>`;

                const emailDoc = { to: email, message: { subject: "Your Booking is Pending - Prince Alex Travel ", html: emailHtml } };
                if (pdfBase64SizeBytes <= MAX_PDF_BASE64_SIZE_BYTES) {
                    emailDoc.message.attachments = [{
                        filename: `Ticket_${bookingRef}.pdf`,
                        content: pdfBase64,
                        encoding: "base64"
                    }];
                } else {
                    console.warn(`PDF for booking ${bookingRef} is too large to attach.`);
                }

                emailsToInsert.push(emailDoc);
            }
            
            try {
                // Add new records to the 'bookings' collection
                for (const booking of bookingsToInsert) {
                    await addDoc(collection(firebaseDb, "bookings"), booking);
                }

                // Add email records to the 'mail' collection
                for (const emailDoc of emailsToInsert) { // Renamed loop variable to avoid conflict
                    await addDoc(collection(firebaseDb, "mail"), emailDoc);
                }

                // Update available seats for the bus
                await updateDoc(busDocRef, {
                    available_seats: increment(-selectedSeats.length)
                });

                // Unsubscribe from the real-time listener after successful booking
                if (unsubscribeSnapshot) {
                    unsubscribeSnapshot();
                    unsubscribeSnapshot = null;
                }

                // If successful, store the last booking reference and redirect
                localStorage.setItem('lastBookingRef', lastBookingRef); // Store the ID of the last booking in the batch

                // Display success message and then redirect automatically after a delay
                const successMessage = `Your seat(s) ${selectedSeats.sort((a, b) => a - b).map(s => `S${s}`).join(', ')} have been reserved and are now pending payment. A provisional ticket has been sent to your email. Please complete the payment to confirm your booking.`;
                const redirectUrl = `booking-success.html?bookingRef=${lastBookingRef}`;
                const successButton = `<button class="popup-button primary" onclick="window.location.href='${redirectUrl}'">Complete Payment</button>`;

                showPopup(
                    ' Seats Reserved!',
                    successMessage,
                    'success',
                    successButton
                );

                closeModal(); // Close the seat selection modal

            } catch (error) {
                console.error('Error confirming booking:', error.message);
                displayCustomMessage('Error confirming booking: ' + error.message);
            }
        }

        function toggleChat() {
            const chatContainer = document.getElementById('aiAssistantChat');
            // Check for 'chat-hidden' class to determine current state
            const isHidden = chatContainer.classList.contains('chat-hidden'); 

            if (isHidden) {
                // If currently hidden, remove 'chat-hidden' to make it display:flex
                chatContainer.classList.remove('chat-hidden'); 
                // A small timeout is often needed to allow the browser to register the display change
                // before applying the transition properties.
                setTimeout(() => {
                    chatContainer.classList.add('chat-visible'); // Add 'chat-visible' to trigger opacity/transform transition
                }, 10); 
            } else {
                // If currently visible, remove 'chat-visible' to start the reverse transition
                chatContainer.classList.remove('chat-visible'); 
                // After the transition completes (300ms, matching CSS), add 'chat-hidden' to set display:none
                setTimeout(() => {
                    chatContainer.classList.add('chat-hidden'); 
                }, 300); // This timeout should match the CSS transition duration for a smooth close
            }
        }

        // Variable to store chat history for the AI assistant
        let chatHistory = [];

        // New functions for chat
        function appendMessage(message, sender) {
            const chatBody = document.getElementById('chatBody');
            const messageElement = document.createElement('p');
            messageElement.classList.add(sender + '-message'); // For potential future styling
            messageElement.textContent = message;
            chatBody.appendChild(messageElement);
            chatBody.scrollTop = chatBody.scrollHeight; // Scroll to bottom
        }

        // Function to send quick messages from buttons
        function sendQuickMessage(message) {
            const chatInput = document.getElementById('chatInput');
            chatInput.value = message;
            handleChatInput();
        }

        // Hero CTA button functions
        function scrollToBooking() {
            document.querySelector('.booking').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        function scrollToContact() {
            document.querySelector('#contact-us').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }

        // Newsletter subscription function
        function subscribeNewsletter() {
            const emailInput = document.querySelector('.newsletter-form input');
            const email = emailInput.value.trim();
            
            if (!email) {
                showPopup('Email Required', 'Please enter your email address to subscribe to our newsletter.', 'warning');
                return;
            }
            
            // Simulate newsletter subscription
            showPopup(
                ' Welcome to Our Newsletter!',
                'Thank you for subscribing! You\'ll now receive updates about our latest offers, travel news, and special promotions directly to your inbox.',
                'success'
            );
            emailInput.value = '';
        }

        // Custom Popup Functions
        function showPopup(title, message, type = 'info', buttons = null) {
            const overlay = document.getElementById('popupOverlay');
            const icon = document.getElementById('popupIcon');
            const titleEl = document.getElementById('popupTitle');
            const messageEl = document.getElementById('popupMessage');
            const buttonsEl = document.getElementById('popupButtons');

            // Set icon based on type
            const icons = {
                success: '',
                error: '',
                warning: '',
                info: ''
            };
            icon.textContent = icons[type] || icons.info;
            icon.className = `popup-icon ${type}`;

            // Set content
            titleEl.textContent = title;
            messageEl.textContent = message;

            // Set buttons
            if (buttons) {
                buttonsEl.innerHTML = buttons;
            } else {
                buttonsEl.innerHTML = '<button class="popup-button primary" onclick="closePopup()">Got it!</button>';
            }

            // Show popup
            overlay.classList.add('show');
        }

        function closePopup() {
            const overlay = document.getElementById('popupOverlay');
            overlay.classList.remove('show');
        }

        // Close popup when clicking outside
        document.getElementById('popupOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closePopup();
            }
        });

        // Function to show auto-dismiss popup (disappears after 3 seconds)
        function showAutoPopup(title, message, type = 'info') {
            const overlay = document.getElementById('popupOverlay');
            const icon = document.getElementById('popupIcon');
            const titleEl = document.getElementById('popupTitle');
            const messageEl = document.getElementById('popupMessage');
            const buttonsEl = document.getElementById('popupButtons');

            // Set icon based on type
            const icons = {
                success: '',
                error: '',
                warning: '',
                info: ''
            };
            icon.textContent = icons[type] || icons.info;
            icon.className = `popup-icon ${type}`;

            // Set content
            titleEl.textContent = title;
            messageEl.textContent = message;

            // Hide buttons for auto-dismiss popup
            buttonsEl.innerHTML = '';

            // Show popup
            overlay.classList.add('show');

            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                overlay.classList.remove('show');
            }, 3000);
        }

        // Fallback response function for when AI API is not available
        function generateFallbackResponse(message, additionalContext) {
            const lowerMessage = message.toLowerCase();
            
            // Bus route queries
            if (lowerMessage.includes('bus') || lowerMessage.includes('route') || lowerMessage.includes('ticket')) {
                if (additionalContext && additionalContext.includes('bus schedule information')) {
                    return `Based on your query about bus routes, here's what I found:\n\n${additionalContext}\n\nFor real-time booking and more detailed information, please use our booking form above or contact our support team at senerwaalex@gmail.com or call +254 717 384 875.`;
                } else {
                    return `I can help you with bus route information! Please specify your origin and destination (e.g., "buses from Nairobi to Kisumu") and I'll provide you with available routes and schedules.\n\nYou can also use our booking form above to search for buses directly.`;
                }
            }
            
            // Contact/support queries
            if (lowerMessage.includes('contact') || lowerMessage.includes('support') || lowerMessage.includes('help')) {
                return `For immediate assistance, please contact our support team:\n\n Email: senerwaalex@gmail.com\n Phone: +254 717 384 875\n Location: Nairobi, Kenya\n\nWe're here to help with your travel needs!`;
            }
            
            // General travel questions
            if (lowerMessage.includes('travel') || lowerMessage.includes('journey') || lowerMessage.includes('trip')) {
                return `Welcome to Prince Alex Travel Services! We provide comfortable and safe bus travel across Kenya.\n\nOur services include:\n Online ticket booking\n Multiple routes across Kenya\n Comfortable, air-conditioned buses\n Professional drivers\n 24/7 customer support\n\nTo book your ticket, use our booking form above or contact us directly.`;
            }
            
            // Pricing questions
            if (lowerMessage.includes('price') || lowerMessage.includes('cost') || lowerMessage.includes('fare')) {
                return `Our ticket prices vary depending on the route and travel date. To get accurate pricing for your specific journey:\n\n1. Use our booking form above to search for buses\n2. Select your preferred route and date\n3. View real-time pricing and availability\n\nFor special group bookings or inquiries, please contact us at senerwaalex@gmail.com or call +254 717 384 875.`;
            }
            
            // Default response
            return `Thank you for your message! I'm here to help with your travel inquiries.\n\nI can assist you with:\n Bus route information\n Booking assistance\n Travel advice\n Contact information\n\nFor specific questions about routes, please mention your origin and destination. For immediate support, contact us at senerwaalex@gmail.com or call +254 717 384 875.`;
        }

        // Function to search buses for the AI assistant
        async function searchBusesForAI(from, to, date) {
            const busesRef = collection(firebaseDb, "buses");
            // Capitalize first letter of from/to for consistent querying with Firestore data
            const capitalizedFrom = from.charAt(0).toUpperCase() + from.slice(1).toLowerCase();
            const capitalizedTo = to.charAt(0).toUpperCase() + to.slice(1).toLowerCase();

            const q = query(busesRef,
                            where("origin", "==", capitalizedFrom),
                            where("destination", "==", capitalizedTo),
                            where("travelDate", "==", date));

            try {
                const querySnapshot = await getDocs(q);
                const buses = [];
                querySnapshot.forEach((doc) => {
                    buses.push(doc.data());
                });

                if (buses.length === 0) {
                    return `No buses found from ${capitalizedFrom} to ${capitalizedTo} on ${date}.`;
                }

                let formattedData = `Available buses from ${capitalizedFrom} to ${capitalizedTo} on ${date}:\n`;
                buses.forEach(bus => {
                    const busName = bus.busName || bus.company || 'Bus';
                    formattedData += `- ${busName} departing at ${bus.departureTime}, Price: Ksh ${bus.price}, Available Seats: ${bus.available_seats} (Total: ${bus.totalSeats})\n`; // Corrected field name
                });
                return formattedData;

            } catch (error) {
                console.error("Error fetching bus data for AI:", error);
                return null; // Indicate error
            }
        }

        async function handleChatInput() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if (message) {
                appendMessage(message, 'user');
                chatInput.value = '';

                // Show typing indicator
                const chatBody = document.getElementById('chatBody');
                const typingIndicator = document.createElement('p');
                typingIndicator.classList.add('bot-message');
                typingIndicator.textContent = 'AI is typing...';
                typingIndicator.id = 'typingIndicator';
                chatBody.appendChild(typingIndicator);
                chatBody.scrollTop = chatBody.scrollHeight;
                
                let promptText = message;
                let additionalContext = "";
                const todayDate = new Date().toISOString().split("T")[0]; // "YYYY-MM-DD"

                // Simple detection for bus route queries
                const busQueryMatch = message.toLowerCase().match(/(?:bus|route|ticket|fare|price|seats)\s+(?:from\s+([\w\s]+))?\s*(?:to\s+([\w\s]+))?/);

                if (busQueryMatch) {
                    let fromLocation = busQueryMatch[1] ? busQueryMatch[1].trim() : '';
                    let toLocation = busQueryMatch[2] ? busQueryMatch[2].trim() : '';

                    // Attempt to infer locations if only one is provided or if general query
                    if (!fromLocation && !toLocation) {
                        additionalContext = "\n\nTo get specific bus information, please tell me the origin and destination, for example: 'buses from Nairobi to Kisumu'.";
                    } else {
                        try {
                            const busData = await searchBusesForAI(fromLocation, toLocation, todayDate);
                            if (busData && !busData.startsWith("No buses found")) {
                                additionalContext = `\n\nHere is relevant bus schedule information for ${fromLocation || 'any'} to ${toLocation || 'any'} on ${todayDate}:\n${busData}\n\n`;
                            } else {
                                additionalContext = `\n\nI don't have that specific bus information right now for ${fromLocation || 'your specified origin'} to ${toLocation || 'your specified destination'} on ${todayDate}. Please contact our customer support at senerwaalex@gmail.com or call +254 717 384 875 for further assistance.`;
                            }
                        } catch (error) {
                            console.error("Error fetching bus data for AI:", error);
                            additionalContext = "\n\nI had trouble looking up bus information right now. Please try again later or contact support at senerwaalex@gmail.com or call +254 717 384 875.";
                        }
                    }
                } else if (message.toLowerCase().includes("chat with agent") || message.toLowerCase().includes("speak to someone") || message.toLowerCase().includes("human help")) {
                    additionalContext = "\n\nI understand you'd like to speak with a human agent. Please contact our customer support directly at senerwaalex@gmail.com or call +254 717 384 875. They will be happy to assist you.";
                } else if (message.toLowerCase().includes("contact") || message.toLowerCase().includes("support")) {
                    additionalContext = "\n\nYou can reach our customer support at senerwaalex@gmail.com or call +254 717 384 875.";
                }


                // Construct the full prompt for Gemini
                let chatHistoryForGemini = [];
                chatHistoryForGemini.push({ role: "user", parts: [{ text: promptText + additionalContext }] });

                try {
                    // Check if we have a valid API key
                    const apiKey = "AIzaSyDGErPBeQ1Fdx9EHPXOHepoEoOx7P2f57o"; // Using the same Firebase API key for now
                    
                    if (!apiKey || apiKey === "") {
                        // Fallback response when no API key is available
                        typingIndicator.remove();
                        const fallbackResponse = generateFallbackResponse(message, additionalContext);
                        appendMessage(fallbackResponse, 'bot');
                        return;
                    }

                    const payload = { 
                        contents: chatHistoryForGemini,
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 1024,
                        }
                    };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Check if the response itself was successful (HTTP status 200-299)
                    if (!response.ok) {
                        const errorBody = await response.text(); // Get raw error body
                        console.error(`Gemini API HTTP Error: ${response.status} ${response.statusText}`, errorBody);
                        typingIndicator.remove();
                        // Use fallback response instead of generic error
                        const fallbackResponse = generateFallbackResponse(message, additionalContext);
                        appendMessage(fallbackResponse, 'bot');
                        return;
                    }

                    const result = await response.json();
                    console.log("Gemini API raw result:", result); // Log the full result for debugging

                    // Remove typing indicator
                    typingIndicator.remove();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const aiResponse = result.candidates[0].content.parts[0].text;
                        appendMessage(aiResponse, 'bot');
                        // Add AI response to chat history
                        chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                    } else {
                        // Check for prompt feedback (e.g., safety issues)
                        if (result.promptFeedback && result.promptFeedback.blockReason) {
                            const fallbackResponse = generateFallbackResponse(message, additionalContext);
                            appendMessage(fallbackResponse, 'bot');
                            console.warn("Gemini API blocked response:", result.promptFeedback);
                        } else if (result.candidates && result.candidates.length > 0 && result.candidates[0].finishReason) {
                            // Check for finish reason if no content was generated
                            const fallbackResponse = generateFallbackResponse(message, additionalContext);
                            appendMessage(fallbackResponse, 'bot');
                            console.warn("Gemini API finished without content:", result.candidates[0].finishReason);
                        } else {
                            // Generic error if structure is unexpected
                            const fallbackResponse = generateFallbackResponse(message, additionalContext);
                            appendMessage(fallbackResponse, 'bot');
                            console.error("AI response structure unexpected or empty candidates:", result);
                        }
                    }
                } catch (error) {
                    // Remove typing indicator on error as well
                    const currentTypingIndicator = document.getElementById('typingIndicator');
                    if (currentTypingIndicator) {
                        currentTypingIndicator.remove();
                    }
                    // Use fallback response instead of generic error message
                    const fallbackResponse = generateFallbackResponse(message, additionalContext);
                    appendMessage(fallbackResponse, 'bot');
                    console.error("Error calling Gemini API:", error);
                }
            }
        }

        // --- Update Authentication Links ---
        function updateAuthLinks() {
            const myProfileLink = document.getElementById('myProfileLink');
            const loginRegisterLink = document.getElementById('loginRegisterLink');
            const logoutLink = document.getElementById('logoutLink');

            if (window.currentUser) {
                // User is logged in
                loginRegisterLink.style.display = 'none';
                myProfileLink.style.display = 'block';
                logoutLink.style.display = 'block';
            } else {
                // User is not logged in
                loginRegisterLink.style.display = 'block';
                myProfileLink.style.display = 'none';
                logoutLink.style.display = 'none';
            }
        }

        // --- Logout Function ---
        async function logout() {
            try {
                await window.signOutFirebase(window.firebaseAuth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Add logout event listener
        document.addEventListener('DOMContentLoaded', () => {
            const logoutLink = document.getElementById('logoutLink');
            if (logoutLink) {
                logoutLink.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await logout();
                });
            }
            
        });
    </script>

    <!-- Custom Popup Modal -->
    <div id="popupOverlay" class="popup-overlay">
        <div class="popup-modal">
            <button class="popup-close" onclick="closePopup()">&times;</button>
            <div class="popup-icon" id="popupIcon"></div>
            <h3 class="popup-title" id="popupTitle"></h3>
            <p class="popup-message" id="popupMessage"></p>
            <div class="popup-buttons" id="popupButtons">
                <button class="popup-button primary" onclick="closePopup()">Got it!</button>
            </div>
        </div>
    </div>

</body>
</html>
