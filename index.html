<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Prince Alex Travel Services</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, increment, onSnapshot, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGErPBeQ1Fdx9EHPXOHepoEoOx7P2f57o",
            authDomain: "princealextravel.firebaseapp.com",
            projectId: "princealextravel",
            storageBucket: "princealextravel.firebasestorage.app",
            messagingSenderId: "947577729462",
            appId: "1:947577729462:web:dd4b4c7cb4a984c5e3d117"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase instances and functions globally accessible
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOutFirebase = signOut; // Renamed to avoid conflict with window.signOut
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.addDoc = addDoc;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.increment = increment;
        window.onSnapshot = onSnapshot;
        window.getDoc = getDoc;
        window.serverTimestamp = serverTimestamp; // Expose serverTimestamp as well

        // Global variable for current user, populated by onAuthStateChanged
        window.currentUser = null;
        window.currentUserProfile = null; // To store additional profile data

        // Listen for authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                window.currentUser = user;
                // Fetch user profile from Firestore
                const userProfileRef = doc(db, "users", user.uid);
                const userProfileSnap = await getDoc(userProfileRef);
                if (userProfileSnap.exists()) {
                    window.currentUserProfile = userProfileSnap.data();
                } else {
                    console.log("No user profile found in Firestore for:", user.uid);
                    window.currentUserProfile = {
                        fullName: user.email, // Fallback if no profile
                        email: user.email
                    };
                }
            } else {
                // User is signed out
                window.currentUser = null;
                window.currentUserProfile = null;
            }
            updateAuthLinks(); // Update navigation links based on auth state
        });
    </script>
    <style>
        /* Modern CSS Variables for Enhanced Design */
        :root {
            --primary-color: #1e3a8a; /* Modern deep blue */
            --primary-light: #3b82f6; /* Lighter blue for accents */
            --accent-color: #f59e0b; /* Modern amber/gold */
            --accent-light: #fbbf24; /* Light amber */
            --light-bg: #f8fafc; /* Clean light background */
            --white: #ffffff;
            --text-dark: #1e293b; /* Modern dark text */
            --text-light: #64748b; /* Light text */
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            --gradient-accent: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-light) 100%);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Use: Resets default browser margins/ paddings and sets box model for consistent sizing. */
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-dark);
            /* Use: Sets global font, background, and text color. */
        }
        .navbar {
            background: var(--gradient-primary);
            padding: 1rem 0;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            /* Modern sticky navbar with gradient background */
        }
        .navbar-container {
            max-width: 1200px;
            margin: auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Use: Centers and arranges navigation elements horizontally within the navbar. */
        }
        .logo {
            background: var(--white);
            padding: 0.75rem 1rem;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            /* Modern logo container with enhanced styling */
        }
        .logo:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .logo img {
            height: 60px;
            display: block;
            /* Optimized logo size */
        }
        .nav-links {
            display: flex;
            gap: 25px;
            /* Use: Arranges navigation links horizontally with spacing. */
        }
        .nav-links a {
            color: var(--white);
            text-decoration: none;
            font-weight: 500;
            font-size: 1rem;
            position: relative;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            /* Modern navigation links with enhanced styling */
        }
        .nav-links a::after {
            content: '';
            display: block;
            width: 0;
            height: 2px;
            background: var(--accent-color);
            transition: width 0.3s ease;
            position: absolute;
            bottom: 0.25rem;
            left: 50%;
            transform: translateX(-50%);
            /* Centered animated underline */
        }
        .nav-links a:hover::after {
            width: 80%;
            /* Expands the underline width on hover */
        }
        .nav-links a:hover {
            color: var(--accent-color);
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
            /* Enhanced hover effect with background and lift */
        }

        /* Hamburger Menu Icon */
        .menu-toggle {
            display: none; /* Hidden by default, shown on mobile */
            flex-direction: column;
            justify-content: space-around;
            width: 30px;
            height: 25px;
            cursor: pointer;
            z-index: 10001; /* Above nav links when open */
        }

        .menu-toggle .bar {
            width: 100%;
            height: 3px;
            background-color: white;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        /* Animation for hamburger to close icon */
        .menu-toggle.open .bar:nth-child(1) {
            transform: translateY(11px) rotate(45deg);
        }
        .menu-toggle.open .bar:nth-child(2) {
            opacity: 0;
        }
        .menu-toggle.open .bar:nth-child(3) {
            transform: translateY(-11px) rotate(-45deg);
        }

        /* Mobile Navigation Overlay */
        /* This class will be applied to the .nav-links element on mobile */
        @media (max-width: 768px) {
            .nav-links { /* Target the .nav-links directly for mobile styles */
                flex-direction: column;
                position: fixed;
                top: 0;
                right: -100%; /* Start off-screen */
                width: 70%; /* Adjust as needed */
                height: 100%;
                background: var(--gradient-primary); /* Use gradient background for better visibility */
                padding-top: 100px; /* Space for logo/header */
                box-shadow: -2px 0 20px rgba(0,0,0,0.3); /* Stronger shadow for better visibility */
                transition: right 0.3s ease-in-out, opacity 0.3s ease-in-out;
                z-index: 10000;
                opacity: 0; /* Initially hidden */
                pointer-events: none; /* Disable interaction when hidden */
                display: flex; /* Keep it as flex for transitions, but visually hidden */
                backdrop-filter: blur(10px); /* Add blur effect for modern look */
            }

            .nav-links.open { /* This class will be toggled by JS */
                right: 0; /* Slide in */
                opacity: 1; /* Make visible */
                pointer-events: auto; /* Enable interaction */
            }

            .nav-links a {
                padding: 15px 20px;
                border-bottom: 1px solid rgba(255,255,255,0.2); /* More visible border */
                text-align: left;
                width: 100%;
                font-size: 1.1em;
                color: var(--white); /* Ensure white text */
                font-weight: 600; /* Make text bolder */
            }
            .nav-links a:last-child {
                border-bottom: none;
            }
            .nav-links a:hover {
                background-color: rgba(255,255,255,0.1); /* Add hover background */
                color: var(--accent-light);
            }
        }


        .hero {
            background: var(--gradient-primary);
            color: var(--white);
            padding: 6rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            /* Modern hero section with enhanced styling */
        }
        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }
        .hero-content {
            position: relative;
            z-index: 1;
            max-width: 800px;
            margin: 0 auto;
        }
        .hero h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            line-height: 1.2;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            /* Enhanced main heading */
        }
        .hero h2 {
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 1rem;
            color: var(--accent-light);
            /* Subtitle styling */
        }
        .hero p {
            font-size: 1.25rem;
            opacity: 0.95;
            line-height: 1.6;
            margin-bottom: 2rem;
            /* Enhanced paragraph text */
        }
        .booking {
            background: var(--white);
            padding: 4rem 2rem;
            text-align: center;
            position: relative;
            /* Modern booking section */
        }
        .booking-container {
            max-width: 1000px;
            margin: auto;
            /* Centers the content within the booking section */
        }
        .booking h2 {
            margin-bottom: 2rem;
            color: var(--primary-color);
            font-size: 2.5rem;
            font-weight: 700;
            /* Enhanced booking heading */
        }
        .booking-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: var(--light-bg);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            /* Modern grid-based form layout */
        }
        .form-group {
            display: flex;
            flex-direction: column;
            text-align: left;
        }
        .form-group label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .booking-form select,
        .booking-form input[type="date"] {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            background: var(--white);
            transition: all 0.3s ease;
            /* Modern form inputs */
        }
        .booking-form select:focus,
        .booking-form input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            /* Focus states for form inputs */
        }
        .booking-form button[type="submit"] {
            background: var(--gradient-accent);
            color: var(--white);
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            grid-column: 1 / -1;
            margin-top: 1rem;
            /* Modern submit button */
        }
        .booking-form button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            /* Enhanced hover effect */
        }
        .booking-form button:active {
            transform: translateY(0);
        }
        .results-section {
            max-width: 1200px;
            margin: 3rem auto;
            padding: 2rem;
            display: none; /* Initially hidden, controlled by JS */
            /* Modern results section */
        }
        .results-section.active {
            display: block;
            animation: fadeInUp 0.6s ease-out;
            /* Smooth animation when results appear */
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .results-section h2 {
            margin-bottom: 2rem;
            color: var(--primary-color);
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            /* Enhanced results heading */
        }
        .result-card {
            background: var(--white);
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex-wrap: wrap;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            /* Modern result cards with enhanced styling */
        }
        .result-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            /* Enhanced hover effect */
        }
        .result-card img {
            width: 120px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
            /* Enhanced bus image styling */
        }
        .result-details {
            flex: 1;
            min-width: 250px;
            /* Enhanced details container */
        }
        .result-details h4 {
            margin: 0 0 0.75rem;
            color: var(--primary-color);
            font-size: 1.25rem;
            font-weight: 600;
            /* Enhanced route heading */
        }
        .result-details p {
            margin: 0.5rem 0;
            font-size: 0.95rem;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            /* Enhanced detail text */
        }
        .result-details p i {
            color: var(--accent-color);
            width: 16px;
        }
        .book-btn {
            background: var(--gradient-accent);
            color: var(--white);
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-left: auto;
            flex-shrink: 0;
            font-size: 1rem;
            /* Modern book button */
        }
        .book-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            /* Enhanced hover effect */
        }
        .book-btn:active {
            transform: translateY(0);
        }
        .gallery {
            padding: 4rem 2rem;
            background: var(--light-bg);
            text-align: center;
            /* Modern gallery section */
        }
        .gallery h2 {
            color: var(--primary-color);
            margin-bottom: 2rem;
            font-size: 2.5rem;
            font-weight: 700;
            /* Enhanced gallery heading */
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            /* Enhanced responsive grid layout */
        }
        .image-grid img {
            width: 100%;
            height: 250px;
            border-radius: 16px;
            object-fit: cover;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            /* Enhanced image styling */
        }
        .image-grid img:hover {
            transform: scale(1.05) translateY(-8px);
            box-shadow: var(--shadow-xl);
            /* Enhanced hover effect with lift */
        }
        .footer {
            background: var(--gradient-primary);
            color: var(--white);
            padding: 3rem 2rem 1rem;
            text-align: center;
            font-size: 0.95rem;
            /* Modern footer styling */
        }
        .footer-content {
            max-width: 1200px;
            margin: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            text-align: left;
            /* Enhanced footer layout */
        }
        .footer-section {
            flex: 1;
            min-width: 200px;
        }
        .footer-section h4 {
            color: var(--accent-color);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            /* Enhanced footer headings */
        }
        .footer-section a,
        .footer-section p {
            display: block;
            color: var(--white);
            margin: 0.5rem 0;
            text-decoration: none;
            transition: color 0.3s ease;
            /* Enhanced footer links */
        }
        .footer-section a:hover {
            color: var(--accent-color);
            transform: translateX(4px);
            /* Enhanced hover effect */
        }
        .footer-bottom {
            margin-top: 2rem;
            padding-top: 1.5rem;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.8;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            /* Enhanced footer bottom */
        }

        /* --- Seat Selection Modal Styling --- */
        #seatModal, #loginChoiceModal { /* Apply same base styles to both modals */
            display: none; /* Initially hidden, controlled by JS */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7); /* Darker overlay */
            z-index: 9999;
            justify-content: center; /* Use flexbox for centering when visible */
            align-items: center;
            padding: 20px; /* Add some padding for smaller screens */
            box-sizing: border-box; /* Include padding in element's total width and height */
            /* Use: Styles the modal overlay for seat selection, making it full screen and centered. */
        }

        #seatModal > div, #loginChoiceModal > div { /* Apply same inner modal styles */
            background:#fff;
            max-width:700px; /* Slightly wider for 32 seats */
            width: 100%; /* Ensure it takes available width */
            padding:30px;
            border-radius:12px;
            position:relative;
            box-shadow: 0 8px 16px rgba(0,0,0,0.25);
            max-height: 90vh; /* Limit height for scrollability */
            overflow-y: auto; /* Enable scrolling if content overflows */
            text-align: center; /* Center text in choice modal */
            /* Use: Styles the modal content box (white background, rounded corners, shadow, scrollable). */
        }

        #seatModal h3, #loginChoiceModal h3 {
            margin-bottom:20px;
            color: var(--primary-color); /* Using your primary color */
            text-align: center;
            font-size: 1.8em;
            /* Use: Styles the heading inside the seat selection modal. */
        }

        #seatGrid {
            display:grid;
            /* grid-template-columns will be set by JS dynamically */
            gap:12px; /* Default gap */
            margin-bottom:25px;
            justify-items: center; /* Center seat icons within their grid cells */
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 8px;
            background-color: #fdfdfd;
            /* Use: Creates a grid layout for displaying bus seats. */
        }

        .seat-container {
            position: relative;
            width: 60px; /* Adjust size of seat container */
            height: 60px; /* Adjust size of seat container */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 8px;
            transition: transform 0.2s ease, background-color 0.2s ease;
            /* Use: Styles individual seat containers, making them clickable and setting initial appearance. */
        }

        .seat-container .seat-icon {
            font-size: 3em; /* Large seat icon */
            color: #7f8c8d; /* Default grey color for available seats */
            transition: color 0.2s ease;
            /* Use: Styles the Font Awesome chair icon within a seat. */
        }

        .seat-container .seat-number {
            font-size: 0.75em;
            font-weight: bold;
            color: #555;
            margin-top: 5px;
            /* Use: Styles the seat number label. */
        }

        /* Styles for Selected Seat */
        .seat-container.selected .seat-icon {
            color: var(--accent-color); /* Using your accent color for selected */
            /* Use: Changes seat icon color to accent color when selected. */
        }
        .seat-container.selected .seat-number {
            color: var(--accent-color);
            /* Use: Changes seat number color to accent color when selected. */
        }
        .seat-container.selected {
            background-color: #fcefdc; /* Light accent background */
            transform: scale(1.05);
            /* Use: Adds a light background and slight scale effect to selected seats. */
        }

        /* Styles for Booked Seat */
        .seat-container.booked {
            cursor: not-allowed;
            /* Use: Changes cursor for booked seats to indicate they are not clickable. */
        }
        .seat-container.booked .seat-icon {
            color: #c0392b; /* Red for booked */
            /* Use: Changes seat icon color to red for booked seats. */
        }
        .seat-container.booked .seat-number {
            color: #c0392b;
            /* Use: Changes seat number color to red for booked seats. */
        }
        .seat-container.booked::after {
            content: 'X'; /* Add an 'X' for booked seats */
            position: absolute;
            font-size: 2.5em;
            color: rgba(255, 255, 255, 0.7);
            text-shadow: 0 0 5px rgba(0,0,0,0.5);
            background-color: rgba(0,0,0,0.3); /* Dark overlay */
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            top: 0; /* Position correctly over the seat */
            left: 0; /* Position correctly over the seat */
            /* Use: Adds a semi-transparent 'X' overlay to visually mark booked seats. */
        }
        .driver-area {
            grid-column: 1 / -1; /* Span all columns */
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: #002d6b;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        /* Input Fields in Modal */
        #seatModal input[type="text"],
        #seatModal input[type="tel"],
        #seatModal input[type="email"],
        #seatModal select { /* Added select for gender */
            padding:12px 15px;
            width:100%;
            margin-bottom:15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box; /* Crucial for width to include padding and border */
            font-size: 1em;
            /* Use: Styles input fields and dropdowns within the seat selection modal. */
        }

        /* Modal Buttons */
        #seatModal button, #loginChoiceModal button {
            padding:12px 25px;
            border:none;
            border-radius:8px;
            cursor:pointer;
            font-size: 1.05em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.1s ease;
            margin: 0 10px; /* Add margin between buttons */
            /* Use: Base styles for buttons within the seat selection modal. */
        }

        #seatModal button:active, #loginChoiceModal button:active {
            transform: translateY(1px); /* Slight press effect */
            /* Use: Adds a subtle press effect when modal buttons are clicked. */
        }

        #seatModal button[onclick="confirmBooking()"],
        #loginChoiceModal button[onclick="proceedAsGuest()"] {
            background: var(--accent-color); /* Use accent color for proceed */
            color:white;
            /* Use: Styles the "Proceed to Pay" button with the accent color. */
        }

        #seatModal button[onclick="confirmBooking()"]:hover,
        #loginChoiceModal button[onclick="proceedAsGuest()"]:hover {
            background-color: #b27e0f; /* Darker accent */
            /* Use: Darkens "Proceed to Pay" button on hover. */
        }

        #seatModal button[onclick="closeModal()"],
        #loginChoiceModal button[onclick="redirectToLogin()"] {
            background:#ccc; /* Grey for cancel/login */
            color: var(--text-dark); /* Dark text on grey */
            /* Use: Styles the "Cancel" button. */
        }

        #seatModal button[onclick="closeModal()"]:hover,
        #loginChoiceModal button[onclick="redirectToLogin()"]:hover {
            background-color: #bbb;
            /* Use: Darkens "Cancel" button on hover. */
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 768px) {
            .navbar-container {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            .nav-links {
                flex-direction: column;
                position: fixed;
                top: 0;
                right: -100%;
                width: 80%;
                height: 100%;
                background: var(--gradient-primary);
                padding-top: 100px;
                box-shadow: var(--shadow-xl);
                transition: right 0.3s ease-in-out, opacity 0.3s ease-in-out;
                z-index: 10000;
                opacity: 0;
                pointer-events: none;
                display: flex;
            }
            .nav-links.open {
                right: 0;
                opacity: 1;
                pointer-events: auto;
            }
            .menu-toggle {
                display: flex;
            }
            
            /* Hero Section Mobile */
            .hero {
                padding: 3rem 1rem;
            }
            .hero h1 {
                font-size: 2.5rem;
            }
            .hero h2 {
                font-size: 1.25rem;
            }
            .hero p {
                font-size: 1rem;
            }
            
            /* Booking Form Mobile */
            .booking {
                padding: 2rem 1rem;
            }
            .booking h2 {
                font-size: 2rem;
            }
            .booking-form {
                grid-template-columns: 1fr;
                padding: 1.5rem;
                gap: 1rem;
            }
            
            /* Results Section Mobile */
            .results-section {
                padding: 1rem;
            }
            .results-section h2 {
                font-size: 1.75rem;
            }
            .result-card {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
                gap: 1rem;
            }
            .result-card img {
                width: 100%;
                height: 200px;
            }
            .result-details {
                min-width: unset;
                width: 100%;
            }
            .book-btn {
                margin-left: unset;
                margin-top: 1rem;
                width: 100%;
            }
            
            /* Gallery Mobile */
            .gallery {
                padding: 2rem 1rem;
            }
            .gallery h2 {
                font-size: 2rem;
            }
            .image-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            /* Modal Mobile */
            .seat-container {
                width: 45px;
                height: 45px;
            }
            .seat-container .seat-icon {
                font-size: 2em;
            }
            #seatModal > div, #loginChoiceModal > div {
                margin: 1rem;
                padding: 1.5rem;
            }
            #seatModal input, #seatModal select {
                padding: 0.75rem;
            }
            #seatModal button, #loginChoiceModal button {
                padding: 0.75rem 1.5rem;
                font-size: 0.95em;
            }
            
            /* Footer Mobile */
            .footer {
                padding: 2rem 1rem 1rem;
            }
            .footer-content {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                text-align: center;
            }
            .footer-section h4 {
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            /* Removed specific seatGrid columns for 480px, let JS handle it dynamically */
            .seat-container {
                width: 45px;
                height: 45px;
            }
            .seat-container .seat-icon {
                font-size: 2em;
            }
            /* Use: Further reduces seat and icon size for very small screens. */
            .book-now-btn, #seatModal button, #loginChoiceModal button {
                font-size: 0.9em;
                padding: 10px 15px;
            }
            /* Use: Adjusts button font size and padding for very small screens. */
        }

        /* AI Assistant Button */
        #aiAssistantButton {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: var(--primary-color);
            color: rgb(245, 209, 4);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8em;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            z-index: 10000; /* Ensure it's above everything */
            transition: background-color 0.3s ease, transform 0.3s ease;
            /* Use: Darkens and slightly scales the AI button on hover. */
        }

        #aiAssistantButton:hover {
            background-color: #001c44; /* Darker primary */
            transform: scale(1.05);
            /* Use: Darkens and slightly scales the AI button on hover. */
        }

        /* AI Assistant Chat Interface */
        #aiAssistantChat {
            position: fixed;
            bottom: 100px; /* Position above the button */
            right: 30px;
            width: 320px;
            height: 400px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
            transform: translateY(20px) scale(0.9);
            opacity: 0;
            pointer-events: none; /* Disable interaction when hidden */
            /* Use: Styles the chat window (position, size, appearance, initial hidden state). */
        }

        #aiAssistantChat.chat-visible {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: auto; /* Enable interaction when visible */
            /* Use: Applies transformation and opacity to make chat window visible with animation. */
        }

        .chat-hidden {
            display: none; /* For initial state and complete hiding */
            /* Use: Hides the chat window completely when not in use. */
        }

        .chat-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Use: Styles the header of the chat window (background, text, layout). */
        }

        .chat-header h3 {
            margin: 0;
            font-size: 1.2em;
            /* Use: Styles the title in the chat header. */
        }

        .chat-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            /* Use: Styles the close button in the chat header. */
        }

        .chat-close-btn:hover {
            color: var(--accent-color);
            /* Use: Changes close button color on hover. */
        }

        .chat-body {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
            /* Use: Styles the main message display area of the chat window (scrollable). */
        }

        /* --- Chat Message Styling --- */
        .chat-body p {
            max-width: 80%; /* Limit message bubble width */
            padding: 8px 12px;
            border-radius: 15px; /* Rounded corners for bubbles */
            margin-bottom: 10px; /* Space between messages */
            line-height: 1.4;
            word-wrap: break-word; /* Ensure long words break */
        }

        .user-message {
            background-color: var(--primary-color); /* User messages blue */
            color: white;
            align-self: flex-end; /* Align to the right */
            margin-left: auto; /* Push to the right */
            border-bottom-right-radius: 2px; /* Sharpen bottom-right corner */
        }

        .bot-message {
            background-color: #e0e0e0; /* Bot messages light grey */
            color: var(--text-dark);
            align-self: flex-start; /* Align to the left */
            margin-right: auto; /* Push to the left */
            border-bottom-left-radius: 2px; /* Sharpen bottom-left corner */
        }
        /* --- End Chat Message Styling --- */


        .chat-footer {
            padding: 15px;
            display: flex;
            gap: 10px;
            border-top: 1px solid #eee;
            background-color: #f0f0f0;
            /* Use: Styles the input area at the bottom of the chat window. */
        }

        .chat-footer input[type="text"] {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95em;
            /* Use: Styles the text input field in the chat footer. */
        }

        .chat-footer button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
            /* Use: Darkens the "Send" button on hover. */
        }

        .chat-footer button:hover {
            background-color: #b27e0f;
            /* Use: Darkens the "Send" button on hover. */
        }

        /* Responsive adjustments for chat */
        @media (max-width: 600px) {
            #aiAssistantButton {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
                bottom: 20px;
                right: 20px;
            }
            /* Use: Adjusts AI button size and position for smaller screens. */
            #aiAssistantChat {
                width: calc(100% - 40px); /* Full width minus margin */
                height: calc(80vh - 100px); /* Adjust height */
                bottom: 80px;
                right: 20px;
            }
            /* Use: Adjusts chat window size and position for smaller screens. */
        }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="navbar-container">
            <div class="logo">
                <img src="mylogo.png" alt="Prince Alex Logo" />
            </div>
            <!-- Hamburger Menu Icon -->
            <div class="menu-toggle" id="mobile-menu">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
            <nav class="nav-links" id="main-nav">
                <a href="index.html">Home</a>
                <a href="about-us.html">About Us</a>
                <a href="#contact-us">Contact</a>
                <a href="ticket-lookup.html">Print Ticket</a>
                <a href="admin.html">Admin Login</a>
                <a href="profile.html" id="myProfileLink" style="display:none;">My Profile</a>
                <a href="login-register.html" id="loginRegisterLink">Login / Register</a>
                <a href="#" id="logoutLink" style="display:none;">Logout</a>
            </nav>
        </div>
    </header>

    <section class="hero">
        <div class="hero-content">
            <h1>Welcome to Prince Alex Digital Travel Services</h1>
            <h2>Travel with Comfort and Safety</h2>
            <p>Your journey, our priority. Book your bus tickets online with Prince Alex Travel Services for a seamless experience.</p>
        </div>
    </section>

    <section class="booking">
        <div class="booking-container">
            <h2>Book Your Ticket</h2>
            <form class="booking-form" onsubmit="event.preventDefault(); searchResults();">
                <div class="form-group">
                    <label for="from">From</label>
                    <select id="from" required>
                        <option value="">Select Origin</option>
                        <option>Nairobi</option>
                        <option>Kisumu</option>
                        <option>Eldoret</option>
                        <option>Mombasa</option>
                        <option>Nakuru</option>
                        <option>Kericho</option>
                        <option>Kakamega</option>
                        <option>Kitale</option>
                        <option>Nyeri</option>
                        <option>Busia</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="to">To</label>
                    <select id="to" required>
                        <option value="">Select Destination</option>
                        <option>Nairobi</option>
                        <option>Kisumu</option>
                        <option>Eldoret</option>
                        <option>Mombasa</option>
                        <option>Nakuru</option>
                        <option>Kericho</option>
                        <option>Kakamega</option>
                        <option>Kitale</option>
                        <option>Nyeri</option>
                        <option>Busia</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="travelDate">Travel Date</label>
                    <input type="date" id="travelDate" required />
                </div>
                <button type="submit">
                    <i class="fas fa-search"></i> Search Buses
                </button>
            </form>
        </div>
    </section>

    <section class="results-section" id="results"></section>
    <section class="gallery">
        <div class="gallery-container">
            <h2>Our Travel Experience</h2>
            <div class="image-grid">
                <img src="Bus1.png" alt="Luxury Bus">
                <img src="Bus2.png" alt="VIP Interior">
                <img src="Bus3.png" alt="Clean and Air Conditioned">
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section" id="contact-us">
                <h4>Contact Us</h4>
                <p>Email: senerwaalex@gmail.com</p>
                <p>Phone: +254 717 384 875</p>
                <p>Location: Nairobi, Kenya</p>
            </div>
            <div class="footer-section">
                <h4>Quick Links</h4>
                <a href="index.html">Home</a>
                <a href="about-us.html">About Us</a>
                <a href="ticket-lookup.html">Print Ticket</a>
                <a href="admin.html">Admin Login</a>
            </div>
            <div class="footer-section">
                <h4>Follow Us</h4>
                <a href="#">Facebook</a>
                <a href="#">Instagram</a>
                <a href="#">Twitter</a>
            </div>
        </div>
        <div class="footer-bottom">
            &copy; 2025 Prince Alex Digital. All rights reserved.
        </div>
    </footer>

    <div id="loginChoiceModal">
        <div>
            <h3>How would you like to proceed?</h3>
            <p>To book your seat, you can log in/sign up or continue as a guest.</p>
            <div style="margin-top: 25px;">
                <button onclick="redirectToLogin()">Login / Sign Up</button>
                <button onclick="proceedAsGuest()">Proceed as Guest</button>
            </div>
        </div>
    </div>

    <div id="seatModal">
        <div>
            <h3 style="margin-bottom:15px;">Select Your Seat for <span id="busDetails"></span></h3>
            <div style="font-size: 0.9em; margin-bottom: 15px; text-align: center;">
                <p>Selected Seats: <span id="selectedSeatsDisplay">None</span></p>
            </div>
            <div id="seatGrid"></div>
            <div style="margin-bottom:10px;">
                <input type="text" id="passengerName" placeholder="Your Full Name" required />
                <input type="text" id="passengerID" placeholder="ID Number" required />
                <select id="passengerGender" required>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
                <input type="tel" id="passengerPhone" placeholder="Phone Number" required />
                <input type="email" id="passengerEmail" placeholder="Email Address" required />
            </div>
            <button onclick="confirmBooking()">Proceed to Pay</button>
            <button onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <div id="aiAssistantButton">
        <i class="fas fa-comments"></i>
    </div>

    <div id="aiAssistantChat" class="chat-hidden">
        <div class="chat-header">
            <h3>AI Assistant</h3>
            <button class="chat-close-btn" onclick="toggleChat()">&times;</button>
        </div>
        <div class="chat-body" id="chatBody">
            <p class="bot-message">Hello! I am your Prince Alex Travel AI Assistant. I can answer general questions about travel or provide information about bus routes if you tell me the origin and destination. How can I assist you today?</p>
        </div>
        <div class="chat-footer">
            <input type="text" placeholder="Type your message..." id="chatInput" />
            <button id="sendChatBtn">Send</button>
        </div>
    </div>

    <script>
        // Set min date for travelDate input to today
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("travelDate").setAttribute("min", today);

        let currentBusId = null;
        let currentBusRoute = null;
        let currentBusTime = null;
        let currentTravelDate = null;
        let currentBusPrice = null;
        let currentTotalSeats = null; // Added to store total seats for the current bus
        let selectedSeats = []; // New array to hold multiple selected seats

        // Global variables for navbar links (already declared in the module script, but re-declared for clarity in this script block)
        const myProfileLink = document.getElementById('myProfileLink');
        const loginRegisterLink = document.getElementById('loginRegisterLink');
        const logoutLink = document.getElementById('logoutLink');
        const mobileMenuToggle = document.getElementById('mobile-menu');
        const mainNav = document.getElementById('main-nav');


        document.addEventListener('DOMContentLoaded', () => {
            // Ensure modals are hidden on load
            document.getElementById("seatModal").style.display = "none";
            document.getElementById("loginChoiceModal").style.display = "none"; 
            
            document.getElementById('aiAssistantButton').addEventListener('click', toggleChat);
            const aiAssistantChat = document.getElementById('aiAssistantChat');
            aiAssistantChat.classList.add('chat-hidden'); // Ensure it starts hidden

            // Get references to chat elements
            const chatInput = document.getElementById('chatInput');
            const sendChatBtn = document.getElementById('sendChatBtn');

            // Attach event listeners for chat input
            sendChatBtn.addEventListener('click', handleChatInput);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleChatInput();
                }
            });

            // Attach logout handler to the logout link in navbar
            logoutLink.addEventListener('click', async (e) => {
                e.preventDefault(); // Prevent default link behavior
                await logout(); // Use await for async logout
            });

            // Toggle mobile menu
            mobileMenuToggle.addEventListener('click', () => {
                mobileMenuToggle.classList.toggle('open');
                // The main change: directly toggle the 'open' class on the nav-links element
                mainNav.classList.toggle('open'); 
            });

            // Close mobile menu when a link is clicked
            mainNav.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', () => {
                    mobileMenuToggle.classList.remove('open');
                    // Remove the 'open' class from the nav-links element
                    mainNav.classList.remove('open'); 
                });
            });
        });

        // Global function to update navbar links based on auth state
        function updateAuthLinks() {
            if (window.currentUser) {
                loginRegisterLink.style.display = 'none';
                myProfileLink.style.display = 'block'; // Show My Profile
                logoutLink.style.display = 'block';
            } else {
                loginRegisterLink.style.display = 'block';
                myProfileLink.style.display = 'none'; // Hide My Profile
                logoutLink.style.display = 'none';
            }
        }

        // Global logout function (now uses Firebase signOut)
        async function logout() {
            try {
                await signOutFirebase(firebaseAuth); // Use the globally exposed signOutFirebase
                displayCustomMessage('Logged out successfully!');
                // onAuthStateChanged will handle updating links and currentUser to null
                window.location.href = 'index.html'; // Redirect to home page after logout
            } catch (error) {
                console.error('Error logging out:', error.message);
                displayCustomMessage('Error logging out: ' + error.message);
            }
        }

        // Custom message display function (replaces alert and confirm)
        function displayCustomMessage(message, type = 'alert') {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: rgba(0,0,0,0.7); display: flex; justify-content: center;
                align-items: center; z-index: 10002; /* Higher than other modals */
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 25px; border-radius: 8px; text-align: center; max-width: 400px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                    <p style="margin-bottom: 20px; font-size: 1.1em;">${message}</p>
                    <button style="background-color: #002d6b; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;" onclick="this.parentNode.parentNode.remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }


        // --- Front-end Booking System Functions ---

        async function searchResults() {
            const from = document.getElementById('from').value;
            const to = document.getElementById('to').value;
            const date = document.getElementById('travelDate').value;
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = '<h2>Search Results</h2>';
            resultsContainer.classList.add('active'); // Show results section

            if (from === to) {
                displayCustomMessage('Please choose different origin and destination.');
                return;
            }

            // Fetch matching buses from Firestore
            const busesRef = collection(firebaseDb, "buses");
            const q = query(busesRef, 
                            where("origin", "==", from), 
                            where("destination", "==", to), 
                            where("travelDate", "==", date));
            
            try {
                const querySnapshot = await getDocs(q);
                const buses = [];
                querySnapshot.forEach((doc) => {
                    buses.push({ id: doc.id, ...doc.data() });
                });

                if (buses.length === 0) {
                    resultsContainer.innerHTML += `<p style="text-align: center;">No available buses for the route from <strong>${from}</strong> to <strong>${to}</strong> on <strong>${date}</strong>.</p>`;
                    return;
                }

                buses.forEach(item => {
                    const busImage = item.image || 'https://placehold.co/150x100/002d6b/ffffff?text=Bus'; // Use a placeholder image if not available

                    // Create result card elements programmatically
                    const resultCard = document.createElement('div');
                    resultCard.classList.add('result-card');

                    const imgElement = document.createElement('img');
                    imgElement.src = busImage;
                    imgElement.alt = `${item.origin} to ${item.destination}`;
                    resultCard.appendChild(imgElement);

                    const detailsDiv = document.createElement('div');
                    detailsDiv.classList.add('result-details');
                    detailsDiv.innerHTML = `
                        <h4>${item.origin} to ${item.destination}</h4>
                        <p><i class="fas fa-clock"></i> Departure: ${item.departureTime}</p>
                        <p><i class="fas fa-money-bill-wave"></i> Price: <strong>Ksh ${item.price}</strong></p>
                        <p><i class="fas fa-chair"></i> Total Seats: ${item.totalSeats}</p>
                        <p><i class="fas fa-check-circle"></i> Available Seats: ${item.available_seats}</p>
                        <p><i class="fas fa-calendar"></i> Travel Date: ${item.travelDate}</p>
                    `;
                    resultCard.appendChild(detailsDiv);

                    const bookBtn = document.createElement('button');
                    bookBtn.classList.add('book-btn');
                    bookBtn.textContent = 'Book Now'; // Only "Book Now" as text content

                    // Set data attributes using dataset for programmatic access
                    bookBtn.dataset.busId = item.id;
                    bookBtn.dataset.busRoute = `${item.origin} to ${item.destination}`;
                    bookBtn.dataset.busTime = item.departureTime;
                    bookBtn.dataset.travelDate = item.travelDate;
                    bookBtn.dataset.busPrice = item.price;
                    bookBtn.dataset.totalSeats = item.totalSeats;
                    bookBtn.dataset.availableSeats = item.available_seats;

                    resultCard.appendChild(bookBtn);
                    resultsContainer.appendChild(resultCard);
                });

                attachBookNowListeners();
            } catch (error) {
                console.error('Error fetching buses:', error.message);
                resultsContainer.innerHTML += `<p style="color: red; text-align: center;">Error fetching buses: ${error.message}</p>`;
            }
        }


        function attachBookNowListeners() {
            document.querySelectorAll('.book-btn').forEach(button => {
                button.removeEventListener('click', handleBookNowClick); // Prevent multiple listeners
                button.addEventListener('click', handleBookNowClick);
            });
        }

        // MODIFIED: handleBookNowClick function
        async function handleBookNowClick(event) {
            console.log("handleBookNowClick called. Current user:", window.currentUser);
            // Store selected bus details temporarily
            currentBusId = event.target.dataset.busId;
            currentBusRoute = event.target.dataset.busRoute;
            currentBusTime = event.target.dataset.busTime;
            currentTravelDate = event.target.dataset.travelDate;
            currentBusPrice = parseFloat(event.target.dataset.busPrice);
            currentTotalSeats = parseInt(event.target.dataset.totalSeats);
            const currentAvailableSeats = parseInt(event.target.dataset.availableSeats);

            if (currentAvailableSeats <= 0) {
                displayCustomMessage("Sorry, this bus is fully booked. Please choose another one.");
                return;
            }

            // Check if user is logged in using Firebase currentUser
            if (window.currentUser) {
                console.log("User is logged in. Proceeding to seat selection directly.");
                // If logged in, directly show the seat selection modal and pre-fill details
                document.getElementById("busDetails").textContent = `${currentBusRoute} at ${currentBusTime} on ${currentTravelDate}`;
                await generateSeats(currentTotalSeats); // Pass total seats to generateSeats
                
                // Pre-fill passenger details from currentUserProfile
                document.getElementById("passengerName").value = window.currentUserProfile?.fullName || '';
                document.getElementById("passengerID").value = window.currentUserProfile?.idNumber || ''; // Assuming you have idNumber in profile
                document.getElementById("passengerGender").value = window.currentUserProfile?.gender || ''; // Assuming you have gender in profile
                document.getElementById("passengerPhone").value = window.currentUserProfile?.phoneNumber || ''; // Assuming you have phoneNumber in profile
                document.getElementById("passengerEmail").value = window.currentUserProfile?.email || '';

                document.getElementById("seatModal").style.display = "flex";

            } else {
                console.log("User is NOT logged in. Showing login choice modal.");
                // If not logged in, show the login choice modal
                showLoginChoiceModal();
            }
        }

        // New function: Show the login/guest choice modal
        function showLoginChoiceModal() {
            console.log("showLoginChoiceModal called. Displaying login choice modal.");
            document.getElementById("loginChoiceModal").style.display = "flex";
        }

        // New function: Close the login/guest choice modal
        function closeLoginChoiceModal() {
            console.log("closeLoginChoiceModal called. Hiding login choice modal.");
            document.getElementById("loginChoiceModal").style.display = "none";
        }

        // New function: Handle "Proceed as Guest"
        async function proceedAsGuest() {
            console.log("proceedAsGuest called.");
            closeLoginChoiceModal(); // Close the choice modal
            // Now, open the seat selection modal as before
            document.getElementById("busDetails").textContent = `${currentBusRoute} at ${currentBusTime} on ${currentTravelDate}`;
            await generateSeats(currentTotalSeats); // Pass total seats to generateSeats
            // Clear passenger details for guest
            document.getElementById("passengerName").value = '';
            document.getElementById("passengerID").value = '';
            document.getElementById("passengerGender").value = '';
            document.getElementById("passengerPhone").value = '';
            document.getElementById("passengerEmail").value = '';
            document.getElementById("seatModal").style.display = "flex";
        }

        // New function: Handle "Login / Sign Up"
        function redirectToLogin() {
            console.log("redirectToLogin called.");
            closeLoginChoiceModal(); // Close the choice modal
            displayCustomMessage("Please log in or sign up. You will need to search for your bus again after logging in.");
            window.location.href = 'login-register.html'; // Redirect to login page
        }

        function closeModal() {
            document.getElementById("seatModal").style.display = "none";
            // Clear passenger details for next time (important for logged-in user who might cancel)
            document.getElementById("passengerName").value = '';
            document.getElementById("passengerID").value = '';
            document.getElementById("passengerGender").value = '';
            document.getElementById("passengerPhone").value = '';
            document.getElementById("passengerEmail").value = '';

            selectedSeats = []; // Clear selected seats
            updateSelectedSeatsDisplay(); // Update display
            const selected = document.querySelectorAll(".seat-container.selected");
            selected.forEach(s => s.classList.remove("selected"));
        }

        let unsubscribeSnapshot = null; // To store the unsubscribe function for real-time listener

        // Helper function to create a seat element (Updated to match admin.html)
        function createSeatElement(parent, seatNumber, bookedSeats) {
            const seatContainer = document.createElement("div");
            seatContainer.classList.add("seat-container");
            seatContainer.setAttribute("data-seat", `S${seatNumber}`); // Store as "S<number>"
            
            const seatIcon = document.createElement("i");
            seatIcon.classList.add("fas", "fa-chair", "seat-icon");

            const seatNumSpan = document.createElement("span");
            seatNumSpan.classList.add("seat-number");
            seatNumSpan.textContent = `S${seatNumber}`;

            seatContainer.appendChild(seatIcon);
            seatContainer.appendChild(seatNumSpan);

            if (bookedSeats.includes(`S${seatNumber}`)) { // Check against "S<number>" format
                seatContainer.classList.add("booked");
                seatContainer.onclick = null; // Make booked seats non-clickable
            } else {
                // Check if this seat was previously selected by the user
                if (selectedSeats.includes(seatNumber)) {
                    seatContainer.classList.add("selected");
                }
                seatContainer.onclick = function () {
                    const seatNum = parseInt(this.dataset.seat.replace('S', '')); // Convert back to number
                    if (this.classList.contains("selected")) {
                        this.classList.remove("selected");
                        selectedSeats = selectedSeats.filter(s => s !== seatNum);
                    } else {
                        this.classList.add("selected");
                        selectedSeats.push(seatNum);
                    }
                    updateSelectedSeatsDisplay();
                };
            }
            parent.appendChild(seatContainer);
        }

        async function generateSeats(totalSeats) {
            const seatGrid = document.getElementById("seatGrid");
            seatGrid.innerHTML = "";
            selectedSeats = [];
            updateSelectedSeatsDisplay();

            // Unsubscribe from previous listener if exists
            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
                unsubscribeSnapshot = null;
            }

            // Determine layout based on total seats (copied from admin.html)
            let seatsInLeftRow = 2;
            let seatsInRightRow = 2;
            let gridColumns = "repeat(2, 1fr) 0.5fr repeat(2, 1fr)"; // Default 2-2 layout (5 columns)

            if (totalSeats <= 14) { // Assuming 14-seater or smaller might be 2-1 layout
                seatsInLeftRow = 2;
                seatsInRightRow = 1;
                gridColumns = "repeat(2, 1fr) 0.5fr 1fr"; // 2-1 layout (4 columns)
            }

            seatGrid.style.gridTemplateColumns = gridColumns;

            // Add a "Front (Driver)" indicator
            const driverArea = document.createElement('div');
            driverArea.classList.add('driver-area');
            driverArea.textContent = 'Front (Driver)';
            seatGrid.appendChild(driverArea);

            // Setup real-time listener for bookings for this specific bus and date
            const bookingsRef = collection(firebaseDb, "bookings");
            const q = query(bookingsRef, 
                            where("bus_id", "==", currentBusId), 
                            where("travel_date", "==", currentTravelDate),
                            where("status", "in", ['pending', 'paid'])); // Filter by active bookings

            unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                const bookedSeatsForThisTrip = [];
                snapshot.forEach((doc) => {
                    const booking = doc.data();
                    // Only add seats that are 'pending' or 'paid'
                    if (booking.status === 'pending' || booking.status === 'paid') {
                        bookedSeatsForThisTrip.push(booking.seat_number);
                    }
                });

                // Re-render seats based on the latest bookedSeatsForThisTrip
                // Clear all seats except the driver area (if already present)
                const existingDriverArea = seatGrid.querySelector('.driver-area');
                seatGrid.innerHTML = '';
                if (existingDriverArea) {
                    seatGrid.appendChild(existingDriverArea); // Re-add the driver area
                } else {
                    // This case should ideally not happen if driverArea is added once
                    const newDriverArea = document.createElement('div');
                    newDriverArea.classList.add('driver-area');
                    newDriverArea.textContent = 'Front (Driver)';
                    seatGrid.appendChild(newDriverArea);
                }

                let currentSeatNum = 1;
                while (currentSeatNum <= totalSeats) {
                    // Left side seats
                    for (let j = 0; j < seatsInLeftRow; j++) {
                        if (currentSeatNum <= totalSeats) {
                            createSeatElement(seatGrid, currentSeatNum, bookedSeatsForThisTrip);
                            currentSeatNum++;
                        }
                    }

                    // Aisle
                    const aisleDiv = document.createElement('div');
                    aisleDiv.classList.add('aisle-space');
                    seatGrid.appendChild(aisleDiv);

                    // Right side seats
                    for (let j = 0; j < seatsInRightRow; j++) {
                        if (currentSeatNum <= totalSeats) {
                            createSeatElement(seatGrid, currentSeatNum, bookedSeatsForThisTrip); 
                            currentSeatNum++;
                        }
                    }
                }
            }, (error) => {
                console.error('Error fetching booked seats in real-time:', error.message);
                displayCustomMessage('Error fetching seat availability. Please try again.');
            });
        }


        function updateSelectedSeatsDisplay() {
            const displayElement = document.getElementById('selectedSeatsDisplay');
            if (selectedSeats.length > 0) {
                displayElement.textContent = selectedSeats.sort((a, b) => a - b).map(s => `S${s}`).join(', '); // Display as "S1, S2"
            } else {
                displayElement.textContent = 'None';
            }
        }

        // Helper function for email validation
        function isValidEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        // Helper function for phone number validation
        function isValidPhoneNumber(phone) {
            // This regex allows for numbers, spaces, hyphens, and can start with a '+'
            const re = /^\+?[0-9\s-]{7,20}$/; 
            return re.test(String(phone));
        }

        async function confirmBooking() {
            const name = document.getElementById("passengerName").value.trim();
            const idNumber = document.getElementById("passengerID").value.trim();
            const gender = document.getElementById("passengerGender").value;
            const phone = document.getElementById("passengerPhone").value.trim();
            const email = document.getElementById("passengerEmail").value.trim();
            
            if (selectedSeats.length === 0) {
                displayCustomMessage("Please select at least one seat.");
                return;
            }
            if (!name) {
                displayCustomMessage("Please enter your Full Name.");
                return;
            }
            if (!idNumber) {
                displayCustomMessage("Please enter your ID Number.");
                return;
            }
            if (gender === "") {
                displayCustomMessage("Please select your Gender.");
                return;
            }
            if (!phone) {
                displayCustomMessage("Please enter your Phone Number.");
                return;
            }
            if (!isValidPhoneNumber(phone)) {
                displayCustomMessage("Please enter a valid Phone Number (e.g., +254712345678 or 0712345678).");
                return;
            }
            if (!email) {
                displayCustomMessage("Please enter your Email Address.");
                return;
            }
            if (!isValidEmail(email)) {
                displayCustomMessage("Please enter a valid Email Address.");
                return;
            }


            const bookingsToInsert = [];
            const emailsToInsert = []; // New array for email documents
            let lastBookingRef = null;

            // Fetch the current bus document to get the latest available_seats
            const busDocRef = doc(firebaseDb, "buses", currentBusId);
            const busDocSnap = await getDoc(busDocRef);

            if (!busDocSnap.exists()) {
                displayCustomMessage("Error: Bus details not found. Please try searching again.");
                return;
            }
            const busData = busDocSnap.data();
            let currentAvailableSeats = busData.available_seats;

            // Check if selected seats are still available
            const bookingsRef = collection(firebaseDb, "bookings");
            const qBookedSeats = query(bookingsRef, 
                                        where("bus_id", "==", currentBusId), 
                                        where("travel_date", "==", currentTravelDate),
                                        where("status", "in", ['pending', 'paid']));
            const bookedSeatsSnapshot = await getDocs(qBookedSeats);
            const currentlyBookedSeats = new Set(bookedSeatsSnapshot.docs.map(doc => doc.data().seat_number));

            for (const seatNumber of selectedSeats) {
                const formattedSeatNumber = `S${seatNumber}`; // Ensure "S<number>" format
                if (currentlyBookedSeats.has(formattedSeatNumber)) {
                    displayCustomMessage(`Seat ${formattedSeatNumber} has just been booked by someone else. Please select another seat.`);
                    generateSeats(currentTotalSeats); // Re-render seat grid with updated status
                    return;
                }
                if (currentAvailableSeats <= 0) {
                    displayCustomMessage("Not enough available seats on this bus for your selection. Please adjust your seats.");
                    generateSeats(currentTotalSeats); // Re-render seat grid with updated status
                    return;
                }
                currentAvailableSeats--; // Tentatively decrement for each selected seat

                const bookingRef = 'PA-' + Date.now().toString().slice(-6) + '-' + String(seatNumber).padStart(2, '0'); // Unique Booking Reference
                
                // Create booking document for 'bookings' collection
                const newBookingDoc = { 
                    booking_ref: bookingRef,
                    passenger_name: name,
                    passenger_id: idNumber,
                    passenger_gender: gender,
                    passenger_phone: phone,
                    passenger_email: email,
                    bus_id: currentBusId,
                    bus_route: currentBusRoute,
                    bus_time: currentBusTime,
                    travel_date: currentTravelDate,
                    seat_number: formattedSeatNumber, // Store in "S<number>" format
                    price: currentBusPrice, // Price per seat
                    status: 'pending', // Set to pending, payment gateway would confirm to 'paid'
                    booking_date: new Date().toISOString(), // ISO string for consistent date format
                    user_id: window.currentUser ? window.currentUser.uid : null, // Store Firebase user ID if logged in
                    createdAt: serverTimestamp(), // Add server timestamp
                };

                bookingsToInsert.push(newBookingDoc);
                lastBookingRef = bookingRef; // Keep track of the last one for redirect

                // Prepare email document for 'mail' collection
                const emailDoc = {
                    to: email,
                    message: {
                        subject: "Your Booking Confirmation - Prince Alex Travel ",
                        html: `
                            <!DOCTYPE html>
                            <html>
                            <head>
                                <meta charset="utf-8">
                                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                                <title>Booking Confirmation - Prince Alex Travel</title>
                                <style>
                                    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; }
                                    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                                    .header { background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
                                    .content { background: #f8fafc; padding: 30px; border-radius: 0 0 10px 10px; }
                                    .booking-details { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #1e3a8a; }
                                    .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
                                    .detail-label { font-weight: bold; color: #374151; }
                                    .detail-value { color: #1f2937; }
                                    .footer { text-align: center; margin-top: 30px; color: #666; font-size: 14px; }
                                    .status-pending { background: #fef3c7; color: #92400e; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; }
                                    .status-paid { background: #d1fae5; color: #065f46; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; }
                                </style>
                            </head>
                            <body>
                                <div class="container">
                                    <div class="header">
                                        <h1> Booking Confirmed!</h1>
                                        <p>Your journey with Prince Alex Travel is confirmed</p>
                                    </div>
                                    <div class="content">
                                        <h2>Hello ${name}!</h2>
                                        <p>Thank you for choosing <strong>Prince Alex Travel Services</strong>. Your booking has been successfully confirmed!</p>
                                        
                                        <div class="booking-details">
                                            <h3 style="margin-top: 0; color: #1e3a8a;"> Booking Details</h3>
                                            <div class="detail-row">
                                                <span class="detail-label">Booking Reference:</span>
                                                <span class="detail-value"><strong>${bookingRef}</strong></span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Route:</span>
                                                <span class="detail-value">${currentBusRoute}</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Seat Number:</span>
                                                <span class="detail-value"><strong>${formattedSeatNumber}</strong></span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Travel Date:</span>
                                                <span class="detail-value">${currentTravelDate}</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Departure Time:</span>
                                                <span class="detail-value">${currentBusTime}</span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Price:</span>
                                                <span class="detail-value"><strong>Ksh ${currentBusPrice.toLocaleString()}</strong></span>
                                            </div>
                                            <div class="detail-row">
                                                <span class="detail-label">Status:</span>
                                                <span class="detail-value">
                                                    <span class="status-pending">PENDING PAYMENT</span>
                                                </span>
                                            </div>
                                        </div>

                                        <div style="background: #fef3c7; padding: 15px; border-radius: 5px; border-left: 4px solid #f59e0b; margin: 20px 0;">
                                            <h4 style="margin-top: 0; color: #92400e;"> Payment Required</h4>
                                            <p style="margin-bottom: 0; color: #92400e;">Your booking is confirmed but payment is pending. Please complete payment to validate your ticket.</p>
                                        </div>

                                        <p><strong> Need Help?</strong></p>
                                        <p>If you have any questions or need assistance, please don't hesitate to contact us:</p>
                                        <p><strong> Email:</strong> senerwaalex@gmail.com<br>
                                        <strong> Phone:</strong> +254 717 384 875</p>
                                    </div>
                                    <div class="footer">
                                        <p> 2025 Prince Alex Digital. All rights reserved.</p>
                                        <p>Nairobi, Kenya | Prince Alex Travel Services</p>
                                    </div>
                                </div>
                            </body>
                            </html>
                        `
                    }
                };
                emailsToInsert.push(emailDoc);
            }
            
            try {
                // Add new records to the 'bookings' collection
                for (const booking of bookingsToInsert) {
                    await addDoc(collection(firebaseDb, "bookings"), booking);
                }

                // Add email records to the 'mail' collection
                for (const emailDoc of emailsToInsert) { // Renamed loop variable to avoid conflict
                    await addDoc(collection(firebaseDb, "mail"), emailDoc);
                }

                // Update available seats for the bus
                await updateDoc(busDocRef, {
                    available_seats: increment(-selectedSeats.length)
                });

                // Unsubscribe from the real-time listener after successful booking
                if (unsubscribeSnapshot) {
                    unsubscribeSnapshot();
                    unsubscribeSnapshot = null;
                }

                // If successful, store the last booking reference and redirect
                localStorage.setItem('lastBookingRef', lastBookingRef); // Store the ID of the last booking in the batch

                // Display success message and then redirect automatically after a delay
                displayCustomMessage(`Booking confirmed for seat(s): ${selectedSeats.sort((a, b) => a - b).map(s => `S${s}`).join(', ')}! You will be redirected shortly to the confirmation page.`, 'success');
                
                setTimeout(() => {
                    window.location.href = `booking-success.html?bookingRef=${lastBookingRef}`; // Pass bookingRef in URL
                }, 3000); // Redirect after 3 seconds

                closeModal(); // Close the seat selection modal

            } catch (error) {
                console.error('Error confirming booking:', error.message);
                displayCustomMessage('Error confirming booking: ' + error.message);
            }
        }

        function toggleChat() {
            const chatContainer = document.getElementById('aiAssistantChat');
            // Check for 'chat-hidden' class to determine current state
            const isHidden = chatContainer.classList.contains('chat-hidden'); 

            if (isHidden) {
                // If currently hidden, remove 'chat-hidden' to make it display:flex
                chatContainer.classList.remove('chat-hidden'); 
                // A small timeout is often needed to allow the browser to register the display change
                // before applying the transition properties.
                setTimeout(() => {
                    chatContainer.classList.add('chat-visible'); // Add 'chat-visible' to trigger opacity/transform transition
                }, 10); 
            } else {
                // If currently visible, remove 'chat-visible' to start the reverse transition
                chatContainer.classList.remove('chat-visible'); 
                // After the transition completes (300ms, matching CSS), add 'chat-hidden' to set display:none
                setTimeout(() => {
                    chatContainer.classList.add('chat-hidden'); 
                }, 300); // This timeout should match the CSS transition duration for a smooth close
            }
        }

        // Variable to store chat history for the AI assistant
        let chatHistory = [];

        // New functions for chat
        function appendMessage(message, sender) {
            const chatBody = document.getElementById('chatBody');
            const messageElement = document.createElement('p');
            messageElement.classList.add(sender + '-message'); // For potential future styling
            messageElement.textContent = message;
            chatBody.appendChild(messageElement);
            chatBody.scrollTop = chatBody.scrollHeight; // Scroll to bottom
        }

        // Function to search buses for the AI assistant
        async function searchBusesForAI(from, to, date) {
            const busesRef = collection(firebaseDb, "buses");
            // Capitalize first letter of from/to for consistent querying with Firestore data
            const capitalizedFrom = from.charAt(0).toUpperCase() + from.slice(1).toLowerCase();
            const capitalizedTo = to.charAt(0).toUpperCase() + to.slice(1).toLowerCase();

            const q = query(busesRef,
                            where("origin", "==", capitalizedFrom),
                            where("destination", "==", capitalizedTo),
                            where("travelDate", "==", date));

            try {
                const querySnapshot = await getDocs(q);
                const buses = [];
                querySnapshot.forEach((doc) => {
                    buses.push(doc.data());
                });

                if (buses.length === 0) {
                    return `No buses found from ${capitalizedFrom} to ${capitalizedTo} on ${date}.`;
                }

                let formattedData = `Available buses from ${capitalizedFrom} to ${capitalizedTo} on ${date}:\n`;
                buses.forEach(bus => {
                    formattedData += `- Bus departing at ${bus.departureTime}, Price: Ksh ${bus.price}, Available Seats: ${bus.available_seats} (Total: ${bus.totalSeats})\n`; // Corrected field name
                });
                return formattedData;

            } catch (error) {
                console.error("Error fetching bus data for AI:", error);
                return null; // Indicate error
            }
        }

        async function handleChatInput() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            if (message) {
                appendMessage(message, 'user');
                chatInput.value = '';

                // Show typing indicator
                const chatBody = document.getElementById('chatBody');
                const typingIndicator = document.createElement('p');
                typingIndicator.classList.add('bot-message');
                typingIndicator.textContent = 'AI is typing...';
                typingIndicator.id = 'typingIndicator';
                chatBody.appendChild(typingIndicator);
                chatBody.scrollTop = chatBody.scrollHeight;
                
                let promptText = message;
                let additionalContext = "";
                const todayDate = new Date().toISOString().split("T")[0]; // "YYYY-MM-DD"

                // Simple detection for bus route queries
                const busQueryMatch = message.toLowerCase().match(/(?:bus|route|ticket|fare|price|seats)\s+(?:from\s+([\w\s]+))?\s*(?:to\s+([\w\s]+))?/);

                if (busQueryMatch) {
                    let fromLocation = busQueryMatch[1] ? busQueryMatch[1].trim() : '';
                    let toLocation = busQueryMatch[2] ? busQueryMatch[2].trim() : '';

                    // Attempt to infer locations if only one is provided or if general query
                    if (!fromLocation && !toLocation) {
                        additionalContext = "\n\nTo get specific bus information, please tell me the origin and destination, for example: 'buses from Nairobi to Kisumu'.";
                    } else {
                        try {
                            const busData = await searchBusesForAI(fromLocation, toLocation, todayDate);
                            if (busData && !busData.startsWith("No buses found")) {
                                additionalContext = `\n\nHere is relevant bus schedule information for ${fromLocation || 'any'} to ${toLocation || 'any'} on ${todayDate}:\n${busData}\n\n`;
                            } else {
                                additionalContext = `\n\nI don't have that specific bus information right now for ${fromLocation || 'your specified origin'} to ${toLocation || 'your specified destination'} on ${todayDate}. Please contact our customer support at senerwaalex@gmail.com or call +254 717 384 875 for further assistance.`;
                            }
                        } catch (error) {
                            console.error("Error fetching bus data for AI:", error);
                            additionalContext = "\n\nI had trouble looking up bus information right now. Please try again later or contact support at senerwaalex@gmail.com or call +254 717 384 875.";
                        }
                    }
                } else if (message.toLowerCase().includes("chat with agent") || message.toLowerCase().includes("speak to someone") || message.toLowerCase().includes("human help")) {
                    additionalContext = "\n\nI understand you'd like to speak with a human agent. Please contact our customer support directly at senerwaalex@gmail.com or call +254 717 384 875. They will be happy to assist you.";
                } else if (message.toLowerCase().includes("contact") || message.toLowerCase().includes("support")) {
                    additionalContext = "\n\nYou can reach our customer support at senerwaalex@gmail.com or call +254 717 384 875.";
                }


                // Construct the full prompt for Gemini
                let chatHistoryForGemini = [];
                chatHistoryForGemini.push({ role: "user", parts: [{ text: promptText + additionalContext }] });

                try {
                    const payload = { contents: chatHistoryForGemini };
                    const apiKey = ""; // Canvas will automatically provide the API key for gemini-2.0-flash
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Check if the response itself was successful (HTTP status 200-299)
                    if (!response.ok) {
                        const errorBody = await response.text(); // Get raw error body
                        console.error(`Gemini API HTTP Error: ${response.status} ${response.statusText}`, errorBody);
                        typingIndicator.remove();
                        appendMessage(`There was an issue with the AI service. Please try again later. (HTTP Error: ${response.status})`, 'bot');
                        return;
                    }

                    const result = await response.json();
                    console.log("Gemini API raw result:", result); // Log the full result for debugging

                    // Remove typing indicator
                    typingIndicator.remove();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const aiResponse = result.candidates[0].content.parts[0].text;
                        appendMessage(aiResponse, 'bot');
                        // Add AI response to chat history
                        chatHistory.push({ role: "model", parts: [{ text: aiResponse }] });
                    } else {
                        // Check for prompt feedback (e.g., safety issues)
                        if (result.promptFeedback && result.promptFeedback.blockReason) {
                            appendMessage(`Sorry, I cannot respond to that query. It was blocked due to: ${result.promptFeedback.blockReason}. Please try rephrasing your question.`, 'bot');
                            console.warn("Gemini API blocked response:", result.promptFeedback);
                        } else if (result.candidates && result.candidates.length > 0 && result.candidates[0].finishReason) {
                            // Check for finish reason if no content was generated
                            appendMessage(`Sorry, I couldn't generate a complete response for that. Reason: ${result.candidates[0].finishReason}. Please try again.`, 'bot');
                            console.warn("Gemini API finished without content:", result.candidates[0].finishReason);
                        } else {
                            // Generic error if structure is unexpected
                            appendMessage("Sorry, I couldn't get a meaningful response from the AI. The response structure was unexpected. Please try again.", 'bot');
                            console.error("AI response structure unexpected or empty candidates:", result);
                        }
                    }
                } catch (error) {
                    // Remove typing indicator on error as well
                    const currentTypingIndicator = document.getElementById('typingIndicator');
                    if (currentTypingIndicator) {
                        currentTypingIndicator.remove();
                    }
                    appendMessage("There was an error connecting to the AI. Please check your network connection and try again.", 'bot');
                    console.error("Error calling Gemini API:", error);
                }
            }
        }

        // --- Update Authentication Links ---
        function updateAuthLinks() {
            const myProfileLink = document.getElementById('myProfileLink');
            const loginRegisterLink = document.getElementById('loginRegisterLink');
            const logoutLink = document.getElementById('logoutLink');

            if (window.currentUser) {
                // User is logged in
                loginRegisterLink.style.display = 'none';
                myProfileLink.style.display = 'block';
                logoutLink.style.display = 'block';
            } else {
                // User is not logged in
                loginRegisterLink.style.display = 'block';
                myProfileLink.style.display = 'none';
                logoutLink.style.display = 'none';
            }
        }

        // --- Logout Function ---
        async function logout() {
            try {
                await window.signOutFirebase(window.firebaseAuth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Add logout event listener
        document.addEventListener('DOMContentLoaded', () => {
            const logoutLink = document.getElementById('logoutLink');
            if (logoutLink) {
                logoutLink.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await logout();
                });
            }
        });
    </script>

</body>
</html>
