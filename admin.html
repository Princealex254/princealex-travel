<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Panel – Prince Alex Travel</title>

<!-- Icons & PDF -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Firebase SDKs -->
<script type="module">
/** =======================
 *  Firebase (same as index.html)
 *  ======================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { 
  getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDoc, increment, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDGErPBeQ1Fdx9EHPXOHepoEoOx7P2f57o",
  authDomain: "princealextravel.firebaseapp.com",
  projectId: "princealextravel",
  storageBucket: "princealextravel.firebasestorage.app",
  messagingSenderId: "947577729462",
  appId: "1:947577729462:web:dd4b4c7cb4a984c5e3d117"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/** =======================
 *  DOM Helpers
 *  ======================= */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);
function toast(msg, type="info") {
  const t = document.createElement("div");
  t.className = `toast ${type}`;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>t.classList.add("show"),10);
  setTimeout(()=>{t.classList.remove("show"); setTimeout(()=>t.remove(),300)}, 2700);
}

/** =======================
 *  Auth Guard
 *  ======================= */
let currentAdmin = null;
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    currentAdmin = null;
    $("#adminApp").classList.add("hidden");
    $("#loginCard").classList.remove("hidden");
    $("#loginEmail").focus();
    return;
  }
  // Check admins collection
  const adminRef = doc(db, "admins", user.uid);
  const snap = await getDoc(adminRef);
  if (snap.exists() && snap.data().isAdmin === true) {
    currentAdmin = user;
    $("#adminEmailBadge").textContent = user.email ?? "Admin";
    $("#loginCard").classList.add("hidden");
    $("#adminApp").classList.remove("hidden");
    // load data
    attachRealtimeBuses();
    attachRealtimeBookings();
  } else {
    await signOut(auth);
    currentAdmin = null;
    $("#adminApp").classList.add("hidden");
    $("#loginCard").classList.remove("hidden");
    toast("Access denied. This account is not an admin.", "error");
  }
});

$("#loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = $("#loginEmail").value.trim();
  const pass = $("#loginPassword").value;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
    toast("Login successful!", "success");
  } catch (err) {
    console.error(err);
    toast(err.message || "Login failed", "error");
  }
});
$("#logoutBtn").addEventListener("click", async ()=>{
  await signOut(auth);
  toast("Logged out.", "info");
});

/** =======================
 *  Tabs
 *  ======================= */
$$(".tab-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const target = btn.dataset.tab;
    $$(".tab-btn").forEach(b=>b.classList.remove("active"));
    $$(".tab-panel").forEach(p=>p.classList.add("hidden"));
    btn.classList.add("active");
    $(`#${target}`).classList.remove("hidden");
  });
});

/** =======================
 *  Manage Buses
 *  ======================= */
const busesCol = collection(db, "buses");
let busesUnsub = null;

function attachRealtimeBuses() {
  if (busesUnsub) busesUnsub();
  busesUnsub = onSnapshot(busesCol, (snap)=>{
    const list = $("#busTableBody");
    list.innerHTML = "";
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${d.company ?? "-"}</td>
        <td>${d.from ?? "-"}</td>
        <td>${d.to ?? "-"}</td>
        <td>${d.departureTime ?? "-"}</td>
        <td>${d.price ? "KES "+Number(d.price).toLocaleString() : "-"}</td>
        <td>${d.totalSeats ?? "-"}</td>
        <td class="nowrap">
          <button class="btn sm" data-action="edit" data-id="${docSnap.id}"><i class="fa-solid fa-pen-to-square"></i></button>
          <button class="btn sm danger" data-action="del" data-id="${docSnap.id}"><i class="fa-solid fa-trash"></i></button>
        </td>
      `;
      list.appendChild(tr);
    });
  });
}
$("#addBusForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const data = {
    company: $("#busCompany").value.trim(),
    from: $("#busFrom").value.trim(),
    to: $("#busTo").value.trim(),
    departureTime: $("#busTime").value.trim(),
    price: Number($("#busPrice").value),
    totalSeats: Number($("#busSeats").value),
    createdAt: serverTimestamp()
  };
  try {
    await addDoc(busesCol, data);
    e.target.reset();
    toast("Bus added.", "success");
  } catch (err) {
    console.error(err);
    toast("Failed to add bus: " + err.message, "error");
  }
});
$("#busTableBody").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button");
  if (!btn) return;
  const id = btn.dataset.id;
  if (btn.dataset.action === "del") {
    if (!confirm("Delete this bus?")) return;
    try {
      await deleteDoc(doc(db, "buses", id));
      toast("Bus deleted.", "success");
    } catch (err) {
      toast("Delete failed: " + err.message, "error");
    }
  } else if (btn.dataset.action === "edit") {
    // Load current values to editor
    const s = await getDoc(doc(db, "buses", id));
    if (!s.exists()) return;
    const d = s.data();
    $("#editBusId").value = id;
    $("#editBusCompany").value = d.company ?? "";
    $("#editBusFrom").value = d.from ?? "";
    $("#editBusTo").value = d.to ?? "";
    $("#editBusTime").value = d.departureTime ?? "";
    $("#editBusPrice").value = d.price ?? "";
    $("#editBusSeats").value = d.totalSeats ?? "";
    $("#editBusModal").classList.remove("hidden");
  }
});
$("#editBusForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const id = $("#editBusId").value;
  try {
    await updateDoc(doc(db, "buses", id), {
      company: $("#editBusCompany").value.trim(),
      from: $("#editBusFrom").value.trim(),
      to: $("#editBusTo").value.trim(),
      departureTime: $("#editBusTime").value.trim(),
      price: Number($("#editBusPrice").value),
      totalSeats: Number($("#editBusSeats").value)
    });
    $("#editBusModal").classList.add("hidden");
    toast("Bus updated.", "success");
  } catch (err) {
    toast("Update failed: " + err.message, "error");
  }
});
$("#editBusCancel").addEventListener("click", ()=>$("#editBusModal").classList.add("hidden"));

/** =======================
 *  Manage Bookings
 *  ======================= */
const bookingsCol = collection(db, "bookings");
let bookingsUnsub = null, bookingCache = [];

function attachRealtimeBookings() {
  if (bookingsUnsub) bookingsUnsub();
  bookingsUnsub = onSnapshot(bookingsCol, (snap)=>{
    bookingCache = [];
    snap.forEach(docSnap=>{
      bookingCache.push({ id: docSnap.id, ...docSnap.data() });
    });
    renderBookingTable(bookingCache);
  });
}
function renderBookingTable(items) {
  const body = $("#bookingTableBody");
  body.innerHTML = "";
  items.sort((a,b)=> (b.createdAt?.seconds??0)-(a.createdAt?.seconds??0));
  for (const b of items) {
    const paid = (b.payment_status || "").toLowerCase() === "paid";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${b.ref ?? b.reference ?? b.bookingRef ?? "-"}</td>
      <td>${b.passengerName ?? "-"}</td>
      <td>${b.passengerEmail ?? "-"}</td>
      <td>${b.from ?? "-"}</td>
      <td>${b.to ?? "-"}</td>
      <td>${b.date ?? "-"}</td>
      <td>${b.seat ?? "-"}</td>
      <td>${b.price ? "KES "+Number(b.price).toLocaleString() : "-"}</td>
      <td><span class="badge ${paid?"success":"warn"}">${paid ? "PAID" : "PENDING"}</span></td>
      <td class="nowrap">
        ${paid ? "" : `<button class="btn sm success" data-action="markpaid" data-id="${b.id}"><i class="fa-solid fa-check"></i> Paid</button>`}
        <button class="btn sm" data-action="ticket" data-id="${b.id}"><i class="fa-solid fa-ticket"></i></button>
        <button class="btn sm danger" data-action="del" data-id="${b.id}"><i class="fa-solid fa-trash"></i></button>
      </td>
    `;
    body.appendChild(tr);
  }
}
$("#bookingSearch").addEventListener("input", ()=>{
  const q = $("#bookingSearch").value.trim().toLowerCase();
  if (!q) return renderBookingTable(bookingCache);
  const results = bookingCache.filter(b=>{
    return (b.passengerName??"").toLowerCase().includes(q)
      || (b.passengerEmail??"").toLowerCase().includes(q)
      || (b.ref??b.reference??b.bookingRef??"").toLowerCase().includes(q);
  });
  renderBookingTable(results);
});
$("#bookingTableBody").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button");
  if (!btn) return;
  const id = btn.dataset.id;
  const item = bookingCache.find(x=>x.id===id);
  if (!item) return;

  if (btn.dataset.action === "del") {
    if (!confirm("Delete this booking?")) return;
    try {
      await deleteDoc(doc(db, "bookings", id));
      toast("Booking deleted.", "success");
    } catch (err) {
      toast("Delete failed: " + err.message, "error");
    }
  } else if (btn.dataset.action === "markpaid") {
    try {
      await updateDoc(doc(db, "bookings", id), { payment_status: "paid", paidAt: serverTimestamp() });
      toast("Marked as PAID.", "success");
      // Send confirmation email (requires Firebase Trigger Email extension)
      if (item.passengerEmail) {
        await addDoc(collection(db,"mail"), {
          to: [item.passengerEmail],
          message: {
            subject: "Payment Confirmed – Prince Alex Travel",
            text: `Hi ${item.passengerName??"Customer"}, your payment for booking ${item.ref??id} has been received. Seat ${item.seat??"-"} on ${item.date??"-"} (${item.from??"-"} → ${item.to??"-"}). Thank you!`,
            html: `<p>Hi ${item.passengerName??"Customer"},</p>
                   <p>Your payment for booking <strong>${item.ref??id}</strong> has been received.</p>
                   <p><strong>Trip:</strong> ${item.from??"-"} → ${item.to??"-"}<br>
                   <strong>Date:</strong> ${item.date??"-"}<br>
                   <strong>Seat:</strong> ${item.seat??"-"}<br>
                   <strong>Amount:</strong> KES ${item.price?Number(item.price).toLocaleString():"-"}</p>
                   <p>Thank you for choosing Prince Alex Travel.</p>`
          },
          createdAt: serverTimestamp()
        });
      }
    } catch (err) {
      toast("Failed to mark paid: " + err.message, "error");
    }
  } else if (btn.dataset.action === "ticket") {
    generateTicketPDF(item);
  }
});

/** =======================
 *  Ticket PDF
 *  ======================= */
function generateTicketPDF(b) {
  const { jsPDF } = window.jspdf;
  const docpdf = new jsPDF();
  const brand = "#002d6b";
  docpdf.setFillColor(0,45,107);
  docpdf.rect(0,0,210,25,"F");
  docpdf.setTextColor(255,255,255);
  docpdf.setFontSize(18);
  docpdf.text("Prince Alex Travel - Ticket", 10, 16);

  docpdf.setTextColor(0,0,0);
  docpdf.setFontSize(12);
  const lines = [
    `Reference: ${b.ref ?? b.reference ?? b.bookingRef ?? b.id}`,
    `Passenger: ${b.passengerName ?? "-"}`,
    `Email: ${b.passengerEmail ?? "-"}`,
    `Route: ${b.from ?? "-"} → ${b.to ?? "-"}`,
    `Date: ${b.date ?? "-"}`,
    `Seat: ${b.seat ?? "-"}`,
    `Amount: KES ${b.price?Number(b.price).toLocaleString():"-"}`,
    `Payment: ${(b.payment_status??"pending").toUpperCase()}`
  ];
  let y=40;
  lines.forEach(t=>{ docpdf.text(t, 10, y); y+=8; });

  docpdf.setDrawColor(0,45,107);
  docpdf.rect(8, 30, 194, y-22);

  docpdf.save(`ticket_${b.ref ?? b.id}.pdf`);
}

/** =======================
 *  Make Booking (Admin)
 *  ======================= */
let selectedBusId = null;
let selectedDate = null;
let selectedSeat = null;
const TOTAL_SEATS_DEFAULT = 32;

$("#adminBookingSearch").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const from = $("#abFrom").value.trim();
  const to = $("#abTo").value.trim();
  const date = $("#abDate").value;
  if (!from || !to || !date) return toast("Select from, to, and date.", "warn");
  selectedDate = date;

  // find buses for route
  const q1 = query(busesCol, where("from","==",from), where("to","==",to));
  const qs = await getDocs(q1);
  const list = $("#abResults");
  list.innerHTML = "";
  qs.forEach(s=>{
    const d=s.data();
    const card = document.createElement("div");
    card.className="result-card";
    card.innerHTML = `
      <div class="result-details">
        <h4>${d.company ?? "Bus"}</h4>
        <p><strong>Route:</strong> ${d.from} → ${d.to}</p>
        <p><strong>Depart:</strong> ${d.departureTime ?? "-"}</p>
        <p><strong>Price:</strong> KES ${d.price?Number(d.price).toLocaleString():"-"}</p>
        <button class="btn" data-busid="${s.id}" data-seats="${d.totalSeats ?? TOTAL_SEATS_DEFAULT}">Select Seats</button>
      </div>
    `;
    list.appendChild(card);
  });
});
$("#abResults").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button[data-busid]");
  if (!btn) return;
  selectedBusId = btn.dataset.busid;
  const total = Number(btn.dataset.seats || TOTAL_SEATS_DEFAULT);
  await openSeatModal(selectedBusId, selectedDate, total);
});

async function openSeatModal(busId, date, totalSeats) {
  selectedSeat = null;
  $("#seatGrid").innerHTML = "";
  $("#seatModal").classList.remove("hidden");
  // layout 4 columns
  $("#seatGrid").style.gridTemplateColumns = `repeat(4, 1fr)`;
  // get booked seats for that bus+date
  const qbk = query(bookingsCol, where("busId","==",busId), where("date","==",date));
  const snap = await getDocs(qbk);
  const booked = new Set();
  snap.forEach(s=>{
    const d=s.data();
    if (d.seat) booked.add(String(d.seat));
  });

  for (let i=1;i<=totalSeats;i++){
    const seat = document.createElement("div");
    seat.className = "seat-container" + (booked.has(String(i)) ? " booked" : "");
    seat.innerHTML = `<i class="fa-solid fa-chair seat-icon"></i><div class="seat-number">${i}</div>`;
    if (!booked.has(String(i))) {
      seat.addEventListener("click", ()=>{
        $$(".seat-container.selected").forEach(x=>x.classList.remove("selected"));
        seat.classList.add("selected");
        selectedSeat = i;
      });
    }
    $("#seatGrid").appendChild(seat);
  }
}
$("#seatCancel").addEventListener("click", ()=>$("#seatModal").classList.add("hidden"));

$("#adminConfirmBooking").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if (!selectedBusId || !selectedDate) return toast("Pick a bus & date first.", "warn");
  if (!selectedSeat) return toast("Select a seat.", "warn");

  const name = $("#abName").value.trim();
  const email = $("#abEmail").value.trim();
  const phone = $("#abPhone").value.trim();
  const price = Number($("#abPrice").value);
  const from = $("#abFrom").value.trim();
  const to = $("#abTo").value.trim();

  try {
    const refdoc = await addDoc(bookingsCol, {
      passengerName: name,
      passengerEmail: email,
      passengerPhone: phone,
      from, to,
      date: selectedDate,
      seat: String(selectedSeat),
      busId: selectedBusId,
      price: price || null,
      payment_status: "paid",
      createdBy: currentAdmin?.uid ?? null,
      createdAt: serverTimestamp()
    });
    $("#seatModal").classList.add("hidden");
    e.target.reset();
    toast("Booking created & marked PAID.", "success");

    // email confirmation
    if (email) {
      await addDoc(collection(db,"mail"), {
        to: [email],
        message: {
          subject: "Your Ticket – Prince Alex Travel",
          text: `Hi ${name||"Customer"}, your booking is confirmed. Seat ${selectedSeat} on ${selectedDate} (${from} → ${to}). Ref: ${refdoc.id}`,
          html: `<p>Hi ${name||"Customer"},</p>
                 <p>Your booking is confirmed.</p>
                 <p><strong>Ref:</strong> ${refdoc.id}<br>
                 <strong>Trip:</strong> ${from} → ${to}<br>
                 <strong>Date:</strong> ${selectedDate}<br>
                 <strong>Seat:</strong> ${selectedSeat}<br>
                 <strong>Amount:</strong> KES ${price?Number(price).toLocaleString():"-"}</p>
                 <p>Thank you for choosing Prince Alex Travel.</p>`
        },
        createdAt: serverTimestamp()
      });
    }
  } catch (err) {
    console.error(err);
    toast("Booking failed: " + err.message, "error");
  }
});
</script>

<style>
:root {
  --primary-color: #002d6b;
  --accent-color: #c69214;
  --light-bg: #f5f7fa;
  --text-dark: #1a1a1a;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:var(--light-bg);color:var(--text-dark)}
/* Navbar (match index) */
.navbar{background:var(--primary-color);padding:12px 0;box-shadow:0 2px 5px rgba(0,0,0,.1)}
.navbar-container{max-width:1200px;margin:auto;padding:0 20px;display:flex;align-items:center;justify-content:space-between}
.logo{background:#fff;padding:8px 12px;border-radius:12px;box-shadow:0 0 8px rgba(0,0,0,.2)}
.logo img{height:60px;display:block}
.nav-links{display:flex;gap:24px}
.nav-links a{color:#fff;text-decoration:none;font-weight:600;position:relative}
.nav-links a::after{content:"";display:block;height:2px;width:0;background:var(--accent-color);transition:width .3s;position:absolute;left:0;bottom:-6px}
.nav-links a:hover{color:var(--accent-color)}
.nav-links a:hover::after{width:100%}

/* Layout */
.container{max-width:1200px;margin:24px auto;padding:0 20px}
.hidden{display:none !important}
.header-row{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:16px}
.header-row h1{font-size:24px}
.badge{padding:4px 10px;border-radius:999px;font-size:12px}
.badge.success{background:#e6f8ea;color:#177a2b;border:1px solid #b5e3be}
.badge.warn{background:#fff3cd;color:#8a6d3b;border:1px solid #ffe29b}
.nowrap{white-space:nowrap}
.card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}

/* Buttons */
.btn{background:var(--accent-color);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;transition:.2s}
.btn:hover{filter:brightness(.95)}
.btn.sm{padding:7px 10px;font-size:12px}
.btn.danger{background:#c0392b}
.btn.success{background:#1f8b3f}

/* Forms & Tables */
input,select{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px}
label{font-size:13px;color:#333;margin-bottom:6px;display:block}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left}
.table th{background:#fafafa}

/* Tabs */
.tabbar{display:flex;gap:8px;margin-bottom:12px}
.tab-btn{background:#e9eef6;color:#123;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700}
.tab-btn.active{background:var(--primary-color);color:#fff}

/* Seat Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal .box{background:#fff;max-width:760px;width:95%;border-radius:12px;padding:18px;max-height:90vh;overflow:auto}
#seatGrid{display:grid;gap:12px;margin:12px 0;padding:10px;border:1px dashed #ccc;border-radius:8px}
.seat-container{position:relative;width:60px;height:60px;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:.2s}
.seat-container .seat-icon{font-size:2.2em;color:#7f8c8d}
.seat-container .seat-number{font-size:.8em;font-weight:bold;color:#555;margin-top:4px}
.seat-container.selected{background:#fcefdc}
.seat-container.selected .seat-icon,.seat-container.selected .seat-number{color:var(--accent-color)}
.seat-container.booked{cursor:not-allowed}
.seat-container.booked .seat-icon,.seat-container.booked .seat-number{color:#c0392b}
.seat-container.booked::after{content:"X";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:2em;color:#fff;background:rgba(0,0,0,.25);border-radius:8px}

/* Toast */
.toast{position:fixed;right:20px;bottom:20px;background:#222;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.25s;z-index:2000}
.toast.show{opacity:1;transform:translateY(0)}
.toast.success{background:#1f8b3f}
.toast.warn{background:#8a6d3b}
.toast.error{background:#c0392b}

/* Login */
.login-card{max-width:420px;margin:48px auto}
.login-title{text-align:center;margin-bottom:10px}

/* Responsive */
@media (max-width: 800px){
  .grid-3{grid-template-columns:1fr}
  .grid-2{grid-template-columns:1fr}
  .nav-links{gap:14px}
}
</style>
</head>
<body>
  <!-- Header (match index) -->
  <header class="navbar">
    <div class="navbar-container">
      <div class="logo">
        <img src="mylogo.png" alt="Prince Alex Logo"/>
      </div>
      <nav class="nav-links">
        <a href="index.html">Home</a>
        <a href="about-us.html">About Us</a>
        <a href="ticket-lookup.html">Print Ticket</a>
        <a href="#" class="badge" id="adminEmailBadge">Admin</a>
        <a href="#" id="logoutBtn">Logout</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Login -->
    <section id="loginCard" class="card login-card">
      <h2 class="login-title">Admin Login</h2>
      <form id="loginForm" class="grid" style="gap:14px">
        <div>
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="admin@example.com" required>
        </div>
        <div>
          <label>Password</label>
          <input id="loginPassword" type="password" placeholder="********" required>
        </div>
        <button class="btn" type="submit">Login</button>
        <p style="font-size:12px;opacity:.8">Access requires an entry in <code>admins/{uid}</code> with <code>isAdmin: true</code>.</p>
    </form>
    </section>

    <!-- Admin App -->
    <section id="adminApp" class="hidden">
      <div class="header-row">
        <h1>Admin Panel</h1>
        <div class="tabbar">
          <button class="tab-btn active" data-tab="tabBuses">Manage Buses</button>
          <button class="tab-btn" data-tab="tabBookings">Manage Bookings</button>
          <button class="tab-btn" data-tab="tabMakeBooking">Make Booking</button>
        </div>
      </div>

      <!-- Manage Buses -->
      <section id="tabBuses" class="tab-panel">
        <div class="card">
          <h3>Add New Bus</h3>
          <form id="addBusForm" class="grid grid-3" style="margin-top:10px">
            <div><label>Company</label><input id="busCompany" required></div>
            <div><label>From</label><input id="busFrom" required></div>
            <div><label>To</label><input id="busTo" required></div>
            <div><label>Departure Time</label><input id="busTime" placeholder="e.g. 08:00 AM" required></div>
            <div><label>Price (KES)</label><input id="busPrice" type="number" min="0" required></div>
            <div><label>Total Seats</label><input id="busSeats" type="number" min="1" value="32" required></div>
            <div class="nowrap" style="align-self:end"><button class="btn" type="submit">Add Bus</button></div>
          </form>
        </div>
        <div class="card">
          <h3>All Buses</h3>
          <table class="table" style="margin-top:8px">
            <thead><tr>
              <th>Company</th><th>From</th><th>To</th><th>Departure</th><th>Price</th><th>Seats</th><th>Actions</th>
            </tr></thead>
            <tbody id="busTableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Manage Bookings -->
      <section id="tabBookings" class="tab-panel hidden">
        <div class="card">
          <div class="grid grid-2">
            <div>
              <h3>Bookings</h3>
              <p style="font-size:12px;opacity:.8">Search by passenger name, email or booking reference.</p>
            </div>
            <div style="align-self:end">
              <input id="bookingSearch" placeholder="Search bookings...">
            </div>
          </div>
          <table class="table" style="margin-top:8px">
            <thead>
              <tr>
                <th>Ref</th><th>Name</th><th>Email</th><th>From</th><th>To</th><th>Date</th><th>Seat</th><th>Price</th><th>Status</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="bookingTableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Make Booking -->
      <section id="tabMakeBooking" class="tab-panel hidden">
        <div class="card">
          <h3>Find Bus</h3>
          <form id="adminBookingSearch" class="grid grid-3" style="margin-top:10px">
            <div><label>From</label><input id="abFrom" required></div>
            <div><label>To</label><input id="abTo" required></div>
            <div><label>Date</label><input id="abDate" type="date" required></div>
            <div class="nowrap" style="grid-column: 1 / -1; text-align:right">
              <button class="btn" type="submit">Search</button>
            </div>
          </form>
          <div id="abResults" class="grid" style="margin-top:10px; gap:14px"></div>
        </div>

        <div class="card">
          <h3>Passenger Details</h3>
          <form id="adminConfirmBooking" class="grid grid-3" style="margin-top:10px">
            <div><label>Full Name</label><input id="abName" required></div>
            <div><label>Email</label><input id="abEmail" type="email"></div>
            <div><label>Phone</label><input id="abPhone"></div>
            <div><label>Price (KES)</label><input id="abPrice" type="number" min="0"></div>
            <div class="nowrap" style="grid-column: 1 / -1; text-align:right">
              <button class="btn" type="submit">Confirm Booking (Paid)</button>
            </div>
          </form>
        </div>
      </section>
    </section>
  </main>

  <!-- Edit Bus Modal -->
  <div id="editBusModal" class="modal hidden">
    <div class="box">
      <h3>Edit Bus</h3>
      <form id="editBusForm" class="grid grid-3" style="margin-top:10px">
        <input type="hidden" id="editBusId">
        <div><label>Company</label><input id="editBusCompany" required></div>
        <div><label>From</label><input id="editBusFrom" required></div>
        <div><label>To</label><input id="editBusTo" required></div>
        <div><label>Departure Time</label><input id="editBusTime" required></div>
        <div><label>Price (KES)</label><input id="editBusPrice" type="number" required></div>
        <div><label>Total Seats</label><input id="editBusSeats" type="number" min="1" required></div>
        <div class="nowrap" style="grid-column:1/-1; text-align:right; display:flex; gap:8px; justify-content:flex-end">
          <button type="button" class="btn" id="editBusCancel">Cancel</button>
          <button class="btn" type="submit">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Seat Modal -->
  <div id="seatModal" class="modal hidden">
    <div class="box">
      <h3>Select Seat</h3>
      <div id="seatGrid"></div>
      <div style="text-align:right; display:flex; gap:8px; justify-content:flex-end">
        <button class="btn" id="seatCancel">Close</button>
      </div>
    </div>
  </div>
</body>
</html>
