<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Panel - Prince Alex Travel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://numnzxrnrlxvkjwlusbe.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51bW56eHJucmx4dmtqd2x1c2JlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMTgxNzgsImV4cCI6MjA2Njc5NDQ1OH0.03mPw9Y7tuWne5SNpsag7lYhQSZ6HqA8YmDSxVMVMFg';

        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Ensure it takes full viewport height */
        }
        .container {
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 900px;
            display: none; /* Hidden by default until admin logs in */
        }
        .admin-login-container {
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        h1, h2 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .tab-button {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            color: #555;
            position: relative;
            outline: none;
        }
        .tab-button.active {
            color: #007bff;
            font-weight: bold;
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -1px;
            width: 100%;
            height: 2px;
            background: #007bff;
        }
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background: #f2f2f2;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="time"],
        .form-group select,
        .form-group input[type="email"], /* For admin login */
        .form-group input[type="password"] /* For admin login */
        {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .logout-button {
            background: #dc3545;
            margin-left: 20px;
        }
        .logout-button:hover {
            background: #c82333;
        }
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .success-message {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .download-btn {
            background: #28a745;
            margin-top: 20px;
        }
        .download-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>

    <div class="admin-login-container" id="adminLoginContainer">
        <h2>Admin Login</h2>
        <form id="adminLoginForm">
            <div class="form-group">
                <label for="adminEmail">Email:</label>
                <input type="email" id="adminEmail" value="senerwaalex@gmail.com" required>
            </div>
            <div class="form-group">
                <label for="adminPassword">Password:</label>
                <input type="password" id="adminPassword" value="admin" required>
            </div>
            <button type="submit">Login</button>
            <p id="adminLoginMessage" class="message" style="display: none;"></p>
        </form>
    </div>

    <div class="container" id="adminPanel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>Admin Dashboard</h1>
            <button class="logout-button" onclick="adminLogout()">Logout</button>
        </div>

        <div class="tab-buttons">
            <button class="tab-button active" data-tab="busesTab" onclick="openTab(event, 'busesTab')">Manage Buses</button>
            <button class="tab-button" data-tab="bookingsTab" onclick="openTab(event, 'bookingsTab')">Manage Bookings</button>
            <button class="tab-button" data-tab="usersTab" onclick="openTab(event, 'usersTab')">Manage Users</button>
        </div>

        <div id="busesTab" class="tab-content active">
            <h2>Bus Management</h2>
            <p id="busesTabMessage" class="message" style="display: none;"></p>

            <h3>Add New Bus</h3>
            <form id="addBusForm">
                <div class="form-group">
                    <label for="busRoute">Route:</label>
                    <input type="text" id="busRoute" required>
                </div>
                <div class="form-group">
                    <label for="busTime">Departure Time:</label>
                    <input type="time" id="busTime" required>
                </div>
                <div class="form-group">
                    <label for="busPrice">Price (Ksh):</label>
                    <input type="number" id="busPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="busCapacity">Capacity:</label>
                    <input type="number" id="busCapacity" required>
                </div>
                <button type="submit">Add Bus</button>
            </form>

            <h3>Existing Buses</h3>
            <table id="busesTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Route</th>
                        <th>Time</th>
                        <th>Price</th>
                        <th>Capacity</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <div id="bookingsTab" class="tab-content">
            <h2>Booking Management</h2>
            <p id="bookingsTabMessage" class="message" style="display: none;"></p>
            <button class="download-btn" onclick="downloadBookingsCSV()">Download Bookings CSV</button>
            <table id="bookingsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Passenger Name</th>
                        <th>Route</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Seat</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <div id="usersTab" class="tab-content">
            <h2>User Management</h2>
            <p id="usersTabMessage" class="message" style="display: none;"></p>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>Full Name</th>
                        <th>Phone Number</th>
                        <th>Created At</th>
                        <th>Last Sign In</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // Supabase client already initialized in head

        const adminLoginContainer = document.getElementById('adminLoginContainer');
        const adminPanel = document.getElementById('adminPanel');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const adminLoginMessage = document.getElementById('adminLoginMessage');

        const addBusForm = document.getElementById('addBusForm');
        const busesTableBody = document.querySelector('#busesTable tbody');
        const bookingsTableBody = document.querySelector('#bookingsTable tbody');
        const usersTableBody = document.querySelector('#usersTable tbody');

        // Message display functions
        function showMessage(tabId, message, type) {
            const messageElement = document.getElementById(tabId + 'Message');
            if (messageElement) {
                messageElement.textContent = message;
                messageElement.className = `message ${type}-message`;
                messageElement.style.display = 'block';
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 5000); // Hide after 5 seconds
            }
        }

        function showSuccessMessage(tabId, message) {
            showMessage(tabId, message, 'success');
        }

        function showErrorMessage(tabId, message) {
            showMessage(tabId, message, 'error');
        }

        // Admin Login Logic
        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            adminLoginMessage.style.display = 'none';

            try {
                console.log('Attempting admin login for:', email);
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) {
                    throw error;
                }

                if (data.user) {
                    console.log('Admin login successful:', data.user);
                    // Check if the user is truly an admin (e.g., via RLS or custom claims/metadata)
                    // For now, we just proceed if login is successful.
                    // In a real app, you'd verify admin role here.
                    adminLoginContainer.style.display = 'none';
                    adminPanel.style.display = 'block';
                    loadBuses();
                    loadBookings();
                    loadUsers();
                    openTab(null, 'busesTab'); // Open default tab
                } else {
                    console.error('Admin Login Error: data.user is null after signInWithPassword.');
                    adminLoginMessage.textContent = 'An unexpected error occurred during login.';
                    adminLoginMessage.className = 'message error-message';
                    adminLoginMessage.style.display = 'block';
                }

            } catch (error) {
                console.error('Admin login error caught:', error.message);
                adminLoginMessage.textContent = 'Login failed: ' + error.message;
                adminLoginMessage.className = 'message error-message';
                adminLoginMessage.style.display = 'block';
            }
        });

        // Admin Logout
        async function adminLogout() {
            console.log('Attempting admin logout...');
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Logout error:', error.message);
            } else {
                console.log('Admin logged out successfully.');
                adminPanel.style.display = 'none';
                adminLoginContainer.style.display = 'block';
                // Clear tables if desired
                busesTableBody.innerHTML = '';
                bookingsTableBody.innerHTML = '';
                usersTableBody.innerHTML = '';
                adminLoginForm.reset(); // Clear login form fields
                adminLoginMessage.style.display = 'none';
            }
        }

        // Function to check initial session and show panel or login
        async function checkAdminSession() {
            console.log('Checking admin session...');
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error) {
                console.error('Error getting session:', error.message);
            }

            if (session) {
                // In a real app, you'd also check user roles here
                // For now, if a session exists, assume they can access admin.
                console.log('Active admin session found.');
                adminLoginContainer.style.display = 'none';
                adminPanel.style.display = 'block';
                loadBuses();
                loadBookings();
                loadUsers();
                openTab(null, 'busesTab'); // Open default tab
            } else {
                console.log('No active admin session. Showing login form.');
                adminLoginContainer.style.display = 'block';
                adminPanel.style.display = 'none';
            }
        }


        // Tab switching logic
        function openTab(evt, tabName) {
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].style.display = 'none';
            }
            const tabButtons = document.getElementsByClassName('tab-button');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            document.getElementById(tabName).style.display = 'block';
            if (evt) {
                evt.currentTarget.classList.add('active');
            } else { // For initial load via JS
                document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');
            }
        }

        // --- Bus Management Functions ---

        // Load Buses
        async function loadBuses() {
            console.log('Loading buses...');
            const { data, error } = await supabase
                .from('buses')
                .select('*')
                .order('id', { ascending: true }); // Order by ID for consistent display

            if (error) {
                console.error('Error loading buses:', error.message);
                showErrorMessage('busesTab', 'Failed to load buses: ' + error.message);
                return;
            }

            busesTableBody.innerHTML = ''; // Clear existing rows
            data.forEach(bus => {
                const row = busesTableBody.insertRow();
                row.insertCell().textContent = bus.id;
                row.insertCell().textContent = bus.route;
                row.insertCell().textContent = bus.time;
                row.insertCell().textContent = bus.price;
                row.insertCell().textContent = bus.capacity;
                const actionsCell = row.insertCell();

                // Add Update Button
                const updateBtn = document.createElement('button');
                updateBtn.textContent = 'Edit';
                updateBtn.onclick = () => editBus(bus);
                actionsCell.appendChild(updateBtn);

                // Add Delete Button
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.style.backgroundColor = '#f44336';
                deleteBtn.style.marginLeft = '5px';
                deleteBtn.onclick = () => deleteBus(bus.id);
                actionsCell.appendChild(deleteBtn);
            });
            console.log('Buses loaded successfully:', data);
        }

        // Add Bus
        addBusForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const route = document.getElementById('busRoute').value;
            const time = document.getElementById('busTime').value;
            const price = parseFloat(document.getElementById('busPrice').value);
            const capacity = parseInt(document.getElementById('busCapacity').value);

            console.log('Adding new bus:', { route, time, price, capacity });

            try {
                const { data, error } = await supabase
                    .from('buses')
                    .insert([{ route, time, price, capacity }]);

                if (error) {
                    throw error;
                }

                console.log('Bus added successfully:', data);
                showSuccessMessage('busesTab', 'Bus added successfully!');
                addBusForm.reset();
                loadBuses(); // Reload list to show new bus
            } catch (error) {
                console.error('Error adding bus:', error.message);
                showErrorMessage('busesTab', 'Failed to add bus: ' + error.message);
            }
        });

        // Edit/Update Bus (New Functionality)
        let currentEditingBusId = null; // To store the ID of the bus being edited

        function editBus(bus) {
            console.log('Editing bus:', bus);
            // Populate the "Add New Bus" form with current bus data for editing
            document.getElementById('busRoute').value = bus.route;
            document.getElementById('busTime').value = bus.time;
            document.getElementById('busPrice').value = bus.price;
            document.getElementById('busCapacity').value = bus.capacity;

            // Change the Add Bus button to an Update Bus button
            const addButton = addBusForm.querySelector('button[type="submit"]');
            addButton.textContent = 'Update Bus';
            addButton.onclick = (e) => submitUpdateBus(e, bus.id); // Set new click handler
            currentEditingBusId = bus.id; // Store ID for update

            showSuccessMessage('busesTab', 'Form loaded for editing. Click "Update Bus" to save changes.');
        }

        async function submitUpdateBus(e, busId) {
            e.preventDefault(); // Prevent form default submission

            const route = document.getElementById('busRoute').value;
            const time = document.getElementById('busTime').value;
            const price = parseFloat(document.getElementById('busPrice').value);
            const capacity = parseInt(document.getElementById('busCapacity').value);

            console.log('Updating bus ID:', busId, 'with data:', { route, time, price, capacity });

            try {
                const { data, error } = await supabase
                    .from('buses')
                    .update({ route, time, price, capacity })
                    .eq('id', busId); // Specify which row to update

                if (error) {
                    throw error;
                }

                console.log('Bus updated successfully:', data);
                showSuccessMessage('busesTab', 'Bus updated successfully!');
                addBusForm.reset(); // Clear the form
                loadBuses(); // Reload list to show updated bus

                // Reset the button back to "Add Bus"
                const addButton = addBusForm.querySelector('button[type="submit"]');
                addButton.textContent = 'Add Bus';
                addButton.onclick = (e) => addBusForm.dispatchEvent(new Event('submit')); // Restore original handler
                currentEditingBusId = null; // Clear editing state
            } catch (error) {
                console.error('Error updating bus:', error.message);
                showErrorMessage('busesTab', 'Failed to update bus: ' + error.message);
            }
        }


        // Delete Bus
        async function deleteBus(busId) {
            if (!confirm('Are you sure you want to delete this bus?')) {
                return;
            }
            console.log('Deleting bus ID:', busId);
            try {
                const { error } = await supabase
                    .from('buses')
                    .delete()
                    .eq('id', busId);

                if (error) {
                    throw error;
                }

                console.log('Bus deleted successfully:', busId);
                showSuccessMessage('busesTab', 'Bus deleted successfully!');
                loadBuses(); // Reload list
            } catch (error) {
                console.error('Error deleting bus:', error.message);
                showErrorMessage('busesTab', 'Failed to delete bus: ' + error.message);
            }
        }

        // --- Booking Management Functions ---

        async function loadBookings() {
            console.log('Loading bookings...');
            const { data, error } = await supabase
                .from('bookings')
                .select('*')
                .order('id', { ascending: false }); // Latest bookings first

            if (error) {
                console.error('Error loading bookings:', error.message);
                showErrorMessage('bookingsTab', 'Failed to load bookings: ' + error.message);
                return;
            }

            bookingsTableBody.innerHTML = '';
            data.forEach(booking => {
                const row = bookingsTableBody.insertRow();
                row.insertCell().textContent = booking.id;
                row.insertCell().textContent = booking.passengerName;
                row.insertCell().textContent = booking.busRoute;
                row.insertCell().textContent = booking.travelDate;
                row.insertCell().textContent = booking.busTime;
                row.insertCell().textContent = booking.seatNumber;
                row.insertCell().textContent = booking.price;
                row.insertCell().textContent = booking.status;
                const actionsCell = row.insertCell();

                // Add actions like 'Confirm Payment', 'Cancel Booking', etc.
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'Confirm Payment';
                confirmBtn.style.backgroundColor = '#007bff';
                confirmBtn.style.fontSize = '0.8em';
                confirmBtn.onclick = () => updateBookingStatus(booking.id, 'paid');
                actionsCell.appendChild(confirmBtn);

                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancel';
                cancelBtn.style.backgroundColor = '#f44336';
                cancelBtn.style.fontSize = '0.8em';
                cancelBtn.style.marginLeft = '5px';
                cancelBtn.onclick = () => updateBookingStatus(booking.id, 'cancelled');
                actionsCell.appendChild(cancelBtn);
            });
            console.log('Bookings loaded successfully:', data);
        }

        async function updateBookingStatus(bookingId, newStatus) {
            console.log(`Updating booking ${bookingId} to status: ${newStatus}...`);
            try {
                const { data, error } = await supabase
                    .from('bookings')
                    .update({ status: newStatus })
                    .eq('id', bookingId);

                if (error) {
                    throw error;
                }
                console.log('Booking status updated successfully:', data);
                showSuccessMessage('bookingsTab', `Booking ${bookingId} status updated to ${newStatus.toUpperCase()}!`);
                loadBookings(); // Reload to show changes
            } catch (error) {
                console.error('Error updating booking status:', error.message);
                showErrorMessage('bookingsTab', `Failed to update booking status: ${error.message}`);
            }
        }


        // --- User Management Functions ---

        async function loadUsers() {
            console.log('Loading users...');
            try {
                // Fetch users from auth.users (requires service role key for full details, or RLS)
                // For simplicity here, we'll try to join with the 'profiles' table
                // This assumes your RLS allows admin to read profiles or you're using a service key
                const { data: users, error: authError } = await supabase.auth.admin.listUsers(); // Requires service_role key to be able to list users for security

                if (authError) {
                    // Fallback if listUsers is not accessible (e.g. only anon key is used)
                    console.warn('Could not list users via auth.admin.listUsers, likely due to anonymous key. Attempting to load from profiles table only.');
                    const { data: profiles, error: profileError } = await supabase
                        .from('profiles')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (profileError) {
                        throw profileError;
                    }

                    usersTableBody.innerHTML = '';
                    profiles.forEach(profile => {
                        const row = usersTableBody.insertRow();
                        row.insertCell().textContent = profile.id;
                        row.insertCell().textContent = profile.email || 'N/A';
                        row.insertCell().textContent = profile.full_name || 'N/A';
                        row.insertCell().textContent = profile.phone_number || 'N/A';
                        row.insertCell().textContent = new Date(profile.created_at).toLocaleString() || 'N/A';
                        row.insertCell().textContent = 'N/A (from profiles)'; // Last sign-in not in profiles
                        const actionsCell = row.insertCell();
                        // Add delete button for user profiles
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete Profile';
                        deleteBtn.style.backgroundColor = '#f44336';
                        deleteBtn.style.fontSize = '0.8em';
                        deleteBtn.onclick = () => deleteUserProfile(profile.id);
                        actionsCell.appendChild(deleteBtn);
                    });
                    console.log('Users loaded from profiles table:', profiles);
                } else {
                    // If auth.admin.listUsers worked (e.g. using service key on backend)
                    usersTableBody.innerHTML = '';
                    for (const user of users.users) {
                        const { data: profile, error: profileFetchError } = await supabase
                            .from('profiles')
                            .select('full_name, phone_number')
                            .eq('id', user.id)
                            .single();

                        const row = usersTableBody.insertRow();
                        row.insertCell().textContent = user.id;
                        row.insertCell().textContent = user.email;
                        row.insertCell().textContent = profile ? profile.full_name : 'N/A';
                        row.insertCell().textContent = profile ? profile.phone_number : 'N/A';
                        row.insertCell().textContent = new Date(user.created_at).toLocaleString();
                        row.insertCell().textContent = user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleString() : 'Never';
                        const actionsCell = row.insertCell();
                        // Add delete button
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete User';
                        deleteBtn.style.backgroundColor = '#f44336';
                        deleteBtn.style.fontSize = '0.8em';
                        deleteBtn.onclick = () => deleteUser(user.id, user.email);
                        actionsCell.appendChild(deleteBtn);
                    }
                    console.log('Users loaded from auth.users:', users);
                }

            } catch (error) {
                console.error('Error loading users:', error.message);
                showErrorMessage('usersTab', 'Failed to load users: ' + error.message);
            }
        }

        // Deleting a user (from auth.users and profiles table)
        async function deleteUser(userId, userEmail) {
            if (!confirm(`Are you sure you want to delete user ${userEmail} (ID: ${userId})? This will also delete their profile.`)) {
                return;
            }
            console.log('Deleting user ID:', userId);
            try {
                // First, delete from profiles table
                const { error: profileError } = await supabase
                    .from('profiles')
                    .delete()
                    .eq('id', userId);

                if (profileError && profileError.code !== 'PGRST116') { // PGRST116 is "No rows found" which is fine if profile doesn't exist
                    console.warn('Could not delete profile (might not exist):', profileError.message);
                }

                // Then delete from auth.users (requires service_role key)
                // This operation typically requires a service role key on the backend
                // or specific RLS policies, which might not be set up for anon key.
                // If you get an error here, it's likely an RLS/auth policy issue.
                const { error: authUserError } = await supabase.auth.admin.deleteUser(userId);

                if (authUserError) {
                    throw authUserError;
                }

                console.log('User deleted successfully:', userId);
                showSuccessMessage('usersTab', `User ${userEmail} deleted successfully!`);
                loadUsers(); // Reload list
            } catch (error) {
                console.error('Error deleting user:', error.message);
                showErrorMessage('usersTab', 'Failed to delete user: ' + error.message + '. Check Supabase RLS for auth.users or try with service role key.');
            }
        }

        // Delete user profile only (if auth.admin.deleteUser is not accessible)
        async function deleteUserProfile(profileId) {
            if (!confirm('Are you sure you want to delete this user\'s profile? This will NOT delete their authentication account.')) {
                return;
            }
            console.log('Deleting user profile ID:', profileId);
            try {
                const { error } = await supabase
                    .from('profiles')
                    .delete()
                    .eq('id', profileId);

                if (error) {
                    throw error;
                }

                console.log('User profile deleted successfully:', profileId);
                showSuccessMessage('usersTab', 'User profile deleted successfully!');
                loadUsers(); // Reload list
            } catch (error) {
                console.error('Error deleting user profile:', error.message);
                showErrorMessage('usersTab', 'Failed to delete user profile: ' + error.message);
            }
        }

        // Download bookings as CSV
        function downloadBookingsCSV() {
            const table = document.getElementById('bookingsTable');
            const rows = table.querySelectorAll('tr');
            let csvRows = [];

            // Add header row
            const header = Array.from(rows[0].querySelectorAll('th')).map(th => `"${th.textContent.trim().replace(/"/g, '""')}"`);
            csvRows.push(header.join(','));

            // Add data rows, excluding the last column (Actions)
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const rowData = Array.from(row.querySelectorAll('td')).map((cell, index) => {
                    if (index === row.cells.length - 1) { // If it's the last column (Actions)
                        return null; // Exclude actions column
                    }
                    return `"${cell.textContent.trim().replace(/"/g, '""')}"`; // Escape double quotes within data
                }).filter(cell => cell !== null); // Filter out the null for the actions column

                csvRows.push(rowData.join(','));
            }

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'prince_alex_bookings.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // Clean up
            showSuccessMessage('bookingsTab', "Bookings data downloaded successfully as CSV!");
        }

        // Initial load when admin panel is shown or page is refreshed
        document.addEventListener('DOMContentLoaded', () => {
            checkAdminSession(); // Check if user is already logged in
        });

        // Listen for Supabase auth changes for persistent login state
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Admin Auth state changed:', event, session);
            if (event === 'SIGNED_IN') {
                console.log('User just signed in. Showing admin panel.');
                adminLoginContainer.style.display = 'none';
                adminPanel.style.display = 'block';
                loadBuses();
                loadBookings();
                loadUsers();
                openTab(null, 'busesTab');
            } else if (event === 'SIGNED_OUT') {
                console.log('User just signed out. Showing login form.');
                adminPanel.style.display = 'none';
                adminLoginContainer.style.display = 'block';
                adminLoginForm.reset();
                adminLoginMessage.style.display = 'none';
                busesTableBody.innerHTML = ''; // Clear tables
                bookingsTableBody.innerHTML = '';
                usersTableBody.innerHTML = '';
            }
        });
    </script>
</body>
</html>
