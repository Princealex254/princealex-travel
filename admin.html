<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Panel â€“ Prince Alex Travel</title>

<!-- Icons & PDF -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script> <!-- Added QRCode.js for PDF -->

<!-- Firebase SDKs -->
<script type="module">
/** =======================
 * Firebase (same as index.html)
 * ======================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { 
  getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDoc, increment, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDGErPBeQ1Fdx9EHPXOHepoEoOx7P2f57o",
  authDomain: "princealextravel.firebaseapp.com",
  projectId: "princealextravel",
  storageBucket: "princealextravel.firebasestorage.app",
  messagingSenderId: "947577729462",
  appId: "1:947577729462:web:dd4b4c7cb4a984c5e3d117"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/** =======================
 * DOM Helpers
 * ======================= */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

// Custom Alert Modal
function showCustomAlert(message, type = 'info', callback = null) {
    const modal = document.createElement('div');
    modal.classList.add('custom-alert-modal');
    let bgColor = '#002d6b'; // Primary Blue
    let textColor = 'white';
    if (type === 'success') { bgColor = '#28a745'; } // Green
    else if (type === 'error') { bgColor = '#dc3545'; } // Red
    else if (type === 'warning') { bgColor = '#ffc107'; textColor = '#333'; } // Yellow

    modal.innerHTML = `
        <div class="custom-alert-content" style="background:${bgColor}; color:${textColor};">
            <p>${message}</p>
            <button onclick="this.closest('.custom-alert-modal').remove(); if(window.alertCallback) window.alertCallback();">OK</button>
        </div>
    `;
    document.body.appendChild(modal);
    window.alertCallback = callback; // Store callback globally for button access
}

// Custom Confirm Modal
function showCustomConfirm(message, type = 'confirm', callback = null) {
    const modal = document.createElement('div');
    modal.classList.add('custom-alert-modal'); // Reusing same modal style
    let confirmColor = '#002d6b';
    if (type === 'delete') confirmColor = '#dc3545';

    modal.innerHTML = `
        <div class="custom-alert-content">
            <p style="color:${confirmColor};">${message}</p>
            <div class="confirm-buttons">
                <button class="confirm-yes" onclick="this.closest('.custom-alert-modal').remove(); if(window.confirmCallback) window.confirmCallback(true);">Yes</button>
                <button class="confirm-no" onclick="this.closest('.custom-alert-modal').remove(); if(window.confirmCallback) window.confirmCallback(false);">No</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    window.confirmCallback = callback; // Store callback globally for button access
}


/** =======================
 * Auth Guard
 * ======================= */
let currentAdmin = null;
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    currentAdmin = null;
    $("#adminApp").classList.add("hidden");
    $("#loginCard").classList.remove("hidden");
    $("#loginEmail").focus();
    return;
  }
  // Check admins collection
  const adminRef = doc(db, "admins", user.uid);
  const snap = await getDoc(adminRef);
  if (snap.exists() && snap.data().isAdmin === true) {
    currentAdmin = user;
    $("#adminEmailBadge").textContent = user.email ?? "Admin";
    $("#loginCard").classList.add("hidden");
    $("#adminApp").classList.remove("hidden");
    // load data
    attachRealtimeBuses();
    attachRealtimeBookings();
  } else {
    await signOut(auth);
    currentAdmin = null;
    $("#adminApp").classList.add("hidden");
    $("#loginCard").classList.remove("hidden");
    showCustomAlert("Access denied. This account is not an admin.", "error");
  }
});

$("#loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = $("#loginEmail").value.trim();
  const pass = $("#loginPassword").value;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
    showCustomAlert("Login successful!", "success");
  } /*
   * Error Handling
   */ catch (err) {
    console.error(err);
    showCustomAlert(err.message || "Login failed", "error");
  }
});
$("#logoutBtn").addEventListener("click", async ()=>{
  showCustomConfirm("Are you sure you want to log out?", "confirm", async (result) => {
    if (result) {
      try {
        await signOut(auth);
        showCustomAlert("Logged out.", "info");
      } /*
       * Error Handling
       */ catch (err) {
        showCustomAlert("Logout failed: " + err.message, "error");
      }
    }
  });
});

/** =======================
 * Tabs
 * ======================= */
$$(".tab-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const target = btn.dataset.tab;
    $$(".tab-btn").forEach(b=>b.classList.remove("active"));
    $$(".tab-panel").forEach(p=>p.classList.add("hidden"));
    btn.classList.add("active");
    $(`#${target}`).classList.remove("hidden");
  });
});

/** =======================
 * Manage Buses
 * ======================= */
const busesCol = collection(db, "buses");
let busesUnsub = null;

function attachRealtimeBuses() {
  if (busesUnsub) busesUnsub();
  busesUnsub = onSnapshot(busesCol, (snap)=>{
    const list = $("#busTableBody");
    list.innerHTML = "";
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const tr = document.createElement("tr");
      // Display fields consistent with index.html's implied structure
      tr.innerHTML = `
        <td>${d.company ?? "-"}</td>
        <td>${d.origin ?? "-"}</td> <!-- Changed from d.from to d.origin -->
        <td>${d.destination ?? "-"}</td> <!-- Changed from d.to to d.destination -->
        <td>${d.travelDate ?? "-"}</td>
        <td>${d.departureTime ?? "-"}</td>
        <td>${d.price ? "KES "+Number(d.price).toLocaleString() : "-"}</td>
        <td>${d.totalSeats ?? "-"}</td>
        <td>${d.available_seats ?? "-"}</td>
        <td class="nowrap">
          <button class="btn sm" data-action="edit" data-id="${docSnap.id}"><i class="fa-solid fa-pen-to-square"></i></button>
          <button class="btn sm danger" data-action="del" data-id="${docSnap.id}"><i class="fa-solid fa-trash"></i></button>
        </td>
      `;
      list.appendChild(tr);
    });
  });
}
$("#addBusForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const data = {
    company: $("#busCompany").value.trim(),
    origin: $("#busFrom").value.trim(), // Mapped to origin
    destination: $("#busTo").value.trim(),     // Mapped to destination
    travelDate: $("#busTravelDate").value, // New field for consistency
    departureTime: $("#busTime").value.trim(), // Maps to time
    price: Number($("#busPrice").value),
    totalSeats: Number($("#busSeats").value),
    available_seats: Number($("#busSeats").value), // Initialize available_seats
    image: $("#busImage").value.trim(), // New field for consistency
    createdAt: serverTimestamp()
  };

  if (!data.company || !data.origin || !data.destination || !data.travelDate || !data.departureTime || isNaN(data.price) || data.price <= 0 || isNaN(data.totalSeats) || data.totalSeats <= 0) {
      showCustomAlert("Please fill all required fields correctly (Company, From, To, Travel Date, Departure Time, Price, Total Seats).", "error");
      return;
  }

  try {
    await addDoc(busesCol, data);
    e.target.reset();
    showCustomAlert("Bus added.", "success");
  } /*
   * Error Handling
   */ catch (err) {
    console.error(err);
    showCustomAlert("Failed to add bus: " + err.message, "error");
  }
});
$("#busTableBody").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button");
  if (!btn) return;
  const id = btn.dataset.id;
  if (btn.dataset.action === "del") {
    showCustomConfirm("Delete this bus? This action cannot be undone.", "delete", async (result) => {
        if (result) {
            try {
              await deleteDoc(doc(db, "buses", id));
              showCustomAlert("Bus deleted.", "success");
            } /*
             * Error Handling
             */ catch (err) {
              showCustomAlert("Delete failed: " + err.message, "error");
            }
        }
    });
  } else if (btn.dataset.action === "edit") {
    // Load current values to editor
    const s = await getDoc(doc(db, "buses", id));
    if (!s.exists()) return;
    const d = s.data();
    $("#editBusId").value = id;
    $("#editBusCompany").value = d.company ?? "";
    $("#editBusFrom").value = d.origin ?? ""; // Changed from d.from to d.origin
    $("#editBusTo").value = d.destination ?? ""; // Changed from d.to to d.destination
    $("#editBusTravelDate").value = d.travelDate ?? ""; // New field
    $("#editBusTime").value = d.departureTime ?? "";
    $("#editBusPrice").value = d.price ?? "";
    $("#editBusSeats").value = d.totalSeats ?? "";
    $("#editBusImage").value = d.image ?? ""; // New field
    $("#editBusModal").classList.remove("hidden");
  }
});
$("#editBusForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const id = $("#editBusId").value;
  const updatedData = {
    company: $("#editBusCompany").value.trim(),
    origin: $("#editBusFrom").value.trim(), // Mapped to origin
    destination: $("#editBusTo").value.trim(),     // Mapped to destination
    travelDate: $("#editBusTravelDate").value, // New field
    departureTime: $("#editBusTime").value.trim(),
    price: Number($("#editBusPrice").value),
    totalSeats: Number($("#editBusSeats").value),
    image: $("#editBusImage").value.trim() // New field
  };

  if (!updatedData.company || !updatedData.origin || !updatedData.destination || !updatedData.travelDate || !updatedData.departureTime || isNaN(updatedData.price) || updatedData.price <= 0 || isNaN(updatedData.totalSeats) || updatedData.totalSeats <= 0) {
      showCustomAlert("Please fill all required fields correctly (Company, From, To, Travel Date, Departure Time, Price, Total Seats).", "error");
      return;
  }

  try {
    await updateDoc(doc(db, "buses", id), updatedData);
    $("#editBusModal").classList.add("hidden");
    showCustomAlert("Bus updated.", "success");
  } /*
   * Error Handling
   */ catch (err) {
    showCustomAlert("Update failed: " + err.message, "error");
  }
});
$("#editBusCancel").addEventListener("click", ()=>$("#editBusModal").classList.add("hidden"));

/** =======================
 * Manage Bookings
 * ======================= */
const bookingsCol = collection(db, "bookings");
let bookingsUnsub = null, bookingCache = [];

function attachRealtimeBookings() {
  if (bookingsUnsub) bookingsUnsub();
  bookingsUnsub = onSnapshot(bookingsCol, (snap)=>{
    bookingCache = [];
    snap.forEach(docSnap=>{
      bookingCache.push({ id: docSnap.id, ...docSnap.data() });
    });
    renderBookingTable(bookingCache);
  });
}
function renderBookingTable(items) {
  const body = $("#bookingTableBody");
  body.innerHTML = "";
  items.sort((a,b)=> (b.createdAt?.seconds??0)-(a.createdAt?.seconds??0));
  for (const b of items) {
    const paid = (b.status || "").toLowerCase() === "paid"; // Use 'status' field
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${b.booking_ref ?? b.reference ?? b.ref ?? "-"}</td>
      <td>${b.passenger_name ?? "-"}</td>
      <td>${b.passenger_email ?? "-"}</td>
      <td>${b.bus_route ?? "-"}</td> <!-- Using bus_route -->
      <td>${b.travel_date ?? "-"}</td> <!-- Using travel_date -->
      <td>${b.seat_number ?? "-"}</td> <!-- Using seat_number -->
      <td>${b.price ? "KES "+Number(b.price).toLocaleString() : "-"}</td>
      <td><span class="badge ${paid?"success":"warn"}">${paid ? "PAID" : "PENDING"}</span></td>
      <td class="nowrap">
        ${paid ? "" : `<button class="btn sm success" data-action="markpaid" data-id="${b.id}"><i class="fa-solid fa-check"></i> Paid</button>`}
        <button class="btn sm" data-action="ticket" data-id="${b.id}"><i class="fa-solid fa-ticket"></i></button>
        <button class="btn sm danger" data-action="del" data-id="${b.id}"><i class="fa-solid fa-trash"></i></button>
        </td>
    `;
    body.appendChild(tr);
  }
}
$("#bookingSearch").addEventListener("input", ()=>{
  const q = $("#bookingSearch").value.trim().toLowerCase();
  if (!q) return renderBookingTable(bookingCache);
  const results = bookingCache.filter(b=>{
    return (b.passenger_name??"").toLowerCase().includes(q)
      || (b.passenger_email??"").toLowerCase().includes(q) 
      || (b.booking_ref??b.reference??b.ref??"").toLowerCase().includes(q);
  });
  renderBookingTable(results);
});
$("#bookingTableBody").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button");
  if (!btn) return;
  const id = btn.dataset.id;
  const item = bookingCache.find(x=>x.id===id);
  if (!item) return;

  if (btn.dataset.action === "del") {
    showCustomConfirm("Delete this booking? This action cannot be undone.", "delete", async (result) => {
        if (result) {
            try {
                await deleteDoc(doc(db, "bookings", id));
                // Assuming busId and seatNumber are stored in booking for decrementing available_seats
                if (item.bus_id && item.seat_number) {
                    const busDocRef = doc(db, "buses", item.bus_id);
                    await updateDoc(busDocRef, {
                        available_seats: increment(1)
                    });
                    console.log(`Available seat incremented for bus ${item.bus_id}`);
                }
                showCustomAlert("Booking deleted.", "success");
            } /*
             * Error Handling
             */ catch (err) {
                showCustomAlert("Delete failed: " + err.message, "error");
            }
        }
    });
  } else if (btn.dataset.action === "markpaid") {
    try {
      await updateDoc(doc(db, "bookings", id), { status: "paid", paidAt: serverTimestamp() });
      showCustomAlert("Marked as PAID.", "success");
      // Send confirmation email (requires Firebase Trigger Email extension)
      if (item.passenger_email) {
        await addDoc(collection(db,"mail"), {
          to: [item.passenger_email],
          message: {
            subject: "Payment Confirmed â€“ Prince Alex Travel",
            text: `Hi ${item.passenger_name??"Customer"}, your payment for booking ${item.booking_ref??id} has been received. Seat ${item.seat_number??"-"} on ${item.travel_date??"-"} (${item.bus_route??"-"}). Thank you!`,
            html: `<p>Hi ${item.passenger_name??"Customer"},</p>
                   <p>Your payment for booking <strong>${item.booking_ref??id}</strong> has been received.</p>
                   <p><strong>Trip:</strong> ${item.bus_route??"-"}<br>
                   <strong>Date:</strong> ${item.travel_date??"-"}<br>
                   <strong>Seat:</strong> ${item.seat_number??"-"}<br>
                   <strong>Amount:</strong> KES ${item.price?Number(item.price).toLocaleString():"-"}</p>
                   <p>Thank you for choosing Prince Alex Travel.</p>`
          },
          createdAt: serverTimestamp()
        });
      }
    } /*
     * Error Handling
     */ catch (err) {
      showCustomAlert("Failed to mark paid: " + err.message, "error");
    }
  } else if (btn.dataset.action === "ticket") {
    generateTicketPDF(item);
  }
});

/** =======================
 * Ticket PDF
 * ======================= */
function generateTicketPDF(booking) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Define colors (matching CSS variables, directly from the CSS in the HTML)
    const primaryColor = '#002d6b';
    const accentColor = '#c69214';
    const darkTextColor = '#1a1a1a';
    // const secondaryTextColor = '#555'; // Not used in this PDF directly

    let yPos = 20; // Initial Y position for content

    // --- 1. Header with Logo and QR Code ---
    // Add Logo (using a placeholder as 'mylogo.png' is not directly accessible in this environment)
    // In a real application, you would load your actual logo image here.
    const logoPlaceholder = "https://placehold.co/100x40/002d6b/ffffff?text=LOGO"; // Placeholder image
    doc.addImage(logoPlaceholder, 'PNG', 15, yPos, 40, 40); // x, y, width, height


    // Title
    doc.setFontSize(24);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(primaryColor);
    doc.text("Prince Alex Travel Services", 60, yPos + 15);
    doc.setFontSize(14);
    doc.setFont("helvetica", "normal");
    doc.text("E-Ticket & Booking Confirmation", 60, yPos + 25);

    // Generate QR Code dynamically
    const qrCodeData = booking.booking_ref; // Data to encode in QR code
    const qrCodeContainer = document.createElement('div');
    qrCodeContainer.style.display = 'none'; // Hide it
    document.body.appendChild(qrCodeContainer);

    let qrCodeImgData = '';
    try {
        new QRCode(qrCodeContainer, {
            text: qrCodeData,
            width: 80,
            height: 80,
            colorDark : primaryColor, // Use company color for QR code
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });

        // Wait a tiny bit for QR code to render to canvas/img
        // This is a common pattern for async rendering to canvas/img
        // For a more robust solution in a production environment, consider a dedicated QR code library that provides direct image data or promises.
        // For this environment, a small timeout is often sufficient.
        const canvasElement = qrCodeContainer.querySelector('canvas');
        if (canvasElement) {
            qrCodeImgData = canvasElement.toDataURL("image/png");
        }
    } /*
     * Error Handling
     */ catch (qrError) {
        console.error("Error generating QR code:", qrError);
    } finally {
        // Clean up the temporary div
        if (qrCodeContainer.parentNode) { // Check if it's still attached to the DOM
            document.body.removeChild(qrCodeContainer);
        }
    }

    if (qrCodeImgData) {
         doc.addImage(qrCodeImgData, 'PNG', 160, yPos, 40, 40); // x, y, width, height
    } else {
        console.warn("QR Code image data not generated, skipping addition to PDF.");
    }

    yPos += 55; // Move Y position down after header content

    // --- Drawing the main ticket body container ---
    doc.setDrawColor(primaryColor);
    doc.setLineWidth(1.5);
    doc.line(10, yPos, 200, yPos); // Horizontal line below header

    yPos += 10; // Space after line

    // --- 2. Booking Reference (Prominent) ---
    doc.setFontSize(18);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(accentColor);
    doc.text(`Booking Reference: ${booking.booking_ref ?? booking.id}`, 20, yPos);
    yPos += 15;

    // --- 3. Passenger Details Section ---
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(primaryColor);
    doc.text("Passenger Details:", 20, yPos);
    yPos += 8;
    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(darkTextColor);
    doc.text(`Name: ${booking.passenger_name ?? "-"}`, 20, yPos); yPos += 7;
    doc.text(`ID Number: ${booking.passenger_id ?? "-"}`, 20, yPos); yPos += 7;
    doc.text(`Gender: ${booking.passenger_gender ?? "-"}`, 20, yPos); yPos += 7;
    doc.text(`Phone: ${booking.passenger_phone ?? "-"}`, 20, yPos); yPos += 7;
    doc.text(`Email: ${booking.passenger_email || 'N/A'}`, 20, yPos); yPos += 12;

    // --- 4. Journey Details Section ---
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(primaryColor);
    doc.text("Journey Details:", 20, yPos);
    yPos += 8;
    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(darkTextColor);
    doc.text(`Route: ${booking.bus_route ?? "-"}`, 20, yPos); yPos += 7;
    doc.text(`Travel Date: ${booking.travel_date ?? "-"}`, 20, yPos); yPos += 7;
    doc.text(`Departure Time: ${booking.bus_time ?? "-"}`, 20, yPos); yPos += 7;
    doc.text(`Bus ID: ${booking.bus_id ?? "-"}`, 20, yPos); yPos += 7;
    doc.text(`Seat Number: ${booking.seat_number ?? "-"}`, 20, yPos); yPos += 12;

    // --- 5. Payment Summary Section ---
    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(primaryColor);
    doc.text("Payment Summary:", 20, yPos);
    yPos += 8;
    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(darkTextColor);
    doc.text(`Amount: Ksh ${Number(booking.price ?? 0).toFixed(2)}`, 20, yPos); yPos += 7;
    doc.text(`Payment Status: ${(booking.status ?? "pending").toUpperCase()}`, 20, yPos); yPos += 12;
    doc.text(`Booking Date: ${new Date(booking.booking_date).toLocaleDateString()}`, 20, yPos); yPos += 12;

    // --- 6. Special Note for PENDING Status ---
    if ((booking.status ?? "pending").toUpperCase() === 'PENDING') {
        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(200, 0, 0); // Red color for warning
        doc.text("NOTE: This ticket is PENDING PAYMENT. Please complete payment to validate.", 20, yPos);
        yPos += 5;
        doc.text("Contact support for assistance: +254 717 384 875", 20, yPos);
        doc.setTextColor(darkTextColor); // Reset color
        yPos += 15;
    }

    // --- 7. Footer ---
    yPos = doc.internal.pageSize.height - 25; // Position footer from bottom
    doc.setDrawColor(primaryColor);
    doc.setLineWidth(0.5);
    doc.line(10, yPos, 200, yPos); // Horizontal line above footer
    yPos += 5;

    doc.setFontSize(9);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(darkTextColor);
    doc.text("Prince Alex Travel Services | Email: senerwaalex@gmail.com | Phone: +254 717 384 875", doc.internal.pageSize.width / 2, yPos, { align: "center" });
    yPos += 5;
    doc.text("Â© 2025 Prince Alex Digital. All rights reserved.", doc.internal.pageSize.width / 2, yPos, { align: "center" });

    doc.save(`PrinceAlex_Ticket_${booking.booking_ref ?? booking.id}.pdf`);
    console.log("PDF download initiated successfully.");
}


/** =======================
 * Make Booking (Admin)
 * ======================= */
let selectedBusId = null;
let selectedDate = null;
let selectedDepartureTime = null; // Store departure time
let selectedBusPrice = null; // Store bus price
let selectedBusRoute = null; // Store bus route (From -> To)
let selectedTotalSeats = null;
let selectedSeatNumber = null; // For single seat selection in admin make booking
let seatSelectionUnsubscribe = null; // For real-time seat updates in modal

// Initially disable the confirm booking button
document.addEventListener('DOMContentLoaded', () => {
    $("#adminConfirmBooking button[type='submit']").disabled = true;
    // Hide the passenger details card initially
    $("#passengerDetailsCard").classList.add("hidden");
});


$("#adminBookingSearch").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const origin = $("#abFrom").value.trim(); // Changed from 'from' to 'origin'
  const destination = $("#abTo").value.trim(); // Changed from 'to' to 'destination'
  const date = $("#abDate").value;

  if (!origin || !destination || !date) {
    return showCustomAlert("Please select origin, destination, and travel date.", "warn");
  }
  
  selectedDate = date;

  // Find buses for route and date
  const q1 = query(busesCol, where("origin","==",origin), where("destination","==",destination), where("travelDate", "==", date)); // Changed fields in query
  const qs = await getDocs(q1);
  const list = $("#abResults");
  list.innerHTML = "";

  if (qs.empty) {
      list.innerHTML = '<p style="text-align:center; margin-top:20px;">No buses found for this route and date.</p>';
      return;
  }

  qs.forEach(s=>{
    const d=s.data();
    const card = document.createElement("div");
    card.className="result-card";
    card.innerHTML = `
      <div class="result-details">
        <h4>${d.company ?? "Bus"}</h4>
        <p><strong>Route:</strong> ${d.origin} â†’ ${d.destination}</p> <!-- Changed from d.from to d.origin and d.to to d.destination -->
        <p><strong>Travel Date:</strong> ${d.travelDate}</p>
        <p><strong>Depart:</strong> ${d.departureTime ?? "-"}</p>
        <p><strong>Price:</strong> KES ${d.price ? Number(d.price).toLocaleString() : "-"}</p>
        <p><strong>Available Seats:</strong> ${d.available_seats ?? d.totalSeats ?? 0}</p>
        <p><strong>Total Seats:</strong> ${d.totalSeats ?? TOTAL_SEATS_DEFAULT}</p>
        <button class="btn" 
            data-busid="${s.id}" 
            data-total-seats="${d.totalSeats ?? TOTAL_SEATS_DEFAULT}"
            data-departure-time="${d.departureTime ?? "-"}"
            data-bus-price="${d.price ?? 0}"
            data-bus-route="${d.origin} to ${d.destination}" <!-- Changed to d.origin and d.destination -->
            data-available-seats="${d.available_seats ?? d.totalSeats ?? 0}"
            >Select Seats</button>
      </div>
    `;
    list.appendChild(card);
  });
});

$("#abResults").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button[data-busid]");
  if (!btn) return;

  selectedBusId = btn.dataset.busid;
  selectedTotalSeats = Number(btn.dataset.totalSeats || 0); // Use 0 if not available
  selectedDepartureTime = btn.dataset.departureTime;
  selectedBusPrice = Number(btn.dataset.busPrice);
  selectedBusRoute = btn.dataset.busRoute;
  const availableSeats = Number(btn.dataset.availableSeats);

  // Set the price in the passenger details form
  $("#abPrice").value = selectedBusPrice.toFixed(2); // Display with 2 decimal places

  // Disable confirm button until seat is selected
  $("#adminConfirmBooking button[type='submit']").disabled = true;


  if (availableSeats <= 0) {
      showCustomAlert("Sorry, this bus is fully booked. Please choose another one.", "warn");
      return;
  }

  await openSeatSelectionModal(selectedBusId, selectedDate, selectedTotalSeats, availableSeats);
});

async function openSeatSelectionModal(busId, travelDate, totalSeats, currentAvailableSeats) {
  selectedSeatNumber = null; // Reset selection
  const seatGrid = $("#seatGrid");
  seatGrid.innerHTML = "";
  $("#seatModal").classList.remove("hidden");
  
  // Display bus info in the modal
  $("#selectedBusInfoAdmin").textContent = `Bus ID: ${busId}, Date: ${travelDate}, Available: ${currentAvailableSeats}`;

  // Layout 4 columns (consistent with index.html's typical layout)
  seatGrid.style.gridTemplateColumns = `repeat(4, 1fr)`;

  // Add a "Front (Driver)" indicator
  const driverArea = document.createElement('div');
  driverArea.classList.add('driver-area');
  driverArea.textContent = 'Front (Driver)';
  seatGrid.appendChild(driverArea);

  // Unsubscribe from previous listener if exists
  if (seatSelectionUnsubscribe) {
      seatSelectionUnsubscribe();
      seatSelectionUnsubscribe = null;
  }

  // Setup real-time listener for bookings for this specific bus and date
  const bookingsRef = collection(db, "bookings");
  const q = query(bookingsRef, 
                  where("bus_id", "==", busId), 
                  where("travel_date", "==", travelDate),
                  where("status", "in", ['pending', 'paid'])); // Only consider active bookings

  seatSelectionUnsubscribe = onSnapshot(q, (snapshot) => {
      const bookedSeatsForThisTrip = new Set(snapshot.docs.map(doc => doc.data().seat_number));
      
      // Clear all seats except the driver area (if already present)
      // Rebuild the seat grid dynamically on each snapshot update
      const existingDriverArea = seatGrid.querySelector('.driver-area');
      seatGrid.innerHTML = '';
      if (existingDriverArea) {
          seatGrid.appendChild(existingDriverArea); // Re-add the driver area
      } else {
          const newDriverArea = document.createElement('div');
          newDriverArea.classList.add('driver-area');
          newDriverArea.textContent = 'Front (Driver)';
          seatGrid.appendChild(newDriverArea);
      }

      for (let i = 1; i <= totalSeats; i++) {
          const seatContainer = document.createElement("div");
          seatContainer.classList.add("seat-container");
          seatContainer.setAttribute("data-seat", i);

          const seatIcon = document.createElement("i");
          seatIcon.classList.add("fas", "fa-chair", "seat-icon");

          const seatNumSpan = document.createElement("span");
          seatNumSpan.classList.add("seat-number");
          seatNumSpan.textContent = `S${i}`; // Consistent with index.html

          seatContainer.appendChild(seatIcon);
          seatContainer.appendChild(seatNumSpan);

          if (bookedSeatsForThisTrip.has(String(i))) { // Firestore stores as string
              seatContainer.classList.add("booked");
              seatContainer.onclick = null;
          } else {
              seatContainer.classList.add("available");
              if (selectedSeatNumber === i) { // Re-highlight if it was the selected one
                  seatContainer.classList.add("selected");
              }
              seatContainer.onclick = function () {
                  // Deselect previously selected seat
                  const currentlySelected = document.querySelector("#seatGrid .seat-container.selected");
                  if (currentlySelected) {
                      currentlySelected.classList.remove("selected");
                  }
                  // Select new seat
                  this.classList.add("selected");
                  selectedSeatNumber = parseInt(this.dataset.seat);
                  $("#selectedSeatNumberAdmin").value = `S${selectedSeatNumber}`; // Update hidden input
                  showCustomAlert(`Seat S${selectedSeatNumber} selected.`, "info", null);
                  
                  // Close seat modal
                  $("#seatModal").classList.add("hidden"); 

                  // Show passenger details card
                  $("#passengerDetailsCard").classList.remove("hidden");
                  $("#adminConfirmBooking button[type='submit']").disabled = false; // Enable confirm button
                  $("#abName").focus(); // Focus on the first passenger detail input
              };
          }
          seatGrid.appendChild(seatContainer);
      }
  }, (error) => {
      console.error("Error fetching booked seats in real-time:", error.message);
      showCustomAlert("Error loading seat availability. Please try again.", "error");
  });
}

$("#seatCancel").addEventListener("click", ()=>{
    $("#seatModal").classList.add("hidden");
    if (seatSelectionUnsubscribe) {
        seatSelectionUnsubscribe(); // Unsubscribe when modal closes
        seatSelectionUnsubscribe = null;
    }
    // Clear passenger details and reset state for next time
    $("#abName").value = '';
    $("#abEmail").value = '';
    $("#abPhone").value = '';
    $("#abID").value = '';
    $("#abGender").value = '';
    $("#abPrice").value = ''; // Clear price input too
    $("#selectedSeatNumberAdmin").value = ''; // Clear selected seat display
    selectedBusId = null;
    selectedDate = null;
    selectedDepartureTime = null;
    selectedBusPrice = null;
    selectedBusRoute = null;
    selectedTotalSeats = null;
    selectedSeatNumber = null;
    $("#adminConfirmBooking button[type='submit']").disabled = true; // Re-disable confirm button
    $("#passengerDetailsCard").classList.add("hidden"); // Hide passenger details card
});

$("#adminConfirmBooking").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if (!selectedBusId || !selectedDate) {
      return showCustomAlert("Please search and select a bus first.", "warn");
  }
  if (!selectedSeatNumber) {
      return showCustomAlert("Please select a seat.", "warn");
  }

  const passenger_name = $("#abName").value.trim();
  const passenger_email = $("#abEmail").value.trim();
  const passenger_phone = $("#abPhone").value.trim();
  const passenger_id = $("#abID").value.trim(); 
  const passenger_gender = $("#abGender").value; 

  // Basic validation
  if (!passenger_name || !passenger_phone || !passenger_email || !passenger_id || !passenger_gender) {
      return showCustomAlert("Please fill all passenger details.", "error");
  }
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(passenger_email)) {
      return showCustomAlert("Please enter a valid email address.", "error");
  }
  const phoneRegex = /^\+?[0-9\s-]{7,20}$/; 
  if (!phoneRegex.test(passenger_phone)) {
      return showCustomAlert("Please enter a valid Phone Number (e.g., +254712345678 or 0712345678).", "error");
  }

  // Generate unique booking reference
  const booking_ref = 'PA-' + Date.now().toString().slice(-6) + '-' + String(selectedSeatNumber).padStart(2, '0'); // Pad seat number for consistent ref format

  try {
    // Re-check if seat is still available (race condition check)
    const existingBookingsQ = query(
        collection(db, "bookings"),
        where("bus_id", "==", selectedBusId),
        where("travel_date", "==", selectedDate),
        where("seat_number", "==", `S${selectedSeatNumber}`), // Match "S<number>" format
        where("status", "in", ['pending', 'paid'])
    );
    const existingBookingsSnapshot = await getDocs(existingBookingsQ);
    if (!existingBookingsSnapshot.empty) {
        showCustomAlert(`Seat S${selectedSeatNumber} has just been booked. Please choose another seat.`, "warn");
        // Re-trigger seat rendering to update current state
        const busDoc = await getDoc(doc(db, "buses", selectedBusId));
        if (busDoc.exists()) {
            await openSeatSelectionModal(selectedBusId, selectedDate, busDoc.data().totalSeats, busDoc.data().available_seats);
        }
        return;
    }

    // Prepare booking data, consistent with index.html
    const bookingData = {
        booking_ref: booking_ref,
        passenger_name: passenger_name,
        passenger_id: passenger_id,
        passenger_gender: passenger_gender,
        passenger_phone: passenger_phone,
        passenger_email: passenger_email,
        bus_id: selectedBusId,
        bus_route: selectedBusRoute, // From selected bus
        bus_time: selectedDepartureTime, // From selected bus
        travel_date: selectedDate,
        seat_number: `S${selectedSeatNumber}`, // Store as "S<number>"
        price: selectedBusPrice, // Price per seat, from selected bus
        status: 'paid', // Admin bookings are considered paid directly
        booking_date: new Date().toISOString(),
        user_id: currentAdmin?.uid ?? null, // Track who booked
        createdAt: serverTimestamp() // Add server timestamp
    };

    const newBookingDocRef = await addDoc(bookingsCol, bookingData); // Add new booking
    
    // Decrement available_seats in the buses collection
    const busDocRef = doc(db, "buses", selectedBusId);
    await updateDoc(busDocRef, {
        available_seats: increment(-1)
    });

    // Send confirmation email (requires Firebase Trigger Email extension)
    if (passenger_email) {
      await addDoc(collection(db,"mail"), {
        to: [passenger_email],
        message: {
          subject: "Your Prince Alex Travel Booking is Confirmed (Admin Booking)",
          html: `
              <p>Dear ${passenger_name},</p>
              <p>Your booking with reference <strong>${booking_ref}</strong> has been successfully created by our administration team.</p>
              <p>The payment for this booking is confirmed.</p>
              <h3>Booking Details:</h3>
              <ul>
                  <li><strong>Route:</strong> ${selectedBusRoute}</li>
                  <li><strong>Travel Date:</strong> ${selectedDate}</li>
                  <li><strong>Departure Time:</strong> ${selectedDepartureTime}</li>
                  <li><strong>Seat Number:</strong> S${selectedSeatNumber}</li>
                  <li><strong>Total Price:</strong> Ksh ${selectedBusPrice.toFixed(2)}</li>
                  <li><strong>Payment Status:</strong> Paid</li>
              </ul>
              <p>Thank you for choosing Prince Alex Travel. We look forward to serving you!</p>
              <hr>
              <p style="font-size: 0.8em; color: #777;">&copy; 2025 Prince Alex Digital. All rights reserved.</p>
          `,
        },
        createdAt: serverTimestamp()
      });
      console.log("Admin-initiated booking confirmation email queued successfully.");
    }

    $("#seatModal").classList.add("hidden");
    e.target.reset(); // Reset the passenger details form
    $("#adminConfirmBooking button[type='submit']").disabled = true; // Disable button after booking
    $("#passengerDetailsCard").classList.add("hidden"); // Hide passenger details card again
    showCustomAlert("Booking created & marked PAID. Confirmation email sent!", "success", () => {
        // Automatically generate and download PDF receipt after successful booking
        generateTicketPDF(bookingData); 
    });
    
    // Unsubscribe from seat listener when booking is confirmed
    if (seatSelectionUnsubscribe) {
        seatSelectionUnsubscribe();
        seatSelectionUnsubscribe = null;
    }
    loadBookings(); // Reload bookings table (need to define this function or call attachRealtimeBookings)
    // Optionally, switch to the bookings tab
    // This is already handled by onSnapshot in attachRealtimeBookings, so no need for explicit switch
    // $(".tab-btn[data-tab='tabBookings']").click();

  } /*
   * Error Handling
   */ catch (err) {
    console.error(err);
    showCustomAlert("Booking failed: " + err.message, "error");
  }
});

// Helper function to reload bookings table for consistency if needed
// This is already done via onSnapshot in attachRealtimeBookings,
// but adding a function for explicit calls if other parts need it.
function loadBookings() {
    attachRealtimeBookings();
}
</script>

<style>
:root {
  --primary-color: #002d6b;
  --accent-color: #c69214;
  --light-bg: #f5f7fa;
  --text-dark: #1a1a1a;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:var(--light-bg);color:var(--text-dark)}
/* Navbar (match index) */
.navbar{background:var(--primary-color);padding:12px 0;box-shadow:0 2px 5px rgba(0,0,0,.1)}
.navbar-container{max-width:1200px;margin:auto;padding:0 20px;display:flex;align-items:center;justify-content:space-between}
.logo{background:#fff;padding:8px 12px;border-radius:12px;box-shadow:0 0 8px rgba(0,0,0,.2)}
.logo img{height:60px;display:block}
.nav-links{display:flex;gap:24px}
.nav-links a{color:#fff;text-decoration:none;font-weight:600;position:relative}
.nav-links a::after{content:"";display:block;height:2px;width:0;background:var(--accent-color);transition:width .3s;position:absolute;left:0;bottom:-6px}
.nav-links a:hover{color:var(--accent-color)}
.nav-links a:hover::after{width:100%}

/* Layout */
.container{max-width:1200px;margin:24px auto;padding:0 20px}
.hidden{display:none !important}
.header-row{display:flex;align-items:center;gap:12px;justify-content:space-between;margin-bottom:16px}
.header-row h1{font-size:24px}
.badge{padding:4px 10px;border-radius:999px;font-size:12px}
.badge.success{background:#e6f8ea;color:#177a2b;border:1px solid #b5e3be}
.badge.warn{background:#fff3cd;color:#8a6d3b;border:1px solid #ffe29b}
.nowrap{white-space:nowrap}
.card{background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:16px;margin-bottom:16px}

/* Buttons */
.btn{background:var(--accent-color);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;transition:.2s}
.btn:hover{filter:brightness(.95)}
.btn.sm{padding:7px 10px;font-size:12px}
.btn.danger{background:#c0392b}
.btn.success{background:#1f8b3f}

/* Forms & Tables */
input,select{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px}
label{font-size:13px;color:#333;margin-bottom:6px;display:block}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-bottom:1px solid #eee;text-align:left}
.table th{background:#fafafa}

/* Tabs */
.tabbar{display:flex;gap:8px;margin-bottom:12px}
.tab-btn{background:#e9eef6;color:#123;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700}
.tab-btn.active{background:var(--primary-color);color:#fff}

/* Seat Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal .box{background:#fff;max-width:760px;width:95%;border-radius:12px;padding:18px;max-height:90vh;overflow:auto}
#seatGrid{display:grid;gap:12px;margin:12px 0;padding:10px;border:1px dashed #ccc;border-radius:8px}
.seat-container{position:relative;width:60px;height:60px;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:.2s}
.seat-container .seat-icon{font-size:2.2em;color:#7f8c8d}
.seat-container .seat-number{font-size:.8em;font-weight:bold;color:#555;margin-top:4px}
.seat-container.selected{background:#fcefdc}
.seat-container.selected .seat-icon,.seat-container.selected .seat-number{color:var(--accent-color)}
.seat-container.booked{cursor:not-allowed}
.seat-container.booked .seat-icon,.seat-container.booked .seat-number{color:#c0392b}
.seat-container.booked::after{content:"X";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:2em;color:#fff;background:rgba(0,0,0,.25);border-radius:8px}
.driver-area { /* Style for the "Front (Driver)" label */
    grid-column: 1 / -1; /* Span all columns */
    text-align: center;
    margin-bottom: 15px;
    font-weight: bold;
    color: var(--primary-color);
    padding: 5px;
    border-bottom: 1px solid #eee;
}
.aisle-space { /* For the gap in the seat layout */
    width: 100%;
    height: 100%;
}

/* Toast (Custom Alert/Confirm) */
.custom-alert-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000; /* Higher than other modals */
}
.custom-alert-content {
    background: white;
    padding: 25px;
    border-radius: 8px;
    text-align: center;
    max-width: 400px;
    box-shadow: 0 4px 8px rgba(0,0,0,.2);
    display: flex;
    flex-direction: column;
    gap: 20px;
}
.custom-alert-content p {
    margin-bottom: 0; /* Remove default paragraph margin */
    font-size: 1.1em;
    color: var(--text-dark);
}
.custom-alert-content button {
    background-color: var(--primary-color);
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color .3s ease;
}
.custom-alert-content button:hover {
    background-color: #001a4d;
}
.confirm-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
}
.confirm-buttons .confirm-yes {
    background-color: var(--success-color); /* Green for Yes */
}
.confirm-buttons .confirm-yes:hover {
    background-color: #218838;
}
.confirm-buttons .confirm-no {
    background-color: var(--error-color); /* Red for No */
}
.confirm-buttons .confirm-no:hover {
    background-color: #c82333;
}


/* Login */
.login-card{max-width:420px;margin:48px auto}
.login-title{text-align:center;margin-bottom:10px}

/* Responsive */
@media (max-width: 800px){
  .grid-3{grid-template-columns:1fr}
  .grid-2{grid-template-columns:1fr}
  .nav-links{gap:14px}
}
</style>
</head>
<body>
  <!-- Header (match index) -->
  <header class="navbar">
    <div class="navbar-container">
      <div class="logo">
        <img src="mylogo.png" alt="Prince Alex Logo"/>
      </div>
      <nav class="nav-links">
        <a href="index.html">Home</a>
        <a href="about-us.html">About Us</a>
        <a href="ticket-lookup.html">Print Ticket</a>
        <a href="#" class="badge" id="adminEmailBadge">Admin</a>
        <a href="#" id="logoutBtn">Logout</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Login -->
    <section id="loginCard" class="card login-card">
      <h2 class="login-title">Admin Login</h2>
      <form id="loginForm" class="grid" style="gap:14px">
        <div>
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="admin@example.com" required>
        </div>
        <div>
          <label>Password</label>
          <input id="loginPassword" type="password" placeholder="********" required>
        </div>
        <button class="btn" type="submit">Login</button>
        <p style="font-size:12px;opacity:.8">
    </form>
    </section>

    <!-- Admin App -->
    <section id="adminApp" class="hidden">
      <div class="header-row">
        <h1>Admin Panel</h1>
        <div class="tabbar">
          <button class="tab-btn active" data-tab="tabBuses">Manage Buses</button>
          <button class="tab-btn" data-tab="tabBookings">Manage Bookings</button>
          <button class="tab-btn" data-tab="tabMakeBooking">Make Booking</button>
        </div>
      </div>

      <!-- Manage Buses -->
      <section id="tabBuses" class="tab-panel">
        <div class="card">
          <h3>Add New Bus</h3>
          <form id="addBusForm" class="grid grid-3" style="margin-top:10px">
            <div><label>Company</label><input id="busCompany" required></div>
            <div><label>From (Origin)</label><input id="busFrom" required></div>
            <div><label>To (Destination)</label><input id="busTo" required></div>
            <div><label>Travel Date</label><input id="busTravelDate" type="date" required></div> <!-- New Field -->
            <div><label>Departure Time</label><input id="busTime" placeholder="e.g. 08:00 AM" required></div>
            <div><label>Price (KES)</label><input id="busPrice" type="number" min="0" required></div>
            <div><label>Total Seats</label><input id="busSeats" type="number" min="1" value="32" required></div>
            <div style="grid-column: span 2;"><label>Image URL (Optional)</label><input id="busImage" type="text" placeholder="https://example.com/bus.png"></div> <!-- New Field -->
            <div class="nowrap" style="align-self:end"><button class="btn" type="submit">Add Bus</button></div>
          </form>
        </div>
        <div class="card">
          <h3>All Buses</h3>
          <table class="table" style="margin-top:8px">
            <thead><tr>
              <th>Company</th><th>From</th><th>To</th><th>Travel Date</th><th>Departure</th><th>Price</th><th>Total Seats</th><th>Available Seats</th><th>Actions</th>
            </tr></thead>
            <tbody id="busTableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Manage Bookings -->
      <section id="tabBookings" class="tab-panel hidden">
        <div class="card">
          <div class="grid grid-2">
            <div>
              <h3>Bookings</h3>
              <p style="font-size:12px;opacity:.8">Search by passenger name, email or booking reference.</p>
            </div>
            <div style="align-self:end">
              <input id="bookingSearch" placeholder="Search bookings...">
            </div>
          </div>
          <table class="table" style="margin-top:8px">
            <thead>
              <tr>
                <th>Ref</th><th>Name</th><th>Email</th><th>Route</th><th>Travel Date</th><th>Seat</th><th>Price</th><th>Status</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="bookingTableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Make Booking -->
      <section id="tabMakeBooking" class="tab-panel hidden">
        <div class="card">
          <h3>Find Bus</h3>
          <form id="adminBookingSearch" class="grid grid-3" style="margin-top:10px">
            <div><label>From (Origin)</label><input id="abFrom" required></div>
            <div><label>To (Destination)</label><input id="abTo" required></div>
            <div><label>Travel Date</label><input id="abDate" type="date" required></div>
            <div class="nowrap" style="grid-column: 1 / -1; text-align:right">
              <button class="btn" type="submit">Search</button>
            </div>
          </form>
          <div id="abResults" class="grid" style="margin-top:10px; gap:14px"></div>
        </div>

        <div id="passengerDetailsCard" class="card hidden"> <!-- Added ID and hidden class -->
          <h3>Passenger Details</h3>
          <form id="adminConfirmBooking" class="grid grid-3" style="margin-top:10px">
            <div><label>Full Name</label><input id="abName" required></div>
            <div><label>Email</label><input id="abEmail" type="email"></div>
            <div><label>Phone</label><input id="abPhone"></div>
            <div><label>ID Number</label><input id="abID" required></div> <!-- New Field -->
            <div>
              <label>Gender</label>
              <select id="abGender" required> <!-- New Field -->
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div><label>Price (KES per seat)</label><input id="abPrice" type="number" min="0" readonly></div> <!-- Display price for clarity -->
            <input type="hidden" id="selectedSeatNumberAdmin"> <!-- To store selected seat -->
            <div class="nowrap" style="grid-column: 1 / -1; text-align:right">
              <button class="btn" type="submit">Confirm Booking (Paid)</button>
            </div>
          </form>
        </div>
      </section>
    </section>
  </main>

  <!-- Edit Bus Modal -->
  <div id="editBusModal" class="modal hidden">
    <div class="box">
      <h3>Edit Bus</h3>
      <form id="editBusForm" class="grid grid-3" style="margin-top:10px">
        <input type="hidden" id="editBusId">
        <div><label>Company</label><input id="editBusCompany" required></div>
        <div><label>From (Origin)</label><input id="editBusFrom" required></div>
        <div><label>To (Destination)</label><input id="editBusTo" required></div>
        <div><label>Travel Date</label><input id="editBusTravelDate" type="date" required></div> <!-- New Field -->
        <div><label>Departure Time</label><input id="editBusTime" required></div>
        <div><label>Price (KES)</label><input id="editBusPrice" type="number" required></div>
        <div><label>Total Seats</label><input id="editBusSeats" type="number" min="1" required></div>
        <div style="grid-column: span 2;"><label>Image URL (Optional)</label><input id="editBusImage" type="text" placeholder="https://example.com/bus.png"></div> <!-- New Field -->
        <div class="nowrap" style="grid-column:1/-1; text-align:right; display:flex; gap:8px; justify-content:flex-end">
          <button type="button" class="btn" id="editBusCancel">Cancel</button>
          <button class="btn" type="submit">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Seat Modal -->
  <div id="seatModal" class="modal hidden">
    <div class="box">
      <h3>Select Seat for <span id="selectedBusInfoAdmin"></span></h3>
      <div id="seatGrid"></div>
      <div style="text-align:right; display:flex; gap:8px; justify-content:flex-end">
        <button class="btn" id="seatCancel">Close</button>
      </div>
    </div>
  </div>
</body>
</html>

