<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Panel – Prince Alex Travel</title>

<!-- Icons & PDF -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script> <!-- Added QRCode.js for PDF -->

<!-- Firebase SDKs -->
<script type="module">
/** =======================
 * Firebase (same as index.html)
 * ======================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { 
  getFirestore, collection, query, where, getDocs, addDoc, doc, updateDoc, deleteDoc, onSnapshot, getDoc, increment, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDGErPBeQ1Fdx9EHPXOHepoEoOx7P2f57o",
  authDomain: "princealextravel.firebaseapp.com",
  projectId: "princealextravel",
  storageBucket: "princealextravel.firebasestorage.app",
  messagingSenderId: "947577729462",
  appId: "1:947577729462:web:dd4b4c7cb4a984c5e3d117"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/** =======================
 * DOM Helpers
 * ======================= */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

// Custom Alert Modal
function showCustomAlert(message, type = 'info', callback = null) {
    const modal = document.createElement('div');
    modal.classList.add('custom-alert-modal');
    let bgColor = '#002d6b'; // Primary Blue
    let textColor = 'white';
    if (type === 'success') { bgColor = '#28a745'; } // Green
    else if (type === 'error') { bgColor = '#dc3545'; } // Red
    else if (type === 'warning') { bgColor = '#ffc107'; textColor = '#333'; } // Yellow

    modal.innerHTML = `
        <div class="custom-alert-content" style="background:${bgColor}; color:${textColor};">
            <p>${message}</p>
            <button onclick="this.closest('.custom-alert-modal').remove(); if(window.alertCallback) window.alertCallback();">OK</button>
        </div>
    `;
    document.body.appendChild(modal);
    window.alertCallback = callback; // Store callback globally for button access
}

// Custom Confirm Modal
function showCustomConfirm(message, type = 'confirm', callback = null) {
    const modal = document.createElement('div');
    modal.classList.add('custom-alert-modal'); // Reusing same modal style
    let confirmColor = '#002d6b';
    if (type === 'delete') confirmColor = '#dc3545';

    modal.innerHTML = `
        <div class="custom-alert-content">
            <p style="color:${confirmColor};">${message}</p>
            <div class="confirm-buttons">
                <button class="confirm-yes" onclick="this.closest('.custom-alert-modal').remove(); if(window.confirmCallback) window.confirmCallback(true);">Yes</button>
                <button class="confirm-no" onclick="this.closest('.custom-alert-modal').remove(); if(window.confirmCallback) window.confirmCallback(false);">No</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    window.confirmCallback = callback; // Store callback globally for button access
}


/** =======================
 * Auth Guard
 * ======================= */
let currentAdmin = null;
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    currentAdmin = null;
    $("#adminApp").classList.add("hidden");
    $("#loginCard").classList.remove("hidden");
    $("#loginEmail").focus();
    return;
  }
  // Check admins collection
  const adminRef = doc(db, "admins", user.uid);
  const snap = await getDoc(adminRef);
  if (snap.exists() && snap.data().isAdmin === true) {
    currentAdmin = user;
    $("#adminEmailBadge").textContent = user.email ?? "Admin";
    $("#loginCard").classList.add("hidden");
    $("#adminApp").classList.remove("hidden");
    // load data
    attachRealtimeBuses();
    attachRealtimeBookings();
    populateRouteDropdowns(); // Populate dropdowns after auth
  } else {
    await signOut(auth);
    currentAdmin = null;
    $("#adminApp").classList.add("hidden");
    $("#loginCard").classList.remove("hidden");
    showCustomAlert("Access denied. This account is not an admin.", "error");
  }
});

$("#loginForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const email = $("#loginEmail").value.trim();
  const pass = $("#loginPassword").value;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
    showCustomAlert("Login successful!", "success");
  } catch (err) {
    console.error(err);
    showCustomAlert(err.message || "Login failed", "error");
  }
});
$("#logoutBtn").addEventListener("click", async ()=>{
  showCustomConfirm("Are you sure you want to log out?", "confirm", async (result) => {
    if (result) {
      try {
        await signOut(auth);
        showCustomAlert("Logged out.", "info");
      } catch (err) {
        showCustomAlert("Logout failed: " + err.message, "error");
      }
    }
  });
});

/** =======================
 * Tabs
 * ======================= */
$$(".tab-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const target = btn.dataset.tab;
    $$(".tab-btn").forEach(b=>b.classList.remove("active"));
    $$(".tab-panel").forEach(p=>p.classList.add("hidden"));
    btn.classList.add("active");
    $(`#${target}`).classList.remove("hidden");
  });
});

/** =======================
 * Manage Buses
 * ======================= */
const busesCol = collection(db, "buses");
let busesUnsub = null;

function attachRealtimeBuses() {
  if (busesUnsub) busesUnsub();
  busesUnsub = onSnapshot(busesCol, (snap)=>{
    const list = $("#busTableBody");
    list.innerHTML = "";
    snap.forEach(docSnap=>{
      const d = docSnap.data();
      const tr = document.createElement("tr");
      // Display fields consistent with index.html's implied structure
      tr.innerHTML = `
        <td>${d.company ?? "-"}</td>
        <td>${d.origin ?? "-"}</td> <!-- Changed from d.from to d.origin -->
        <td>${d.destination ?? "-"}</td> <!-- Changed from d.to to d.destination -->
        <td>${d.travelDate ?? "-"}</td>
        <td>${d.departureTime ?? "-"}</td>
        <td>${d.price ? "KES "+Number(d.price).toLocaleString() : "-"}</td>
        <td>${d.totalSeats ?? "-"}</td>
        <td>${d.available_seats ?? "-"}</td>
        <td class="nowrap">
          <button class="btn sm" data-action="edit" data-id="${docSnap.id}"><i class="fa-solid fa-pen-to-square"></i></button>
          <button class="btn sm danger" data-action="del" data-id="${docSnap.id}"><i class="fa-solid fa-trash"></i></button>
        </td>
      `;
      list.appendChild(tr);
    });
  });
}
$("#addBusForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const data = {
    company: $("#busCompany").value.trim(),
    origin: $("#busFrom").value.trim(), // Mapped to origin
    destination: $("#busTo").value.trim(),     // Mapped to destination
    travelDate: $("#busTravelDate").value, // New field for consistency
    departureTime: $("#busTime").value.trim(), // Maps to time
    price: Number($("#busPrice").value),
    totalSeats: Number($("#busSeats").value),
    available_seats: Number($("#busSeats").value), // Initialize available_seats
    image: $("#busImage").value.trim(), // New field for consistency
    createdAt: serverTimestamp()
  };

  if (!data.company || !data.origin || !data.destination || !data.travelDate || !data.departureTime || isNaN(data.price) || data.price <= 0 || isNaN(data.totalSeats) || data.totalSeats <= 0) {
      showCustomAlert("Please fill all required fields correctly (Company, From, To, Travel Date, Departure Time, Price, Total Seats).", "error");
      return;
  }

  try {
    await addDoc(busesCol, data);
    e.target.reset();
    showCustomAlert("Bus added.", "success");
    populateRouteDropdowns(); // Refresh dropdowns after adding a new bus
  } catch (err) {
    console.error(err);
    showCustomAlert("Failed to add bus: " + err.message, "error");
  }
});
$("#busTableBody").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button");
  if (!btn) return;
  const id = btn.dataset.id;
  if (btn.dataset.action === "del") {
    showCustomConfirm("Delete this bus? This action cannot be undone.", "delete", async (result) => {
        if (result) {
            try {
              await deleteDoc(doc(db, "buses", id));
              showCustomAlert("Bus deleted.", "success");
              populateRouteDropdowns(); // Refresh dropdowns after deleting a bus
            } catch (err) {
              showCustomAlert("Delete failed: " + err.message, "error");
            }
        }
    });
  } else if (btn.dataset.action === "edit") {
    // Load current values to editor
    const s = await getDoc(doc(db, "buses", id));
    if (!s.exists()) return;
    const d = s.data();
    $("#editBusId").value = id;
    $("#editBusCompany").value = d.company ?? "";
    $("#editBusFrom").value = d.origin ?? ""; // Changed from d.from to d.origin
    $("#editBusTo").value = d.destination ?? ""; // Changed from d.to to d.destination
    $("#editBusTravelDate").value = d.travelDate ?? ""; // New field
    $("#editBusTime").value = d.departureTime ?? "";
    $("#editBusPrice").value = d.price ?? "";
    $("#editBusSeats").value = d.totalSeats ?? "";
    $("#editBusImage").value = d.image ?? ""; // New field
    $("#editBusModal").classList.remove("hidden");
  }
});
$("#editBusForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const id = $("#editBusId").value;
  const updatedData = {
    company: $("#editBusCompany").value.trim(),
    origin: $("#editBusFrom").value.trim(), // Mapped to origin
    destination: $("#editBusTo").value.trim(),     // Mapped to destination
    travelDate: $("#editBusTravelDate").value, // New field
    departureTime: $("#editBusTime").value.trim(),
    price: Number($("#editBusPrice").value),
    totalSeats: Number($("#editBusSeats").value),
    image: $("#editBusImage").value.trim() // New field
  };

  if (!updatedData.company || !updatedData.origin || !updatedData.destination || !updatedData.travelDate || !updatedData.departureTime || isNaN(updatedData.price) || updatedData.price <= 0 || isNaN(updatedData.totalSeats) || updatedData.totalSeats <= 0) {
      showCustomAlert("Please fill all required fields correctly (Company, From, To, Travel Date, Departure Time, Price, Total Seats).", "error");
      return;
  }

  try {
    await updateDoc(doc(db, "buses", id), updatedData);
    $("#editBusModal").classList.add("hidden");
    showCustomAlert("Bus updated.", "success");
    populateRouteDropdowns(); // Refresh dropdowns after updating a bus
  } catch (err) {
    showCustomAlert("Update failed: " + err.message, "error");
  }
});
$("#editBusCancel").addEventListener("click", ()=>$("#editBusModal").classList.add("hidden"));

/** =======================
 * Manage Bookings
 * ======================= */
const bookingsCol = collection(db, "bookings");
let bookingsUnsub = null, bookingCache = [];

function attachRealtimeBookings() {
  if (bookingsUnsub) bookingsUnsub();
  bookingsUnsub = onSnapshot(bookingsCol, (snap)=>{
    bookingCache = [];
    snap.forEach(docSnap=>{
      bookingCache.push({ id: docSnap.id, ...docSnap.data() });
    });
    renderBookingTable(bookingCache);
  });
}
function renderBookingTable(items) {
  const body = $("#bookingTableBody");
  body.innerHTML = "";
  items.sort((a,b)=> (b.createdAt?.seconds??0)-(a.createdAt?.seconds??0));
  for (const b of items) {
    const paid = (b.status || "").toLowerCase() === "paid"; // Use 'status' field
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${b.booking_ref ?? b.reference ?? b.ref ?? "-"}</td>
      <td>${b.passenger_name ?? "-"}</td>
      <td>${b.passenger_email ?? "-"}</td>
      <td>${b.bus_route ?? "-"}</td> <!-- Using bus_route -->
      <td>${b.travel_date ?? "-"}</td> <!-- Using travel_date -->
      <td>${b.seat_number ?? "-"}</td> <!-- Using seat_number -->
      <td>${b.price ? "KES "+Number(b.price).toLocaleString() : "-"}</td>
      <td><span class="badge ${paid?"success":"warn"}">${paid ? "PAID" : "PENDING"}</span></td>
      <td class="nowrap">
        ${paid ? "" : `<button class="btn sm success" data-action="markpaid" data-id="${b.id}"><i class="fa-solid fa-check"></i> Paid</button>`}
        <button class="btn sm" data-action="ticket" data-id="${b.id}"><i class="fa-solid fa-ticket"></i></button>
        <button class="btn sm danger" data-action="del" data-id="${b.id}"><i class="fa-solid fa-trash"></i></button>
      </td>
    `;
    body.appendChild(tr);
  }
}
$("#bookingSearch").addEventListener("input", ()=>{
  const q = $("#bookingSearch").value.trim().toLowerCase();
  if (!q) return renderBookingTable(bookingCache);
  const results = bookingCache.filter(b=>{
    return (b.passenger_name??"").toLowerCase().includes(q)
      || (b.passenger_email??"").toLowerCase().includes(q) 
      || (b.booking_ref??b.reference??b.ref??"").toLowerCase().includes(q);
  });
  renderBookingTable(results);
});
$("#bookingTableBody").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button");
  if (!btn) return;
  const id = btn.dataset.id;
  const item = bookingCache.find(x=>x.id===id);
  if (!item) return;

  if (btn.dataset.action === "del") {
    showCustomConfirm("Delete this booking? This action cannot be undone.", "delete", async (result) => {
        if (result) {
            try {
                await deleteDoc(doc(db, "bookings", id));
                // Assuming busId and seatNumber are stored in booking for decrementing available_seats
                if (item.bus_id && item.seat_number) {
                    const busDocRef = doc(db, "buses", item.bus_id);
                    await updateDoc(busDocRef, {
                        available_seats: increment(1)
                    });
                    console.log(`Available seat incremented for bus ${item.bus_id}`);
                }
                showCustomAlert("Booking deleted.", "success");
            } catch (err) {
                showCustomAlert("Delete failed: " + err.message, "error");
            }
        }
    });
  } else if (btn.dataset.action === "markpaid") {
    try {
      await updateDoc(doc(db, "bookings", id), { status: "paid", paidAt: serverTimestamp() });
      showCustomAlert("Marked as PAID.", "success");
      // Send confirmation email (requires Firebase Trigger Email extension)
      if (item.passenger_email) {
        // Generate PDF content for the email attachment
        const pdfDoc = await generatePdfContent(item);
        const pdfDataUri = pdfDoc.output("datauristring");
        const pdfBase64 = pdfDataUri.split(",")[1];

        // Max PDF size check (copied from ticket-lookup.html)
        const MAX_PDF_BASE64_SIZE_BYTES = 800 * 1024;
        const pdfBase64SizeBytes = new TextEncoder().encode(pdfBase64).length;

        if (pdfBase64SizeBytes > MAX_PDF_BASE64_SIZE_BYTES) {
            console.warn(`PDF for email is too large (${(pdfBase64SizeBytes / 1024).toFixed(2)} KB). Skipping email attachment.`);
            showCustomAlert(`Marked as PAID. Note: Ticket PDF was too large for email attachment (${(pdfBase64SizeBytes / 1024).toFixed(2)} KB). Please download it locally.`, 'warning');
            // Send email without attachment if too large
            await addDoc(collection(db,"mail"), {
                to: [item.passenger_email],
                message: {
                    subject: "Your Prince Alex Travel Booking Confirmation", // Updated subject
                    text: `Dear ${item.passenger_name??"Customer"},\n\nThank you for booking a ticket with us!.\nYour ticket has been booked successfully. \n\nYour Ticket details:\nBooking Reference: ${item.booking_ref??id}\nRoute: ${item.bus_route??"-"}\nTravel Date: ${item.travel_date??"-"}\nDeparture Time: ${item.bus_time??"-"}\nSeat: ${item.seat_number??"-"}\nPrice: KES ${item.price?Number(item.price).toLocaleString():"-"}`,
                    html: `<p>Dear ${item.passenger_name??"Customer"},</p>
                           <p>Thank you for booking a ticket with us!</p>
                           <p>Your ticket has been booked successfully.</p>
                           <p>Your Ticket details:</p>
                           <ul>
                               <li><strong>Booking Reference:</strong> ${item.booking_ref??id}</li>
                               <li><strong>Route:</strong> ${item.bus_route??"-"}</li>
                               <li><strong>Travel Date:</strong> ${item.travel_date??"-"}</li>
                               <li><strong>Departure Time:</strong> ${item.bus_time??"-"}</li>
                               <li><strong>Seat:</strong> ${item.seat_number??"-"}</li>
                               <li><strong>Price:</strong> KES ${item.price?Number(item.price).toLocaleString():"-"}</li>
                           </ul>
                           <p>Thank you for choosing Prince Alex Travel.</p>`
                },
                createdAt: serverTimestamp()
            });
        } else {
            // Professional payment confirmation email template
            const paymentConfirmationHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Payment Confirmed - Prince Alex Travel</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; }
                        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                        .header { background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
                        .content { background: #f8fafc; padding: 30px; border-radius: 0 0 10px 10px; }
                        .ticket-details { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #1e3a8a; }
                        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
                        .detail-label { font-weight: bold; color: #374151; }
                        .detail-value { color: #1f2937; }
                        .footer { text-align: center; margin-top: 30px; color: #666; font-size: 14px; }
                        .payment-success { background: #d1fae5; padding: 15px; border-radius: 5px; border-left: 4px solid #10b981; margin: 20px 0; }
                        .attachment-notice { background: #d1fae5; padding: 15px; border-radius: 5px; border-left: 4px solid #10b981; margin: 20px 0; }
                        .status-paid { background: #d1fae5; color: #065f46; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>💳 Payment Confirmed!</h1>
                            <p>Prince Alex Travel - Payment Successfully Processed</p>
                        </div>
                        <div class="content">
                            <h2>Hello ${item.passenger_name ?? "Customer"}!</h2>
                            <p>Great news! Your payment has been successfully processed and your ticket is now confirmed!</p>
                            
                            <div class="payment-success">
                                <h4 style="margin-top: 0; color: #065f46;">✅ Payment Successful</h4>
                                <p style="margin-bottom: 0; color: #065f46;">Your booking is now fully confirmed and your e-ticket is ready!</p>
                            </div>
                            
                            <div class="ticket-details">
                                <h3 style="margin-top: 0; color: #1e3a8a;">🎫 Confirmed Ticket Details</h3>
                                <div class="detail-row">
                                    <span class="detail-label">Booking Reference:</span>
                                    <span class="detail-value"><strong>${item.booking_ref ?? id}</strong></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Route:</span>
                                    <span class="detail-value">${item.bus_route ?? "-"}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Seat Number:</span>
                                    <span class="detail-value"><strong>${item.seat_number ?? "-"}</strong></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Travel Date:</span>
                                    <span class="detail-value">${item.travel_date ?? "-"}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Departure Time:</span>
                                    <span class="detail-value">${item.bus_time ?? "-"}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Price Paid:</span>
                                    <span class="detail-value"><strong>KES ${item.price ? Number(item.price).toLocaleString() : "-"}</strong></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Status:</span>
                                    <span class="detail-value">
                                        <span class="status-paid">PAID & CONFIRMED</span>
                                    </span>
                                </div>
                            </div>

                            <div class="attachment-notice">
                                <h4 style="margin-top: 0; color: #065f46;">📎 E-Ticket Attached</h4>
                                <p style="margin-bottom: 0; color: #065f46;">Your confirmed e-ticket PDF is attached to this email. You can download it and present it at the bus terminal.</p>
                            </div>

                            <div style="background: #fef3c7; padding: 15px; border-radius: 5px; border-left: 4px solid #f59e0b; margin: 20px 0;">
                                <h4 style="margin-top: 0; color: #92400e;">📱 Important Reminders</h4>
                                <ul style="margin-bottom: 0; color: #92400e;">
                                    <li>Arrive at the terminal 15 minutes before departure</li>
                                    <li>Present your e-ticket (digital or printed) to the driver</li>
                                    <li>Keep your booking reference handy</li>
                                </ul>
                            </div>

                            <p><strong>📱 Need Help?</strong></p>
                            <p>If you have any questions or need assistance, please don't hesitate to contact us:</p>
                            <p><strong>📧 Email:</strong> senerwaalex@gmail.com<br>
                            <strong>📞 Phone:</strong> +254 717 384 875</p>
                        </div>
                        <div class="footer">
                            <p>© 2025 Prince Alex Digital. All rights reserved.</p>
                            <p>Nairobi, Kenya | Prince Alex Travel Services</p>
                        </div>
                    </div>
                </body>
                </html>
            `;

            await addDoc(collection(db,"mail"), {
                to: [item.passenger_email],
                message: {
                    subject: "Payment Confirmed - Your Ticket is Ready! 🎫",
                    text: `Dear ${item.passenger_name ?? "Customer"},\n\nGreat news! Your payment has been successfully processed and your ticket is now confirmed!\n\nConfirmed Ticket Details:\nBooking Reference: ${item.booking_ref ?? id}\nRoute: ${item.bus_route ?? "-"}\nTravel Date: ${item.travel_date ?? "-"}\nDeparture Time: ${item.bus_time ?? "-"}\nSeat: ${item.seat_number ?? "-"}\nPrice Paid: KES ${item.price ? Number(item.price).toLocaleString() : "-"}\nStatus: PAID & CONFIRMED\n\nYour confirmed e-ticket PDF is attached to this email. You can download it and present it at the bus terminal.\n\nImportant Reminders:\n- Arrive at the terminal 15 minutes before departure\n- Present your e-ticket (digital or printed) to the driver\n- Keep your booking reference handy\n\nThank you for choosing Prince Alex Travel Services!\n\nBest regards,\nPrince Alex Travel Team`,
                    html: paymentConfirmationHtml,
                    attachments: [
                        {
                            filename: `PrinceAlex_Ticket_${item.booking_ref ?? id}.pdf`,
                            content: pdfBase64,
                            encoding: "base64"
                        }
                    ]
                },
                createdAt: serverTimestamp()
            });
            showCustomAlert("Marked as PAID. Confirmation email with ticket sent!", "success");
        }
      }
    } catch (err) {
      console.error("Error marking paid or sending email:", err);
      showCustomAlert("Failed to mark paid or send email: " + err.message, "error");
    }
  } else if (btn.dataset.action === "ticket") {
    // This will download the PDF for the admin directly
    generateTicketPDF(item);
  }
});

/** =======================
 * Ticket PDF (Reusable function for both Admin & Public view)
 * ======================= */
async function generatePdfContent(booking) { // Changed to async to support image loading
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Define modern color scheme
    const primaryColor = '#1e3a8a'; // Modern blue
    const accentColor = '#f59e0b'; // Modern amber
    const successColor = '#10b981'; // Green for paid status
    const warningColor = '#f59e0b'; // Amber for pending
    const errorColor = '#ef4444'; // Red for errors
    const darkTextColor = '#1f2937'; // Dark gray
    const lightTextColor = '#6b7280'; // Light gray
    const backgroundColor = '#f8fafc'; // Light background

    let yPos = 15; // Initial Y position

    // --- 1. HEADER WITH GRADIENT BACKGROUND ---
    // Create header background rectangle
    doc.setFillColor(30, 58, 138); // Primary blue
    doc.rect(0, 0, 210, 45, 'F'); // Full width header background

    // Company logo placeholder (you can replace with actual logo)
    doc.setFillColor(255, 255, 255); // White
    doc.circle(25, 22, 8, 'F'); // Simple circle logo
    doc.setTextColor(255, 255, 255); // White text
    doc.setFontSize(8);
    doc.setFont("helvetica", "bold");
    doc.text("PA", 22, 25);

    // Company name
    doc.setFontSize(20);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(255, 255, 255); // White
    doc.text("Prince Alex Travel", 40, 20);
    
    // Subtitle
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text("E-Ticket & Booking Confirmation", 40, 28);
    
    // Status badge in header
    const status = (booking.status ?? "pending").toUpperCase();
    const statusColor = status === 'PAID' ? successColor : warningColor;
    doc.setFillColor(statusColor === successColor ? 16 : 245, statusColor === successColor ? 185 : 158, statusColor === successColor ? 129 : 11);
    doc.roundedRect(150, 12, 50, 20, 3, 3, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.text(status, 175, 24, { align: "center" });

    yPos = 55; // Move below header

    // --- 2. BOOKING REFERENCE HIGHLIGHT ---
    doc.setFillColor(backgroundColor);
    doc.rect(10, yPos, 190, 25, 'F'); // Background for booking ref
    doc.setDrawColor(primaryColor);
    doc.setLineWidth(2);
    doc.rect(10, yPos, 190, 25); // Border around booking ref
    
    doc.setFontSize(16);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(primaryColor);
    doc.text("BOOKING REFERENCE", 15, yPos + 8);
    
    doc.setFontSize(20);
    doc.setTextColor(accentColor);
    doc.text(`${booking.booking_ref ?? booking.id}`, 15, yPos + 20);
    
    yPos += 35;

    // --- 3. QR CODE SECTION ---
    // Generate QR Code
    const qrCodeData = booking.booking_ref ?? booking.id;
    const qrCodeContainer = document.createElement('div');
    qrCodeContainer.style.display = 'none';
    document.body.appendChild(qrCodeContainer);

    let qrCodeImgData = '';
    try {
        new QRCode(qrCodeContainer, {
            text: qrCodeData,
            width: 100,
            height: 100,
            colorDark: primaryColor,
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });

        await new Promise(resolve => setTimeout(resolve, 50));
        const canvasElement = qrCodeContainer.querySelector('canvas');
        if (canvasElement) {
            qrCodeImgData = canvasElement.toDataURL("image/png");
        }
    } catch (qrError) {
        console.error("Error generating QR code:", qrError);
    } finally {
        if (qrCodeContainer.parentNode) {
            document.body.removeChild(qrCodeContainer);
        }
    }

    // QR Code with border
    if (qrCodeImgData) {
        doc.setDrawColor(primaryColor);
        doc.setLineWidth(1);
        doc.rect(150, yPos, 50, 50); // QR code border
        doc.addImage(qrCodeImgData, 'PNG', 155, yPos + 5, 40, 40);
    }

    // --- 4. PASSENGER DETAILS SECTION ---
    doc.setFillColor(primaryColor);
    doc.rect(10, yPos, 190, 8, 'F'); // Section header background
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("PASSENGER INFORMATION", 15, yPos + 6);
    yPos += 15;

    // Passenger details in two columns
    const passengerDetails = [
        { label: "Full Name", value: booking.passenger_name ?? "-" },
        { label: "ID Number", value: booking.passenger_id ?? "-" },
        { label: "Gender", value: booking.passenger_gender ?? "-" },
        { label: "Phone", value: booking.passenger_phone ?? "-" },
        { label: "Email", value: booking.passenger_email || 'N/A' }
    ];

    passengerDetails.forEach((detail, index) => {
        const xPos = index < 3 ? 15 : 110; // Two columns
        const yOffset = index < 3 ? index * 8 : (index - 3) * 8;
        
        doc.setFontSize(9);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(lightTextColor);
        doc.text(detail.label + ":", xPos, yPos + yOffset);
        
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(darkTextColor);
        doc.text(detail.value, xPos + 25, yPos + yOffset);
    });

    yPos += 45;

    // --- 5. JOURNEY DETAILS SECTION ---
    doc.setFillColor(primaryColor);
    doc.rect(10, yPos, 190, 8, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("JOURNEY DETAILS", 15, yPos + 6);
    yPos += 15;

    const journeyDetails = [
        { label: "Route", value: booking.bus_route ?? "-" },
        { label: "Travel Date", value: booking.travel_date ?? "-" },
        { label: "Departure Time", value: booking.bus_time ?? "-" },
        { label: "Seat Number", value: booking.seat_number ?? "-" },
        { label: "Bus ID", value: booking.bus_id ?? "-" }
    ];

    journeyDetails.forEach((detail, index) => {
        const xPos = index < 3 ? 15 : 110;
        const yOffset = index < 3 ? index * 8 : (index - 3) * 8;
        
        doc.setFontSize(9);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(lightTextColor);
        doc.text(detail.label + ":", xPos, yPos + yOffset);
        
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(darkTextColor);
        doc.text(detail.value, xPos + 25, yPos + yOffset);
    });

    yPos += 45;

    // --- 6. PAYMENT SUMMARY SECTION ---
    doc.setFillColor(primaryColor);
    doc.rect(10, yPos, 190, 8, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(12);
    doc.setFont("helvetica", "bold");
    doc.text("PAYMENT SUMMARY", 15, yPos + 6);
    yPos += 15;

    // Amount with highlight
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(lightTextColor);
    doc.text("Amount:", 15, yPos);
    
    doc.setFontSize(16);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(accentColor);
    doc.text(`Ksh ${Number(booking.price ?? 0).toLocaleString()}`, 35, yPos);
    yPos += 12;

    // Payment status with colored badge
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(lightTextColor);
    doc.text("Status:", 15, yPos);
    
    const statusBgColor = status === 'PAID' ? [16, 185, 129] : [245, 158, 11];
    doc.setFillColor(statusBgColor[0], statusBgColor[1], statusBgColor[2]);
    doc.roundedRect(35, yPos - 4, 30, 8, 2, 2, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(8);
    doc.setFont("helvetica", "bold");
    doc.text(status, 50, yPos, { align: "center" });
    yPos += 15;

    // Booking date
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(lightTextColor);
    doc.text("Booking Date:", 15, yPos);
    
    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(darkTextColor);
    doc.text(new Date(booking.booking_date).toLocaleDateString(), 50, yPos);
    yPos += 20;

    // --- 7. STATUS-SPECIFIC NOTICES ---
    if (status === 'PENDING') {
        doc.setFillColor(254, 243, 199); // Light amber background
        doc.rect(10, yPos, 190, 20, 'F');
        doc.setDrawColor(warningColor);
        doc.setLineWidth(1);
        doc.rect(10, yPos, 190, 20);
        
        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(146, 64, 14); // Dark amber text
        doc.text("⚠️ PAYMENT PENDING", 15, yPos + 8);
        
        doc.setFontSize(8);
        doc.setFont("helvetica", "normal");
        doc.text("Please complete payment to validate your ticket.", 15, yPos + 15);
        yPos += 30;
    } else if (status === 'PAID') {
        doc.setFillColor(209, 250, 229); // Light green background
        doc.rect(10, yPos, 190, 20, 'F');
        doc.setDrawColor(successColor);
        doc.setLineWidth(1);
        doc.rect(10, yPos, 190, 20);
        
        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.setTextColor(6, 95, 70); // Dark green text
        doc.text("✅ PAYMENT CONFIRMED", 15, yPos + 8);
        
        doc.setFontSize(8);
        doc.setFont("helvetica", "normal");
        doc.text("Your ticket is valid and ready for travel.", 15, yPos + 15);
        yPos += 30;
    }

    // --- 8. IMPORTANT NOTICES ---
    doc.setFillColor(backgroundColor);
    doc.rect(10, yPos, 190, 25, 'F');
    doc.setDrawColor(lightTextColor);
    doc.setLineWidth(0.5);
    doc.rect(10, yPos, 190, 25);
    
    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");
    doc.setTextColor(primaryColor);
    doc.text("📱 IMPORTANT REMINDERS", 15, yPos + 8);
    
    doc.setFontSize(8);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(darkTextColor);
    doc.text("• Arrive at terminal 15 minutes before departure", 15, yPos + 15);
    doc.text("• Present this ticket (digital or printed) to driver", 15, yPos + 22);
    yPos += 35;

    // --- 9. FOOTER ---
    yPos = doc.internal.pageSize.height - 20;
    
    // Footer line
    doc.setDrawColor(primaryColor);
    doc.setLineWidth(1);
    doc.line(10, yPos, 200, yPos);
    yPos += 5;
    
    // Contact information
    doc.setFontSize(8);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(lightTextColor);
    doc.text("Prince Alex Travel Services", doc.internal.pageSize.width / 2, yPos, { align: "center" });
    yPos += 4;
    doc.text("Email: senerwaalex@gmail.com | Phone: +254 717 384 875", doc.internal.pageSize.width / 2, yPos, { align: "center" });
    yPos += 4;
    doc.text("© 2025 Prince Alex Digital. All rights reserved.", doc.internal.pageSize.width / 2, yPos, { align: "center" });

    return doc;
}

// This is the function called when the admin clicks "ticket" button in Manage Bookings
function generateTicketPDF(booking) {
    generatePdfContent(booking).then(doc => {
        doc.save(`PrinceAlex_Ticket_${booking.booking_ref ?? booking.id}.pdf`);
        console.log("PDF download initiated successfully for admin.");
    }).catch(error => {
        console.error("Error generating PDF for admin download:", error);
        showCustomAlert("Failed to generate ticket PDF for download. Please try again.", 'error');
    });
}


/** =======================
 * Make Booking (Admin)
 * ======================= */
let selectedBusId = null;
let selectedDate = null;
let selectedDepartureTime = null; // Store departure time
let selectedBusPrice = null; // Store bus price
let selectedBusRoute = null; // Store bus route (From -> To)
let selectedTotalSeats = null;
let selectedSeatNumber = null; // For single seat selection in admin make booking
let seatSelectionUnsubscribe = null; // For real-time seat updates in modal

// Maximum allowed size for Base64 PDF content in bytes (approx 800KB for safety, Firestore limit is 1MB)
const MAX_PDF_BASE64_SIZE_BYTES = 800 * 1024; // 800KB

// Initially disable the confirm booking button
document.addEventListener('DOMContentLoaded', () => {
    $("#adminConfirmBooking button[type='submit']").disabled = true;
    // Hide the passenger details card initially
    $("#passengerDetailsCard").classList.add("hidden");
});

async function populateRouteDropdowns() {
    const fromDropdown = $("#abFrom");
    const toDropdown = $("#abTo");

    // Clear existing options
    fromDropdown.innerHTML = '<option value="">Select Origin</option>';
    toDropdown.innerHTML = '<option value="">Select Destination</option>';

    const uniqueOrigins = new Set();
    const uniqueDestinations = new Set();

    try {
        const querySnapshot = await getDocs(busesCol);
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.origin) uniqueOrigins.add(data.origin);
            if (data.destination) uniqueDestinations.add(data.destination);
        });

        uniqueOrigins.forEach(origin => {
            const option = document.createElement('option');
            option.value = origin;
            option.textContent = origin;
            fromDropdown.appendChild(option);
        });

        uniqueDestinations.forEach(destination => {
            const option = document.createElement('option');
            option.value = destination;
            option.textContent = destination;
            toDropdown.appendChild(option);
        });

    } catch (error) {
        console.error("Error populating route dropdowns:", error);
        showCustomAlert("Error loading bus routes. Please try again.", "error");
    }
}


$("#adminBookingSearch").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const origin = $("#abFrom").value.trim(); // Now a select dropdown
  const destination = $("#abTo").value.trim(); // Now a select dropdown
  const date = $("#abDate").value;

  if (!origin || !destination || !date) {
    return showCustomAlert("Please select origin, destination, and travel date.", "warn");
  }
  
  selectedDate = date;

  // Find buses for route and date
  const q1 = query(busesCol, where("origin","==",origin), where("destination","==",destination), where("travelDate", "==", date)); // Changed fields in query
  const qs = await getDocs(q1);
  const list = $("#abResults");
  list.innerHTML = "";

  if (qs.empty) {
      list.innerHTML = '<p style="text-align:center; margin-top:20px;">No buses found for this route and date.</p>';
      return;
  }

  qs.forEach(s=>{
    const d=s.data();
    const card = document.createElement("div");
    card.className="result-card";
    card.innerHTML = `
      <div class="result-details">
        <h4>${d.company ?? "Bus"}</h4>
        <p><strong>Route:</strong> ${d.origin} → ${d.destination}</p> <!-- Changed from d.from to d.origin and d.to to d.destination -->
        <p><strong>Travel Date:</strong> ${d.travelDate}</p>
        <p><strong>Depart:</strong> ${d.departureTime ?? "-"}</p>
        <p><strong>Price:</strong> KES ${d.price ? Number(d.price).toLocaleString() : "-"}</p>
        <p><strong>Available Seats:</strong> ${d.available_seats ?? d.totalSeats ?? 0}</p>
        <p><strong>Total Seats:</strong> ${d.totalSeats ?? TOTAL_SEATS_DEFAULT}</p>
        <button class="btn" 
            data-busid="${s.id}" 
            data-total-seats="${d.totalSeats ?? TOTAL_SEATS_DEFAULT}"
            data-departure-time="${d.departureTime ?? "-"}"
            data-bus-price="${d.price ?? 0}"
            data-bus-route="${d.origin} to ${d.destination}" <!-- Changed to d.origin and d.destination -->
            data-available-seats="${d.available_seats ?? d.totalSeats ?? 0}"
            >Select Seats</button>
      </div>
    `;
    list.appendChild(card);
  });
});

$("#abResults").addEventListener("click", async (e)=>{
  const btn = e.target.closest("button[data-busid]");
  if (!btn) return;

  selectedBusId = btn.dataset.busid;
  selectedTotalSeats = Number(btn.dataset.totalSeats || 0); // Use 0 if not available
  selectedDepartureTime = btn.dataset.departureTime;
  selectedBusPrice = Number(btn.dataset.busPrice);
  selectedBusRoute = btn.dataset.busRoute;
  const availableSeats = Number(btn.dataset.availableSeats);

  // Set the price in the passenger details form
  $("#abPrice").value = selectedBusPrice.toFixed(2); // Display with 2 decimal places

  // Disable confirm button until seat is selected
  $("#adminConfirmBooking button[type='submit']").disabled = true;


  if (availableSeats <= 0) {
      showCustomAlert("Sorry, this bus is fully booked. Please choose another one.", "warn");
      return;
  }

  await openSeatSelectionModal(selectedBusId, selectedDate, selectedTotalSeats, availableSeats);
});

async function openSeatSelectionModal(busId, travelDate, totalSeats, currentAvailableSeats) {
  selectedSeatNumber = null; // Reset selection
  const seatGrid = $("#seatGrid");
  seatGrid.innerHTML = "";
  $("#seatModal").classList.remove("hidden");
  
  // Display bus info in the modal
  $("#selectedBusInfoAdmin").textContent = `Bus ID: ${busId}, Date: ${travelDate}, Available: ${currentAvailableSeats}`;

  // Layout 4 columns (consistent with index.html's typical layout)
  seatGrid.style.gridTemplateColumns = `repeat(4, 1fr)`;

  // Add a "Front (Driver)" indicator
  const driverArea = document.createElement('div');
  driverArea.classList.add('driver-area');
  driverArea.textContent = 'Front (Driver)';
  seatGrid.appendChild(driverArea);

  // Unsubscribe from previous listener if exists
  if (seatSelectionUnsubscribe) {
      seatSelectionUnsubscribe();
      seatSelectionUnsubscribe = null;
  }

  // Setup real-time listener for bookings for this specific bus and date
  const bookingsRef = collection(db, "bookings");
  const q = query(bookingsRef, 
                  where("bus_id", "==", busId), 
                  where("travel_date", "==", travelDate),
                  where("status", "in", ['pending', 'paid'])); // Only consider active bookings

  seatSelectionUnsubscribe = onSnapshot(q, (snapshot) => {
      const bookedSeatsForThisTrip = new Set(snapshot.docs.map(doc => doc.data().seat_number));
      
      // Clear all seats except the driver area (if already present)
      // Rebuild the seat grid dynamically on each snapshot update
      const existingDriverArea = seatGrid.querySelector('.driver-area');
      seatGrid.innerHTML = '';
      if (existingDriverArea) {
          seatGrid.appendChild(existingDriverArea); // Re-add the driver area
      } else {
          const newDriverArea = document.createElement('div');
          newDriverArea.classList.add('driver-area');
          newDriverArea.textContent = 'Front (Driver)';
          seatGrid.appendChild(newDriverArea);
      }

      for (let i = 1; i <= totalSeats; i++) {
          const seatContainer = document.createElement("div");
          seatContainer.classList.add("seat-container");
          seatContainer.setAttribute("data-seat", i);

          const seatIcon = document.createElement("i");
          seatIcon.classList.add("fas", "fa-chair", "seat-icon");

          const seatNumSpan = document.createElement("span");
          seatNumSpan.classList.add("seat-number");
          seatNumSpan.textContent = `S${i}`; // Consistent with index.html

          seatContainer.appendChild(seatIcon);
          seatContainer.appendChild(seatNumSpan);

          // FIX: Correctly check for booked seats using the "S<number>" format
          if (bookedSeatsForThisTrip.has(`S${i}`)) { 
              seatContainer.classList.add("booked");
              seatContainer.onclick = null;
          } else {
              seatContainer.classList.add("available");
              if (selectedSeatNumber === i) { // Re-highlight if it was the selected one
                  seatContainer.classList.add("selected");
              }
              seatContainer.onclick = function () {
                  // Deselect previously selected seat
                  const currentlySelected = document.querySelector("#seatGrid .seat-container.selected");
                  if (currentlySelected) {
                      currentlySelected.classList.remove("selected");
                  }
                  // Select new seat
                  this.classList.add("selected");
                  selectedSeatNumber = parseInt(this.dataset.seat);
                  $("#selectedSeatNumberAdmin").value = `S${selectedSeatNumber}`; // Update hidden input
                  $("#displayedSeatNumber").value = `S${selectedSeatNumber}`; // Update visible input
                  showCustomAlert(`Seat S${selectedSeatNumber} selected.`, "info", null);
                  
                  // Close seat modal
                  $("#seatModal").classList.add("hidden"); 

                  // Show passenger details card
                  $("#passengerDetailsCard").classList.remove("hidden");
                  $("#adminConfirmBooking button[type='submit']").disabled = false; // Enable confirm button
                  $("#abName").focus(); // Focus on the first passenger detail input
              };
          }
          seatGrid.appendChild(seatContainer);
      }
  }, (error) => {
      console.error("Error fetching booked seats in real-time:", error.message);
      showCustomAlert("Error loading seat availability. Please try again.", "error");
  });
}

$("#seatCancel").addEventListener("click", ()=>{
    $("#seatModal").classList.add("hidden");
    if (seatSelectionUnsubscribe) {
        seatSelectionUnsubscribe(); // Unsubscribe when modal closes
        seatSelectionUnsubscribe = null;
    }
    // Clear passenger details and reset state for next time
    $("#abName").value = '';
    $("#abEmail").value = '';
    $("#abPhone").value = '';
    $("#abID").value = '';
    $("#abGender").value = '';
    $("#abPrice").value = ''; // Clear price input too
    $("#selectedSeatNumberAdmin").value = ''; // Clear hidden selected seat input
    $("#displayedSeatNumber").value = ''; // Clear displayed seat input
    selectedBusId = null;
    selectedDate = null;
    selectedDepartureTime = null;
    selectedBusPrice = null;
    selectedBusRoute = null;
    selectedTotalSeats = null;
    selectedSeatNumber = null;
    $("#adminConfirmBooking button[type='submit']").disabled = true; // Re-disable confirm button
    $("#passengerDetailsCard").classList.add("hidden"); // Hide passenger details card
});

$("#adminConfirmBooking").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if (!selectedBusId || !selectedDate) {
      return showCustomAlert("Please search and select a bus first.", "warn");
  }
  if (!selectedSeatNumber) {
      return showCustomAlert("Please select a seat.", "warn");
  }

  const passenger_name = $("#abName").value.trim();
  const passenger_email = $("#abEmail").value.trim();
  const passenger_phone = $("#abPhone").value.trim();
  const passenger_id = $("#abID").value.trim(); 
  const passenger_gender = $("#abGender").value; 

  // Basic validation
  if (!passenger_name || !passenger_phone || !passenger_email || !passenger_id || !passenger_gender) {
      return showCustomAlert("Please fill all passenger details.", "error");
  }
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(passenger_email)) {
      return showCustomAlert("Please enter a valid email address.", "error");
  }
  const phoneRegex = /^\+?[0-9\s-]{7,20}$/; 
  if (!phoneRegex.test(passenger_phone)) {
      return showCustomAlert("Please enter a valid Phone Number (e.g., +254712345678 or 0712345678).", "error");
  }

  // Generate unique booking reference
  const booking_ref = 'PA-' + Date.now().toString().slice(-6) + '-' + String(selectedSeatNumber).padStart(2, '0'); // Pad seat number for consistent ref format

  try {
    // Re-check if seat is still available (race condition check)
    const existingBookingsQ = query(
        collection(db, "bookings"),
        where("bus_id", "==", selectedBusId),
        where("travel_date", "==", selectedDate),
        where("seat_number", "==", `S${selectedSeatNumber}`), // Match "S<number>" format
        where("status", "in", ['pending', 'paid'])
    );
    const existingBookingsSnapshot = await getDocs(existingBookingsQ);
    if (!existingBookingsSnapshot.empty) {
        showCustomAlert(`Seat S${selectedSeatNumber} has just been booked. Please choose another seat.`, "warn");
        // Re-trigger seat rendering to update current state
        const busDoc = await getDoc(doc(db, "buses", selectedBusId));
        if (busDoc.exists()) {
            await openSeatSelectionModal(selectedBusId, selectedDate, busDoc.data().totalSeats, busDoc.data().available_seats);
        }
        return;
    }

    // Prepare booking data, consistent with index.html
    const bookingData = {
        booking_ref: booking_ref,
        passenger_name: passenger_name,
        passenger_id: passenger_id,
        passenger_gender: passenger_gender,
        passenger_phone: passenger_phone,
        passenger_email: passenger_email,
        bus_id: selectedBusId,
        bus_route: selectedBusRoute, // From selected bus
        bus_time: selectedDepartureTime, // From selected bus
        travel_date: selectedDate,
        seat_number: `S${selectedSeatNumber}`, // Store as "S<number>"
        price: selectedBusPrice, // Price per seat, from selected bus
        status: 'paid', // Admin bookings are considered paid directly
        booking_date: new Date().toISOString(),
        user_id: currentAdmin?.uid ?? null, // Track who booked
        createdAt: serverTimestamp() // Add server timestamp
    };

    const newBookingDocRef = await addDoc(bookingsCol, bookingData); // Add new booking
    
    // Decrement available_seats in the buses collection
    const busDocRef = doc(db, "buses", selectedBusId);
    await updateDoc(busDocRef, {
        available_seats: increment(-1)
    });

    // --- Generate PDF and send email ---
    if (passenger_email) {
        try {
            const pdfDoc = await generatePdfContent(bookingData); // Use the bookingData for PDF generation
            const pdfDataUri = pdfDoc.output("datauristring");
            const pdfBase64 = pdfDataUri.split(",")[1];

            const pdfBase64SizeBytes = new TextEncoder().encode(pdfBase64).length;

            let mailPayload;
            // Professional email template with modern design
            const professionalEmailHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="utf-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Ticket Confirmation - Prince Alex Travel</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; }
                        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                        .header { background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
                        .content { background: #f8fafc; padding: 30px; border-radius: 0 0 10px 10px; }
                        .ticket-details { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #1e3a8a; }
                        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb; }
                        .detail-label { font-weight: bold; color: #374151; }
                        .detail-value { color: #1f2937; }
                        .footer { text-align: center; margin-top: 30px; color: #666; font-size: 14px; }
                        .attachment-notice { background: #d1fae5; padding: 15px; border-radius: 5px; border-left: 4px solid #10b981; margin: 20px 0; }
                        .status-paid { background: #d1fae5; color: #065f46; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; }
                        .no-attachment-notice { background: #fef3c7; padding: 15px; border-radius: 5px; border-left: 4px solid #f59e0b; margin: 20px 0; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>🎫 Ticket Confirmed!</h1>
                            <p>Prince Alex Travel - Admin Booking Confirmation</p>
                        </div>
                        <div class="content">
                            <h2>Hello ${passenger_name}!</h2>
                            <p>Thank you for choosing <strong>Prince Alex Travel Services</strong>. Your ticket has been successfully booked and confirmed by our admin team!</p>
                            
                            <div class="ticket-details">
                                <h3 style="margin-top: 0; color: #1e3a8a;">🎫 Ticket Information</h3>
                                <div class="detail-row">
                                    <span class="detail-label">Booking Reference:</span>
                                    <span class="detail-value"><strong>${booking_ref}</strong></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Route:</span>
                                    <span class="detail-value">${selectedBusRoute}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Seat Number:</span>
                                    <span class="detail-value"><strong>S${selectedSeatNumber}</strong></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Travel Date:</span>
                                    <span class="detail-value">${selectedDate}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Departure Time:</span>
                                    <span class="detail-value">${selectedDepartureTime}</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Price:</span>
                                    <span class="detail-value"><strong>KES ${selectedBusPrice.toFixed(2)}</strong></span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label">Status:</span>
                                    <span class="detail-value">
                                        <span class="status-paid">PAID & CONFIRMED</span>
                                    </span>
                                </div>
                            </div>

                            <div style="background: #fef3c7; padding: 15px; border-radius: 5px; border-left: 4px solid #f59e0b; margin: 20px 0;">
                                <h4 style="margin-top: 0; color: #92400e;">📱 Important Reminders</h4>
                                <ul style="margin-bottom: 0; color: #92400e;">
                                    <li>Arrive at the terminal 15 minutes before departure</li>
                                    <li>Present your ticket (digital or printed) to the driver</li>
                                    <li>Keep your booking reference handy</li>
                                </ul>
                            </div>

                            <p><strong>📱 Need Help?</strong></p>
                            <p>If you have any questions or need assistance, please don't hesitate to contact us:</p>
                            <p><strong>📧 Email:</strong> senerwaalex@gmail.com<br>
                            <strong>📞 Phone:</strong> +254 717 384 875</p>
                        </div>
                        <div class="footer">
                            <p>© 2025 Prince Alex Digital. All rights reserved.</p>
                            <p>Nairobi, Kenya | Prince Alex Travel Services</p>
                        </div>
                    </div>
                </body>
                </html>
            `;

            // Common email details for both cases (with/without attachment)
            const commonEmailDetails = {
                subject: "Your Ticket Confirmation - Prince Alex Travel 🎫",
                text: `Dear ${passenger_name},\n\nThank you for booking a ticket with Prince Alex Travel Services!\nYour ticket has been successfully booked and confirmed.\n\nTicket Details:\nBooking Reference: ${booking_ref}\nRoute: ${selectedBusRoute}\nTravel Date: ${selectedDate}\nDeparture Time: ${selectedDepartureTime}\nSeat: S${selectedSeatNumber}\nPrice: KES ${selectedBusPrice.toFixed(2)}\nStatus: PAID & CONFIRMED\n\nThank you for choosing Prince Alex Travel Services.\n\nBest regards,\nPrince Alex Travel Team`,
                html: professionalEmailHtml,
            };

            // Add attachment notice for emails with PDF
            const attachmentNoticeHtml = `
                <div class="attachment-notice">
                    <h4 style="margin-top: 0; color: #065f46;">📎 E-Ticket Attached</h4>
                    <p style="margin-bottom: 0; color: #065f46;">Your e-ticket PDF is attached to this email. You can download it and present it at the bus terminal.</p>
                </div>
            `;

            const noAttachmentNoticeHtml = `
                <div class="no-attachment-notice">
                    <h4 style="margin-top: 0; color: #92400e;">📄 Ticket Available</h4>
                    <p style="margin-bottom: 0; color: #92400e;">Your ticket has been confirmed. Please contact us if you need a copy of your ticket.</p>
                </div>
            `;


            if (pdfBase64SizeBytes > MAX_PDF_BASE64_SIZE_BYTES) {
                console.warn(`PDF for email is too large (${(pdfBase64SizeBytes / 1024).toFixed(2)} KB). Skipping email attachment.`);
                showCustomAlert(`Booking created & marked PAID. Note: Ticket PDF was too large for email attachment (${(pdfBase64SizeBytes / 1024).toFixed(2)} KB). Confirmation email sent without attachment.`, 'warning');
                mailPayload = {
                    to: [passenger_email],
                    message: {
                        subject: commonEmailDetails.subject,
                        text: commonEmailDetails.text,
                        html: professionalEmailHtml + noAttachmentNoticeHtml,
                    },
                    createdAt: serverTimestamp()
                };
            } else {
                mailPayload = {
                    to: [passenger_email],
                    message: {
                        subject: commonEmailDetails.subject,
                        text: commonEmailDetails.text + `\n\nPlease find your e-Ticket attached as a PDF file.`,
                        html: professionalEmailHtml + attachmentNoticeHtml,
                        attachments: [
                            {
                                filename: `PrinceAlex_Ticket_${booking_ref}.pdf`,
                                content: pdfBase64,
                                encoding: "base64"
                            }
                        ]
                    },
                    createdAt: serverTimestamp()
                };
                showCustomAlert("Booking created & marked PAID. Confirmation email with ticket sent!", "success");
            }
            await addDoc(collection(db,"mail"), mailPayload);
            console.log("Admin-initiated booking confirmation email queued successfully in mail collection.");

        } catch (pdfError) {
            console.error("Error generating PDF or queuing email:", pdfError);
            showCustomAlert("Booking created & marked PAID. Failed to generate ticket PDF or send email.", "error");
        }
    } else {
        showCustomAlert("Booking created & marked PAID. No email sent as passenger email is missing.", "info");
    }

    $("#seatModal").classList.add("hidden");
    e.target.reset(); // Reset the passenger details form
    $("#adminConfirmBooking button[type='submit']").disabled = true; // Disable button after booking
    $("#passengerDetailsCard").classList.add("hidden"); // Hide passenger details card again
    
    // Automatically download PDF receipt for the admin
    generateTicketPDF(bookingData); 
    
    // Unsubscribe from seat listener when booking is confirmed
    if (seatSelectionUnsubscribe) {
        seatSelectionUnsubscribe();
        seatSelectionUnsubscribe = null;
    }
    loadBookings(); // Reload bookings table
  } catch (err) {
    console.error(err);
    showCustomAlert("Booking failed: " + err.message, "error");
  }
});

// Helper function to reload bookings table for consistency if needed
function loadBookings() {
    attachRealtimeBookings();
}
</script>

<style>
:root {
  --primary-color: #1e3a8a; /* Modern deep blue */
  --primary-light: #3b82f6; /* Lighter blue for accents */
  --accent-color: #f59e0b; /* Modern amber/gold */
  --accent-light: #fbbf24; /* Light amber */
  --light-bg: #f8fafc; /* Clean light background */
  --white: #ffffff;
  --text-dark: #1e293b;
  --text-light: #64748b;
  --success: #10b981;
  --error: #ef4444;
  --warning: #f59e0b;
  --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
  --gradient-accent: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-light) 100%);
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  --border-radius: 12px;
  --border-radius-lg: 16px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:var(--light-bg);color:var(--text-dark)}
/* Modern Navbar */
.navbar{background:var(--gradient-primary);padding:1rem 0;box-shadow:var(--shadow-lg);position:sticky;top:0;z-index:1000;backdrop-filter:blur(10px)}
.navbar-container{max-width:1200px;margin:auto;padding:0 20px;display:flex;align-items:center;justify-content:space-between}
.logo{background:var(--white);padding:0.75rem 1rem;border-radius:var(--border-radius-lg);box-shadow:var(--shadow-md);transition:var(--transition)}
.logo:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
.logo img{height:50px;display:block;transition:var(--transition)}
.nav-links{display:flex;gap:2rem;align-items:center}
.nav-links a{color:var(--white);text-decoration:none;font-weight:600;font-size:0.95rem;position:relative;padding:0.5rem 0;transition:var(--transition)}
.nav-links a::after{content:"";display:block;height:2px;width:0;background:var(--accent-color);transition:var(--transition);position:absolute;left:0;bottom:0;border-radius:1px}
.nav-links a:hover{color:var(--accent-light);transform:translateY(-1px)}
.nav-links a:hover::after{width:100%}
.nav-links .badge{background:var(--accent-color);color:var(--white);padding:0.25rem 0.75rem;border-radius:999px;font-size:0.8rem;font-weight:700}

/* Modern Layout */
.container{max-width:1200px;margin:2rem auto;padding:0 1.5rem}
.hidden{display:none !important}
.header-row{display:flex;align-items:center;gap:1rem;justify-content:space-between;margin-bottom:2rem;flex-wrap:wrap}
.header-row h1{font-size:2rem;font-weight:700;color:var(--text-dark);margin:0}
.badge{padding:0.5rem 1rem;border-radius:999px;font-size:0.75rem;font-weight:600;text-transform:uppercase;letter-spacing:0.05em}
.badge.success{background:var(--success);color:var(--white)}
.badge.warn{background:var(--warning);color:var(--white)}
.nowrap{white-space:nowrap}
.card{background:var(--white);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-md);padding:1.5rem;margin-bottom:1.5rem;border:1px solid rgba(0,0,0,0.05);transition:var(--transition)}
.card:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px)}

/* Modern Buttons */
.btn{background:var(--gradient-accent);color:var(--white);border:none;border-radius:var(--border-radius);padding:0.75rem 1.5rem;font-weight:600;font-size:0.9rem;cursor:pointer;transition:var(--transition);box-shadow:var(--shadow-sm);position:relative;overflow:hidden}
.btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.btn:active{transform:translateY(0)}
.btn.sm{padding:0.5rem 1rem;font-size:0.8rem}
.btn.danger{background:var(--error);color:var(--white)}
.btn.danger:hover{background:#dc2626}
.btn.success{background:var(--success);color:var(--white)}
.btn.success:hover{background:#059669}

/* Modern Forms & Tables */
input,select{width:100%;padding:0.75rem 1rem;border:2px solid #e2e8f0;border-radius:var(--border-radius);font-size:0.9rem;transition:var(--transition);background:var(--white)}
input:focus,select:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(59, 130, 246, 0.1)}
input:hover,select:hover{border-color:#cbd5e1}
label{font-size:0.85rem;color:var(--text-dark);margin-bottom:0.5rem;display:block;font-weight:600}
.grid{display:grid;gap:1rem}
.grid-2{grid-template-columns:repeat(2,1fr)}
.grid-3{grid-template-columns:repeat(3,1fr)}
.table{width:100%;border-collapse:collapse;background:var(--white);border-radius:var(--border-radius);overflow:hidden;box-shadow:var(--shadow-sm)}
.table th,.table td{padding:1rem;border-bottom:1px solid #f1f5f9;text-align:left;font-size:0.9rem}
.table th{background:#f8fafc;font-weight:600;color:var(--text-dark);text-transform:uppercase;letter-spacing:0.05em;font-size:0.8rem}
.table tbody tr:hover{background:#f8fafc}

/* Modern Tabs */
.tabbar{display:flex;gap:0.5rem;margin-bottom:1.5rem;background:#f1f5f9;padding:0.25rem;border-radius:var(--border-radius)}
.tab-btn{background:transparent;color:var(--text-light);border:none;border-radius:calc(var(--border-radius) - 0.25rem);padding:0.75rem 1.5rem;cursor:pointer;font-weight:600;font-size:0.9rem;transition:var(--transition);position:relative}
.tab-btn:hover{color:var(--text-dark);background:rgba(255,255,255,0.5)}
.tab-btn.active{background:var(--white);color:var(--primary-color);box-shadow:var(--shadow-sm)}

/* Modern Seat Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)}
.modal .box{background:var(--white);max-width:800px;width:95%;border-radius:var(--border-radius-lg);padding:2rem;max-height:90vh;overflow:auto;box-shadow:var(--shadow-xl)}
#seatGrid{display:grid;gap:1rem;margin:1.5rem 0;padding:1.5rem;border:2px dashed #e2e8f0;border-radius:var(--border-radius);background:#f8fafc}
.seat-container{position:relative;width:70px;height:70px;border-radius:var(--border-radius);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:var(--transition);border:2px solid transparent}
.seat-container .seat-icon{font-size:2.5em;color:#94a3b8;transition:var(--transition)}
.seat-container .seat-number{font-size:0.8em;font-weight:700;color:var(--text-light);margin-top:0.25rem;transition:var(--transition)}
.seat-container.selected{background:var(--accent-light);border-color:var(--accent-color);transform:scale(1.05)}
.seat-container.selected .seat-icon,.seat-container.selected .seat-number{color:var(--accent-color)}
.seat-container.booked{cursor:not-allowed;background:#fee2e2;border-color:#fca5a5}
.seat-container.booked .seat-icon,.seat-container.booked .seat-number{color:var(--error)}
.seat-container.booked::after{content:"✕";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:2em;color:var(--white);background:rgba(239,68,68,0.8);border-radius:var(--border-radius)}
.driver-area{grid-column:1/-1;text-align:center;margin-bottom:1rem;font-weight:700;color:var(--primary-color);padding:0.75rem;border-bottom:2px solid #e2e8f0;background:var(--white);border-radius:var(--border-radius)}
.aisle-space{width:100%;height:100%}

/* Modern Toast (Custom Alert/Confirm) */
.custom-alert-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:2000;backdrop-filter:blur(4px)}
.custom-alert-content{background:var(--white);padding:2rem;border-radius:var(--border-radius-lg);text-align:center;max-width:450px;box-shadow:var(--shadow-xl);display:flex;flex-direction:column;gap:1.5rem;border:1px solid rgba(0,0,0,0.05)}
.custom-alert-content p{margin:0;font-size:1.1rem;color:var(--text-dark);line-height:1.6}
.custom-alert-content button{background:var(--gradient-primary);color:var(--white);padding:0.75rem 2rem;border:none;border-radius:var(--border-radius);cursor:pointer;font-size:1rem;font-weight:600;transition:var(--transition);box-shadow:var(--shadow-sm)}
.custom-alert-content button:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.confirm-buttons{display:flex;justify-content:center;gap:1rem}
.confirm-buttons .confirm-yes{background:var(--success)}
.confirm-buttons .confirm-yes:hover{background:#059669}
.confirm-buttons .confirm-no{background:var(--error)}
.confirm-buttons .confirm-no:hover{background:#dc2626}


/* Modern Login */
.login-card{max-width:450px;margin:3rem auto;background:var(--white);border-radius:var(--border-radius-lg);box-shadow:var(--shadow-lg);padding:2rem;border:1px solid rgba(0,0,0,0.05)}
.login-title{text-align:center;margin-bottom:1.5rem;font-size:1.5rem;font-weight:700;color:var(--text-dark)}

/* Modern Responsive Design */
@media (max-width: 768px){
  .container{padding:0 1rem}
  .grid-3{grid-template-columns:1fr}
  .grid-2{grid-template-columns:1fr}
  .nav-links{gap:1rem;flex-wrap:wrap}
  .header-row{flex-direction:column;align-items:flex-start;gap:1rem}
  .tabbar{flex-wrap:wrap}
  .table{font-size:0.8rem}
  .table th,.table td{padding:0.75rem 0.5rem}
  .modal .box{padding:1.5rem;margin:1rem}
  #seatGrid{padding:1rem;gap:0.75rem}
  .seat-container{width:60px;height:60px}
  .seat-container .seat-icon{font-size:2em}
  .login-card{margin:2rem auto;padding:1.5rem}
}
@media (max-width: 480px){
  .navbar-container{padding:0 1rem}
  .logo img{height:40px}
  .nav-links{gap:0.75rem}
  .nav-links a{font-size:0.85rem}
  .header-row h1{font-size:1.5rem}
  .card{padding:1rem}
  .btn{padding:0.6rem 1.2rem;font-size:0.85rem}
}
</style>
</head>
<body>
  <!-- Header (match index) -->
  <header class="navbar">
    <div class="navbar-container">
      <div class="logo">
        <img src="mylogo.png" alt="Prince Alex Logo"/>
      </div>
      <nav class="nav-links">
        <a href="index.html">Home</a>
        <a href="about-us.html">About Us</a>
        <a href="ticket-lookup.html">Print Ticket</a>
        <a href="#" class="badge" id="adminEmailBadge">Admin</a>
        <a href="#" id="logoutBtn">Logout</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Login -->
    <section id="loginCard" class="card login-card">
      <h2 class="login-title">Admin Login</h2>
      <form id="loginForm" class="grid" style="gap:14px">
        <div>
          <label>Email</label>
          <input id="loginEmail" type="email" placeholder="admin@example.com" required>
        </div>
        <div>
          <label>Password</label>
          <input id="loginPassword" type="password" placeholder="********" required>
        </div>
        <button class="btn" type="submit">Login</button>
        <p style="font-size:12px;opacity:.8">
    </form>
    </section>

    <!-- Admin App -->
    <section id="adminApp" class="hidden">
      <div class="header-row">
        <h1>Admin Panel</h1>
        <div class="tabbar">
          <button class="tab-btn active" data-tab="tabBuses">Manage Buses</button>
          <button class="tab-btn" data-tab="tabBookings">Manage Bookings</button>
          <button class="tab-btn" data-tab="tabMakeBooking">Make Booking</button>
        </div>
      </div>

      <!-- Manage Buses -->
      <section id="tabBuses" class="tab-panel">
        <div class="card">
          <h3>Add New Bus</h3>
          <form id="addBusForm" class="grid grid-3" style="margin-top:10px">
            <div><label>Company</label><input id="busCompany" required></div>
            <div><label>From (Origin)</label><input id="busFrom" required></div>
            <div><label>To (Destination)</label><input id="busTo" required></div>
            <div><label>Travel Date</label><input id="busTravelDate" type="date" required></div> <!-- New Field -->
            <div><label>Departure Time</label><input id="busTime" placeholder="e.g. 08:00 AM" required></div>
            <div><label>Price (KES)</label><input id="busPrice" type="number" min="0" required></div>
            <div><label>Total Seats</label><input id="busSeats" type="number" min="1" value="32" required></div>
            <div style="grid-column: span 2;"><label>Image URL (Optional)</label><input id="busImage" type="text" placeholder="https://example.com/bus.png"></div> <!-- New Field -->
            <div class="nowrap" style="align-self:end"><button class="btn" type="submit">Add Bus</button></div>
          </form>
        </div>
        <div class="card">
          <h3>All Buses</h3>
          <table class="table" style="margin-top:8px">
            <thead><tr>
              <th>Company</th><th>From</th><th>To</th><th>Travel Date</th><th>Departure</th><th>Price</th><th>Total Seats</th><th>Available Seats</th><th>Actions</th>
            </tr></thead>
            <tbody id="busTableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Manage Bookings -->
      <section id="tabBookings" class="tab-panel hidden">
        <div class="card">
          <div class="grid grid-2">
            <div>
              <h3>Bookings</h3>
              <p style="font-size:12px;opacity:.8">Search by passenger name, email or booking reference.</p>
            </div>
            <div style="align-self:end">
              <input id="bookingSearch" placeholder="Search bookings...">
            </div>
          </div>
          <table class="table" style="margin-top:8px">
            <thead>
              <tr>
                <th>Ref</th><th>Name</th><th>Email</th><th>Route</th><th>Travel Date</th><th>Seat</th><th>Price</th><th>Status</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="bookingTableBody"></tbody>
          </table>
        </div>
      </section>

      <!-- Make Booking -->
      <section id="tabMakeBooking" class="tab-panel hidden">
        <div class="card">
          <h3>Find Bus</h3>
          <form id="adminBookingSearch" class="grid grid-3" style="margin-top:10px">
            <div>
              <label>From (Origin)</label>
              <select id="abFrom" required>
                <option value="">Select Origin</option>
              </select>
            </div>
            <div>
              <label>To (Destination)</label>
              <select id="abTo" required>
                <option value="">Select Destination</option>
              </select>
            </div>
            <div><label>Travel Date</label><input id="abDate" type="date" required></div>
            <div class="nowrap" style="grid-column: 1 / -1; text-align:right">
              <button class="btn" type="submit">Search</button>
            </div>
          </form>
          <div id="abResults" class="grid" style="margin-top:10px; gap:14px"></div>
        </div>

        <div id="passengerDetailsCard" class="card hidden"> <!-- Added ID and hidden class -->
          <h3>Passenger Details</h3>
          <form id="adminConfirmBooking" class="grid grid-3" style="margin-top:10px">
            <div><label>Full Name</label><input id="abName" required></div>
            <div><label>Email</label><input id="abEmail" type="email"></div>
            <div><label>Phone</label><input id="abPhone"></div>
            <div><label>ID Number</label><input id="abID" required></div> <!-- New Field -->
            <div>
              <label>Gender</label>
              <select id="abGender" required> <!-- New Field -->
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div><label>Price (KES per seat)</label><input id="abPrice" type="number" min="0" readonly></div> <!-- Display price for clarity -->
            <div><label>Selected Seat</label><input id="displayedSeatNumber" type="text" readonly></div> <!-- New visible field for selected seat -->
            <input type="hidden" id="selectedSeatNumberAdmin"> <!-- This will still hold the programmatic value -->
            <div class="nowrap" style="grid-column: 1 / -1; text-align:right">
              <button class="btn" type="submit">Confirm Booking (Paid)</button>
            </div>
          </form>
        </div>
      </section>
    </section>
  </main>

  <!-- Edit Bus Modal -->
  <div id="editBusModal" class="modal hidden">
    <div class="box">
      <h3>Edit Bus</h3>
      <form id="editBusForm" class="grid grid-3" style="margin-top:10px">
        <input type="hidden" id="editBusId">
        <div><label>Company</label><input id="editBusCompany" required></div>
        <div><label>From (Origin)</label><input id="editBusFrom" required></div>
        <div><label>To (Destination)</label><input id="editBusTo" required></div>
        <div><label>Travel Date</label><input id="editBusTravelDate" type="date" required></div> <!-- New Field -->
        <div><label>Departure Time</label><input id="editBusTime" required></div>
        <div><label>Price (KES)</label><input id="editBusPrice" type="number" required></div>
        <div><label>Total Seats</label><input id="editBusSeats" type="number" min="1" required></div>
        <div style="grid-column: span 2;"><label>Image URL (Optional)</label><input id="editBusImage" type="text" placeholder="https://example.com/bus.png"></div> <!-- New Field -->
        <div class="nowrap" style="grid-column:1/-1; text-align:right; display:flex; gap:8px; justify-content:flex-end">
          <button type="button" class="btn" id="editBusCancel">Cancel</button>
          <button class="btn" type="submit">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Seat Modal -->
  <div id="seatModal" class="modal hidden">
    <div class="box">
      <h3>Select Seat for <span id="selectedBusInfoAdmin"></span></h3>
      <div id="seatGrid"></div>
      <div style="text-align:right; display:flex; gap:8px; justify-content:flex-end">
        <button class="btn" id="seatCancel">Close</button>
      </div>
    </div>
  </div>
</body>
</html>
