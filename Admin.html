<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Panel - Prince Alex Travel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
            margin: 0;
            padding: 20px;
        }
        .header-brand {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        .header-brand img {
            height: 60px;
            border-radius: 8px;
        }
        .header-brand h1 {
            font-size: 24px;
            color: #002d6b;
            margin: 0;
        }
        .login, .admin-panel {
            max-width: 95%; /* Wider to accommodate more columns */
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        input, button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 10px;
            text-align: left;
            font-size: 0.9em; /* Smaller font for more columns */
        }
        th {
            background-color: #f2f2f2;
        }
        .hidden {
            display: none;
        }
        button {
            background: #002d6b;
            color: white;
            border: none;
            cursor: pointer;
            padding: 10px 15px; /* Adjust padding */
            width: auto; /* Allow buttons to size to content */
            border-radius: 5px;
        }
        button:hover {
            background: #001c44;
        }
        
        /* Ensure action buttons in table cells are on the same line */
        td.action-buttons {
            display: flex;
            flex-wrap: nowrap; /* Prevent wrapping to new lines */
            gap: 5px; /* Space between buttons */
            align-items: center; /* Vertically align buttons */
        }
        td.action-buttons button {
            margin: 0; /* Remove individual button margins, gap handles spacing */
        }

        .section {
            margin-top: 40px;
            overflow-x: auto; /* Allow horizontal scrolling for tables */
        }
        h2 {
            color: #002d6b;
            text-align: left;
            margin-bottom: 15px;
        }

        /* Specific styling for status */
        .status-paid { color: green; font-weight: bold; }
        .status-pending { color: orange; font-weight: bold; }
        .status-cancelled { color: red; font-weight: bold; }

        .button-group {
            margin-top: 15px;
            margin-bottom: 10px;
            text-align: right; /* Align download button to the right */
        }
        .button-group button {
            width: auto;
            display: inline-block;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .login, .admin-panel {
                padding: 15px;
            }
            .header-brand {
                flex-direction: column;
                text-align: center;
            }
            .header-brand h1 {
                font-size: 20px;
            }
            th, td {
                font-size: 0.8em;
                padding: 8px;
            }
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap; /* Prevent wrapping in table cells */
            }
            td.action-buttons {
                flex-direction: column; /* Stack buttons on small screens */
                align-items: flex-start;
            }
            td.action-buttons button {
                width: 100%; /* Make buttons full width when stacked */
                margin-bottom: 5px; /* Add margin when stacked */
            }
        }
    </style>
</head>
<body>

    <div class="login" id="loginForm">
        <div class="header-brand">
            <img src="Mylogo.png" alt="Prince Alex Logo">
            <h1>Prince Alex Digital Admin Login</h1>
        </div>
        <input type="email" id="adminEmail" placeholder="Email" required>
        <input type="password" id="adminPass" placeholder="Password" required>
        <button onclick="adminLogin()">Login</button>
    </div>

    <div class="admin-panel hidden" id="adminPanel">
        <div class="header-brand">
            <img src="Mylogo.png" alt="Prince Alex Logo">
            <h1>Prince Alex Digital Admin Panel</h1>
        </div>

        <div class="section">
            <h2>Bus Management</h2>
            <input type="text" id="busFrom" placeholder="From" required>
            <input type="text" id="busTo" placeholder="To" required>
            <input type="text" id="busTime" placeholder="Time (e.g., 08:00 AM)" required>
            <input type="number" id="busPrice" placeholder="Price" required>
            <input type="text" id="busImage" placeholder="Image URL (e.g., Bus1.jpeg)" required>
            <input type="number" id="busTotalSeats" placeholder="Total Seats" required>
            <input type="date" id="busTravelDate" placeholder="Travel Date" required>
            <button onclick="addBus()">Add Bus</button>

            <table>
                <thead>
                    <tr>
                        <th>Bus ID</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Time</th>
                        <th>Price</th>
                        <th>Total Seats</th>
                        <th>Travel Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="busTableBody"></tbody>
            </table>
        </div>

        <div class="section">
            <h2>Booking Management</h2>
            <div class="button-group">
                <button onclick="downloadBookingsCSV()">Download Bookings CSV</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Booking ID</th>
                        <th>Name</th>
                        <th>ID No.</th>
                        <th>Gender</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Route</th>
                        <th>Travel Date</th>
                        <th>Time</th>
                        <th>Seat</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th>Booking Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="bookingTableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const ADMIN_EMAIL = "senerwaalex@gmail.com";
        const ADMIN_PASS = "admin";

        // Utility functions for localStorage
        function getStoredBuses() {
            const buses = localStorage.getItem('buses');
            return buses ? JSON.parse(buses) : [];
        }

        function setStoredBuses(buses) {
            localStorage.setItem('buses', JSON.stringify(buses));
        }

        function getStoredBookings() {
            const bookings = localStorage.getItem('bookings');
            return bookings ? JSON.parse(bookings) : [];
        }

        function setStoredBookings(bookings) {
            localStorage.setItem('bookings', JSON.stringify(bookings));
        }

        function adminLogin() {
            const email = document.getElementById("adminEmail").value;
            const pass = document.getElementById("adminPass").value;
            if (email === ADMIN_EMAIL && pass === ADMIN_PASS) {
                document.getElementById("loginForm").classList.add("hidden");
                document.getElementById("adminPanel").classList.remove("hidden");
                loadBuses();
                loadBookings();
            } else {
                alert("Invalid credentials.");
            }
        }

        function loadBuses() {
            const buses = getStoredBuses();
            const table = document.getElementById("busTableBody");
            table.innerHTML = "";
            buses.forEach((bus, i) => {
                table.innerHTML += `
                    <tr>
                        <td>${bus.id || 'N/A'}</td>
                        <td>${bus.from}</td>
                        <td>${bus.to}</td>
                        <td>${bus.time}</td>
                        <td>Ksh ${bus.price}</td>
                        <td>${bus.totalSeats}</td>
                        <td>${bus.travelDate || 'N/A'}</td>
                        <td class="action-buttons">
                            <button onclick="editBus(${i})">Edit</button>
                            <button onclick="deleteBus(${i})">Delete</button>
                        </td>
                    </tr>`;
            });
        }

        function addBus() {
            const from = document.getElementById("busFrom").value;
            const to = document.getElementById("busTo").value;
            const time = document.getElementById("busTime").value;
            const price = document.getElementById("busPrice").value;
            const image = document.getElementById("busImage").value;
            const totalSeats = parseInt(document.getElementById("busTotalSeats").value);
            const travelDate = document.getElementById("busTravelDate").value; // Capture Travel Date

            if (!from || !to || !time || !price || !image || isNaN(totalSeats) || totalSeats <= 0 || !travelDate) {
                alert("Please fill all bus details correctly, including Travel Date.");
                return;
            }

            const newBus = {
                id: 'BUS-' + Date.now(), // Generate a simple ID
                from: from,
                to: to,
                time: time,
                price: parseFloat(price),
                image: image,
                totalSeats: totalSeats,
                travelDate: travelDate // Add Travel Date to bus object
            };

            let buses = getStoredBuses();
            buses.push(newBus);
            setStoredBuses(buses);
            loadBuses();
            alert("Bus added.");

            // Clear form
            document.getElementById("busFrom").value = '';
            document.getElementById("busTo").value = '';
            document.getElementById("busTime").value = '';
            document.getElementById("busPrice").value = '';
            document.getElementById("busImage").value = '';
            document.getElementById("busTotalSeats").value = '';
            document.getElementById("busTravelDate").value = ''; // Clear Travel Date field
        }

        function deleteBus(index) {
            let buses = getStoredBuses();
            if (confirm("Are you sure you want to delete this bus? This action cannot be undone.")) {
                buses.splice(index, 1);
                setStoredBuses(buses);
                loadBuses();
                alert("Bus deleted.");
            }
        }

        function editBus(index) {
            let buses = getStoredBuses();
            const busToEdit = buses[index];

            // Populate form fields with data of the bus to be edited
            document.getElementById("busFrom").value = busToEdit.from;
            document.getElementById("busTo").value = busToEdit.to;
            document.getElementById("busTime").value = busToEdit.time;
            document.getElementById("busPrice").value = busToEdit.price;
            document.getElementById("busImage").value = busToEdit.image;
            document.getElementById("busTotalSeats").value = busToEdit.totalSeats;
            document.getElementById("busTravelDate").value = busToEdit.travelDate; // Populate Travel Date

            // Remove the original bus entry from the array after populating the form
            buses.splice(index, 1);
            setStoredBuses(buses);
            loadBuses();
            alert("Bus data loaded for editing. Modify fields and click 'Add Bus' to save changes.");
        }

        function loadBookings() {
            const bookings = getStoredBookings();
            const table = document.getElementById("bookingTableBody");
            table.innerHTML = "";
            bookings.forEach((b) => {
                let statusClass = '';
                if (b.status === 'paid') {
                    statusClass = 'status-paid';
                } else if (b.status === 'pending') {
                    statusClass = 'status-pending';
                } else if (b.status === 'cancelled') {
                    statusClass = 'status-cancelled';
                }

                table.innerHTML += `
                    <tr>
                        <td>${b.id || 'N/A'}</td>
                        <td>${b.passengerName || 'N/A'}</td>
                        <td>${b.passengerID || 'N/A'}</td>
                        <td>${b.passengerGender || 'N/A'}</td>
                        <td>${b.passengerEmail || 'N/A'}</td>
                        <td>${b.passengerPhone || 'N/A'}</td>
                        <td>${b.busRoute || 'N/A'}</td>
                        <td>${b.travelDate || 'N/A'}</td>
                        <td>${b.busTime || 'N/A'}</td>
                        <td>${b.seatNumber || 'N/A'}</td>
                        <td>Ksh ${b.price || 'N/A'}</td>
                        <td class="${statusClass}">${b.status ? b.status.toUpperCase() : 'N/A'}</td>
                        <td>${b.bookingDate || 'N/A'}</td>
                        <td class="action-buttons">
                            <button onclick="updateBookingStatus('${b.id}', 'paid')">Mark Paid</button>
                            <button onclick="cancelBooking('${b.id}')">Cancel</button>
                            <button onclick="editBookingSeat('${b.id}')">Edit Seat</button>
                        </td>
                    </tr>`;
            });
        }

        function updateBookingStatus(bookingId, newStatus) {
            let bookings = getStoredBookings();
            const bookingIndex = bookings.findIndex(b => b.id === bookingId);
            if (bookingIndex !== -1) {
                bookings[bookingIndex].status = newStatus;
                setStoredBookings(bookings);
                loadBookings(); // Reload the table to reflect changes
                alert(`Booking ${bookingId} status updated to ${newStatus.toUpperCase()}.`);
            } else {
                alert(`Booking ${bookingId} not found.`);
            }
        }

        function markPaid(bookingId) {
            updateBookingStatus(bookingId, "paid");
        }

        function cancelBooking(bookingId) {
            if (confirm("Are you sure you want to cancel this booking?")) {
                updateBookingStatus(bookingId, "cancelled");
            }
        }

        function editBookingSeat(bookingId) {
            let bookings = getStoredBookings();
            const bookingIndex = bookings.findIndex(b => b.id === bookingId);

            if (bookingIndex !== -1) {
                const currentBooking = bookings[bookingIndex];
                const newSeatNumber = prompt(`Enter new seat number for Booking ID ${bookingId} (Current: ${currentBooking.seatNumber}):`);

                if (newSeatNumber !== null && newSeatNumber.trim() !== '') {
                    const oldSeatNumber = currentBooking.seatNumber;
                    currentBooking.seatNumber = newSeatNumber.trim();
                    setStoredBookings(bookings); // Save updated bookings

                    loadBookings(); // Reload the table to reflect changes

                    // Simulate sending a message to the customer
                    const customerMessage = `Dear ${currentBooking.passengerName},\n\nYour booking (ID: ${currentBooking.id}) for the ${currentBooking.busRoute} route on ${currentBooking.travelDate} at ${currentBooking.busTime} has been updated.\n\nYour seat number has been changed from ${oldSeatNumber} to ${newSeatNumber.trim()}.\n\nThank you,\nPrince Alex Travel Services`;
                    alert("Simulating message sent to customer:\n\n" + customerMessage);

                    alert(`Seat for Booking ID ${bookingId} updated to ${newSeatNumber.trim()} and customer notified.`);
                } else if (newSeatNumber === '') {
                    alert("Seat number cannot be empty. No changes made.");
                } else {
                    alert("Seat change cancelled.");
                }
            } else {
                alert(`Booking ${bookingId} not found.`);
            }
        }

        function downloadBookingsCSV() {
            const bookings = getStoredBookings();
            if (bookings.length === 0) {
                alert("No bookings to download.");
                return;
            }

            // Define CSV headers
            const headers = [
                "Booking ID", "Passenger Name", "Passenger ID No.", "Passenger Gender",
                "Passenger Email", "Passenger Phone", "Bus Route", "Travel Date",
                "Bus Time", "Seat Number", "Price", "Status", "Booking Date"
            ];

            // Map booking object properties to CSV columns
            const csvRows = [headers.join(',')]; // Add header row

            bookings.forEach(booking => {
                const row = [
                    `"${booking.id || ''}"`,
                    `"${booking.passengerName || ''}"`,
                    `"${booking.passengerID || ''}"`,
                    `"${booking.passengerGender || ''}"`,
                    `"${booking.passengerEmail || ''}"`,
                    `"${booking.passengerPhone || ''}"`,
                    `"${booking.busRoute || ''}"`,
                    `"${booking.travelDate || ''}"`,
                    `"${booking.busTime || ''}"`,
                    `"${booking.seatNumber || ''}"`,
                    `"${booking.price || ''}"`,
                    `"${booking.status ? booking.status.toUpperCase() : ''}"`,
                    `"${booking.bookingDate || ''}"`
                ].map(field => field.replace(/"/g, '""')).join(','); // Escape double quotes

                csvRows.push(row);
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'prince_alex_bookings.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // Clean up
            alert("Bookings data downloaded successfully as CSV!");
        }

        // Initial load when admin panel is shown or page is refreshed
        document.addEventListener('DOMContentLoaded', () => {
            if (!document.getElementById("loginForm").classList.contains("hidden")) {
                // If login form is visible, wait for login
            } else {
                loadBuses();
                loadBookings();
            }
        });
    </script>
</body>
</html>